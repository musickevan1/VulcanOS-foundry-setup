# Milestone v2.1: Maintenance

**Status:** SHIPPED 2026-02-01
**Phases:** 11-13
**Total Plans:** 9

## Overview

Clean up technical debt from v2.0 to solidify the Appearance Manager codebase before adding new features. This maintenance milestone focused on wiring existing infrastructure (AppState state machine, security validation, wallpaper assets) rather than building new features.

## Phases

### Phase 11: Security Hardening

**Goal**: Theme import security via parse_and_validate() integration
**Depends on**: Nothing (maintenance work on existing code)
**Requirements**: SEC-01, SEC-02, SEC-03
**Plans**: 1 plan

Plans:
- [x] 11-01: Wire parse_and_validate() into all theme loading paths

**Success Criteria:**
1. All theme loading paths (builtin, custom, import) use parse_and_validate() function
2. Theme import rejects files with dangerous patterns (command injection, eval, pipes)
3. Theme import rejects files with path traversal attempts (../, absolute paths)
4. User receives clear error message when importing malformed or malicious theme

**Details:**
Changed 5 parse_theme_file() calls to parse_and_validate() in theme_storage.rs. The parse_and_validate() function (created in v2.0 Phase 7) contains 23 test cases for dangerous pattern detection.

### Phase 12: UX Polish

**Goal**: Complete theme/wallpaper experience with binding detection and wallpaper library
**Depends on**: Nothing (independent UX improvements)
**Requirements**: UX-01, UX-02, UX-03
**Plans**: 3 plans

Plans:
- [x] 12-01: BindingMode auto-transition (ThemeBound -> CustomOverride)
- [x] 12-02: Fix wallpaper path resolution
- [x] 12-03: Download missing wallpapers and update LICENSE attribution

**Success Criteria:**
1. BindingMode automatically transitions to CustomOverride when user manually changes wallpaper after applying theme
2. All 10 preset themes have matching wallpapers bundled
3. Wallpaper LICENSE files contain proper attribution for all downloaded sources
4. User can apply any preset theme and see coordinated wallpaper immediately

**Details:**
- Added 4-line condition check in WallpapersChanged handler for auto-transition
- Updated wallpaper path resolution to use dotfiles/wallpapers/{theme_id}/ structure
- Downloaded wallpapers from Unsplash (CC0) for 7 themes, created custom gruvbox-dark wallpaper

### Phase 13: Architecture Cleanup

**Goal**: AppState integration for proper preview/apply/cancel workflow
**Depends on**: Nothing (internal state management)
**Requirements**: ARCH-01, ARCH-02, ARCH-03
**Plans**: 5 plans

Plans:
- [x] 13-01: AppState integration into ThemeViewModel
- [x] 13-02: Action bar UI with Revealer animation
- [x] 13-03: Cancel restore logic with RestoreWallpapers message
- [x] 13-04: Implicit apply on close and human verification
- [x] 13-05: Apply state transitions with rollback on failure

**Success Criteria:**
1. App uses AppState state machine to track preview/apply lifecycle
2. Cancel Preview button restores previous theme AND wallpapers
3. Preview/Apply/Cancel buttons are disabled during invalid states (cannot preview while already previewing)
4. User can preview multiple themes, cancel to restore original state, then apply desired theme

**Details:**
- ThemeViewModel tracks state with app_state, preview_snapshot, and previewing_theme_id fields
- Action bar slides up during preview with Cancel/Apply buttons
- Cancel restores both theme and wallpapers from PreviewSnapshot
- Implicit apply on window close via GTK4 close-request signal
- Apply failure triggers rollback() to preserve user ability to retry or cancel

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale |
|----------|-----------|
| Wire existing infrastructure, not new features | Maintenance milestone, consolidate before expanding |
| Trust central validator (parse_and_validate) | Security validation in one place, no duplication |
| CC0 licensing for wallpapers | Clear redistribution rights |
| Implicit apply on close | Prevents loss of preview work, matches user expectation |
| Apply failure -> Previewing (not Idle) | User can retry or cancel instead of starting over |

**Issues Resolved:**

- Security bypass in theme loading (parse_theme_file used instead of parse_and_validate)
- Missing wallpapers for 7 of 10 preset themes
- BindingMode stuck in ThemeBound after manual wallpaper change
- No cancel restore for wallpapers (only theme was restored)
- No implicit apply on window close during preview

**Issues Deferred:**

- AppState error dialogs/spinners — Defer to v2.2 (requires UI design)
- Wallpaper preview state tracking — Defer to v2.2 (separate feature)
- Multi-step undo/redo — Defer to v2.2 (beyond maintenance scope)

**Technical Debt Incurred:**

None — v2.1 was specifically designed to reduce tech debt from v2.0.

---

*For current project status, see .planning/ROADMAP.md*
