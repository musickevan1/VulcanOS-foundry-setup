---
phase: 11-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vulcan-appearance-manager/src/services/theme_storage.rs
autonomous: true

must_haves:
  truths:
    - "Theme import rejects files with dangerous patterns (command injection, eval, pipes)"
    - "Theme import rejects files with path traversal attempts (../, absolute paths)"
    - "All theme loading paths (builtin, custom, import) validate files before use"
    - "User receives clear error message when importing malformed or malicious theme"
  artifacts:
    - path: "vulcan-appearance-manager/src/services/theme_storage.rs"
      provides: "Theme storage functions using secure validation"
      contains: "parse_and_validate"
  key_links:
    - from: "vulcan-appearance-manager/src/services/theme_storage.rs"
      to: "vulcan-appearance-manager/src/services/theme_parser.rs"
      via: "parse_and_validate() calls"
      pattern: "theme_parser::parse_and_validate"
---

<objective>
Wire existing parse_and_validate() security function into all theme loading paths.

Purpose: Close security gap where theme files bypass validation. The validation logic exists and is tested (23 test cases in theme_parser.rs), but theme_storage.rs calls parse_theme_file() directly, which lacks security checks. This phase connects the existing security infrastructure.

Output: theme_storage.rs with all 5 parse_theme_file() calls replaced by parse_and_validate() calls.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-security-hardening/11-RESEARCH.md

# Key source files
@vulcan-appearance-manager/src/services/theme_storage.rs
@vulcan-appearance-manager/src/services/theme_parser.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace parse_theme_file() with parse_and_validate()</name>
  <files>vulcan-appearance-manager/src/services/theme_storage.rs</files>
  <action>
Replace all 5 occurrences of `theme_parser::parse_theme_file()` with `theme_parser::parse_and_validate()` in theme_storage.rs:

1. Line 68 (load_all_themes, builtin themes loop):
   Change: `match theme_parser::parse_theme_file(&path)`
   To: `match theme_parser::parse_and_validate(&path)`

2. Line 89 (load_all_themes, custom themes loop):
   Change: `match theme_parser::parse_theme_file(&path)`
   To: `match theme_parser::parse_and_validate(&path)`

3. Line 114 (load_theme, builtin path):
   Change: `let mut theme = theme_parser::parse_theme_file(&theme_file)?;`
   To: `let mut theme = theme_parser::parse_and_validate(&theme_file)?;`

4. Line 122 (load_theme, custom path):
   Change: `let mut theme = theme_parser::parse_theme_file(&custom_file)?;`
   To: `let mut theme = theme_parser::parse_and_validate(&custom_file)?;`

5. Line 167 (import_theme):
   Change: `let mut theme = theme_parser::parse_theme_file(source_path)?;`
   To: `let mut theme = theme_parser::parse_and_validate(source_path)?;`

Do NOT modify theme_parser.rs - the validation functions are already complete.
Do NOT add any additional validation logic in theme_storage.rs - trust the central validator.
  </action>
  <verify>
Run: `grep -n "parse_theme_file\|parse_and_validate" vulcan-appearance-manager/src/services/theme_storage.rs`
Expected: Only `parse_and_validate` calls (5 occurrences), no `parse_theme_file` calls
  </verify>
  <done>
All 5 theme loading call sites in theme_storage.rs use parse_and_validate() instead of parse_theme_file()
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify security validation works</name>
  <files>vulcan-appearance-manager/src/services/theme_storage.rs</files>
  <action>
Run the existing test suite to verify:
1. Build compiles without errors
2. All existing tests pass (theme_parser.rs has 23 test cases covering dangerous patterns and path traversal)
3. Theme loading still works for valid themes

Commands:
```bash
cd vulcan-appearance-manager
cargo build 2>&1
cargo test 2>&1
```

If tests fail, check that:
- parse_and_validate is properly exported from theme_parser (it already is: pub fn)
- No signature mismatches (both functions have same signature: fn(path: &Path) -> Result<Theme>)
  </action>
  <verify>
Run: `cd vulcan-appearance-manager && cargo test 2>&1 | tail -20`
Expected: "test result: ok" with 0 failures
  </verify>
  <done>
Build succeeds and all tests pass, confirming validation wiring is correct
  </done>
</task>

</tasks>

<verification>
After completing both tasks, verify:

1. **Code verification:**
   ```bash
   grep -c "parse_and_validate" vulcan-appearance-manager/src/services/theme_storage.rs
   # Expected: 5

   grep -c "parse_theme_file" vulcan-appearance-manager/src/services/theme_storage.rs
   # Expected: 0
   ```

2. **Test verification:**
   ```bash
   cd vulcan-appearance-manager && cargo test
   # All tests pass
   ```

3. **Requirements coverage:**
   - SEC-01: All 5 theme loading paths now use parse_and_validate()
   - SEC-02: Dangerous patterns rejected via check_dangerous_patterns() (called by parse_and_validate)
   - SEC-03: Path traversal rejected via validate_theme() (called by parse_and_validate)
</verification>

<success_criteria>
1. theme_storage.rs has 5 calls to parse_and_validate(), 0 calls to parse_theme_file()
2. cargo build succeeds
3. cargo test passes (23+ tests)
4. SEC-01, SEC-02, SEC-03 requirements satisfied by wiring
</success_criteria>

<output>
After completion, create `.planning/phases/11-security-hardening/11-01-SUMMARY.md`
</output>
