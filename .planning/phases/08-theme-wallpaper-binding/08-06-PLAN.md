---
phase: 08-theme-wallpaper-binding
plan: 06
type: execute
wave: 4
depends_on: ["08-03", "08-04", "08-05"]
files_modified:
  - vulcan-appearance-manager/src/app.rs
  - vulcan-appearance-manager/src/components/theme_view.rs
  - vulcan-appearance-manager/src/components/wallpaper_view.rs
autonomous: false

must_haves:
  truths:
    - "Profiles tab appears as third tab in ViewStack"
    - "Applying theme with wallpaper shows binding dialog"
    - "User choice from binding dialog triggers correct action"
    - "Loading profile applies both theme and wallpapers"
    - "Saving profile captures current theme + wallpapers + binding mode"
    - "Override badge shows on theme card when wallpaper manually changed"
  artifacts:
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "Unified app with three tabs and binding flow"
      contains: "ProfileViewModel"
    - path: "vulcan-appearance-manager/src/components/theme_view.rs"
      provides: "Theme application triggers binding dialog when wallpaper suggested"
      contains: "BindingDialogModel"
  key_links:
    - from: "vulcan-appearance-manager/src/app.rs"
      to: "vulcan-appearance-manager/src/components/profile_view.rs"
      via: "ViewStack tab for profiles"
      pattern: "add_titled_with_icon.*profiles"
    - from: "vulcan-appearance-manager/src/components/theme_view.rs"
      to: "vulcan-appearance-manager/src/components/binding_dialog.rs"
      via: "shows dialog when theme has wallpaper"
      pattern: "BindingDialogModel::show_dialog"
    - from: "vulcan-appearance-manager/src/app.rs"
      to: "profile_storage"
      via: "profile loading applies theme + wallpapers"
      pattern: "load_unified_profile\\|ApplyProfile"
---

<objective>
Wire all Phase 8 components together into the unified application

Purpose: Complete the theme-wallpaper binding feature by integrating the Profiles tab, binding dialog, and tracking binding state across the application. This is the final integration plan for Phase 8.

Output: Fully functional theme-wallpaper binding with Profiles tab, binding dialog on theme apply, and coordinated profile save/load
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-theme-wallpaper-binding/08-CONTEXT.md

@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/src/components/theme_view.rs
@vulcan-appearance-manager/src/components/wallpaper_view.rs
@vulcan-appearance-manager/src/components/binding_dialog.rs
@vulcan-appearance-manager/src/components/profile_view.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Profiles tab to ViewStack</name>
  <files>
    vulcan-appearance-manager/src/app.rs
  </files>
  <action>
Add the third tab for Profiles to the main app:

1. **Add imports** at top of app.rs:
```rust
use crate::components::profile_view::{ProfileViewModel, ProfileViewMsg, ProfileViewOutput};
use crate::models::{UnifiedProfile, BindingMode};
```

2. **Add field to App struct**:
```rust
pub struct App {
    view_stack: adw::ViewStack,
    theme_view: Controller<ThemeViewModel>,
    wallpaper_view: Controller<WallpaperViewModel>,
    profile_view: Controller<ProfileViewModel>,  // NEW
    profile_manager: Controller<ProfileManagerModel>,
    toast_overlay: adw::ToastOverlay,
    current_binding_mode: BindingMode,  // NEW: Track binding state
}
```

3. **Add AppMsg variants**:
```rust
pub enum AppMsg {
    // ... existing ...
    ProfileLoad(UnifiedProfile),
    ProfileDeleted(String),
    BindingModeChanged(BindingMode),
}
```

4. **In init function**, create profile_view and add to ViewStack:
```rust
// Create profile view component
let profile_view = ProfileViewModel::builder()
    .launch(())
    .forward(sender.input_sender(), |msg| {
        match msg {
            ProfileViewOutput::ShowToast(text) => AppMsg::ShowToast(text),
            ProfileViewOutput::LoadProfile(profile) => AppMsg::ProfileLoad(profile),
            ProfileViewOutput::ProfileDeleted(name) => AppMsg::ProfileDeleted(name),
        }
    });

// Add Profiles tab to ViewStack (after Wallpapers)
view_stack.add_titled_with_icon(
    profile_view.widget(),
    Some("profiles"),
    "Profiles",
    "user-bookmarks-symbolic"
);
```

5. **Add keyboard shortcut** Ctrl+3 for Profiles tab:
```rust
let view_stack_clone3 = view_stack.clone();
let profiles_action = gtk::CallbackAction::new(move |_, _| {
    view_stack_clone3.set_visible_child_name("profiles");
    gtk::glib::Propagation::Stop
});
let profiles_shortcut = gtk::Shortcut::new(
    gtk::ShortcutTrigger::parse_string("<Control>3"),
    Some(profiles_action),
);
shortcut_controller.add_shortcut(profiles_shortcut);
```

6. **Handle ProfileLoad message**:
```rust
AppMsg::ProfileLoad(profile) => {
    // Apply theme if present
    if let Some(ref theme_id) = profile.theme_id {
        self.theme_view.emit(ThemeViewMsg::ApplyThemeById(theme_id.clone()));
    }

    // Apply wallpapers
    self.wallpaper_view.emit(WallpaperViewMsg::ApplyProfile(profile.monitor_wallpapers.clone()));

    // Update binding mode
    self.current_binding_mode = profile.binding_mode;

    let toast = adw::Toast::new(&format!("Loaded profile: {}", profile.name));
    self.toast_overlay.add_toast(toast);
}
```
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|profile_view)" || echo "Profiles tab added OK"
  </verify>
  <done>
Profiles tab appears in ViewStack with icon, Ctrl+3 shortcut works, ProfileLoad message applies theme + wallpapers from profile
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate binding dialog into theme application flow</name>
  <files>
    vulcan-appearance-manager/src/components/theme_view.rs
  </files>
  <action>
Modify theme application to show binding dialog when theme has suggested wallpaper:

1. **Add imports**:
```rust
use crate::models::resolve_theme_wallpaper;
use super::binding_dialog::{BindingDialogModel, BindingDialogOutput, BindingDialogInit};
```

2. **Add fields to ThemeViewModel**:
```rust
pub struct ThemeViewModel {
    // ... existing ...
    binding_dialog: Option<Controller<BindingDialogModel>>,
    binding_window: Option<gtk::Window>,
}
```

3. **Add message variants**:
```rust
pub enum ThemeViewMsg {
    // ... existing ...
    ApplyThemeById(String),  // NEW: apply by ID (for profile loading)
    BindingChoice(BindingDialogOutput),  // NEW: result from binding dialog
}

pub enum ThemeViewOutput {
    // ... existing ...
    ApplyWallpaper(std::path::PathBuf),  // NEW: request wallpaper application
    BindingModeChanged(crate::models::BindingMode),  // NEW: notify binding state change
}
```

4. **Modify ApplyTheme handling**:
```rust
ThemeViewMsg::ApplyTheme => {
    if let Some(ref theme) = self.selected_theme {
        // Check if theme has suggested wallpaper
        if let Some(wallpaper_path) = resolve_theme_wallpaper(theme) {
            // Show binding dialog
            self.show_binding_dialog(theme.clone(), wallpaper_path, sender.clone());
        } else {
            // No wallpaper suggestion - apply theme directly
            self.apply_theme_only(theme, sender.clone());
        }
    }
}
```

5. **Add helper methods**:
```rust
impl ThemeViewModel {
    fn show_binding_dialog(
        &mut self,
        theme: Theme,
        wallpaper_path: PathBuf,
        sender: ComponentSender<Self>,
    ) {
        // Create binding dialog
        let dialog = BindingDialogModel::builder()
            .launch(BindingDialogInit {
                theme: theme.clone(),
                wallpaper_path: wallpaper_path.clone(),
            })
            .forward(sender.input_sender(), |msg| {
                ThemeViewMsg::BindingChoice(msg)
            });

        let window = gtk::Window::builder()
            .title(&format!("Apply {} Wallpaper?", theme.theme_name))
            .modal(true)
            .default_width(600)
            .default_height(400)
            .child(dialog.widget())
            .build();

        window.present();

        self.binding_dialog = Some(dialog);
        self.binding_window = Some(window);
    }

    fn apply_theme_only(&self, theme: &Theme, sender: ComponentSender<Self>) {
        if let Err(e) = theme_applier::apply_theme(&theme.theme_id) {
            sender.output(ThemeViewOutput::ShowToast(format!("Apply failed: {}", e))).ok();
        } else {
            sender.output(ThemeViewOutput::ShowToast(format!("Applied: {}", theme.theme_name))).ok();
            sender.output(ThemeViewOutput::ThemeApplied(theme.theme_id.clone())).ok();
            sender.output(ThemeViewOutput::BindingModeChanged(BindingMode::Unbound)).ok();
        }
    }
}
```

6. **Handle BindingChoice**:
```rust
ThemeViewMsg::BindingChoice(choice) => {
    // Close dialog
    if let Some(window) = self.binding_window.take() {
        window.close();
    }
    self.binding_dialog = None;

    match choice {
        BindingDialogOutput::ApplyThemeOnly => {
            if let Some(ref theme) = self.selected_theme {
                self.apply_theme_only(theme, sender.clone());
            }
        }
        BindingDialogOutput::ApplyBoth(wallpaper_path) => {
            if let Some(ref theme) = self.selected_theme {
                // Apply theme
                if let Err(e) = theme_applier::apply_theme(&theme.theme_id) {
                    sender.output(ThemeViewOutput::ShowToast(format!("Apply failed: {}", e))).ok();
                } else {
                    // Request wallpaper application
                    sender.output(ThemeViewOutput::ApplyWallpaper(wallpaper_path)).ok();
                    sender.output(ThemeViewOutput::ShowToast(format!("Applied: {} with wallpaper", theme.theme_name))).ok();
                    sender.output(ThemeViewOutput::ThemeApplied(theme.theme_id.clone())).ok();
                    sender.output(ThemeViewOutput::BindingModeChanged(BindingMode::ThemeBound)).ok();
                }
            }
        }
        BindingDialogOutput::Cancelled => {
            // Do nothing
        }
    }
}
```
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|BindingDialog)" || echo "Binding dialog integrated OK"
  </verify>
  <done>
Applying theme with wallpaper suggestion shows binding dialog, user choice of "Theme Only" applies theme with Unbound mode, "Apply Both" applies theme + wallpaper with ThemeBound mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire app.rs to handle wallpaper application and state sync</name>
  <files>
    vulcan-appearance-manager/src/app.rs
  </files>
  <action>
Complete the wiring between theme_view, wallpaper_view, and profile_view:

1. **Update theme_view forward handler** in app.rs init:
```rust
let theme_view = ThemeViewModel::builder()
    .launch(())
    .forward(sender.input_sender(), |msg| {
        match msg {
            ThemeViewOutput::ShowToast(text) => AppMsg::ShowToast(text),
            ThemeViewOutput::ThemeApplied(id) => AppMsg::ThemeApplied(id),
            ThemeViewOutput::ApplyWallpaper(path) => AppMsg::ApplyThemeWallpaper(path),
            ThemeViewOutput::BindingModeChanged(mode) => AppMsg::BindingModeChanged(mode),
        }
    });
```

2. **Add AppMsg variant**:
```rust
pub enum AppMsg {
    // ... existing ...
    ApplyThemeWallpaper(std::path::PathBuf),
}
```

3. **Handle ApplyThemeWallpaper**:
```rust
AppMsg::ApplyThemeWallpaper(path) => {
    // Apply wallpaper to all monitors (or primary monitor)
    // This uses the wallpaper backend to set the wallpaper
    self.wallpaper_view.emit(WallpaperViewMsg::SetAllWallpapers(path));
}
```

4. **Add WallpaperViewMsg variant** if not exists (in wallpaper_view.rs):
```rust
SetAllWallpapers(PathBuf),  // Set same wallpaper on all monitors
```

5. **Sync current state to profile_view** when theme/wallpapers change:
```rust
AppMsg::ThemeApplied(theme_id) => {
    // ... existing toast ...

    // Update profile view's current state
    self.profile_view.emit(ProfileViewMsg::UpdateCurrentState {
        theme_id: Some(theme_id),
        wallpapers: self.get_current_wallpapers(),
        binding_mode: self.current_binding_mode.clone(),
    });
}

AppMsg::WallpapersChanged(wallpapers) => {
    self.profile_manager.emit(ProfileManagerInput::UpdateWallpapers(wallpapers.clone()));

    // If wallpaper changed manually, update binding mode
    if self.current_binding_mode == BindingMode::ThemeBound {
        self.current_binding_mode = BindingMode::CustomOverride;
        // TODO: Update theme card override badge
    }

    // Update profile view's current state
    self.profile_view.emit(ProfileViewMsg::UpdateCurrentState {
        theme_id: self.get_current_theme_id(),
        wallpapers,
        binding_mode: self.current_binding_mode.clone(),
    });
}
```

6. **Add helper method** to get current wallpapers:
```rust
impl App {
    fn get_current_wallpapers(&self) -> std::collections::HashMap<String, std::path::PathBuf> {
        // This would need to query wallpaper_view or maintain state
        // For now, return empty - will be populated via WallpapersChanged messages
        std::collections::HashMap::new()
    }

    fn get_current_theme_id(&self) -> Option<String> {
        // This would need to track applied theme ID
        // For now, return None - will be populated via ThemeApplied messages
        None
    }
}
```

Note: Full state tracking may require additional fields in App struct to track current_theme_id and current_wallpapers.
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|ApplyThemeWallpaper)" || echo "App wiring OK"
  </verify>
  <done>
ApplyThemeWallpaper message triggers wallpaper application on all monitors, state synced to profile_view for saving, binding mode tracked and updated on manual wallpaper changes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 8 theme-wallpaper binding:
- Profiles tab as third tab in the app
- Binding dialog when applying theme with wallpaper
- Profile save/load with theme + wallpapers + binding mode
- Override badge on theme cards when binding broken
  </what-built>
  <how-to-verify>
1. Build and run the application:
   ```bash
   cd /home/evan/VulcanOS/vulcan-appearance-manager
   cargo build --release
   cp target/release/vulcan-appearance-manager ~/.local/bin/
   vulcan-appearance-manager
   ```

2. Verify Profiles tab:
   - Check third tab "Profiles" appears
   - Ctrl+3 switches to Profiles tab
   - Empty state shows when no profiles

3. Test binding dialog:
   - Go to Themes tab
   - Find/create a theme with THEME_WALLPAPER set
   - Click Apply on that theme
   - Confirm dialog appears showing theme colors + wallpaper preview
   - Test "Theme Only" - applies theme, keeps current wallpaper
   - Test "Apply Both" - applies theme AND changes wallpaper

4. Test profile save/load:
   - Apply a theme with wallpaper
   - Go to Profiles tab
   - Click "Save Current"
   - Enter profile name
   - Confirm profile card appears showing theme colors + wallpaper
   - Change to different theme/wallpaper
   - Click Load on saved profile
   - Confirm both theme and wallpaper restore

5. Test profile delete:
   - Click trash icon on a profile card
   - Confirm profile is removed from list

6. Verify theme card wallpaper thumbnail:
   - In Themes tab, themes with THEME_WALLPAPER show small wallpaper preview in corner
   - Themes without THEME_WALLPAPER show no thumbnail
  </how-to-verify>
  <resume-signal>Type "approved" if all functionality works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Full build succeeds:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo build
```

All three tabs present:
```bash
grep -n "add_titled_with_icon" vulcan-appearance-manager/src/app.rs | wc -l
# Should show 3
```

Binding dialog integration:
```bash
grep -n "BindingDialogModel\|show_binding_dialog" vulcan-appearance-manager/src/components/theme_view.rs
```
</verification>

<success_criteria>
- Profiles tab appears in ViewStack with Ctrl+3 shortcut
- Binding dialog shows when applying theme with THEME_WALLPAPER
- "Theme Only" applies theme without wallpaper change
- "Apply Both" applies theme AND wallpaper
- Profile save captures theme_id + wallpapers + binding_mode
- Profile load restores theme + wallpapers
- Profile delete removes profile
- Human verification confirms all functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-wallpaper-binding/08-06-SUMMARY.md`
</output>
