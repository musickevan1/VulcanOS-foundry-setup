---
phase: 08-theme-wallpaper-binding
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - vulcan-appearance-manager/src/components/binding_dialog.rs
  - vulcan-appearance-manager/src/components/mod.rs
autonomous: true

must_haves:
  truths:
    - "Binding dialog shows theme colors and wallpaper preview side by side"
    - "Dialog has 'Theme Only' and 'Apply Both' buttons"
    - "Dialog is modal with transient parent set"
    - "User choice is returned via output message"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/binding_dialog.rs"
      provides: "BindingDialog component"
      exports: ["BindingDialogModel", "BindingDialogOutput"]
    - path: "vulcan-appearance-manager/src/components/mod.rs"
      provides: "Module export for binding_dialog"
      contains: "pub mod binding_dialog"
  key_links:
    - from: "vulcan-appearance-manager/src/components/binding_dialog.rs"
      to: "gtk::Window"
      via: "modal dialog with transient_for"
      pattern: "set_modal.*true"
    - from: "vulcan-appearance-manager/src/components/binding_dialog.rs"
      to: "gtk::Picture"
      via: "wallpaper preview display"
      pattern: "gtk::Picture"
---

<objective>
Create the binding confirmation dialog for applying theme's suggested wallpaper

Purpose: When user applies a theme that has a THEME_WALLPAPER suggestion, this dialog asks "Apply theme's wallpaper too?" showing both the theme colors and wallpaper preview side by side for informed decision.

Output: New binding_dialog.rs component with modal dialog showing theme preview + wallpaper preview and action buttons
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-theme-wallpaper-binding/08-CONTEXT.md
@.planning/phases/08-theme-wallpaper-binding/08-RESEARCH.md

@vulcan-appearance-manager/src/components/theme_editor.rs (reference for dialog pattern)
@vulcan-appearance-manager/src/components/theme_card.rs (reference for color preview)
@vulcan-appearance-manager/src/models/theme.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BindingDialog component structure</name>
  <files>
    vulcan-appearance-manager/src/components/binding_dialog.rs
    vulcan-appearance-manager/src/components/mod.rs
  </files>
  <action>
Create new binding_dialog.rs with the dialog component:

1. **Create file** at `vulcan-appearance-manager/src/components/binding_dialog.rs`:

```rust
use gtk::prelude::*;
use gtk::gio;
use relm4::prelude::*;
use std::path::PathBuf;

use crate::models::Theme;

/// Output messages from binding dialog
#[derive(Debug)]
pub enum BindingDialogOutput {
    /// User chose to apply theme only (no wallpaper change)
    ApplyThemeOnly,
    /// User chose to apply both theme and its suggested wallpaper
    ApplyBoth(PathBuf),  // wallpaper path to apply
    /// User cancelled the dialog
    Cancelled,
}

/// Input messages for binding dialog
#[derive(Debug)]
pub enum BindingDialogInput {
    ThemeOnly,
    ApplyBoth,
    Cancel,
}

/// Init data for binding dialog
pub struct BindingDialogInit {
    pub theme: Theme,
    pub wallpaper_path: PathBuf,
}

pub struct BindingDialogModel {
    theme: Theme,
    wallpaper_path: PathBuf,
}
```

2. **Implement SimpleComponent** with view:
```rust
#[relm4::component(pub)]
impl SimpleComponent for BindingDialogModel {
    type Init = BindingDialogInit;
    type Input = BindingDialogInput;
    type Output = BindingDialogOutput;

    view! {
        gtk::Box {
            set_orientation: gtk::Orientation::Vertical,
            set_spacing: 16,
            set_margin_all: 24,

            // Title
            gtk::Label {
                set_markup: "<b>Apply Theme Wallpaper?</b>",
                set_halign: gtk::Align::Start,
            },

            // Description
            gtk::Label {
                #[watch]
                set_label: &format!(
                    "Theme '{}' suggests a wallpaper. Apply it too?",
                    model.theme.theme_name
                ),
                set_wrap: true,
                set_halign: gtk::Align::Start,
            },

            // Preview area (horizontal split)
            gtk::Box {
                set_orientation: gtk::Orientation::Horizontal,
                set_spacing: 16,
                set_hexpand: true,
                set_vexpand: true,
                set_height_request: 200,

                // Theme colors preview (left)
                gtk::Frame {
                    set_hexpand: true,
                    set_label: Some("Theme Colors"),

                    gtk::Box {
                        set_orientation: gtk::Orientation::Vertical,
                        set_spacing: 4,
                        set_margin_all: 8,

                        // Color swatches (simplified - 2 rows of 4)
                        #[name = "color_preview"]
                        gtk::Box {
                            set_orientation: gtk::Orientation::Vertical,
                            set_spacing: 2,
                            set_vexpand: true,
                        },
                    },
                },

                // Wallpaper preview (right)
                gtk::Frame {
                    set_hexpand: true,
                    set_label: Some("Suggested Wallpaper"),

                    #[name = "wallpaper_picture"]
                    gtk::Picture {
                        set_content_fit: gtk::ContentFit::Contain,
                        set_can_shrink: true,
                        set_hexpand: true,
                        set_vexpand: true,
                    },
                },
            },

            // Action buttons
            gtk::Box {
                set_orientation: gtk::Orientation::Horizontal,
                set_spacing: 8,
                set_halign: gtk::Align::End,
                set_margin_top: 8,

                gtk::Button {
                    set_label: "Cancel",
                    connect_clicked => BindingDialogInput::Cancel,
                },

                gtk::Button {
                    set_label: "Theme Only",
                    set_tooltip_text: Some("Apply theme colors, keep current wallpaper"),
                    connect_clicked => BindingDialogInput::ThemeOnly,
                },

                gtk::Button {
                    set_label: "Apply Both",
                    add_css_class: "suggested-action",
                    set_tooltip_text: Some("Apply theme colors and wallpaper"),
                    connect_clicked => BindingDialogInput::ApplyBoth,
                },
            },
        }
    }

    fn init(
        init: Self::Init,
        root: Self::Root,
        sender: ComponentSender<Self>,
    ) -> ComponentParts<Self> {
        let model = BindingDialogModel {
            theme: init.theme,
            wallpaper_path: init.wallpaper_path,
        };

        let widgets = view_output!();

        // Set wallpaper picture
        widgets.wallpaper_picture.set_file(Some(&gio::File::for_path(&model.wallpaper_path)));

        // Build color preview (simplified for dialog)
        build_color_preview(&widgets.color_preview, &model.theme);

        ComponentParts { model, widgets }
    }

    fn update(&mut self, msg: Self::Input, sender: ComponentSender<Self>) {
        match msg {
            BindingDialogInput::ThemeOnly => {
                sender.output(BindingDialogOutput::ApplyThemeOnly).ok();
            }
            BindingDialogInput::ApplyBoth => {
                sender.output(BindingDialogOutput::ApplyBoth(self.wallpaper_path.clone())).ok();
            }
            BindingDialogInput::Cancel => {
                sender.output(BindingDialogOutput::Cancelled).ok();
            }
        }
    }
}
```

3. **Add helper function for color preview**:
```rust
fn build_color_preview(container: &gtk::Box, theme: &Theme) {
    let colors = theme.preview_colors();

    // Create two rows of 4 colors each
    for row_start in [0, 4] {
        let row = gtk::Box::new(gtk::Orientation::Horizontal, 2);
        row.set_homogeneous(true);

        for i in row_start..std::cmp::min(row_start + 4, colors.len()) {
            let area = gtk::DrawingArea::new();
            area.set_content_height(40);
            area.set_content_width(50);

            let color = parse_hex_color(colors[i]);
            area.set_draw_func(move |_, cr, width, height| {
                cr.set_source_rgb(color.0, color.1, color.2);
                cr.rectangle(0.0, 0.0, width as f64, height as f64);
                let _ = cr.fill();
            });

            row.append(&area);
        }

        container.append(&row);
    }
}

fn parse_hex_color(hex: &str) -> (f64, f64, f64) {
    let hex = hex.trim_start_matches('#');
    if hex.len() >= 6 {
        let r = u8::from_str_radix(&hex[0..2], 16).unwrap_or(0) as f64 / 255.0;
        let g = u8::from_str_radix(&hex[2..4], 16).unwrap_or(0) as f64 / 255.0;
        let b = u8::from_str_radix(&hex[4..6], 16).unwrap_or(0) as f64 / 255.0;
        (r, g, b)
    } else {
        (0.5, 0.5, 0.5)
    }
}
```

4. **Update components/mod.rs**:
   - Add `pub mod binding_dialog;`
   - Add `pub use binding_dialog::{BindingDialogModel, BindingDialogOutput, BindingDialogInit};`
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|binding_dialog)" || echo "binding_dialog OK"
  </verify>
  <done>
BindingDialogModel component exists with view showing theme colors and wallpaper preview, ThemeOnly and ApplyBoth buttons emit correct output messages, module exported from components/mod.rs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dialog window wrapper function</name>
  <files>
    vulcan-appearance-manager/src/components/binding_dialog.rs
  </files>
  <action>
Add helper function to create and show the dialog as a modal window:

```rust
impl BindingDialogModel {
    /// Create and show the binding dialog as a modal window
    /// Returns the controller - caller should forward output messages
    pub fn show_dialog<W: IsA<gtk::Window>>(
        parent: Option<&W>,
        theme: Theme,
        wallpaper_path: PathBuf,
        sender: impl Fn(BindingDialogOutput) + 'static,
    ) -> (Controller<Self>, gtk::Window) {
        let init = BindingDialogInit {
            theme: theme.clone(),
            wallpaper_path,
        };

        let controller = BindingDialogModel::builder()
            .launch(init)
            .forward(sender);

        let title = format!("Apply {} Wallpaper?", theme.theme_name);

        let window = gtk::Window::builder()
            .title(&title)
            .modal(true)
            .default_width(600)
            .default_height(400)
            .child(controller.widget())
            .build();

        if let Some(parent) = parent {
            window.set_transient_for(Some(parent));
        }

        window.present();

        (controller, window)
    }
}
```

This pattern matches the existing theme_editor.rs dialog approach but is simpler.
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|show_dialog)" || echo "show_dialog OK"
  </verify>
  <done>
show_dialog helper function exists that creates modal window with transient parent, presents the dialog, and returns controller + window for cleanup
  </done>
</task>

</tasks>

<verification>
Component compiles:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check
```

Module exported:
```bash
grep -n "binding_dialog" vulcan-appearance-manager/src/components/mod.rs
```

Output enum has correct variants:
```bash
grep -n "ApplyThemeOnly\|ApplyBoth" vulcan-appearance-manager/src/components/binding_dialog.rs
```
</verification>

<success_criteria>
- BindingDialogModel component exists with side-by-side preview layout
- Dialog shows theme color swatches and wallpaper Picture
- "Theme Only" button emits ApplyThemeOnly output
- "Apply Both" button emits ApplyBoth(PathBuf) output
- Dialog can be shown as modal window with transient parent
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-wallpaper-binding/08-04-SUMMARY.md`
</output>
