---
phase: 08-theme-wallpaper-binding
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - vulcan-appearance-manager/src/services/profile_storage.rs
autonomous: true

must_haves:
  truths:
    - "UnifiedProfile can be saved to TOML file"
    - "UnifiedProfile can be loaded from TOML file"
    - "Old WallpaperProfile format auto-migrates to UnifiedProfile on load"
    - "Profile directory is vulcan-appearance-manager (not vulcan-wallpaper)"
    - "User can delete unified profiles by name"
  artifacts:
    - path: "vulcan-appearance-manager/src/services/profile_storage.rs"
      provides: "UnifiedProfile CRUD operations"
      exports: ["save_unified_profile", "load_unified_profile", "list_unified_profiles", "delete_unified_profile"]
  key_links:
    - from: "vulcan-appearance-manager/src/services/profile_storage.rs"
      to: "vulcan-appearance-manager/src/models/binding.rs"
      via: "imports UnifiedProfile and BindingMode"
      pattern: "use crate::models::.*UnifiedProfile"
---

<objective>
Extend profile storage to handle UnifiedProfile with theme binding data

Purpose: Enable saving and loading profiles that include theme ID, wallpaper configuration, and binding mode as a coordinated unit. Support migration from old WallpaperProfile format.

Output: Updated profile_storage.rs with UnifiedProfile CRUD functions and backward-compatible loading
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-theme-wallpaper-binding/08-CONTEXT.md
@.planning/phases/08-theme-wallpaper-binding/08-RESEARCH.md

@vulcan-appearance-manager/src/services/profile_storage.rs
@vulcan-appearance-manager/src/models/binding.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UnifiedProfile storage functions</name>
  <files>
    vulcan-appearance-manager/src/services/profile_storage.rs
  </files>
  <action>
Add new functions for UnifiedProfile CRUD alongside existing WallpaperProfile functions:

1. **Update imports** at top of file:
   - Add `use crate::models::{UnifiedProfile, BindingMode};`

2. **Update profile_dir() function**:
   - Change path from "vulcan-wallpaper/profiles" to "vulcan-appearance-manager/profiles"
   - This is the new unified app name

3. **Add save_unified_profile function**:
```rust
pub fn save_unified_profile(profile: &UnifiedProfile) -> Result<PathBuf> {
    let dir = ensure_profile_dir()?;
    let path = dir.join(format!("{}.toml", profile.name));

    let toml = toml::to_string_pretty(profile)
        .context("Failed to serialize unified profile")?;

    fs::write(&path, toml)
        .context("Failed to write unified profile file")?;

    Ok(path)
}
```

4. **Add load_unified_profile function** with migration support:
```rust
pub fn load_unified_profile(name: &str) -> Result<UnifiedProfile> {
    let dir = profile_dir();
    let path = dir.join(format!("{}.toml", name));

    let contents = fs::read_to_string(&path)
        .context("Failed to read profile file")?;

    // Try new UnifiedProfile format first
    if let Ok(profile) = toml::from_str::<UnifiedProfile>(&contents) {
        return Ok(profile);
    }

    // Fallback: migrate old WallpaperProfile format
    let old_profile: WallpaperProfile = toml::from_str(&contents)
        .context("Failed to parse profile as either format")?;

    Ok(UnifiedProfile {
        name: old_profile.name,
        description: old_profile.description,
        theme_id: None,
        monitor_wallpapers: old_profile.monitor_wallpapers,
        binding_mode: BindingMode::Unbound,
    })
}
```

5. **Add list_unified_profiles function** (can reuse list_profiles logic):
```rust
pub fn list_unified_profiles() -> Result<Vec<String>> {
    list_profiles()  // Same logic, just lists .toml files
}
```

6. **Add delete_unified_profile function** (can alias delete_profile):
```rust
pub fn delete_unified_profile(name: &str) -> Result<()> {
    delete_profile(name)
}
```
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|unified)" || echo "Unified profile functions OK"
  </verify>
  <done>
save_unified_profile, load_unified_profile, list_unified_profiles, delete_unified_profile functions exist and compile
  </done>
</task>

<task type="auto">
  <name>Task 2: Add profile migration and legacy path support</name>
  <files>
    vulcan-appearance-manager/src/services/profile_storage.rs
  </files>
  <action>
Handle migration from old profile directory and file format:

1. **Add legacy profile directory constant**:
```rust
fn legacy_profile_dir() -> PathBuf {
    dirs::config_dir()
        .unwrap_or_else(|| PathBuf::from("~/.config"))
        .join("vulcan-wallpaper")
        .join("profiles")
}
```

2. **Update load_unified_profile** to check legacy location:
   - If profile not found in new location, check legacy_profile_dir
   - If found in legacy, load and optionally migrate (save to new location)
   - Return migrated profile

3. **Add migrate_legacy_profiles function** (optional, for bulk migration):
```rust
pub fn migrate_legacy_profiles() -> Result<usize> {
    let legacy_dir = legacy_profile_dir();
    if !legacy_dir.exists() {
        return Ok(0);
    }

    let mut count = 0;
    for entry in fs::read_dir(&legacy_dir)? {
        let entry = entry?;
        let path = entry.path();
        if path.extension().and_then(|s| s.to_str()) == Some("toml") {
            if let Some(name) = path.file_stem().and_then(|s| s.to_str()) {
                // Load from legacy, save to new location
                if let Ok(profile) = load_unified_profile(name) {
                    let _ = save_unified_profile(&profile);
                    count += 1;
                }
            }
        }
    }

    Ok(count)
}
```

4. **Update ensure_known_profiles** to create UnifiedProfile format:
   - Change WallpaperProfile creation to UnifiedProfile
   - Use save_unified_profile instead of save_profile
  </action>
  <verify>
cargo test --package vulcan-appearance-manager profile 2>&1 | tail -20
  </verify>
  <done>
Legacy profile directory is checked on load, migrate_legacy_profiles function exists, ensure_known_profiles creates UnifiedProfile format
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for unified profile roundtrip</name>
  <files>
    vulcan-appearance-manager/src/services/profile_storage.rs
  </files>
  <action>
Add test functions to verify unified profile functionality:

1. **Add test_unified_profile_roundtrip**:
```rust
#[test]
fn test_unified_profile_roundtrip() {
    use crate::models::BindingMode;

    let mut wallpapers = HashMap::new();
    wallpapers.insert("eDP-1".to_string(), PathBuf::from("/home/test/wall.png"));

    let profile = UnifiedProfile {
        name: "test-unified".to_string(),
        description: "Test unified profile".to_string(),
        theme_id: Some("catppuccin".to_string()),
        monitor_wallpapers: wallpapers.clone(),
        binding_mode: BindingMode::ThemeBound,
    };

    // Save
    let result = save_unified_profile(&profile);
    assert!(result.is_ok());

    // Load
    let loaded = load_unified_profile("test-unified");
    assert!(loaded.is_ok());

    let loaded = loaded.unwrap();
    assert_eq!(loaded.name, "test-unified");
    assert_eq!(loaded.theme_id, Some("catppuccin".to_string()));
    assert_eq!(loaded.monitor_wallpapers, wallpapers);
    assert!(matches!(loaded.binding_mode, BindingMode::ThemeBound));

    // Cleanup
    let _ = delete_unified_profile("test-unified");
}
```

2. **Add test_legacy_profile_migration**:
```rust
#[test]
fn test_legacy_profile_migration() {
    // Create a WallpaperProfile format file manually
    // Load it as UnifiedProfile
    // Verify migration adds default theme_id=None and binding_mode=Unbound
}
```
  </action>
  <verify>
cargo test --package vulcan-appearance-manager unified 2>&1 | tail -10
  </verify>
  <done>
test_unified_profile_roundtrip passes, legacy migration test passes (or is marked TODO if complex to set up)
  </done>
</task>

</tasks>

<verification>
All storage functions compile:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check
```

Tests pass:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo test profile
```

Profile directory updated:
```bash
grep -n "vulcan-appearance-manager" vulcan-appearance-manager/src/services/profile_storage.rs
```
</verification>

<success_criteria>
- save_unified_profile and load_unified_profile functions exist
- Profile directory path is "vulcan-appearance-manager/profiles"
- Loading old WallpaperProfile format auto-migrates to UnifiedProfile
- Test for unified profile roundtrip passes
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-wallpaper-binding/08-02-SUMMARY.md`
</output>
