---
phase: 08-theme-wallpaper-binding
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - vulcan-appearance-manager/src/components/theme_card.rs
  - vulcan-appearance-manager/src/brand_css.rs
autonomous: true

must_haves:
  truths:
    - "Theme card shows wallpaper thumbnail in corner when theme has THEME_WALLPAPER"
    - "Wallpaper thumbnail uses gtk::Picture with content-fit cover"
    - "Theme card can show override badge when binding is broken"
    - "Thumbnail is visible but unobtrusive (60x40 pixels in corner)"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/theme_card.rs"
      provides: "Theme card with wallpaper overlay"
      contains: "gtk::Picture"
    - path: "vulcan-appearance-manager/src/brand_css.rs"
      provides: "CSS classes for wallpaper-corner-preview and override-badge"
      contains: "wallpaper-corner-preview"
  key_links:
    - from: "vulcan-appearance-manager/src/components/theme_card.rs"
      to: "vulcan-appearance-manager/src/models/binding.rs"
      via: "imports resolve_theme_wallpaper"
      pattern: "resolve_theme_wallpaper"
    - from: "vulcan-appearance-manager/src/components/theme_card.rs"
      to: "gtk::Overlay"
      via: "wraps color preview with overlay for thumbnails"
      pattern: "gtk::Overlay"
---

<objective>
Add wallpaper thumbnail overlay to theme cards in the browser

Purpose: Show users which themes have suggested wallpapers directly in the theme browser. The small corner thumbnail (60x40 pixels) indicates a theme has a bundled wallpaper without cluttering the card.

Output: Updated theme_card.rs with gtk::Overlay wrapping the color preview, showing wallpaper thumbnail in bottom-right corner when theme has THEME_WALLPAPER
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-theme-wallpaper-binding/08-CONTEXT.md
@.planning/phases/08-theme-wallpaper-binding/08-RESEARCH.md

@vulcan-appearance-manager/src/components/theme_card.rs
@vulcan-appearance-manager/src/models/binding.rs
@vulcan-appearance-manager/src/brand_css.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wallpaper thumbnail overlay to ThemeItem</name>
  <files>
    vulcan-appearance-manager/src/components/theme_card.rs
  </files>
  <action>
Modify ThemeItem to wrap the color preview Frame with gtk::Overlay for wallpaper thumbnail:

1. **Add imports** at top:
```rust
use gtk::gio;
use crate::models::resolve_theme_wallpaper;
```

2. **Add field to ThemeItem struct**:
```rust
pub struct ThemeItem {
    pub theme: Theme,
    pub is_current: bool,
    pub is_override: bool,  // NEW: true if user overrode theme's wallpaper
}
```

3. **Update view! macro** to wrap Frame with Overlay:
   - Replace the outer `gtk::Frame` with `gtk::Overlay`
   - Move existing Frame as `set_child` of Overlay
   - Add wallpaper Picture as overlay (bottom-right corner)
   - Add override badge Image as overlay (top-right corner)

Example structure:
```rust
view! {
    gtk::Box {
        set_orientation: gtk::Orientation::Vertical,
        // ... existing spacing/margin ...

        // Wrap color preview in Overlay
        gtk::Overlay {
            // Main content: existing color preview Frame
            #[wrap(Some)]
            set_child = &gtk::Frame {
                add_css_class: "color-preview-frame",
                // ... existing color preview boxes ...
            },

            // Wallpaper thumbnail (bottom-right corner)
            #[name = "wallpaper_thumb"]
            add_overlay = &gtk::Picture {
                set_halign: gtk::Align::End,
                set_valign: gtk::Align::End,
                set_margin_end: 4,
                set_margin_bottom: 4,
                set_width_request: 60,
                set_height_request: 40,
                set_content_fit: gtk::ContentFit::Cover,
                set_can_shrink: true,
                add_css_class: "wallpaper-corner-preview",
            },

            // Override badge (top-right corner)
            #[name = "override_badge"]
            add_overlay = &gtk::Image {
                set_icon_name: Some("emblem-default-symbolic"),
                set_pixel_size: 16,
                set_halign: gtk::Align::End,
                set_valign: gtk::Align::Start,
                set_margin_top: 4,
                set_margin_end: 4,
                add_css_class: "override-badge",
            },
        },

        // ... existing theme name label and badges ...
    }
}
```

4. **Update init_widgets** to set wallpaper Picture file:
```rust
fn init_widgets(...) -> Self::Widgets {
    let widgets = view_output!();

    // Set wallpaper thumbnail if theme has one
    if let Some(wallpaper_path) = resolve_theme_wallpaper(&self.theme) {
        widgets.wallpaper_thumb.set_file(Some(&gio::File::for_path(&wallpaper_path)));
        widgets.wallpaper_thumb.set_visible(true);
    } else {
        widgets.wallpaper_thumb.set_visible(false);
    }

    // Show override badge only if is_override is true
    widgets.override_badge.set_visible(self.is_override);

    // ... existing color drawing setup ...
}
```

5. **Update init_model** to handle new is_override field:
```rust
fn init_model(init: Self::Init, ...) -> Self {
    ThemeItem {
        theme: init.0,
        is_current: init.1,
        is_override: false,  // Default to false, updated later by parent
    }
}
```
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|theme_card)" || echo "theme_card OK"
  </verify>
  <done>
Theme card wraps color preview with gtk::Overlay, wallpaper Picture added as overlay with 60x40 size and ContentFit::Cover, override badge Image added with top-right positioning
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS classes for thumbnail and badge styling</name>
  <files>
    vulcan-appearance-manager/src/brand_css.rs
  </files>
  <action>
Add CSS styling for the wallpaper corner preview and override badge:

1. **Add to WIDGET_CSS constant** (or equivalent CSS string):
```css
.wallpaper-corner-preview {
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.override-badge {
    background-color: @accent_color;
    border-radius: 50%;
    padding: 2px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}
```

2. **Ensure CSS is loaded** - verify the css_provider loads WIDGET_CSS (should already be done from Phase 6/7)

Note: The Picture widget handles aspect ratio via content-fit property, CSS just adds visual polish (border, shadow, rounded corners).
  </action>
  <verify>
grep -n "wallpaper-corner-preview\|override-badge" vulcan-appearance-manager/src/brand_css.rs
  </verify>
  <done>
CSS classes .wallpaper-corner-preview and .override-badge exist in brand_css.rs with styling for border-radius, shadow, and accent color background
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ThemeCardOutput and browser to track override state</name>
  <files>
    vulcan-appearance-manager/src/components/theme_card.rs
  </files>
  <action>
Prepare for binding state tracking by enhancing ThemeCardOutput:

1. **Keep ThemeCardOutput simple** for now:
   - Selected(Theme) is sufficient for Phase 8
   - Override state will be set by parent (ThemeBrowser/ThemeView) when binding is broken

2. **Add input message to ThemeItem** for updating override state:
```rust
#[derive(Debug)]
pub enum ThemeItemInput {
    SetOverride(bool),
}
```

3. **Implement input handling**:
```rust
fn update(&mut self, msg: Self::Input, _sender: FactorySender<Self>) {
    match msg {
        ThemeItemInput::SetOverride(is_override) => {
            self.is_override = is_override;
        }
    }
}
```

4. **Update Init type** to include is_override:
```rust
type Init = (Theme, bool, bool);  // (theme, is_current, is_override)
```

Or keep as tuple and add helper:
```rust
fn init_model(init: Self::Init, ...) -> Self {
    // init.0 = theme, init.1 = is_current
    ThemeItem {
        theme: init.0,
        is_current: init.1,
        is_override: false,  // Start false, parent updates if needed
    }
}
```

The override state tracking will be fully wired in Plan 06 (Integration), this just prepares the component.
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|ThemeItem)" || echo "ThemeItem OK"
  </verify>
  <done>
ThemeItem has is_override field, SetOverride input message exists (or is_override can be updated), theme_card compiles without errors
  </done>
</task>

</tasks>

<verification>
Theme card compiles with overlay:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check
```

Overlay structure in theme_card:
```bash
grep -n "gtk::Overlay\|wallpaper_thumb\|override_badge" vulcan-appearance-manager/src/components/theme_card.rs
```

CSS classes added:
```bash
grep -n "wallpaper-corner-preview" vulcan-appearance-manager/src/brand_css.rs
```
</verification>

<success_criteria>
- Theme card uses gtk::Overlay to layer wallpaper thumbnail over color preview
- Wallpaper Picture is 60x40 pixels in bottom-right corner with ContentFit::Cover
- Override badge Image is 16px icon in top-right corner
- CSS classes provide visual styling (rounded corners, shadow)
- is_override field exists for future binding state tracking
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-wallpaper-binding/08-03-SUMMARY.md`
</output>
