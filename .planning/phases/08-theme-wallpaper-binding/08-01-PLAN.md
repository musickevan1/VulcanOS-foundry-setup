---
phase: 08-theme-wallpaper-binding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vulcan-appearance-manager/src/models/binding.rs
  - vulcan-appearance-manager/src/models/mod.rs
  - vulcan-appearance-manager/src/models/profile.rs
  - vulcan-appearance-manager/src/services/theme_parser.rs
autonomous: true

must_haves:
  truths:
    - "BindingMode enum exists with ThemeBound, CustomOverride, Unbound variants"
    - "UnifiedProfile struct extends WallpaperProfile with theme_id and binding_mode"
    - "Theme parser extracts THEME_WALLPAPER field from .sh files"
    - "Theme struct has theme_wallpaper field populated from parsing"
  artifacts:
    - path: "vulcan-appearance-manager/src/models/binding.rs"
      provides: "BindingMode enum and UnifiedProfile struct"
      exports: ["BindingMode", "UnifiedProfile"]
    - path: "vulcan-appearance-manager/src/models/profile.rs"
      provides: "WallpaperProfile with description field"
      exports: ["WallpaperProfile"]
    - path: "vulcan-appearance-manager/src/services/theme_parser.rs"
      provides: "THEME_WALLPAPER extraction"
      contains: "theme_wallpaper"
  key_links:
    - from: "vulcan-appearance-manager/src/models/binding.rs"
      to: "vulcan-appearance-manager/src/models/profile.rs"
      via: "imports WallpaperProfile fields pattern"
      pattern: "monitor_wallpapers.*HashMap"
    - from: "vulcan-appearance-manager/src/services/theme_parser.rs"
      to: "vulcan-appearance-manager/src/models/theme.rs"
      via: "populates theme_wallpaper field"
      pattern: "theme_wallpaper.*="
---

<objective>
Create the foundational data models for theme-wallpaper binding

Purpose: Establish the core types (BindingMode, UnifiedProfile) and extend the theme parser to extract THEME_WALLPAPER field from theme files. This foundation enables all subsequent plans.

Output: binding.rs with BindingMode enum and UnifiedProfile struct, updated theme_parser.rs that extracts THEME_WALLPAPER
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-theme-wallpaper-binding/08-CONTEXT.md
@.planning/phases/08-theme-wallpaper-binding/08-RESEARCH.md

@vulcan-appearance-manager/src/models/profile.rs
@vulcan-appearance-manager/src/models/theme.rs
@vulcan-appearance-manager/src/models/mod.rs
@vulcan-appearance-manager/src/services/theme_parser.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BindingMode enum and UnifiedProfile struct</name>
  <files>
    vulcan-appearance-manager/src/models/binding.rs
    vulcan-appearance-manager/src/models/mod.rs
  </files>
  <action>
Create new file `binding.rs` with:

1. **BindingMode enum** with serde derives:
   - `ThemeBound` - Theme's suggested wallpaper is active
   - `CustomOverride` - User has overridden theme's suggestion
   - `Unbound` - Theme has no wallpaper suggestion (default)
   - Implement `Default` trait returning `Unbound`
   - Add `display_name(&self) -> &str` method for UI display

2. **UnifiedProfile struct** with serde derives:
   - `name: String` - Profile name
   - `description: String` with `#[serde(default)]` - Optional description
   - `theme_id: Option<String>` - Bound theme ID (None if no theme)
   - `monitor_wallpapers: HashMap<String, PathBuf>` - Per-monitor wallpapers
   - `binding_mode: BindingMode` with `#[serde(default)]`
   - Add `new(name: String) -> Self` constructor

3. **Add helper function** `resolve_theme_wallpaper(theme: &Theme) -> Option<PathBuf>`:
   - Extract theme_wallpaper field from theme
   - Get theme.source_path parent directory
   - Join relative wallpaper path to theme directory
   - Return Some(path) only if path.exists(), else None with warning

4. **Update mod.rs** to export new module:
   - Add `pub mod binding;`
   - Add `pub use binding::{BindingMode, UnifiedProfile, resolve_theme_wallpaper};`

Use existing imports from profile.rs as reference (HashMap, PathBuf, serde).
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|warning.*binding)" || echo "No binding errors"
  </verify>
  <done>
BindingMode enum exists with three variants and Default impl, UnifiedProfile struct has all required fields with serde derives, resolve_theme_wallpaper helper compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend theme parser to extract THEME_WALLPAPER</name>
  <files>
    vulcan-appearance-manager/src/services/theme_parser.rs
  </files>
  <action>
Update theme_parser.rs to extract the optional THEME_WALLPAPER field:

1. **In parse_theme_file function**, add extraction for THEME_WALLPAPER:
   - Look for line matching `THEME_WALLPAPER="..."` or `THEME_WALLPAPER='...'`
   - Store value in theme.theme_wallpaper as Some(String)
   - If not found, leave as None (already default)

2. **Add validation** (in validate_theme_security or separate function):
   - If THEME_WALLPAPER is present, ensure it's a relative path (not starting with / or containing ..)
   - Reject absolute paths for security (theme shouldn't point to arbitrary system files)
   - Allow paths like "wallpapers/dark.png" or "bg.jpg"

3. **Pattern matching logic:**
   - Use regex or string matching consistent with existing field extraction
   - Handle both single and double quotes
   - Trim whitespace from extracted value

The theme.theme_wallpaper field already exists in Theme struct (added in Phase 6), just needs parser population.
  </action>
  <verify>
cargo test --package vulcan-appearance-manager theme 2>&1 | tail -20
  </verify>
  <done>
Theme parser extracts THEME_WALLPAPER field, validates it's a relative path, Theme struct populated with theme_wallpaper value when present in .sh file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update models/profile.rs with description field consistency</name>
  <files>
    vulcan-appearance-manager/src/models/profile.rs
  </files>
  <action>
Ensure WallpaperProfile in models/profile.rs has the description field with proper serde handling:

1. **Check current WallpaperProfile** in models/profile.rs:
   - Should have `description: String` field with `#[serde(default)]`
   - If missing, add it

2. **Note:** The main WallpaperProfile is in services/profile_storage.rs, models/profile.rs may be a duplicate or simpler version. Reconcile:
   - If models/profile.rs exists with WallpaperProfile, ensure it matches services/profile_storage.rs
   - Consider if models/profile.rs should just re-export from services, or if they serve different purposes

3. **Ensure consistency** between the two WallpaperProfile definitions if both exist, or consolidate to single source of truth.

This ensures the base WallpaperProfile struct is ready for UnifiedProfile to extend its pattern.
  </action>
  <verify>
cargo check --package vulcan-appearance-manager 2>&1 | grep -E "(error|WallpaperProfile)" || echo "WallpaperProfile OK"
  </verify>
  <done>
WallpaperProfile struct has description field with #[serde(default)], no duplicate struct conflicts
  </done>
</task>

</tasks>

<verification>
All models compile without errors:
```bash
cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check
```

BindingMode and UnifiedProfile are accessible:
```bash
grep -r "BindingMode\|UnifiedProfile" vulcan-appearance-manager/src/models/
```

Theme parser handles THEME_WALLPAPER:
```bash
grep -n "theme_wallpaper" vulcan-appearance-manager/src/services/theme_parser.rs
```
</verification>

<success_criteria>
- BindingMode enum has ThemeBound, CustomOverride, Unbound variants with Default
- UnifiedProfile struct has name, description, theme_id, monitor_wallpapers, binding_mode fields
- resolve_theme_wallpaper function exists and compiles
- Theme parser extracts THEME_WALLPAPER field from .sh files
- No compilation errors in vulcan-appearance-manager crate
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-wallpaper-binding/08-01-SUMMARY.md`
</output>
