---
phase: 09-theming-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - vulcan-appearance-manager/src/app.rs
  - vulcan-appearance-manager/src/services/theme_applier.rs
autonomous: true

must_haves:
  truths:
    - "App loads theme CSS at startup if it exists"
    - "App reloads theme CSS after applying a new theme"
    - "GUI colors update to match the active theme without app restart"
  artifacts:
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "CSS loading on startup and theme change"
      contains: "CssProvider"
    - path: "vulcan-appearance-manager/src/services/theme_applier.rs"
      provides: "Theme application with CSS notification"
      contains: "apply_theme"
  key_links:
    - from: "app.rs"
      to: "theme_css.rs"
      via: "function call"
      pattern: "get_theme_css"
    - from: "app.rs"
      to: "GTK4 Display"
      via: "CssProvider"
      pattern: "style_context_add_provider_for_display"
---

<objective>
Integrate self-theming into the Appearance Manager app.

Purpose: Make the app GUI reflect the active theme colors by loading theme CSS at startup and after theme changes.
Output: App self-themes based on active system theme.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-theming-infrastructure/09-RESEARCH.md

# From Plan 02
@.planning/phases/09-theming-infrastructure/09-02-SUMMARY.md

# Existing implementation
@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/src/services/theme_applier.rs
@vulcan-appearance-manager/src/services/theme_css.rs
@vulcan-appearance-manager/src/brand_css.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add runtime CSS loading function</name>
  <files>vulcan-appearance-manager/src/app.rs</files>
  <action>
Add a function to load theme CSS at runtime using GTK4 CssProvider:

1. Add imports at top of app.rs:
```rust
use gtk::{CssProvider, gdk::Display};
use crate::services::theme_css;
```

2. Add a helper function (outside impl App block):
```rust
/// Load theme CSS at runtime via CssProvider
///
/// This supplements brand_css.rs which provides defaults.
/// Theme CSS overrides brand colors with active theme colors.
fn load_theme_css() {
    if let Some(css_content) = theme_css::get_theme_css() {
        let provider = CssProvider::new();
        provider.load_from_string(&css_content);

        if let Some(display) = Display::default() {
            gtk::style_context_add_provider_for_display(
                &display,
                &provider,
                gtk::STYLE_PROVIDER_PRIORITY_USER, // Higher priority than APPLICATION
            );
        }
    }
}
```

Key point: Use STYLE_PROVIDER_PRIORITY_USER (600) which is higher than APPLICATION (400), ensuring theme colors override brand defaults.

3. Call `load_theme_css()` in the App's init() function, after the model is created but before returning the ComponentParts:
   - Find the init() function in impl Component for App
   - Add `load_theme_css();` call at an appropriate point
  </action>
  <verify>
Run: `cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check 2>&1 | tail -5`

Expected: No errors
  </verify>
  <done>App loads theme CSS on startup if file exists</done>
</task>

<task type="auto">
  <name>Task 2: Reload CSS after theme application</name>
  <files>vulcan-appearance-manager/src/app.rs</files>
  <action>
Trigger CSS reload when a theme is applied:

1. Find where theme application happens in app.rs:
   - Look for handlers that call theme_applier::apply_theme()
   - This is likely in the update() function handling AppMsg variants

2. After successful theme application, call `load_theme_css()`:
```rust
// Example pattern (adjust to actual code structure):
AppMsg::ApplyTheme(theme_id) => {
    if let Err(e) = theme_applier::apply_theme(&theme_id) {
        // Handle error
    } else {
        // Reload theme CSS for self-theming
        load_theme_css();
        // Show success toast
    }
}
```

3. The key insight: `vulcan-theme set` now generates ~/.config/vulcan/current-theme.css (from Plan 02), so calling load_theme_css() after apply_theme() picks up the new colors.

4. Ensure load_theme_css() is called in ALL code paths where theme is applied:
   - Direct apply from theme browser
   - Apply from binding dialog (theme + wallpaper)
   - Profile load (if it applies theme)
  </action>
  <verify>
Build and run the app:
```
cd /home/evan/VulcanOS/vulcan-appearance-manager
cargo build --release
./target/release/vulcan-appearance-manager
```

Expected: App launches without errors
  </verify>
  <done>Theme CSS reloads after every theme application</done>
</task>

<task type="auto">
  <name>Task 3: Update brand_css for theme overrideability</name>
  <files>vulcan-appearance-manager/src/brand_css.rs</files>
  <action>
Ensure brand_css colors can be overridden by theme CSS:

1. Review brand_css.rs WIDGET_CSS section
2. Change color references from vulcan_* to theme_* where appropriate for themeable elements:

The accent color references should use theme_accent (overrideable) not vulcan_ember (fixed):
```css
/* Suggested action button - use theme accent */
button.suggested-action {
    background: linear-gradient(to bottom, @theme_accent, shade(@theme_accent, 0.9));
}

/* Selection uses theme accent */
flowboxchild:selected {
    background-color: alpha(@theme_accent, 0.3);
    border: 2px solid @theme_accent;
}
```

3. Add fallback definitions in BRAND_COLORS_CSS so app works before any theme is applied:
```css
/* Theme color fallbacks (overridden by current-theme.css when loaded) */
@define-color theme_accent @vulcan_ember;
@define-color theme_bg_primary @vulcan_obsidian;
@define-color theme_bg_secondary @vulcan_charcoal;
/* etc. */
```

4. Keep vulcan_* colors for truly brand-specific elements that shouldn't change with theme.

The goal: Widget styles reference theme_* colors, which default to vulcan_* but get overridden when theme CSS is loaded.
  </action>
  <verify>
Run: `cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check 2>&1 | tail -5`

Expected: No errors
  </verify>
  <done>brand_css defines theme_* fallbacks that can be overridden by runtime CSS</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the app: `cargo build --release`
2. Apply a theme: `vulcan-theme set vulcan-forge`
3. Launch app: `./target/release/vulcan-appearance-manager`
4. Verify: App accent color matches theme
5. Apply different theme from within app
6. Verify: App accent color updates immediately (no restart needed)
</verification>

<success_criteria>
- App loads and applies theme CSS on startup
- Changing theme from within app updates app's own colors
- No app restart required to see color changes
- App compiles and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-theming-infrastructure/09-03-SUMMARY.md`
</output>
