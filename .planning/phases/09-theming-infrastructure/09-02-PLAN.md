---
phase: 09-theming-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dotfiles/scripts/.local/bin/vulcan-theme
  - vulcan-appearance-manager/src/services/theme_css.rs
  - vulcan-appearance-manager/src/services/mod.rs
autonomous: true

must_haves:
  truths:
    - "vulcan-theme generates GTK-compatible CSS for the active theme"
    - "Generated CSS file uses @define-color syntax (not CSS custom properties)"
    - "Rust service can read the generated CSS file"
  artifacts:
    - path: "dotfiles/scripts/.local/bin/vulcan-theme"
      provides: "GTK CSS generation for active theme"
      contains: "generate_gtk_css"
    - path: "vulcan-appearance-manager/src/services/theme_css.rs"
      provides: "Service to read current theme CSS"
      exports: ["get_theme_css", "get_theme_css_path"]
  key_links:
    - from: "vulcan-theme script"
      to: "~/.config/vulcan/current-theme.css"
      via: "file write"
      pattern: "current-theme.css"
    - from: "theme_css.rs"
      to: "~/.config/vulcan/current-theme.css"
      via: "file read"
      pattern: "current-theme.css"
---

<objective>
Create GTK CSS generation for active theme colors.

Purpose: Generate a CSS file with @define-color overrides that can be loaded at runtime to theme the Appearance Manager GUI.
Output: vulcan-theme generates ~/.config/vulcan/current-theme.css with GTK-compatible color definitions.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-theming-infrastructure/09-RESEARCH.md

# Existing implementation
@dotfiles/scripts/.local/bin/vulcan-theme
@vulcan-appearance-manager/src/brand_css.rs
@vulcan-appearance-manager/src/services/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GTK CSS generation to vulcan-theme</name>
  <files>dotfiles/scripts/.local/bin/vulcan-theme</files>
  <action>
Add a function to vulcan-theme that generates GTK-compatible CSS for the active theme:

1. Add a new function `generate_gtk_css()` that:
   - Creates `~/.config/vulcan/current-theme.css`
   - Outputs @define-color statements for theme colors
   - Uses the same color variables already sourced (ACCENT, BG_PRIMARY, etc.)

2. The generated CSS should define:
   ```css
   /* Theme: ${THEME_NAME} (${THEME_ID}) */
   @define-color theme_accent ${ACCENT};
   @define-color theme_bg_primary ${BG_PRIMARY};
   @define-color theme_bg_secondary ${BG_SECONDARY};
   @define-color theme_bg_tertiary ${BG_TERTIARY};
   @define-color theme_fg_primary ${FG_PRIMARY};
   @define-color theme_fg_secondary ${FG_SECONDARY};
   @define-color theme_fg_muted ${FG_MUTED};
   @define-color theme_red ${RED};
   @define-color theme_green ${GREEN};
   @define-color theme_yellow ${YELLOW};
   @define-color theme_blue ${BLUE};
   @define-color theme_purple ${PURPLE};
   @define-color theme_cyan ${CYAN};
   @define-color theme_border_active ${BORDER_ACTIVE};
   @define-color theme_border_inactive ${BORDER_INACTIVE};

   /* Override Adwaita/Vulcan accent with theme accent */
   @define-color accent_bg_color ${ACCENT};
   @define-color accent_color ${ACCENT};
   ```

3. Call `generate_gtk_css` at the end of `apply_theme()` function (after component processing, before reload)

Key requirement: Use `cat <<EOF` heredoc syntax to write the CSS file (simpler than template processing for this use case).
  </action>
  <verify>
Run: `vulcan-theme set vulcan-forge && cat ~/.config/vulcan/current-theme.css | head -20`

Expected: CSS file with @define-color statements containing actual hex colors
  </verify>
  <done>vulcan-theme generates ~/.config/vulcan/current-theme.css with theme colors</done>
</task>

<task type="auto">
  <name>Task 2: Create theme_css Rust service</name>
  <files>vulcan-appearance-manager/src/services/theme_css.rs, vulcan-appearance-manager/src/services/mod.rs</files>
  <action>
Create a new service module to read the generated theme CSS:

1. Create `src/services/theme_css.rs`:

```rust
//! Theme CSS loading service
//!
//! Reads the current theme CSS file generated by vulcan-theme.

use anyhow::{Context, Result};
use std::path::PathBuf;

/// Get the path to the current theme CSS file
pub fn get_theme_css_path() -> PathBuf {
    let home = std::env::var("HOME")
        .map(PathBuf::from)
        .unwrap_or_else(|_| dirs::home_dir().unwrap_or_default());

    home.join(".config/vulcan/current-theme.css")
}

/// Read the current theme CSS content
///
/// Returns the CSS content if the file exists, or None if not found.
/// This is designed to gracefully handle the case where no theme has been applied yet.
pub fn get_theme_css() -> Option<String> {
    let path = get_theme_css_path();
    std::fs::read_to_string(&path).ok()
}

/// Check if a theme CSS file exists (theme has been applied at least once)
pub fn has_theme_css() -> bool {
    get_theme_css_path().exists()
}
```

2. Add to `src/services/mod.rs`:
   - Add `pub mod theme_css;`

3. Ensure the module compiles: `cargo check` in vulcan-appearance-manager directory
  </action>
  <verify>
Run: `cd /home/evan/VulcanOS/vulcan-appearance-manager && cargo check 2>&1 | tail -5`

Expected: No errors, compilation succeeds
  </verify>
  <done>theme_css module exists and compiles, exports get_theme_css and get_theme_css_path</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Switch theme and verify CSS generation:
   - `vulcan-theme set vulcan-forge`
   - `cat ~/.config/vulcan/current-theme.css` shows valid GTK CSS

2. Verify Rust service compiles:
   - `cd vulcan-appearance-manager && cargo check` succeeds

3. Verify CSS content:
   - Contains @define-color statements
   - Contains theme_accent, theme_bg_primary, etc.
   - Contains actual hex colors (not variables)
</verification>

<success_criteria>
- ~/.config/vulcan/current-theme.css is generated on every theme switch
- CSS file uses @define-color syntax with theme_ prefix for colors
- Rust service can read the CSS file and return its content
- No compilation errors in vulcan-appearance-manager
</success_criteria>

<output>
After completion, create `.planning/phases/09-theming-infrastructure/09-02-SUMMARY.md`
</output>
