---
phase: 12-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vulcan-appearance-manager/src/models/binding.rs
  - dotfiles/themes/colors/catppuccin-mocha.sh
  - dotfiles/themes/colors/catppuccin-latte.sh
  - dotfiles/themes/colors/dracula.sh
  - dotfiles/themes/colors/gruvbox-dark.sh
  - dotfiles/themes/colors/gruvbox-light.sh
  - dotfiles/themes/colors/nord.sh
  - dotfiles/themes/colors/tokyonight.sh
  - dotfiles/themes/colors/rosepine.sh
  - dotfiles/themes/colors/onedark.sh
  - dotfiles/themes/colors/vulcan-forge.sh
autonomous: true

must_haves:
  truths:
    - "resolve_theme_wallpaper() finds wallpapers in dotfiles/wallpapers/{theme}/ directory"
    - "All 10 theme files reference wallpapers with correct relative paths"
    - "Applying any preset theme resolves its wallpaper path correctly"
  artifacts:
    - path: "vulcan-appearance-manager/src/models/binding.rs"
      provides: "Updated wallpaper path resolution"
      contains: "dotfiles/wallpapers"
    - path: "dotfiles/themes/colors/*.sh"
      provides: "Theme wallpaper references"
      contains: "THEME_WALLPAPER"
  key_links:
    - from: "resolve_theme_wallpaper()"
      to: "dotfiles/wallpapers/{theme}/{theme}.png"
      via: "path construction from theme name"
      pattern: "wallpapers.*theme"
---

<objective>
Fix wallpaper path resolution so themes correctly locate wallpapers in the wallpapers directory.

Purpose: Enable theme-wallpaper binding to work for all themes once wallpapers are added.
Output: Updated resolve_theme_wallpaper() function and theme files with correct wallpaper paths.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ux-polish/12-RESEARCH.md

@vulcan-appearance-manager/src/models/binding.rs
@dotfiles/themes/colors/catppuccin-mocha.sh
@dotfiles/wallpapers/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update resolve_theme_wallpaper() to use wallpapers directory</name>
  <files>vulcan-appearance-manager/src/models/binding.rs</files>
  <action>
The current `resolve_theme_wallpaper()` function resolves wallpapers relative to the theme file's directory (`dotfiles/themes/colors/`), but wallpapers are stored in `dotfiles/wallpapers/{theme}/`.

Update the function to:
1. Extract the theme ID from the theme (e.g., "tokyonight")
2. Build path to wallpapers directory: `{repo_root}/dotfiles/wallpapers/{theme_id}/{wallpaper_filename}`

Two approaches (choose based on code review):

**Approach A: Use theme_id to construct path**
```rust
pub fn resolve_theme_wallpaper(theme: &Theme) -> Option<PathBuf> {
    let wallpaper_filename = theme.theme_wallpaper.as_ref()?;
    let theme_id = &theme.theme_id;

    // Build path to wallpapers directory
    // Wallpapers are stored at: dotfiles/wallpapers/{theme_id}/{filename}
    let theme_source = theme.source_path.as_ref()?;

    // Navigate from theme file to wallpapers directory
    // From: dotfiles/themes/colors/{theme}.sh
    // To: dotfiles/wallpapers/{theme_id}/{filename}
    let dotfiles_dir = theme_source.parent()?.parent()?.parent()?; // Go up to dotfiles/
    let wallpaper_path = dotfiles_dir
        .join("wallpapers")
        .join(theme_id)
        .join(wallpaper_filename);

    if wallpaper_path.exists() {
        Some(wallpaper_path)
    } else {
        eprintln!(
            "Warning: Theme '{}' suggests wallpaper '{}' but file not found at {:?}",
            theme.theme_name, wallpaper_filename, wallpaper_path
        );
        None
    }
}
```

**Approach B: Update theme files to use relative paths**
Keep the resolver, but update THEME_WALLPAPER in each theme file to use relative path:
`export THEME_WALLPAPER="../wallpapers/tokyonight/tokyonight.png"`

Prefer Approach A as it's cleaner and doesn't require updating all theme files.
  </action>
  <verify>
1. Build: `cd vulcan-appearance-manager && cargo build 2>&1 | tail -20`
2. Verify logic: `grep -A15 "resolve_theme_wallpaper" src/models/binding.rs`
  </verify>
  <done>
- resolve_theme_wallpaper() constructs path to dotfiles/wallpapers/{theme_id}/ directory
- Code compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify path resolution with existing wallpapers</name>
  <files>vulcan-appearance-manager/src/models/binding.rs</files>
  <action>
Write a quick test to verify the path resolution works for themes that already have wallpapers (catppuccin-mocha, catppuccin-latte, dracula).

Create a simple test function or use cargo run to verify:
1. Load catppuccin-mocha theme
2. Call resolve_theme_wallpaper()
3. Verify it returns path to `dotfiles/wallpapers/catppuccin-mocha/catppuccin-mocha.png`

If the codebase has existing tests, add a unit test. Otherwise, manually verify by:
1. Checking the path construction logic matches the actual directory structure
2. Verifying that `dotfiles/wallpapers/catppuccin-mocha/catppuccin-mocha.png` exists

Note: Full runtime testing will happen in verification phase.
  </action>
  <verify>
1. `ls -la dotfiles/wallpapers/catppuccin-mocha/catppuccin-mocha.png` (should exist)
2. Path logic in resolve_theme_wallpaper navigates: themes/colors/{x}.sh -> wallpapers/{x}/{x}.png
3. For catppuccin-mocha:
   - source_path: `dotfiles/themes/colors/catppuccin-mocha.sh`
   - parent.parent.parent: `dotfiles/`
   - join("wallpapers", "catppuccin-mocha", "catppuccin-mocha.png"): `dotfiles/wallpapers/catppuccin-mocha/catppuccin-mocha.png`
  </verify>
  <done>
- Path construction verified to resolve correctly for existing wallpapers
- Logic documented for themes that don't have wallpapers yet (returns None)
  </done>
</task>

</tasks>

<verification>
1. Code compiles: `cd vulcan-appearance-manager && cargo build`
2. Path resolution: `grep -A20 "pub fn resolve_theme_wallpaper" vulcan-appearance-manager/src/models/binding.rs`
3. Existing wallpaper exists: `ls dotfiles/wallpapers/catppuccin-mocha/catppuccin-mocha.png`
</verification>

<success_criteria>
- resolve_theme_wallpaper() uses wallpapers/{theme_id}/ path structure
- Code compiles without errors
- Path logic verified against existing catppuccin-mocha wallpaper
</success_criteria>

<output>
After completion, create `.planning/phases/12-ux-polish/12-02-SUMMARY.md`
</output>
