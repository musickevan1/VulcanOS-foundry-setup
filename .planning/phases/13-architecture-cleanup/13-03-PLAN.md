---
phase: 13-architecture-cleanup
plan: 03
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - vulcan-appearance-manager/src/components/theme_view.rs
  - vulcan-appearance-manager/src/app.rs
autonomous: true

must_haves:
  truths:
    - "Cancel restores original theme (theme from before any preview started)"
    - "Cancel restores original wallpapers (per-monitor state before preview)"
    - "Cancel transitions Previewing -> Idle and clears snapshot"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/theme_view.rs"
      provides: "Cancel restore logic with RestoreWallpapers output"
      contains: "cancel_preview"
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "RestoreWallpapers message routing"
      contains: "RestoreWallpapers"
  key_links:
    - from: "CancelPreview handler"
      to: "theme_applier::apply_theme"
      via: "restore from snapshot.theme_id"
      pattern: "snapshot\\.theme_id.*apply_theme"
    - from: "CancelPreview handler"
      to: "ThemeViewOutput::RestoreWallpapers"
      via: "restore wallpapers via output message"
      pattern: "RestoreWallpapers"
    - from: "App handler"
      to: "WallpaperViewMsg::ApplyProfile"
      via: "forward wallpaper restore"
      pattern: "RestoreWallpapers.*ApplyProfile"
---

<objective>
Implement Cancel restore logic and wire RestoreWallpapers message through App coordinator.

Purpose: Complete the cancel workflow so users can safely preview themes and revert to their original state. Cancel restores both theme AND wallpapers to their state before any preview started.

Output: Fully functional Cancel that restores theme + wallpapers via proper message routing.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-architecture-cleanup/13-CONTEXT.md
@.planning/phases/13-architecture-cleanup/13-RESEARCH.md
@vulcan-appearance-manager/src/components/theme_view.rs
@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CancelPreview with full restore</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Add new output message for wallpaper restore:
```rust
#[derive(Debug)]
pub enum ThemeViewOutput {
    ShowToast(String),
    ThemeApplied(String),
    ApplyWallpaper(std::path::PathBuf),
    BindingModeChanged(crate::models::BindingMode),
    RestoreWallpapers(std::collections::HashMap<String, std::path::PathBuf>),  // ADD THIS
}
```

Rewrite the CancelPreview handler to restore from snapshot:
```rust
ThemeViewMsg::CancelPreview => {
    if !self.app_state.is_previewing() {
        // Not in preview state, nothing to cancel
        return;
    }

    // Restore from snapshot
    if let Some(ref snapshot) = self.preview_snapshot {
        // Restore theme
        if let Some(ref theme_id) = snapshot.theme_id {
            if let Err(e) = theme_applier::apply_theme(theme_id) {
                eprintln!("Failed to restore theme: {}", e);
                sender.output(ThemeViewOutput::ShowToast(
                    format!("Failed to restore theme: {}", e)
                )).ok();
            }
        }

        // Restore wallpapers via parent coordinator
        if !snapshot.wallpapers.is_empty() {
            sender.output(ThemeViewOutput::RestoreWallpapers(
                snapshot.wallpapers.clone()
            )).ok();
        }
    }

    // Transition state: Previewing -> Idle
    match self.app_state.clone().cancel_preview() {
        Ok(new_state) => {
            self.app_state = new_state;
            self.preview_snapshot = None;
            self.previewing_theme_id = None;
            sender.output(ThemeViewOutput::ShowToast(
                "Reverted to original theme".to_string()
            )).ok();
        }
        Err(e) => {
            eprintln!("Invalid cancel transition: {}", e);
        }
    }
}
```

This restores both theme AND wallpapers from the original snapshot, then clears preview state.
  </action>
  <verify>
Run `cargo check -p vulcan-appearance-manager` - compiles
  </verify>
  <done>CancelPreview handler restores theme and wallpapers from snapshot, transitions to Idle</done>
</task>

<task type="auto">
  <name>Task 2: Wire RestoreWallpapers message in App coordinator</name>
  <files>vulcan-appearance-manager/src/app.rs</files>
  <action>
Add handler for RestoreWallpapers output from ThemeView.

Update the match in App's theme_view forward closure:
```rust
let theme_view = ThemeViewModel::builder()
    .launch(())
    .forward(sender.input_sender(), |msg| {
        match msg {
            ThemeViewOutput::ShowToast(text) => AppMsg::ShowToast(text),
            ThemeViewOutput::ThemeApplied(id) => AppMsg::ThemeApplied(id),
            ThemeViewOutput::ApplyWallpaper(path) => AppMsg::ApplyThemeWallpaper(path),
            ThemeViewOutput::BindingModeChanged(mode) => AppMsg::BindingModeChanged(mode),
            ThemeViewOutput::RestoreWallpapers(wallpapers) => AppMsg::RestoreWallpapers(wallpapers),  // ADD
        }
    });
```

Add the AppMsg variant:
```rust
#[derive(Debug)]
pub enum AppMsg {
    // ... existing variants ...
    RestoreWallpapers(HashMap<String, PathBuf>),
}
```

Add the handler:
```rust
AppMsg::RestoreWallpapers(wallpapers) => {
    // Restore wallpapers via wallpaper view's profile apply mechanism
    self.wallpaper_view.emit(WallpaperViewMsg::ApplyProfile(wallpapers));
}
```

Add necessary imports at top of app.rs:
```rust
use std::collections::HashMap;
use std::path::PathBuf;
```

This reuses the existing ApplyProfile mechanism which applies per-monitor wallpapers.
  </action>
  <verify>
Run `cargo check -p vulcan-appearance-manager` - compiles
  </verify>
  <done>App coordinator handles RestoreWallpapers by forwarding to wallpaper view</done>
</task>

</tasks>

<verification>
1. `cargo check -p vulcan-appearance-manager` passes
2. `cargo build -p vulcan-appearance-manager` succeeds
3. Code review: CancelPreview restores from snapshot.theme_id and snapshot.wallpapers
4. Code review: RestoreWallpapers routed through App to WallpaperView
</verification>

<success_criteria>
- Cancel restores original theme from snapshot.theme_id
- Cancel restores original wallpapers via RestoreWallpapers output message
- Cancel transitions Previewing -> Idle and clears snapshot
- App coordinator routes RestoreWallpapers to wallpaper view via ApplyProfile
</success_criteria>

<output>
After completion, create `.planning/phases/13-architecture-cleanup/13-03-SUMMARY.md`
</output>
