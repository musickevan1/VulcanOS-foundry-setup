---
phase: 13-architecture-cleanup
plan: 05
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - vulcan-appearance-manager/src/state.rs
  - vulcan-appearance-manager/src/components/theme_view.rs
autonomous: true

must_haves:
  truths:
    - "Apply transitions to Applying state, then to Idle on success"
    - "Apply failure returns to Previewing state (user can retry or cancel)"
    - "Apply updates original_theme_id to newly applied theme"
    - "State machine has rollback() transition: Applying -> Previewing"
  artifacts:
    - path: "vulcan-appearance-manager/src/state.rs"
      provides: "rollback() method for Applying -> Previewing transition"
      contains: "fn rollback"
    - path: "vulcan-appearance-manager/src/components/theme_view.rs"
      provides: "ApplyTheme handler with state transitions"
      contains: "start_apply"
  key_links:
    - from: "ApplyTheme handler"
      to: "app_state.start_apply()"
      via: "state transition Previewing -> Applying"
      pattern: "start_apply"
    - from: "ApplyTheme handler (success)"
      to: "app_state.finish()"
      via: "state transition Applying -> Idle"
      pattern: "finish"
    - from: "ApplyTheme handler (failure)"
      to: "app_state.rollback(snapshot)"
      via: "state transition Applying -> Previewing"
      pattern: "rollback"
---

<objective>
Add rollback() method to state machine and implement Apply state transitions with proper error recovery.

Purpose: Complete the apply workflow with proper state machine transitions. Per CONTEXT.md: "Apply failure shows inline error, stays in preview mode (user can retry or cancel)". The rollback() method enables this by providing a valid Applying -> Previewing transition.

Output: State machine with rollback(), ApplyTheme handler with full state transitions.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-architecture-cleanup/13-CONTEXT.md
@.planning/phases/13-architecture-cleanup/13-RESEARCH.md
@vulcan-appearance-manager/src/state.rs
@vulcan-appearance-manager/src/components/theme_view.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rollback() method to AppState</name>
  <files>vulcan-appearance-manager/src/state.rs</files>
  <action>
Add a `rollback()` method to AppState that transitions from Applying back to Previewing.

This is needed because:
1. User is Previewing theme A
2. User clicks Apply -> state becomes Applying
3. Apply fails (write error, etc.)
4. User should return to Previewing (not Idle) so they can retry or cancel
5. The original snapshot must be preserved for cancel to work

Add to AppState impl:
```rust
/// Rollback from Applying to Previewing after a failure.
/// Only valid from Applying state. Requires the snapshot to restore to.
pub fn rollback(self, snapshot: PreviewSnapshot) -> Result<AppState> {
    match self {
        AppState::Applying => Ok(AppState::Previewing { previous: snapshot }),
        AppState::Idle => {
            bail!("Cannot rollback from state: Idle (not applying)")
        }
        AppState::Previewing { .. } => {
            bail!("Cannot rollback from state: Previewing (not applying)")
        }
        AppState::Error { .. } => {
            bail!("Cannot rollback from state: Error (must recover first)")
        }
    }
}
```

Add test for rollback:
```rust
#[test]
fn test_applying_to_previewing_rollback() {
    let state = AppState::Applying;
    let snapshot = make_snapshot();
    let result = state.rollback(snapshot.clone());
    assert!(result.is_ok());
    let new_state = result.unwrap();
    assert!(new_state.is_previewing());
    assert_eq!(new_state.previous_snapshot(), Some(&snapshot));
}

#[test]
fn test_cannot_rollback_from_idle() {
    let state = AppState::Idle;
    let snapshot = make_snapshot();
    let result = state.rollback(snapshot);
    assert!(result.is_err());
}

#[test]
fn test_cannot_rollback_from_previewing() {
    let snapshot = make_snapshot();
    let state = AppState::Previewing { previous: snapshot.clone() };
    let result = state.rollback(snapshot);
    assert!(result.is_err());
}
```
  </action>
  <verify>
Run `cargo test -p vulcan-appearance-manager -- state::tests` - all tests pass including new rollback tests
  </verify>
  <done>rollback() method exists with proper state validation and tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement ApplyTheme with state transitions</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Rewrite the ApplyTheme handler to use state machine transitions including rollback on failure.

```rust
ThemeViewMsg::ApplyTheme => {
    if let Some(ref theme) = self.selected_theme {
        // Check if we're in a valid state for apply
        if !self.app_state.is_previewing() && !self.app_state.is_idle() {
            return;
        }

        // Check if theme has a suggested wallpaper (existing binding dialog logic)
        if let Some(wallpaper_path) = resolve_theme_wallpaper(theme) {
            // Show binding dialog (existing logic)
            self.show_binding_dialog(theme.clone(), wallpaper_path, sender.clone());
            return;
        }

        // No wallpaper - apply theme with state transitions
        let theme_id = theme.theme_id.clone();
        let theme_name = theme.theme_name.clone();

        // Save snapshot before transitioning (needed for rollback)
        let snapshot_for_rollback = self.preview_snapshot.clone();

        // Transition to Applying state
        match self.app_state.clone().start_apply() {
            Ok(new_state) => {
                self.app_state = new_state;

                // Perform apply
                match theme_applier::apply_theme(&theme_id) {
                    Ok(_) => {
                        // Success - transition to Idle
                        match self.app_state.clone().finish() {
                            Ok(final_state) => {
                                self.app_state = final_state;
                                self.preview_snapshot = None;
                                self.previewing_theme_id = None;
                                self.original_theme_id = theme_id.clone();
                                self.theme_browser.emit(ThemeBrowserInput::SetCurrentTheme(theme_id.clone()));
                                sender.output(ThemeViewOutput::ThemeApplied(theme_id)).ok();
                                sender.output(ThemeViewOutput::ShowToast(
                                    format!("Applied: {}", theme_name)
                                )).ok();
                            }
                            Err(e) => {
                                eprintln!("Invalid finish transition: {}", e);
                            }
                        }
                    }
                    Err(e) => {
                        // Apply failed - rollback to Previewing state
                        // Per CONTEXT.md: "Apply failure shows inline error, stays in preview mode"
                        if let Some(snapshot) = snapshot_for_rollback {
                            match self.app_state.clone().rollback(snapshot.clone()) {
                                Ok(rollback_state) => {
                                    self.app_state = rollback_state;
                                    self.preview_snapshot = Some(snapshot);
                                    // previewing_theme_id stays the same
                                }
                                Err(re) => {
                                    eprintln!("Rollback failed: {}", re);
                                    // Fallback: force to Idle
                                    self.app_state = AppState::Idle;
                                    self.preview_snapshot = None;
                                    self.previewing_theme_id = None;
                                }
                            }
                        } else {
                            // No snapshot - go to Idle
                            self.app_state = AppState::Idle;
                        }
                        sender.output(ThemeViewOutput::ShowToast(
                            format!("Apply failed: {}. You can retry or cancel.", e)
                        )).ok();
                    }
                }
            }
            Err(e) => {
                eprintln!("Cannot apply from current state: {}", e);
            }
        }
    }
}
```

Also update the apply_theme_only() helper method (called from BindingChoice handler) to use state transitions:
```rust
fn apply_theme_only(&mut self, theme_id: &str, sender: ComponentSender<Self>) {
    // Save snapshot before transitioning (needed for rollback)
    let snapshot_for_rollback = self.preview_snapshot.clone();

    // Transition to Applying state
    match self.app_state.clone().start_apply() {
        Ok(new_state) => {
            self.app_state = new_state;

            match theme_applier::apply_theme(theme_id) {
                Ok(_) => {
                    // Success - transition to Idle
                    match self.app_state.clone().finish() {
                        Ok(final_state) => {
                            self.app_state = final_state;
                            self.preview_snapshot = None;
                            self.previewing_theme_id = None;
                            self.original_theme_id = theme_id.to_string();
                            self.theme_browser.emit(ThemeBrowserInput::SetCurrentTheme(theme_id.to_string()));
                            sender.output(ThemeViewOutput::ShowToast(format!("Applied theme: {}", theme_id))).ok();
                            sender.output(ThemeViewOutput::ThemeApplied(theme_id.to_string())).ok();
                        }
                        Err(e) => {
                            eprintln!("Invalid finish transition: {}", e);
                        }
                    }
                }
                Err(e) => {
                    // Apply failed - rollback to Previewing
                    if let Some(snapshot) = snapshot_for_rollback {
                        match self.app_state.clone().rollback(snapshot.clone()) {
                            Ok(rollback_state) => {
                                self.app_state = rollback_state;
                                self.preview_snapshot = Some(snapshot);
                            }
                            Err(re) => {
                                eprintln!("Rollback failed: {}", re);
                                self.app_state = AppState::Idle;
                                self.preview_snapshot = None;
                                self.previewing_theme_id = None;
                            }
                        }
                    } else {
                        self.app_state = AppState::Idle;
                    }
                    sender.output(ThemeViewOutput::ShowToast(format!("Apply failed: {}", e))).ok();
                }
            }
        }
        Err(e) => {
            eprintln!("Cannot apply from current state: {}", e);
            sender.output(ThemeViewOutput::ShowToast(format!("Apply failed: {}", e))).ok();
        }
    }
}
```
  </action>
  <verify>
Run `cargo check -p vulcan-appearance-manager` - compiles without errors
  </verify>
  <done>ApplyTheme handler transitions Previewing -> Applying -> Idle on success, Applying -> Previewing (via rollback) on failure</done>
</task>

</tasks>

<verification>
1. `cargo check -p vulcan-appearance-manager` passes
2. `cargo test -p vulcan-appearance-manager -- state::tests` - all tests pass
3. `cargo build -p vulcan-appearance-manager` succeeds
4. Code review: rollback() method only valid from Applying state
5. Code review: ApplyTheme uses rollback() on failure, preserving preview state
</verification>

<success_criteria>
- state.rs has rollback(snapshot) method for Applying -> Previewing transition
- rollback() validates it's only called from Applying state
- ApplyTheme handler transitions Previewing -> Applying -> Idle on success
- ApplyTheme handler uses rollback() on failure, staying in Previewing with error toast
- User can retry Apply or Cancel after failure (still in preview mode)
- All state machine tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-architecture-cleanup/13-05-SUMMARY.md`
</output>
