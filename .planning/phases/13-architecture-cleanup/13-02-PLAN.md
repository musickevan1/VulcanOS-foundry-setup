---
phase: 13-architecture-cleanup
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - vulcan-appearance-manager/src/components/theme_view.rs
autonomous: true

must_haves:
  truths:
    - "Action bar appears when preview starts (slides in)"
    - "Action bar disappears when returning to Idle (slides out)"
    - "Apply button disabled during Applying state"
    - "Cancel button disabled during Applying state"
    - "Status shows 'Applied: X / Previewing: Y' during preview"
    - "Apply button shows spinner during Applying state"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/theme_view.rs"
      provides: "Action bar with Revealer animation"
      contains: "gtk::Revealer"
  key_links:
    - from: "Revealer set_reveal_child"
      to: "model.app_state.is_previewing()"
      via: "#[watch] macro binding"
      pattern: "set_reveal_child.*is_previewing"
    - from: "Apply button set_sensitive"
      to: "model.app_state state checks"
      via: "#[watch] macro binding"
      pattern: "set_sensitive.*is_previewing.*is_applying"
---

<objective>
Add action bar UI with Revealer animation that responds to AppState changes.

Purpose: Provide visual feedback and controls (Apply/Cancel) during preview workflow. Action bar slides in when previewing, shows status indicator, and slides out when returning to Idle.

Output: Action bar wrapped in Revealer with state-reactive visibility, button sensitivity, and loading spinner.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-architecture-cleanup/13-CONTEXT.md
@.planning/phases/13-architecture-cleanup/13-RESEARCH.md
@vulcan-appearance-manager/src/components/theme_view.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure view! macro for action bar placement</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Restructure the view! macro to wrap existing content in a vertical Box with action bar at bottom.

Current structure:
```rust
view! {
    gtk::Paned { ... }
}
```

New structure:
```rust
view! {
    gtk::Box {
        set_orientation: gtk::Orientation::Vertical,

        // Main content (existing Paned)
        gtk::Paned {
            set_vexpand: true,
            // ... existing paned content unchanged ...
        },

        // Action bar with slide-up animation (new)
        gtk::Revealer {
            set_transition_type: gtk::RevealerTransitionType::SlideUp,
            set_transition_duration: 200,
            #[watch]
            set_reveal_child: model.app_state.is_previewing() || model.app_state.is_error(),

            // Action bar content added in Task 2
        },
    }
}
```

Move all existing Paned properties and children to be inside the new Box structure. Add `set_vexpand: true` to Paned so it expands to fill available space above action bar.
  </action>
  <verify>
Run `cargo check -p vulcan-appearance-manager` - compiles (even though Revealer is empty)
  </verify>
  <done>View macro restructured with outer Box containing Paned + Revealer</done>
</task>

<task type="auto">
  <name>Task 2: Add action bar content with status and buttons</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Add action bar content inside the Revealer from Task 1:

```rust
gtk::Revealer {
    set_transition_type: gtk::RevealerTransitionType::SlideUp,
    set_transition_duration: 200,
    #[watch]
    set_reveal_child: model.app_state.is_previewing() || model.app_state.is_error(),

    gtk::ActionBar {
        // Status indicator (left side)
        pack_start = &gtk::Box {
            set_orientation: gtk::Orientation::Horizontal,
            set_spacing: 8,

            gtk::Label {
                #[watch]
                set_markup: &{
                    if model.app_state.is_previewing() || model.app_state.is_applying() {
                        format!(
                            "Applied: <b>{}</b> / Previewing: <b>{}</b>",
                            model.original_theme_id,
                            model.previewing_theme_id.as_deref().unwrap_or("None")
                        )
                    } else if let crate::state::AppState::Error { message, .. } = &model.app_state {
                        format!("<span color='#ff5555'>Error: {}</span>", message)
                    } else {
                        String::new()
                    }
                },
                set_use_markup: true,
            },
        },

        // Action buttons (right side)
        pack_end = &gtk::Box {
            set_orientation: gtk::Orientation::Horizontal,
            set_spacing: 8,

            gtk::Button {
                set_label: "Cancel",
                set_tooltip_text: Some("Revert to original theme and wallpaper"),
                #[watch]
                set_sensitive: model.app_state.is_previewing() && !model.app_state.is_applying(),
                connect_clicked => ThemeViewMsg::CancelPreview,
            },

            gtk::Button {
                add_css_class: "suggested-action",
                #[watch]
                set_sensitive: model.app_state.is_previewing() && !model.app_state.is_applying(),

                #[wrap(Some)]
                set_child = &gtk::Box {
                    set_orientation: gtk::Orientation::Horizontal,
                    set_spacing: 6,

                    gtk::Spinner {
                        #[watch]
                        set_spinning: model.app_state.is_applying(),
                        #[watch]
                        set_visible: model.app_state.is_applying(),
                    },

                    gtk::Label {
                        #[watch]
                        set_label: if model.app_state.is_applying() { "Applying..." } else { "Apply" },
                    },
                },

                connect_clicked => ThemeViewMsg::ApplyTheme,
            },
        },
    },
},
```

This implements:
- Revealer with SlideUp transition (200ms)
- Status label showing "Applied: X / Previewing: Y"
- Cancel button (disabled during Applying)
- Apply button with spinner (disabled during Applying, shows spinner when applying)
  </action>
  <verify>
Run `cargo check -p vulcan-appearance-manager` - compiles without errors
  </verify>
  <done>Action bar has status indicator, Cancel button, and Apply button with spinner</done>
</task>

<task type="auto">
  <name>Task 3: Remove old action buttons from right panel</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Remove the existing "Action buttons" Box from the right panel (set_end_child of Paned) since they're now in the action bar.

Find and remove this section from inside the Paned's set_end_child:
```rust
// Action buttons
gtk::Box {
    set_orientation: gtk::Orientation::Horizontal,
    set_spacing: 8,
    set_halign: gtk::Align::End,

    gtk::Button {
        set_label: "Edit",
        // ...
    },

    gtk::Button {
        set_label: "Preview",
        // ...
    },

    gtk::Button {
        set_label: "Cancel",
        // ...
    },

    gtk::Button {
        set_label: "Apply",
        // ...
    },
},
```

Keep the Edit button - move it to the right panel header next to the "Available Themes" label and import/new buttons. The Edit button should stay visible always (not just during preview).

OR keep a minimal button bar in the right panel with just the Edit button, since Edit operates on the selected theme regardless of preview state.

Actually, keep the Edit button in the right panel (it's part of theme management, not preview workflow). Remove Preview, Cancel, Apply from right panel as they move to action bar. The Preview button is no longer needed since clicking theme cards triggers preview automatically per CONTEXT.md decisions.
  </action>
  <verify>
1. `cargo check -p vulcan-appearance-manager` compiles
2. Visual check: Run app, verify no duplicate buttons
  </verify>
  <done>Old Preview/Cancel/Apply buttons removed from right panel; Edit button remains for theme editing</done>
</task>

</tasks>

<verification>
1. `cargo check -p vulcan-appearance-manager` passes
2. `cargo build -p vulcan-appearance-manager` succeeds
3. Manual test: Run app, click theme card - action bar slides in
4. Manual test: Status shows "Applied: X / Previewing: Y"
5. Manual test: Buttons have correct tooltips
6. Code review: Revealer uses #[watch] on set_reveal_child bound to is_previewing()
7. Code review: Apply button sensitivity uses is_previewing() && !is_applying()
</verification>

<success_criteria>
- Action bar wrapped in Revealer with SlideUp transition
- Action bar visible only during Previewing or Error states (slides in/out)
- Status indicator shows applied vs previewing theme names
- Cancel button disabled during Applying state
- Apply button disabled during Applying state
- Apply button shows spinner during Applying state
- Old duplicate buttons removed from right panel
</success_criteria>

<output>
After completion, create `.planning/phases/13-architecture-cleanup/13-02-SUMMARY.md`
</output>
