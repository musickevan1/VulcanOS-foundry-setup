---
phase: 06-foundation-architecture
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - vulcan-appearance-manager/src/services/wallpaper_backend.rs
  - vulcan-appearance-manager/src/services/mod.rs
autonomous: true

must_haves:
  truths:
    - "WallpaperBackend trait exists with apply(), query_active(), and name() methods"
    - "SwwwBackend struct implements WallpaperBackend using swww CLI"
    - "HyprpaperBackend struct implements WallpaperBackend using hyprctl hyprpaper CLI"
    - "detect_backend() function probes for available backend and returns Box<dyn WallpaperBackend>"
    - "Both backends parse their respective query output formats correctly"
    - "detect_backend() prefers swww over hyprpaper and returns Err if neither available"
  artifacts:
    - path: "vulcan-appearance-manager/src/services/wallpaper_backend.rs"
      provides: "Wallpaper backend trait with swww and hyprpaper implementations"
      contains: "pub trait WallpaperBackend"
      min_lines: 80
  key_links:
    - from: "vulcan-appearance-manager/src/services/wallpaper_backend.rs"
      to: "swww CLI"
      via: "std::process::Command"
      pattern: "Command::new\\(\"swww\"\\)"
    - from: "vulcan-appearance-manager/src/services/wallpaper_backend.rs"
      to: "hyprctl CLI"
      via: "std::process::Command"
      pattern: "Command::new\\(\"hyprctl\"\\)"
---

<objective>
Create the wallpaper backend abstraction trait with SwwwBackend and HyprpaperBackend implementations, plus auto-detection.

Purpose: Abstract wallpaper operations behind a trait so the app can support both swww (current default, smooth transitions) and hyprpaper (alternative, built into Hyprland). The existing code hardcodes swww in hyprpaper.rs (confusingly named) and has hyprpaper IPC in hyprctl.rs. This creates a clean abstraction. Phase 7 will wire this into app.rs; this plan creates the module.

Output: wallpaper_backend.rs with WallpaperBackend trait, two implementations, and detect_backend() function.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-foundation-architecture/06-CONTEXT.md
@.planning/phases/06-foundation-architecture/06-RESEARCH.md
@.planning/phases/06-foundation-architecture/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WallpaperBackend trait and SwwwBackend</name>
  <files>vulcan-appearance-manager/src/services/wallpaper_backend.rs</files>
  <action>
  Create `vulcan-appearance-manager/src/services/wallpaper_backend.rs` with:

  **1. WallpaperBackend trait:**
  ```rust
  use std::path::Path;
  use std::collections::HashMap;
  use anyhow::Result;

  /// Wallpaper backend abstraction.
  /// Allows the app to work with either swww or hyprpaper.
  pub trait WallpaperBackend {
      /// Apply a wallpaper to a specific monitor
      fn apply(&self, monitor: &str, path: &Path) -> Result<()>;

      /// Query active wallpapers: monitor name -> image path
      fn query_active(&self) -> Result<HashMap<String, String>>;

      /// Backend name for display/logging
      fn name(&self) -> &str;
  }
  ```

  **2. SwwwBackend implementation:**
  Based on the existing code in `services/hyprpaper.rs` (which actually uses swww despite the filename):

  - `apply()`: Runs `swww img <path> --outputs <monitor> --transition-type fade --transition-duration 0.5`. Check exit status, bail on failure with stderr.
  - `query_active()`: Runs `swww query`, parses each line. Format: `MONITOR: WxH, scale: S, currently displaying: image: /path`. Use the existing parsing logic from hyprpaper.rs -- look for "image: " in each line, extract monitor name from before the first ": ".
  - `name()`: Returns "swww"

  Use `std::process::Command` (synchronous, not async -- matches existing pattern).

  **3. HyprpaperBackend implementation:**
  Based on the existing code in `services/hyprctl.rs`:

  - `apply()`: Two-step process -- (1) `hyprctl hyprpaper preload <path>`, (2) `hyprctl hyprpaper wallpaper <monitor>,<path>`. Check exit status on both.
  - `query_active()`: Runs `hyprctl hyprpaper listactive`, parses `MONITOR = /path` format. Split on " = ".
  - `name()`: Returns "hyprpaper"

  **4. detect_backend() function:**
  ```rust
  /// Detect which wallpaper backend is available and running.
  /// Prefers swww (smoother transitions). Falls back to hyprpaper.
  /// Returns Err if neither is available.
  pub fn detect_backend() -> Result<Box<dyn WallpaperBackend>> {
  ```
  - Try `swww query` -- if exit code 0, return SwwwBackend
  - Try `hyprctl hyprpaper listactive` -- if exit code 0, return HyprpaperBackend
  - Otherwise bail with "No wallpaper backend found. Install swww or hyprpaper."

  **Important:** Do NOT delete or modify the existing `hyprpaper.rs` or `hyprctl.rs` files. The new `wallpaper_backend.rs` coexists alongside them. The old files still work and are referenced by app.rs. Migration of app.rs to use the trait happens in Phase 7.

  Do NOT make the trait async. Use synchronous std::process::Command.
  Do NOT use trait objects with Send+Sync bounds -- not needed for single-threaded GTK app.
  </action>
  <verify>
  `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes.
  ```bash
  grep "pub trait WallpaperBackend" vulcan-appearance-manager/src/services/wallpaper_backend.rs
  grep "pub struct SwwwBackend" vulcan-appearance-manager/src/services/wallpaper_backend.rs
  grep "pub struct HyprpaperBackend" vulcan-appearance-manager/src/services/wallpaper_backend.rs
  grep "pub fn detect_backend" vulcan-appearance-manager/src/services/wallpaper_backend.rs
  ```
  </verify>
  <done>
  - WallpaperBackend trait with apply, query_active, name methods
  - SwwwBackend struct implementing the trait (using swww CLI)
  - HyprpaperBackend struct implementing the trait (using hyprctl hyprpaper)
  - detect_backend() function with swww preference
  - Module compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Register module and add unit tests</name>
  <files>
  vulcan-appearance-manager/src/services/mod.rs
  vulcan-appearance-manager/src/services/wallpaper_backend.rs
  </files>
  <action>
  **1. Add `pub mod wallpaper_backend;` to services/mod.rs** (after the existing module declarations).

  **2. Add unit tests to wallpaper_backend.rs** in a `#[cfg(test)] mod tests` block:

  Since the backends depend on external commands (swww, hyprctl), tests should focus on parsing logic, not execution:

  - `test_swww_query_parsing`: Create a helper function that parses swww query output format. Test with sample output:
    ```
    DP-10:   1920x1080 [1920x1080], scale: 1.000000, currently displaying: image: /home/user/wallpaper1.png
    eDP-1:   2560x1600 [2560x1600], scale: 1.000000, currently displaying: image: /home/user/wallpaper2.jpg
    ```
    Verify correct monitor->path extraction.

  - `test_hyprpaper_query_parsing`: Create a helper function that parses hyprpaper listactive output format. Test with sample output:
    ```
    DP-10 = /home/user/wallpaper1.png
    eDP-1 = /home/user/wallpaper2.jpg
    ```
    Verify correct monitor->path extraction.

  - `test_swww_query_empty`: Empty output returns empty HashMap.
  - `test_hyprpaper_query_empty`: Empty output returns empty HashMap.

  To make the parsing testable, extract the output parsing into standalone functions:
  ```rust
  /// Parse swww query stdout into monitor->path map
  fn parse_swww_query(stdout: &str) -> HashMap<String, String> { ... }

  /// Parse hyprpaper listactive stdout into monitor->path map
  fn parse_hyprpaper_query(stdout: &str) -> HashMap<String, String> { ... }
  ```

  These are called by the respective `query_active()` implementations.

  Do NOT test detect_backend() in unit tests (requires running daemons).
  Do NOT test apply() in unit tests (side effects on live system).
  </action>
  <verify>
  Run tests:
  ```bash
  cargo test --manifest-path vulcan-appearance-manager/Cargo.toml -- wallpaper_backend
  ```
  All parsing tests must pass. Expect 4 tests.
  Also verify: `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes.
  </verify>
  <done>
  - wallpaper_backend module declared in services/mod.rs
  - parse_swww_query and parse_hyprpaper_query helper functions extractable and tested
  - 4 unit tests pass covering both output formats and empty cases
  - `cargo check` passes
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `cargo test --manifest-path vulcan-appearance-manager/Cargo.toml -- wallpaper_backend` passes all 4 tests
2. `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes
3. WallpaperBackend trait has 3 methods: apply, query_active, name
4. Two implementations: SwwwBackend, HyprpaperBackend
5. detect_backend() function exists with swww preference
6. Existing hyprpaper.rs and hyprctl.rs files are untouched
</verification>

<success_criteria>
- Clean trait abstraction for wallpaper backends
- Both swww and hyprpaper supported via the same interface
- Auto-detection prefers swww, falls back to hyprpaper
- Output parsing is tested independently of CLI availability
- Existing code is NOT broken (old modules untouched)
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-architecture/06-04-SUMMARY.md`
</output>
