---
phase: 06-foundation-architecture
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - vulcan-appearance-manager/src/state.rs
autonomous: true

must_haves:
  truths:
    - "AppState enum exists with Idle, Previewing, Applying, and Error variants"
    - "State transitions enforce valid paths: Idle->Previewing, Idle/Previewing->Applying, Previewing/Applying->Idle, Any->Error"
    - "Invalid state transitions return Result::Err with descriptive message"
    - "PreviewSnapshot captures wallpaper state and optional theme ID for revert"
    - "Error state stores recovery path (what state to return to)"
    - "Unit tests verify all valid and invalid transitions"
  artifacts:
    - path: "vulcan-appearance-manager/src/state.rs"
      provides: "Explicit state machine for application states"
      contains: "pub enum AppState"
      min_lines: 80
  key_links:
    - from: "vulcan-appearance-manager/src/state.rs"
      to: "anyhow::Result"
      via: "transition methods return Result"
      pattern: "pub fn.*Result<AppState>"
---

<objective>
Create the explicit state machine module (state.rs) with Idle/Previewing/Applying/Error states and validated transitions.

Purpose: Replace the implicit ad-hoc state tracking in the current app.rs (selected_monitor, selected_wallpaper fields) with an explicit state machine where invalid transitions return Result::Err. This prevents state corruption bugs -- invalid transitions surface immediately as errors rather than silently corrupting UI state. Phase 7 will wire this into app.rs; this plan creates the module and tests it.

Output: A state.rs module with AppState enum, PreviewSnapshot struct, transition methods, and comprehensive unit tests.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-foundation-architecture/06-CONTEXT.md
@.planning/phases/06-foundation-architecture/06-RESEARCH.md
@.planning/phases/06-foundation-architecture/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state.rs with AppState enum and transitions</name>
  <files>vulcan-appearance-manager/src/state.rs</files>
  <action>
  Create `vulcan-appearance-manager/src/state.rs` with the following:

  **1. PreviewSnapshot struct:**
  ```rust
  use std::collections::HashMap;
  use std::path::PathBuf;
  use anyhow::Result;

  /// Snapshot of state before preview, used for revert
  #[derive(Debug, Clone, PartialEq)]
  pub struct PreviewSnapshot {
      /// Monitor -> wallpaper path mapping before preview started
      pub wallpapers: HashMap<String, PathBuf>,
      /// Theme ID that was active before preview (if any)
      pub theme_id: Option<String>,
  }
  ```

  **2. AppState enum:**
  ```rust
  /// Application state machine with explicit transitions.
  /// Invalid transitions return Result::Err.
  #[derive(Debug, Clone, PartialEq)]
  pub enum AppState {
      /// No preview active, showing live system state
      Idle,
      /// User is previewing a change but hasn't applied
      Previewing {
          /// State before preview started (for revert)
          previous: PreviewSnapshot,
      },
      /// Currently applying changes to live system
      Applying,
      /// An error occurred during apply/preview
      Error {
          /// Human-readable error description
          message: String,
          /// State to return to after acknowledging error
          recovery: Box<AppState>,
      },
  }
  ```

  **3. Transition methods on AppState:**

  - `start_preview(snapshot: PreviewSnapshot) -> Result<AppState>`: Only valid from Idle. Returns Err from Previewing, Applying, or Error.
  - `start_apply() -> Result<AppState>`: Valid from Idle or Previewing. Returns Err from Applying or Error.
  - `finish() -> Result<AppState>`: Valid from Previewing or Applying. Returns Err from Idle or Error. Returns Idle.
  - `cancel_preview() -> Result<AppState>`: Valid from Previewing only. Returns Err from Idle, Applying, Error. Returns Idle.
  - `fail(message: String) -> AppState`: Valid from ANY state. Always succeeds (infallible). Returns Error with recovery set to Idle.
  - `recover() -> Result<AppState>`: Valid from Error only. Returns the recovery state (always Idle for now). Returns Err from non-Error states.

  **4. Convenience query methods:**
  - `is_idle() -> bool`
  - `is_previewing() -> bool`
  - `is_applying() -> bool`
  - `is_error() -> bool`
  - `previous_snapshot(&self) -> Option<&PreviewSnapshot>`: Returns the snapshot if in Previewing state.

  **5. Default impl:**
  ```rust
  impl Default for AppState {
      fn default() -> Self {
          AppState::Idle
      }
  }
  ```

  Use `anyhow::bail!()` for error returns with descriptive messages like: "Cannot start preview from state: Applying (must be Idle)".

  Do NOT use the typestate pattern (incompatible with Relm4 -- see research).
  Do NOT make this async -- transitions are synchronous state changes.
  </action>
  <verify>
  `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes.
  ```bash
  grep "pub enum AppState" vulcan-appearance-manager/src/state.rs
  grep "pub fn start_preview" vulcan-appearance-manager/src/state.rs
  grep "pub fn fail" vulcan-appearance-manager/src/state.rs
  ```
  </verify>
  <done>
  - state.rs exists with AppState enum (4 variants) and PreviewSnapshot struct
  - 6 transition methods implemented with Result returns
  - 5 query methods implemented
  - Default impl returns Idle
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests and wire module into crate</name>
  <files>
  vulcan-appearance-manager/src/state.rs
  vulcan-appearance-manager/src/main.rs
  </files>
  <action>
  **1. Add `mod state;` to main.rs** (after the existing mod declarations, before `use` statements).

  **2. Add comprehensive unit tests to state.rs** in a `#[cfg(test)] mod tests` block:

  Test valid transitions (should succeed):
  - `test_idle_to_previewing`: Idle -> start_preview -> Previewing (Ok)
  - `test_idle_to_applying`: Idle -> start_apply -> Applying (Ok)
  - `test_previewing_to_applying`: Idle -> Previewing -> start_apply -> Applying (Ok)
  - `test_previewing_to_idle_cancel`: Idle -> Previewing -> cancel_preview -> Idle (Ok)
  - `test_applying_to_idle_finish`: start_apply -> finish -> Idle (Ok)
  - `test_previewing_to_idle_finish`: start_preview -> finish -> Idle (Ok)
  - `test_any_to_error`: Idle -> fail("msg") -> Error (always Ok, infallible)
  - `test_error_to_recovery`: Error -> recover -> Idle (Ok)

  Test invalid transitions (should return Err):
  - `test_cannot_preview_from_applying`: Applying -> start_preview -> Err
  - `test_cannot_preview_from_previewing`: Previewing -> start_preview -> Err
  - `test_cannot_apply_from_error`: Error -> start_apply -> Err
  - `test_cannot_finish_from_idle`: Idle -> finish -> Err
  - `test_cannot_cancel_from_idle`: Idle -> cancel_preview -> Err
  - `test_cannot_recover_from_idle`: Idle -> recover -> Err

  Test query methods:
  - `test_is_idle`: Default state is Idle, is_idle() returns true
  - `test_previous_snapshot`: Previewing state returns Some(&snapshot)
  - `test_previous_snapshot_none`: Non-Previewing state returns None

  Each test should use `assert!(result.is_ok())` or `assert!(result.is_err())` as appropriate. For valid transitions, also verify the resulting state with pattern matching or is_* methods.
  </action>
  <verify>
  Run tests:
  ```bash
  cargo test --manifest-path vulcan-appearance-manager/Cargo.toml -- state
  ```
  All state tests must pass. Expect 17 tests.
  Also verify: `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes.
  </verify>
  <done>
  - state module declared in main.rs
  - 17+ unit tests covering all valid transitions, all invalid transitions, and query methods
  - All tests pass
  - `cargo check` passes
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `cargo test --manifest-path vulcan-appearance-manager/Cargo.toml -- state` passes all 17+ tests
2. `cargo check --manifest-path vulcan-appearance-manager/Cargo.toml` passes
3. AppState enum has 4 variants: Idle, Previewing, Applying, Error
4. Invalid transitions return descriptive Err messages
5. state module is declared in main.rs
</verification>

<success_criteria>
- Explicit state machine with validated transitions
- Invalid transitions caught at runtime via Result::Err
- PreviewSnapshot captures revert data
- Error state stores recovery path
- Comprehensive test coverage of all transition paths
- Module compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-architecture/06-03-SUMMARY.md`
</output>
