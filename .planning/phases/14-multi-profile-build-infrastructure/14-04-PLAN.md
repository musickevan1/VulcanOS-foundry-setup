---
phase: 14-multi-profile-build-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - archiso/profiles/foundry/pacman.conf
  - archiso/profiles/foundry/profiledef.sh
  - archiso/profiles/foundry/grub/grub.cfg
  - archiso/profiles/foundry/syslinux/syslinux.cfg
autonomous: true

must_haves:
  truths:
    - "Foundry pacman.conf has NO arch-mact2 repo (standard repos only)"
    - "Foundry profiledef.sh produces vulcanos-foundry-YYYY.MM.DD.iso"
    - "Foundry boot menus say 'VulcanOS Foundry' and have NVIDIA params"
  artifacts:
    - path: "archiso/profiles/foundry/pacman.conf"
      provides: "Foundry package manager config (standard repos)"
    - path: "archiso/profiles/foundry/profiledef.sh"
      provides: "Foundry ISO metadata"
      contains: "vulcanos-foundry"
    - path: "archiso/profiles/foundry/grub/grub.cfg"
      provides: "Foundry GRUB boot menu"
      contains: "VulcanOS Foundry"
    - path: "archiso/profiles/foundry/syslinux/syslinux.cfg"
      provides: "Foundry SYSLINUX boot menu"
      contains: "VulcanOS Foundry"
  key_links:
    - from: "archiso/profiles/foundry/grub/grub.cfg"
      to: "NVIDIA driver"
      via: "kernel parameter"
      pattern: "nvidia-drm.modeset=1"
---

<objective>
Create Foundry profile configuration files

Purpose: Define Foundry-specific configs for AI workstation. NO arch-mact2 repo, NVIDIA kernel params for GPU support.
Output: pacman.conf (standard repos), profiledef.sh for Foundry ISO naming, grub.cfg and syslinux.cfg with Foundry branding and NVIDIA params
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@archiso/pacman.conf
@archiso/profiledef.sh
@archiso/grub/grub.cfg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Foundry pacman.conf (no arch-mact2)</name>
  <files>archiso/profiles/foundry/pacman.conf</files>
  <action>
Create archiso/profiles/foundry/pacman.conf with STANDARD Arch repos only.

NO arch-mact2 repository - Foundry is a generic workstation, not T2-specific.

```
# =============================================================================
# VulcanOS Foundry - Pacman Configuration
# AI Workstation build (generic hardware)
# =============================================================================

[options]
HoldPkg     = pacman glibc
Architecture = auto
CheckSpace
ParallelDownloads = 5
SigLevel    = Required DatabaseOptional
LocalFileSigLevel = Optional

# =============================================================================
# REPOSITORIES
# Standard Arch Linux repos - no T2-specific repos
# =============================================================================

# Core Arch Linux packages
[core]
Include = /etc/pacman.d/mirrorlist

# Extra Arch Linux packages
[extra]
Include = /etc/pacman.d/mirrorlist

# 32-bit compatibility layer (required for Steam, NVIDIA 32-bit libs)
[multilib]
Include = /etc/pacman.d/mirrorlist
```

Comment notes multilib is required for Steam and NVIDIA 32-bit libraries.
  </action>
  <verify>
    ! grep -q "arch-mact2" archiso/profiles/foundry/pacman.conf
    grep -q "^\[core\]" archiso/profiles/foundry/pacman.conf
    grep -q "^\[multilib\]" archiso/profiles/foundry/pacman.conf
  </verify>
  <done>
    - pacman.conf has NO arch-mact2 section
    - Contains [core], [extra], [multilib] sections
    - multilib section present (needed for 32-bit NVIDIA libs)
    - Comment explains this is for generic/AI workstation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Foundry profiledef.sh</name>
  <files>archiso/profiles/foundry/profiledef.sh</files>
  <action>
Create archiso/profiles/foundry/profiledef.sh for Foundry ISO naming.

Changes from base:
- iso_name="vulcanos-foundry" (produces vulcanos-foundry-YYYY.MM.DD-x86_64.iso)
- iso_label includes FOUNDRY identifier
- iso_application mentions AI Workstation

```bash
#!/usr/bin/env bash
# shellcheck disable=SC2034

# =============================================================================
# VulcanOS Foundry - archiso Profile Definition
# AI Workstation build
# =============================================================================

iso_name="vulcanos-foundry"
iso_label="VULCAN_FDRY_$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y%m)"
iso_publisher="VulcanOS Project <https://github.com/yourusername/vulcanos>"
iso_application="VulcanOS Foundry AI Workstation Live/Install Medium"
iso_version="$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y.%m.%d)"
install_dir="arch"
buildmodes=('iso')
bootmodes=(
    'bios.syslinux.mbr'
    'bios.syslinux.eltorito'
    'uefi-ia32.grub.esp'
    'uefi-x64.grub.esp'
    'uefi-ia32.grub.eltorito'
    'uefi-x64.grub.eltorito'
)
arch="x86_64"
pacman_conf="pacman.conf"
airootfs_image_type="squashfs"
airootfs_image_tool_options=('-comp' 'xz' '-Xbcj' 'x86' '-b' '1M' '-Xdict-size' '1M')
bootstrap_tarball_compression=('zstd' '-c' '-T0' '--long' '-19')
file_permissions=(
    ["/etc/shadow"]="0:0:400"
    ["/etc/gshadow"]="0:0:400"
    ["/root"]="0:0:750"
    ["/etc/sudoers.d/wheel"]="0:0:440"
    ["/usr/local/bin/"]="0:0:755"
)
```

Note: iso_label uses FDRY (abbreviated) to stay within filesystem label limits.
  </action>
  <verify>
    grep -q 'iso_name="vulcanos-foundry"' archiso/profiles/foundry/profiledef.sh
    grep -q "AI Workstation" archiso/profiles/foundry/profiledef.sh
  </verify>
  <done>
    - profiledef.sh has iso_name="vulcanos-foundry"
    - iso_label contains FDRY identifier
    - iso_application mentions AI Workstation
    - All other settings match standard profiledef.sh structure
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Foundry boot configs with NVIDIA params</name>
  <files>
    archiso/profiles/foundry/grub/grub.cfg
    archiso/profiles/foundry/syslinux/syslinux.cfg
  </files>
  <action>
Create boot configs for Foundry with NVIDIA-specific kernel parameters.

Create directories:
- archiso/profiles/foundry/grub/
- archiso/profiles/foundry/syslinux/

For grub.cfg, modify from T2 version:
- Change branding: "VulcanOS Foundry" instead of "T2 MacBook Pro"
- Remove T2 params: intel_iommu=on iommu=pt pcie_ports=compat
- Add NVIDIA params: nvidia-drm.modeset=1

```
# VulcanOS Foundry GRUB Configuration
# AI Workstation build

insmod part_gpt
insmod part_msdos
insmod fat
insmod iso9660
insmod udf
insmod search_fs_uuid

set default=0
set timeout=5
set timeout_style=menu

if loadfont "${prefix}/fonts/unicode.pf2"; then
    insmod all_video
    set gfxmode=1920x1080,1280x1024,auto
    set gfxpayload=keep
    terminal_output gfxterm

    # Load VulcanOS theme
    insmod gfxmenu
    loadfont ($root)/boot/grub/themes/vulcanos/inter_12.pf2
    loadfont ($root)/boot/grub/themes/vulcanos/inter_14.pf2
    loadfont ($root)/boot/grub/themes/vulcanos/inter_18.pf2
    set theme=($root)/boot/grub/themes/vulcanos/theme.txt
    export theme
fi

menuentry "VulcanOS Foundry Live" --class arch --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    linux /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% nvidia-drm.modeset=1
    initrd /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
}

menuentry "VulcanOS Foundry Live - Copy to RAM" --class arch --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    linux /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% copytoram nvidia-drm.modeset=1
    initrd /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
}

menuentry "VulcanOS Foundry Live - Nouveau (Open Source)" --class arch --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    linux /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% modprobe.blacklist=nvidia,nvidia_modeset,nvidia_uvm,nvidia_drm
    initrd /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
}

if [ "${grub_platform}" == "efi" ]; then
    menuentry "UEFI Firmware Settings" --id 'uefi-firmware' {
        fwsetup
    }
fi

menuentry "System shutdown" --class shutdown {
    echo "System shutting down..."
    halt
}

menuentry "System restart" --class reboot {
    echo "System rebooting..."
    reboot
}
```

For syslinux.cfg:
- Same branding changes
- Same kernel param changes
- Add Nouveau fallback option

Copy theme files from archiso/grub/themes/ to archiso/profiles/foundry/grub/themes/
Copy splash.png from archiso/syslinux/ to archiso/profiles/foundry/syslinux/
  </action>
  <verify>
    grep -q "VulcanOS Foundry" archiso/profiles/foundry/grub/grub.cfg
    grep -q "nvidia-drm.modeset=1" archiso/profiles/foundry/grub/grub.cfg
    ! grep -q "intel_iommu" archiso/profiles/foundry/grub/grub.cfg
    grep -q "VulcanOS Foundry" archiso/profiles/foundry/syslinux/syslinux.cfg
  </verify>
  <done>
    - grub/grub.cfg branded "VulcanOS Foundry"
    - grub/grub.cfg has nvidia-drm.modeset=1 kernel param
    - grub/grub.cfg has NO T2 params (intel_iommu, iommu, pcie_ports)
    - grub/grub.cfg has Nouveau fallback option
    - grub/themes/ directory copied
    - syslinux/syslinux.cfg branded "VulcanOS Foundry"
    - syslinux/splash.png copied
  </done>
</task>

</tasks>

<verification>
- Foundry pacman.conf has NO arch-mact2 (standard repos only)
- Foundry profiledef.sh produces vulcanos-foundry ISO name
- Boot menus branded "VulcanOS Foundry"
- NVIDIA kernel params present, T2 params absent
- Nouveau fallback option available
</verification>

<success_criteria>
1. `grep arch-mact2 archiso/profiles/foundry/pacman.conf` fails (no T2 repo)
2. `grep vulcanos-foundry archiso/profiles/foundry/profiledef.sh` finds ISO name
3. `grep nvidia-drm.modeset archiso/profiles/foundry/grub/grub.cfg` finds param
4. `grep intel_iommu archiso/profiles/foundry/grub/grub.cfg` fails (no T2 params)
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-04-SUMMARY.md`
</output>
