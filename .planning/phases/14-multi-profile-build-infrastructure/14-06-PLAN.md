---
phase: 14-multi-profile-build-infrastructure
plan: 06
type: execute
wave: 2
depends_on: ["14-01", "14-02", "14-03"]
files_modified:
  - scripts/build-t2.sh
autonomous: true

must_haves:
  truths:
    - "User can run ./scripts/build-t2.sh to build T2 ISO"
    - "Script validates profile before building"
    - "Script uses assemble-then-build pattern from research"
    - "ISO output is vulcanos-t2-YYYY.MM.DD-x86_64.iso"
  artifacts:
    - path: "scripts/build-t2.sh"
      provides: "T2 build entry point"
      min_lines: 40
      contains: "PROFILE=\"t2\""
  key_links:
    - from: "scripts/build-t2.sh"
      to: "scripts/lib/build-common.sh"
      via: "source"
      pattern: "source.*lib/build-common.sh"
    - from: "scripts/build-t2.sh"
      to: "archiso/profiles/t2/"
      via: "PROFILE variable"
      pattern: "PROFILE.*t2"
---

<objective>
Create build-t2.sh entry point script

Purpose: Primary build script for T2 MacBook Pro ISO. Sources shared library, validates T2 profile, assembles profile, runs mkarchiso.
Output: Executable scripts/build-t2.sh that produces vulcanos-t2-YYYY.MM.DD-x86_64.iso
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@.planning/phases/14-multi-profile-build-infrastructure/14-01-SUMMARY.md
@scripts/build.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build-t2.sh script</name>
  <files>scripts/build-t2.sh</files>
  <action>
Create scripts/build-t2.sh following the pattern from RESEARCH.md.

Structure:
```bash
#!/bin/bash
# =============================================================================
# VulcanOS T2 - Build Script
# Builds ISO for T2 MacBook Pro
# =============================================================================

set -e

# Path setup
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ARCHISO_DIR="$PROJECT_DIR/archiso"

# Profile configuration
PROFILE="t2"
WORK_DIR="/tmp/vulcanos-work-$PROFILE"
ASSEMBLED_DIR="/tmp/vulcanos-assembled-$PROFILE"
OUT_DIR="$PROJECT_DIR/out"

# Source shared functions
if [[ ! -f "$SCRIPT_DIR/lib/build-common.sh" ]]; then
    echo "ERROR: Missing lib/build-common.sh"
    exit 1
fi
source "$SCRIPT_DIR/lib/build-common.sh"

# Set up cleanup trap
trap cleanup EXIT

# Main build function
main() {
    echo "=========================================="
    echo "  VulcanOS T2 - ISO Build"
    echo "=========================================="
    echo ""

    info "Profile: $PROFILE"
    info "Work directory: $WORK_DIR"
    info "Assembly directory: $ASSEMBLED_DIR"
    info "Output directory: $OUT_DIR"
    echo ""

    # Pre-flight checks
    check_root
    check_dependencies

    # Validate profile
    validate_profile "$PROFILE"

    # Clean previous build
    clean_build "$WORK_DIR" "$ASSEMBLED_DIR"

    # Assemble profile (merge base + profile)
    assemble_profile "$PROFILE" "$ASSEMBLED_DIR"

    # Run mkarchiso
    run_mkarchiso "$ASSEMBLED_DIR" "$WORK_DIR" "$OUT_DIR"

    # Post-build
    generate_checksums "$OUT_DIR"
    fix_permissions "$OUT_DIR"

    # Show results
    show_info "$OUT_DIR" "$PROFILE"
}

# Run main
main "$@"
```

Key features:
1. Sources lib/build-common.sh for shared functions
2. Sets PROFILE="t2" for T2-specific build
3. Uses separate work directories to avoid contamination
4. trap cleanup EXIT for error handling
5. Full pipeline: validate -> clean -> assemble -> build -> checksums

Make script executable: chmod +x scripts/build-t2.sh
  </action>
  <verify>
    test -x scripts/build-t2.sh
    grep -q 'PROFILE="t2"' scripts/build-t2.sh
    grep -q "source.*lib/build-common.sh" scripts/build-t2.sh
    bash -n scripts/build-t2.sh  # Syntax check
  </verify>
  <done>
    - scripts/build-t2.sh exists and is executable
    - Sets PROFILE="t2"
    - Sources lib/build-common.sh
    - Uses /tmp/vulcanos-work-t2 work directory
    - Calls validate_profile, assemble_profile, run_mkarchiso
    - Has cleanup trap for error handling
    - Passes bash syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify script can be parsed and sourced</name>
  <files></files>
  <action>
Verify the build script works correctly by:

1. Syntax check:
```bash
bash -n scripts/build-t2.sh
```

2. Verify it can source the library (mock test):
```bash
# Just test that sourcing works - don't actually run
bash -c 'source scripts/lib/build-common.sh && echo "Library loaded"'
```

3. Verify key variables are set:
```bash
grep -E "^PROFILE=" scripts/build-t2.sh
grep -E "^WORK_DIR=" scripts/build-t2.sh
grep -E "^ASSEMBLED_DIR=" scripts/build-t2.sh
```

4. Verify function calls are present:
```bash
grep -q "validate_profile" scripts/build-t2.sh
grep -q "assemble_profile" scripts/build-t2.sh
grep -q "run_mkarchiso" scripts/build-t2.sh
```

Note: DO NOT run the actual build yet - that requires all profile files to be in place and runs as root.
  </action>
  <verify>
    bash -n scripts/build-t2.sh
  </verify>
  <done>
    - Script passes bash -n syntax check
    - Library can be sourced
    - All required function calls present
    - Script is ready for integration testing
  </done>
</task>

</tasks>

<verification>
- build-t2.sh is executable
- Script syntax is valid
- Sources shared library correctly
- Uses correct profile and work directories
</verification>

<success_criteria>
1. `test -x scripts/build-t2.sh` succeeds
2. `bash -n scripts/build-t2.sh` succeeds (valid syntax)
3. `grep 'PROFILE="t2"' scripts/build-t2.sh` finds profile setting
4. Script contains validate_profile, assemble_profile, run_mkarchiso calls
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-06-SUMMARY.md`
</output>
