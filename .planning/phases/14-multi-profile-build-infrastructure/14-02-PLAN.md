---
phase: 14-multi-profile-build-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - archiso/base/packages.base
  - archiso/profiles/t2/packages.profile
  - archiso/profiles/foundry/packages.profile
autonomous: true

must_haves:
  truths:
    - "Shared packages in packages.base appear in both ISOs"
    - "T2-specific packages only in T2 ISO"
    - "Foundry-specific packages only in Foundry ISO"
    - "No kernel in base - each profile specifies its own"
  artifacts:
    - path: "archiso/base/packages.base"
      provides: "Shared packages for all profiles"
      min_lines: 80
      contains: "hyprland"
    - path: "archiso/profiles/t2/packages.profile"
      provides: "T2-specific packages"
      min_lines: 5
      contains: "linux-t2"
    - path: "archiso/profiles/foundry/packages.profile"
      provides: "Foundry-specific packages"
      min_lines: 5
      contains: "nvidia-open-dkms"
  key_links:
    - from: "archiso/base/packages.base"
      to: "archiso/profiles/t2/packages.profile"
      via: "concatenation at build time"
      pattern: "NO kernel in base"
---

<objective>
Split packages into base and profile-specific lists

Purpose: Separate shared packages from hardware-specific packages per RESEARCH.md analysis. Enables both profiles to share desktop/dev tools while having distinct kernels and drivers.
Output: packages.base (shared, ~85 packages, no kernel), packages.profile for T2 (6 packages), packages.profile for Foundry (~10 packages)
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@archiso/packages.x86_64
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base packages list</name>
  <files>archiso/base/packages.base</files>
  <action>
Create archiso/base/packages.base with ALL shared packages.

Start from current packages.x86_64 and REMOVE:
- linux-t2, linux-t2-headers (T2-specific kernel)
- apple-bcm-firmware, apple-t2-audio-config, t2fanrd, tiny-dfr (T2 hardware)
- Duplicate wl-clipboard (appears twice in original)

Keep EVERYTHING ELSE (base system, desktop, dev tools, fonts, audio, theming).

CRITICAL: NO KERNEL in base. Each profile specifies its own kernel.

Structure with clear section comments:
```
# ============================================================================
# VulcanOS Base Packages - Shared across all profiles
# ============================================================================

# ----------------------------------------------------------------------------
# BASE SYSTEM (NO KERNEL - profiles add their own)
# ----------------------------------------------------------------------------
base
linux-firmware

# ----------------------------------------------------------------------------
# BOOTLOADER
# ----------------------------------------------------------------------------
grub
efibootmgr
...
```

Use section headers from current packages.x86_64 as template.
Remove duplicate entries (wl-clipboard appears twice).
  </action>
  <verify>
    # Verify no T2-specific packages
    ! grep -E "^linux-t2|^apple-|^t2fanrd|^tiny-dfr" archiso/base/packages.base
    # Verify no kernel
    ! grep "^linux$" archiso/base/packages.base
    # Verify core desktop packages present
    grep -q "hyprland" archiso/base/packages.base
  </verify>
  <done>
    - packages.base contains ~85 shared packages
    - NO linux-t2, linux-t2-headers
    - NO apple-bcm-firmware, apple-t2-audio-config, t2fanrd, tiny-dfr
    - NO duplicate wl-clipboard
    - NO generic linux kernel (profiles add their own)
    - Contains all desktop (hyprland, waybar, etc.)
    - Contains all dev tools (docker, git, etc.)
    - Contains all CLI utilities
  </done>
</task>

<task type="auto">
  <name>Task 2: Create T2 profile packages</name>
  <files>archiso/profiles/t2/packages.profile</files>
  <action>
Create archiso/profiles/t2/packages.profile with T2-ONLY packages.

Content (from RESEARCH.md):
```
# ============================================================================
# VulcanOS T2 Profile - T2 MacBook Pro specific packages
# ============================================================================

# ----------------------------------------------------------------------------
# T2 KERNEL
# ----------------------------------------------------------------------------
linux-t2
linux-t2-headers

# ----------------------------------------------------------------------------
# T2 HARDWARE SUPPORT
# ----------------------------------------------------------------------------
apple-bcm-firmware
apple-t2-audio-config
t2fanrd
tiny-dfr
```

These are the 6 packages that make T2 different from a generic build.
  </action>
  <verify>
    grep -q "linux-t2" archiso/profiles/t2/packages.profile
    grep -q "apple-bcm-firmware" archiso/profiles/t2/packages.profile
    wc -l archiso/profiles/t2/packages.profile | grep -E "[1-2][0-9]"  # ~15-20 lines with comments
  </verify>
  <done>
    - packages.profile contains linux-t2, linux-t2-headers
    - Contains apple-bcm-firmware, apple-t2-audio-config
    - Contains t2fanrd, tiny-dfr
    - Clear section headers for kernel and hardware
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Foundry profile packages</name>
  <files>archiso/profiles/foundry/packages.profile</files>
  <action>
Create archiso/profiles/foundry/packages.profile with Foundry-ONLY packages.

Content (from RESEARCH.md):
```
# ============================================================================
# VulcanOS Foundry Profile - AI Workstation specific packages
# ============================================================================

# ----------------------------------------------------------------------------
# GENERIC KERNEL
# ----------------------------------------------------------------------------
linux
linux-headers

# ----------------------------------------------------------------------------
# NVIDIA GPU DRIVERS (RTX 5070 Ti - Blackwell)
# Note: Uses nvidia-open-dkms for RTX 50 series (sm_120)
# ----------------------------------------------------------------------------
nvidia-open-dkms
nvidia-utils
nvidia-settings
lib32-nvidia-utils

# ----------------------------------------------------------------------------
# CUDA/ML STACK
# Note: cuda-12.8+ for Blackwell support
# ----------------------------------------------------------------------------
cuda
cudnn
nvidia-container-toolkit
```

Include comments noting:
- nvidia-open-dkms required for RTX 50 series (not nvidia-dkms)
- CUDA 12.8+ needed for sm_120 architecture
- PyTorch installed separately (nightly build required)
  </action>
  <verify>
    grep -q "^linux$" archiso/profiles/foundry/packages.profile
    grep -q "nvidia-open-dkms" archiso/profiles/foundry/packages.profile
    grep -q "cuda" archiso/profiles/foundry/packages.profile
  </verify>
  <done>
    - packages.profile contains linux, linux-headers (generic kernel)
    - Contains nvidia-open-dkms, nvidia-utils, nvidia-settings
    - Contains lib32-nvidia-utils
    - Contains cuda, cudnn, nvidia-container-toolkit
    - Comments explain RTX 50 series requirements
  </done>
</task>

</tasks>

<verification>
- Base has no kernel or T2-specific packages
- T2 profile has linux-t2 and T2 hardware packages
- Foundry profile has linux and NVIDIA/CUDA packages
- Combined base + T2 = original functionality
- Combined base + Foundry = AI workstation
</verification>

<success_criteria>
1. `grep -c "^[a-z]" archiso/base/packages.base` returns ~85 (non-comment lines)
2. `grep linux-t2 archiso/profiles/t2/packages.profile` succeeds
3. `grep nvidia-open-dkms archiso/profiles/foundry/packages.profile` succeeds
4. `grep linux archiso/base/packages.base` fails (no kernel in base)
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-02-SUMMARY.md`
</output>
