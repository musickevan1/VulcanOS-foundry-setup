---
phase: 14-multi-profile-build-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - archiso/profiles/t2/pacman.conf
  - archiso/profiles/t2/profiledef.sh
  - archiso/profiles/t2/grub/grub.cfg
  - archiso/profiles/t2/syslinux/syslinux.cfg
autonomous: true

must_haves:
  truths:
    - "T2 pacman.conf has arch-mact2 repo UNCOMMENTED and FIRST"
    - "T2 profiledef.sh produces vulcanos-t2-YYYY.MM.DD.iso"
    - "T2 boot menus say 'VulcanOS T2' and include T2 kernel params"
  artifacts:
    - path: "archiso/profiles/t2/pacman.conf"
      provides: "T2 package manager config with arch-mact2 repo"
      contains: "[arch-mact2]"
    - path: "archiso/profiles/t2/profiledef.sh"
      provides: "T2 ISO metadata"
      contains: "vulcanos-t2"
    - path: "archiso/profiles/t2/grub/grub.cfg"
      provides: "T2 GRUB boot menu"
      contains: "VulcanOS T2"
    - path: "archiso/profiles/t2/syslinux/syslinux.cfg"
      provides: "T2 SYSLINUX boot menu"
      contains: "VulcanOS T2"
  key_links:
    - from: "archiso/profiles/t2/pacman.conf"
      to: "arch-mact2 repository"
      via: "repository priority (first repo)"
      pattern: "\\[arch-mact2\\].*\\[core\\]"
---

<objective>
Create T2 profile configuration files

Purpose: Define T2-specific configs per CONTEXT.md decisions. Critical: arch-mact2 repo must be UNCOMMENTED and FIRST for linux-t2 kernel priority.
Output: pacman.conf with arch-mact2, profiledef.sh for T2 ISO naming, grub.cfg and syslinux.cfg with T2 branding and kernel params
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@archiso/pacman.conf
@archiso/profiledef.sh
@archiso/grub/grub.cfg
@archiso/syslinux/syslinux.cfg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create T2 pacman.conf with arch-mact2 repo</name>
  <files>archiso/profiles/t2/pacman.conf</files>
  <action>
Create archiso/profiles/t2/pacman.conf based on current archiso/pacman.conf.

CRITICAL CHANGES:
1. arch-mact2 repository UNCOMMENTED
2. arch-mact2 repository BEFORE [core] (repo order determines package priority)

```
# =============================================================================
# VulcanOS T2 - Pacman Configuration
# T2 MacBook Pro specific build
# =============================================================================

[options]
HoldPkg     = pacman glibc
Architecture = auto
CheckSpace
ParallelDownloads = 5
SigLevel    = Required DatabaseOptional
LocalFileSigLevel = Optional

# =============================================================================
# REPOSITORIES
# T2 repository MUST come first for linux-t2 kernel priority
# =============================================================================

# T2 MacBook Pro Support (kernel, drivers, firmware)
[arch-mact2]
Server = https://mirror.funami.tech/arch-mact2/os/x86_64
SigLevel = Never

# Core Arch Linux packages
[core]
Include = /etc/pacman.d/mirrorlist

# Extra Arch Linux packages
[extra]
Include = /etc/pacman.d/mirrorlist

# 32-bit compatibility layer
[multilib]
Include = /etc/pacman.d/mirrorlist
```

The key difference from current pacman.conf: arch-mact2 is ACTIVE, not commented.
  </action>
  <verify>
    grep -A1 "^\[arch-mact2\]" archiso/profiles/t2/pacman.conf | grep -q "Server"
    # Verify arch-mact2 comes before core
    head -30 archiso/profiles/t2/pacman.conf | grep -q "arch-mact2"
  </verify>
  <done>
    - pacman.conf has [arch-mact2] section UNCOMMENTED
    - arch-mact2 appears BEFORE [core] section
    - Server URL is https://mirror.funami.tech/arch-mact2/os/x86_64
    - SigLevel = Never for arch-mact2
  </done>
</task>

<task type="auto">
  <name>Task 2: Create T2 profiledef.sh</name>
  <files>archiso/profiles/t2/profiledef.sh</files>
  <action>
Create archiso/profiles/t2/profiledef.sh based on current profiledef.sh.

Changes for T2 profile:
- iso_name="vulcanos-t2" (produces vulcanos-t2-YYYY.MM.DD-x86_64.iso)
- iso_label includes T2 identifier
- iso_application mentions T2 MacBook Pro

```bash
#!/usr/bin/env bash
# shellcheck disable=SC2034

# =============================================================================
# VulcanOS T2 - archiso Profile Definition
# T2 MacBook Pro specific build
# =============================================================================

iso_name="vulcanos-t2"
iso_label="VULCAN_T2_$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y%m)"
iso_publisher="VulcanOS Project <https://github.com/yourusername/vulcanos>"
iso_application="VulcanOS T2 MacBook Pro Live/Install Medium"
iso_version="$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y.%m.%d)"
install_dir="arch"
buildmodes=('iso')
bootmodes=(
    'bios.syslinux.mbr'
    'bios.syslinux.eltorito'
    'uefi-ia32.grub.esp'
    'uefi-x64.grub.esp'
    'uefi-ia32.grub.eltorito'
    'uefi-x64.grub.eltorito'
)
arch="x86_64"
pacman_conf="pacman.conf"
airootfs_image_type="squashfs"
airootfs_image_tool_options=('-comp' 'xz' '-Xbcj' 'x86' '-b' '1M' '-Xdict-size' '1M')
bootstrap_tarball_compression=('zstd' '-c' '-T0' '--long' '-19')
file_permissions=(
    ["/etc/shadow"]="0:0:400"
    ["/etc/gshadow"]="0:0:400"
    ["/root"]="0:0:750"
    ["/etc/sudoers.d/wheel"]="0:0:440"
    ["/usr/local/bin/"]="0:0:755"
)
```
  </action>
  <verify>
    grep -q 'iso_name="vulcanos-t2"' archiso/profiles/t2/profiledef.sh
    grep -q "T2 MacBook Pro" archiso/profiles/t2/profiledef.sh
  </verify>
  <done>
    - profiledef.sh has iso_name="vulcanos-t2"
    - iso_label contains T2 identifier
    - iso_application mentions T2 MacBook Pro
    - All other settings match current profiledef.sh
  </done>
</task>

<task type="auto">
  <name>Task 3: Create T2 boot configs (GRUB and SYSLINUX)</name>
  <files>
    archiso/profiles/t2/grub/grub.cfg
    archiso/profiles/t2/syslinux/syslinux.cfg
  </files>
  <action>
Create archiso/profiles/t2/grub/ and archiso/profiles/t2/syslinux/ directories.

Copy boot configs from archiso/grub/ and archiso/syslinux/ but they're already T2-branded.

For grub.cfg:
- Keep "VulcanOS T2" or "VulcanOS Live (T2 MacBook Pro)" branding
- Keep T2 kernel params: intel_iommu=on iommu=pt pcie_ports=compat
- Copy the entire grub/themes/ directory as well

For syslinux.cfg:
- Keep "VulcanOS T2" or "VulcanOS Live (T2 MacBook Pro)" labels
- Keep T2 kernel params

Create directories:
- archiso/profiles/t2/grub/
- archiso/profiles/t2/syslinux/

Copy files:
- archiso/grub/grub.cfg -> archiso/profiles/t2/grub/grub.cfg
- archiso/grub/themes/ -> archiso/profiles/t2/grub/themes/
- archiso/syslinux/syslinux.cfg -> archiso/profiles/t2/syslinux/syslinux.cfg
- archiso/syslinux/splash.png -> archiso/profiles/t2/syslinux/splash.png

The current files are already T2-specific, so this is a copy operation.
  </action>
  <verify>
    grep -q "T2 MacBook Pro" archiso/profiles/t2/grub/grub.cfg
    grep -q "intel_iommu=on" archiso/profiles/t2/grub/grub.cfg
    grep -q "T2 MacBook Pro" archiso/profiles/t2/syslinux/syslinux.cfg
    ls archiso/profiles/t2/grub/themes/vulcanos/theme.txt
  </verify>
  <done>
    - grub/grub.cfg exists with T2 branding
    - grub/themes/ directory copied with VulcanOS theme
    - syslinux/syslinux.cfg exists with T2 branding
    - syslinux/splash.png copied
    - Both configs have T2 kernel params (intel_iommu, iommu, pcie_ports)
  </done>
</task>

</tasks>

<verification>
- T2 pacman.conf has active arch-mact2 repo (not commented)
- T2 profiledef.sh produces vulcanos-t2 ISO name
- Boot menus branded "VulcanOS T2" or "T2 MacBook Pro"
- All T2 kernel parameters present in boot configs
</verification>

<success_criteria>
1. `grep "^\[arch-mact2\]" archiso/profiles/t2/pacman.conf` finds uncommented repo
2. `grep vulcanos-t2 archiso/profiles/t2/profiledef.sh` finds ISO name
3. `grep "intel_iommu=on" archiso/profiles/t2/grub/grub.cfg` finds kernel params
4. Theme directory exists at archiso/profiles/t2/grub/themes/vulcanos/
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-03-SUMMARY.md`
</output>
