---
phase: 14-multi-profile-build-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - archiso/base/.gitkeep
  - archiso/profiles/t2/.gitkeep
  - archiso/profiles/foundry/.gitkeep
  - scripts/lib/build-common.sh
autonomous: true

must_haves:
  truths:
    - "Directory structure exists for base and both profiles"
    - "Shared build functions are available for sourcing"
    - "Logging, validation, and assembly functions work correctly"
  artifacts:
    - path: "archiso/base/"
      provides: "Shared base content directory"
    - path: "archiso/profiles/t2/"
      provides: "T2 profile directory"
    - path: "archiso/profiles/foundry/"
      provides: "Foundry profile directory"
    - path: "scripts/lib/build-common.sh"
      provides: "Shared build functions"
      min_lines: 100
      contains: "assemble_profile"
  key_links:
    - from: "scripts/lib/build-common.sh"
      to: "archiso/base/"
      via: "BASE_DIR variable"
      pattern: "base_dir.*archiso/base"
---

<objective>
Create multi-profile directory structure and shared build library

Purpose: Foundation for multi-profile build system. Creates directory layout per CONTEXT.md decisions and shared functions per RESEARCH.md patterns.
Output: Directory structure (archiso/base/, archiso/profiles/{t2,foundry}/) and scripts/lib/build-common.sh with reusable functions
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@scripts/build.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-profile directory structure</name>
  <files>
    archiso/base/.gitkeep
    archiso/profiles/t2/.gitkeep
    archiso/profiles/foundry/.gitkeep
  </files>
  <action>
Create the directory structure for multi-profile builds:

```
archiso/
├── base/                    # Will hold shared content
│   └── .gitkeep
├── profiles/
│   ├── t2/                  # T2 MacBook profile
│   │   └── .gitkeep
│   └── foundry/             # Generic workstation profile
│       └── .gitkeep
```

Create directories using mkdir -p:
- archiso/base/
- archiso/profiles/t2/
- archiso/profiles/foundry/

Add .gitkeep files to preserve empty directories in git.

DO NOT modify or move existing archiso/ content yet - that happens in Plan 05.
  </action>
  <verify>
    ls -la archiso/base/ archiso/profiles/t2/ archiso/profiles/foundry/
    # Should show .gitkeep in each
  </verify>
  <done>
    - archiso/base/ directory exists with .gitkeep
    - archiso/profiles/t2/ directory exists with .gitkeep
    - archiso/profiles/foundry/ directory exists with .gitkeep
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared build library</name>
  <files>scripts/lib/build-common.sh</files>
  <action>
Create scripts/lib/ directory and build-common.sh with shared functions.

The library should include (from RESEARCH.md patterns):

1. **Color constants and logging functions:**
   - info(), success(), warn(), error()
   - Consistent formatting with color codes

2. **Dependency checking:**
   - check_root() - verify running as root
   - check_dependencies() - verify mkarchiso, rsync, etc. installed

3. **Validation function:**
   - validate_profile() - check required files exist before build
   - Required files: packages.profile, pacman.conf, profiledef.sh, grub/grub.cfg, syslinux/syslinux.cfg
   - Required directories: airootfs (warning if missing, not error)

4. **Assembly function:**
   - assemble_profile() - merge base + profile into work directory
   - Uses rsync -a for base airootfs first
   - Uses rsync -a for profile overlay (profile wins on conflict)
   - Merges package lists (cat base + profile, remove comments, sort -u)
   - Copies profile-specific configs (pacman.conf, profiledef.sh)
   - Copies boot configs (grub/, syslinux/)
   - Copies efiboot (profile-specific if exists, else archiso/efiboot/)

5. **Build helpers:**
   - clean_build() - remove work/assembled directories
   - run_mkarchiso() - invoke mkarchiso with proper args
   - generate_checksums() - create SHA256SUMS, MD5SUMS
   - fix_permissions() - chown to SUDO_USER
   - cleanup() - trap handler for failed builds
   - show_info() - display build results

Key variables to define at top (but expect callers to override):
- ARCHISO_DIR="$PROJECT_DIR/archiso"
- BASE_DIR="$ARCHISO_DIR/base"
- PROFILE_DIR="$ARCHISO_DIR/profiles"

Use `set -e` and trap for error handling.
Use functions from existing build.sh as reference but restructure for reuse.
  </action>
  <verify>
    # Source the library and check functions exist
    bash -c 'source scripts/lib/build-common.sh && type assemble_profile && type validate_profile'
  </verify>
  <done>
    - scripts/lib/build-common.sh exists
    - Contains info(), success(), warn(), error() functions
    - Contains check_root(), check_dependencies() functions
    - Contains validate_profile() function with file checks
    - Contains assemble_profile() function with rsync merge logic
    - Contains run_mkarchiso(), generate_checksums(), cleanup() functions
    - File is sourceable without errors
  </done>
</task>

</tasks>

<verification>
- Directory structure matches CONTEXT.md layout
- build-common.sh sources without errors
- All expected functions are defined
- No existing archiso/ content modified
</verification>

<success_criteria>
1. `ls archiso/base archiso/profiles/t2 archiso/profiles/foundry` shows .gitkeep files
2. `bash -c 'source scripts/lib/build-common.sh'` succeeds without errors
3. `grep -l assemble_profile scripts/lib/build-common.sh` finds the function
4. `grep -l validate_profile scripts/lib/build-common.sh` finds the function
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-01-SUMMARY.md`
</output>
