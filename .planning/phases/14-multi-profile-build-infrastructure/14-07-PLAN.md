---
phase: 14-multi-profile-build-infrastructure
plan: 07
type: execute
wave: 2
depends_on: ["14-01", "14-02", "14-04"]
files_modified:
  - scripts/build-foundry.sh
  - archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf
autonomous: true

must_haves:
  truths:
    - "User can run ./scripts/build-foundry.sh to build Foundry ISO"
    - "Script validates profile before building"
    - "ISO output is vulcanos-foundry-YYYY.MM.DD-x86_64.iso"
    - "Foundry has mkinitcpio.conf with NVIDIA modules"
  artifacts:
    - path: "scripts/build-foundry.sh"
      provides: "Foundry build entry point"
      min_lines: 40
      contains: "PROFILE=\"foundry\""
    - path: "archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf"
      provides: "Foundry initramfs config with NVIDIA"
      contains: "nvidia"
  key_links:
    - from: "scripts/build-foundry.sh"
      to: "scripts/lib/build-common.sh"
      via: "source"
      pattern: "source.*lib/build-common.sh"
    - from: "scripts/build-foundry.sh"
      to: "archiso/profiles/foundry/"
      via: "PROFILE variable"
      pattern: "PROFILE.*foundry"
---

<objective>
Create build-foundry.sh entry point and Foundry-specific airootfs

Purpose: Build script for Foundry AI Workstation ISO. Also creates Foundry-specific mkinitcpio.conf with NVIDIA modules for early KMS.
Output: Executable scripts/build-foundry.sh, profiles/foundry/airootfs/ with NVIDIA mkinitcpio config
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@.planning/phases/14-multi-profile-build-infrastructure/14-01-SUMMARY.md
@scripts/build.sh
@archiso/airootfs/etc/mkinitcpio.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build-foundry.sh script</name>
  <files>scripts/build-foundry.sh</files>
  <action>
Create scripts/build-foundry.sh following the same pattern as build-t2.sh.

Structure:
```bash
#!/bin/bash
# =============================================================================
# VulcanOS Foundry - Build Script
# Builds ISO for AI Workstation (NVIDIA GPU)
# =============================================================================

set -e

# Path setup
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ARCHISO_DIR="$PROJECT_DIR/archiso"

# Profile configuration
PROFILE="foundry"
WORK_DIR="/tmp/vulcanos-work-$PROFILE"
ASSEMBLED_DIR="/tmp/vulcanos-assembled-$PROFILE"
OUT_DIR="$PROJECT_DIR/out"

# Source shared functions
if [[ ! -f "$SCRIPT_DIR/lib/build-common.sh" ]]; then
    echo "ERROR: Missing lib/build-common.sh"
    exit 1
fi
source "$SCRIPT_DIR/lib/build-common.sh"

# Set up cleanup trap
trap cleanup EXIT

# Main build function
main() {
    echo "=========================================="
    echo "  VulcanOS Foundry - ISO Build"
    echo "=========================================="
    echo ""

    info "Profile: $PROFILE"
    info "Work directory: $WORK_DIR"
    info "Assembly directory: $ASSEMBLED_DIR"
    info "Output directory: $OUT_DIR"
    echo ""

    # Pre-flight checks
    check_root
    check_dependencies

    # Validate profile
    validate_profile "$PROFILE"

    # Clean previous build
    clean_build "$WORK_DIR" "$ASSEMBLED_DIR"

    # Assemble profile (merge base + profile)
    assemble_profile "$PROFILE" "$ASSEMBLED_DIR"

    # Run mkarchiso
    run_mkarchiso "$ASSEMBLED_DIR" "$WORK_DIR" "$OUT_DIR"

    # Post-build
    generate_checksums "$OUT_DIR"
    fix_permissions "$OUT_DIR"

    # Show results
    show_info "$OUT_DIR" "$PROFILE"
}

# Run main
main "$@"
```

Key differences from build-t2.sh:
1. PROFILE="foundry"
2. Work directories use -foundry suffix
3. Banner says "VulcanOS Foundry"

Make script executable: chmod +x scripts/build-foundry.sh
  </action>
  <verify>
    test -x scripts/build-foundry.sh
    grep -q 'PROFILE="foundry"' scripts/build-foundry.sh
    grep -q "source.*lib/build-common.sh" scripts/build-foundry.sh
    bash -n scripts/build-foundry.sh
  </verify>
  <done>
    - scripts/build-foundry.sh exists and is executable
    - Sets PROFILE="foundry"
    - Sources lib/build-common.sh
    - Uses /tmp/vulcanos-work-foundry work directory
    - Passes bash syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Foundry mkinitcpio.conf with NVIDIA modules</name>
  <files>archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf</files>
  <action>
Create Foundry-specific mkinitcpio.conf with NVIDIA modules for early KMS.

Create directory structure:
```bash
mkdir -p archiso/profiles/foundry/airootfs/etc/
```

Create mkinitcpio.conf based on Arch recommendations for NVIDIA:
```bash
# =============================================================================
# VulcanOS Foundry - mkinitcpio Configuration
# NVIDIA GPU with early KMS
# =============================================================================

# MODULES
# Include nvidia modules for early KMS (required for proper display)
# nvidia, nvidia_modeset, nvidia_uvm, nvidia_drm are loaded early
MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)

# BINARIES
# None needed beyond defaults
BINARIES=()

# FILES
# None needed beyond defaults
FILES=()

# HOOKS
# Standard archiso hooks plus necessary modules
# archiso requirements: archiso, archiso_loop_mnt
# nvidia: no special hooks needed, modules loaded via MODULES array
HOOKS=(base udev archiso archiso_loop_mnt modconf block filesystems keyboard)

# COMPRESSION
# Use zstd for fast boot
COMPRESSION="zstd"
COMPRESSION_OPTIONS=(-c -T0 -19)
```

Key NVIDIA requirements:
- nvidia, nvidia_modeset, nvidia_uvm, nvidia_drm in MODULES
- This enables early KMS for NVIDIA
- Required for proper display before X/Wayland starts
  </action>
  <verify>
    grep -q "nvidia" archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf
    grep -q "MODULES=" archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf
    grep -q "archiso" archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf
  </verify>
  <done>
    - mkinitcpio.conf exists in profiles/foundry/airootfs/etc/
    - MODULES includes nvidia, nvidia_modeset, nvidia_uvm, nvidia_drm
    - HOOKS includes archiso, archiso_loop_mnt (required for live ISO)
    - Compression uses zstd
  </done>
</task>

</tasks>

<verification>
- build-foundry.sh is executable and valid
- Foundry profile has mkinitcpio.conf with NVIDIA modules
- Build script sources shared library correctly
</verification>

<success_criteria>
1. `test -x scripts/build-foundry.sh` succeeds
2. `bash -n scripts/build-foundry.sh` succeeds (valid syntax)
3. `grep 'PROFILE="foundry"' scripts/build-foundry.sh` finds profile setting
4. `grep nvidia archiso/profiles/foundry/airootfs/etc/mkinitcpio.conf` finds NVIDIA modules
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-07-SUMMARY.md`
</output>
