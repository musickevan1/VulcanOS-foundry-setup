---
phase: 14-multi-profile-build-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["14-01", "14-02", "14-03"]
files_modified:
  - archiso/base/airootfs/
  - archiso/profiles/t2/airootfs/
autonomous: true

must_haves:
  truths:
    - "Shared dotfiles are in base/airootfs/etc/skel/"
    - "T2-specific modprobe configs are in profiles/t2/airootfs/"
    - "Base airootfs merged with T2 overlay produces original functionality"
  artifacts:
    - path: "archiso/base/airootfs/etc/skel/"
      provides: "Shared user configuration (hypr, kitty, themes, etc.)"
    - path: "archiso/base/airootfs/usr/local/bin/"
      provides: "Shared scripts (vulcan-power, vulcan-screenshot, etc.)"
    - path: "archiso/profiles/t2/airootfs/etc/modprobe.d/"
      provides: "T2-specific kernel module configs"
      contains: "apple-bce.conf"
  key_links:
    - from: "archiso/base/airootfs/"
      to: "archiso/profiles/t2/airootfs/"
      via: "rsync overlay at build time"
      pattern: "profile wins on conflict"
---

<objective>
Migrate airootfs to base + T2 overlay structure

Purpose: Split current airootfs into shared base (dotfiles, scripts, themes) and T2-specific overlay (modprobe configs). Follows copy-first, remove-last migration strategy from RESEARCH.md.
Output: base/airootfs/ with all shared content, profiles/t2/airootfs/ with T2-specific modprobe configs
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-RESEARCH.md
@.planning/phases/14-multi-profile-build-infrastructure/14-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy shared content to base/airootfs/</name>
  <files>archiso/base/airootfs/</files>
  <action>
Copy the majority of current archiso/airootfs/ to archiso/base/airootfs/.

Use rsync to copy EVERYTHING first:
```bash
rsync -a archiso/airootfs/ archiso/base/airootfs/
```

This copies:
- etc/skel/ (all dotfiles: hypr, kitty, themes, nvim, opencode, etc.)
- etc/skel/Pictures/ (wallpapers, logos)
- etc/skel/.config/ (all config directories)
- etc/skel/.local/ (applications, icons)
- usr/local/bin/ (vulcan-power, vulcan-screenshot, vulcan-wallpaper, etc.)
- usr/share/ (backgrounds, sddm themes)
- etc/sddm.conf.d/
- etc/hostname, etc/locale.conf, etc/locale.gen, etc/vconsole.conf
- etc/passwd, etc/group, etc/shadow, etc/gshadow
- etc/sudoers.d/wheel
- etc/pacman.d/mirrorlist
- etc/mkinitcpio.conf
- etc/modprobe.d/ (temporarily - will move T2-specific ones out)
- etc/systemd/ (systemd configs)

After copy, we'll separate T2-specific files in Task 2.
  </action>
  <verify>
    ls archiso/base/airootfs/etc/skel/.config/hypr/hyprland.conf
    ls archiso/base/airootfs/usr/local/bin/vulcan-power
    ls archiso/base/airootfs/etc/sddm.conf.d/
  </verify>
  <done>
    - base/airootfs/ contains full copy of current airootfs
    - etc/skel/ has all dotfiles
    - usr/local/bin/ has all vulcan scripts
    - usr/share/ has backgrounds, sddm themes
    - All etc/ configs copied
  </done>
</task>

<task type="auto">
  <name>Task 2: Create T2-specific airootfs overlay</name>
  <files>archiso/profiles/t2/airootfs/</files>
  <action>
Create profiles/t2/airootfs/ with ONLY T2-specific files.

From RESEARCH.md and current structure, T2-specific files are:
- etc/modprobe.d/apple-bce.conf (T2 keyboard/trackpad driver config)
- etc/modprobe.d/apple-gmux.conf (T2 GPU switching config)

Create the T2 overlay directory structure:
```bash
mkdir -p archiso/profiles/t2/airootfs/etc/modprobe.d/
```

Move T2-specific modprobe configs from base to T2 profile:
```bash
mv archiso/base/airootfs/etc/modprobe.d/apple-bce.conf archiso/profiles/t2/airootfs/etc/modprobe.d/
mv archiso/base/airootfs/etc/modprobe.d/apple-gmux.conf archiso/profiles/t2/airootfs/etc/modprobe.d/
```

If base/airootfs/etc/modprobe.d/ is now empty, remove it (or leave empty).

The build process will:
1. Copy base/airootfs/ to work directory
2. Overlay profiles/t2/airootfs/ on top (rsync -a, no --delete)
3. Result: T2 gets both shared configs AND T2-specific modprobe configs
  </action>
  <verify>
    ls archiso/profiles/t2/airootfs/etc/modprobe.d/apple-bce.conf
    ls archiso/profiles/t2/airootfs/etc/modprobe.d/apple-gmux.conf
    ! ls archiso/base/airootfs/etc/modprobe.d/apple-*.conf 2>/dev/null
  </verify>
  <done>
    - profiles/t2/airootfs/etc/modprobe.d/ exists
    - Contains apple-bce.conf
    - Contains apple-gmux.conf
    - base/airootfs/ does NOT have apple-*.conf files
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify migration integrity</name>
  <files></files>
  <action>
Verify that base + T2 overlay = original airootfs content.

Run comparison checks:

1. Count files in original vs base:
```bash
find archiso/airootfs -type f | wc -l
find archiso/base/airootfs -type f | wc -l
# Base should have 2 fewer (the apple-*.conf files moved to T2)
```

2. Verify critical shared files exist in base:
```bash
ls archiso/base/airootfs/etc/skel/.config/hypr/hyprland.conf
ls archiso/base/airootfs/etc/skel/.config/kitty/kitty.conf
ls archiso/base/airootfs/etc/skel/.config/themes/
ls archiso/base/airootfs/usr/local/bin/vulcan-power
ls archiso/base/airootfs/usr/share/sddm/themes/vulcanos/
```

3. Verify T2-specific files are in profile:
```bash
ls archiso/profiles/t2/airootfs/etc/modprobe.d/apple-bce.conf
ls archiso/profiles/t2/airootfs/etc/modprobe.d/apple-gmux.conf
```

4. Verify no T2-specific files remain in base:
```bash
! grep -r "apple" archiso/base/airootfs/etc/modprobe.d/ 2>/dev/null
```

DO NOT delete original archiso/airootfs/ yet - that happens after build verification in Plan 08.
  </action>
  <verify>
    # All critical paths exist
    test -f archiso/base/airootfs/etc/skel/.config/hypr/hyprland.conf
    test -f archiso/profiles/t2/airootfs/etc/modprobe.d/apple-bce.conf
  </verify>
  <done>
    - Base has all shared content (dotfiles, scripts, themes)
    - T2 profile has T2-specific modprobe configs
    - No T2-specific files in base
    - Original airootfs/ preserved for rollback
  </done>
</task>

</tasks>

<verification>
- base/airootfs/ has all shared content (~100 files)
- profiles/t2/airootfs/ has only T2-specific files (2 files)
- Combined content matches original airootfs functionality
- Original archiso/airootfs/ still exists (not deleted)
</verification>

<success_criteria>
1. `find archiso/base/airootfs -type f | wc -l` returns ~100+ files
2. `find archiso/profiles/t2/airootfs -type f | wc -l` returns 2 files
3. `ls archiso/base/airootfs/etc/skel/.config/hypr/` shows hyprland configs
4. `ls archiso/profiles/t2/airootfs/etc/modprobe.d/` shows apple-*.conf files
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-05-SUMMARY.md`
</output>
