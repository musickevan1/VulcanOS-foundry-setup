---
phase: 14-multi-profile-build-infrastructure
plan: 08
type: execute
wave: 3
depends_on: ["14-05", "14-06", "14-07"]
files_modified:
  - scripts/build.sh
autonomous: false

must_haves:
  truths:
    - "Running ./scripts/build.sh shows deprecation error with guidance"
    - "build.sh exits with non-zero status"
    - "Error message tells user to use build-t2.sh or build-foundry.sh"
  artifacts:
    - path: "scripts/build.sh"
      provides: "Deprecation stub with guidance"
      min_lines: 10
      contains: "build-t2.sh"
  key_links: []
---

<objective>
Deprecate old build.sh and verify build system

Purpose: Replace old build.sh with deprecation stub per CONTEXT.md decision. User-facing build command changes from `./scripts/build.sh` to `./scripts/build-t2.sh` or `./scripts/build-foundry.sh`.
Output: build.sh shows error with clear guidance, user verifies T2 build works
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-profile-build-infrastructure/14-CONTEXT.md
@.planning/phases/14-multi-profile-build-infrastructure/14-05-SUMMARY.md
@.planning/phases/14-multi-profile-build-infrastructure/14-06-SUMMARY.md
@.planning/phases/14-multi-profile-build-infrastructure/14-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace build.sh with deprecation stub</name>
  <files>scripts/build.sh</files>
  <action>
Replace scripts/build.sh with a simple deprecation stub.

Per CONTEXT.md: "Running `./scripts/build.sh` should exit with non-zero status and print message."

New content:
```bash
#!/bin/bash
# =============================================================================
# VulcanOS - Build Script (DEPRECATED)
# This script has been replaced by profile-specific build scripts.
# =============================================================================

echo ""
echo "=========================================="
echo "  VulcanOS Build System Changed"
echo "=========================================="
echo ""
echo "The unified build.sh has been replaced with profile-specific scripts:"
echo ""
echo "  For T2 MacBook Pro:"
echo "    sudo ./scripts/build-t2.sh"
echo ""
echo "  For Foundry AI Workstation:"
echo "    sudo ./scripts/build-foundry.sh"
echo ""
echo "See docs/BUILD.md for more information."
echo ""
exit 1
```

This:
1. Exits with status 1 (non-zero)
2. Tells user exactly what to run instead
3. Keeps the script as documentation/guidance

Keep script executable.
  </action>
  <verify>
    scripts/build.sh; test $? -ne 0  # Should exit non-zero
    grep -q "build-t2.sh" scripts/build.sh
    grep -q "build-foundry.sh" scripts/build.sh
  </verify>
  <done>
    - build.sh exits with non-zero status
    - Shows message about build-t2.sh and build-foundry.sh
    - Clear instructions for both profiles
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete multi-profile build infrastructure:
    - Directory structure: archiso/base/, archiso/profiles/{t2,foundry}/
    - Package split: packages.base + packages.profile for each profile
    - Profile configs: pacman.conf, profiledef.sh, boot menus
    - Airootfs split: shared in base, T2-specific in profiles/t2
    - Build scripts: build-t2.sh, build-foundry.sh
    - Deprecation: build.sh now shows error with guidance
  </what-built>
  <how-to-verify>
    1. Run old build script and verify deprecation:
       ```bash
       ./scripts/build.sh
       ```
       Expected: Error message with guidance, exits non-zero

    2. Verify directory structure:
       ```bash
       ls -la archiso/base/
       ls -la archiso/profiles/t2/
       ls -la archiso/profiles/foundry/
       ```
       Expected: All directories exist with content

    3. Verify T2 pacman.conf has active arch-mact2:
       ```bash
       grep "^\[arch-mact2\]" archiso/profiles/t2/pacman.conf
       ```
       Expected: Finds the uncommented repo

    4. Verify Foundry has NO arch-mact2:
       ```bash
       grep "arch-mact2" archiso/profiles/foundry/pacman.conf
       ```
       Expected: No matches

    5. DRY RUN - Test T2 validation (without building):
       ```bash
       sudo bash -c 'source scripts/lib/build-common.sh && ARCHISO_DIR=/home/evan/VulcanOS/archiso && validate_profile t2'
       ```
       Expected: Validation passes or shows specific missing files

    6. (OPTIONAL) Full T2 build test:
       ```bash
       sudo ./scripts/build-t2.sh
       ```
       Expected: Produces vulcanos-t2-YYYY.MM.DD-x86_64.iso in out/

    Note: Full build requires ~30 minutes and ~20GB disk space. The dry run validation is sufficient for phase completion.
  </how-to-verify>
  <resume-signal>Type "approved" if verification passes, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Old build.sh shows deprecation message
- Directory structure complete
- Package files in correct locations
- Profile configs properly separated
- Build scripts ready for execution
</verification>

<success_criteria>
1. `./scripts/build.sh` exits non-zero with guidance message
2. All profile directories exist with required files
3. T2 validation passes (arch-mact2 repo active)
4. Foundry has no T2-specific repos
5. User approves checkpoint verification
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-profile-build-infrastructure/14-08-SUMMARY.md`
</output>
