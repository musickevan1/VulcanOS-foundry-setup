---
phase: 05-vulcanos-wallpaper-manager
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - vulcan-wallpaper-manager/src/app.rs
  - vulcan-wallpaper-manager/src/services/hyprpaper.rs
  - vulcan-wallpaper-manager/src/services/mod.rs
autonomous: true

must_haves:
  truths:
    - "User can select monitor then assign wallpaper from picker"
    - "Wallpaper changes apply immediately via hyprpaper IPC"
    - "Monitor layout shows wallpaper preview thumbnails"
  artifacts:
    - path: "vulcan-wallpaper-manager/src/services/hyprpaper.rs"
      provides: "Hyprpaper IPC commands"
      exports: ["apply_wallpaper", "preload_wallpaper"]
    - path: "vulcan-wallpaper-manager/src/app.rs"
      provides: "Integrated app with monitor layout and wallpaper picker"
      contains: "WallpaperPickerModel"
  key_links:
    - from: "vulcan-wallpaper-manager/src/app.rs"
      to: "vulcan-wallpaper-manager/src/services/hyprpaper.rs"
      via: "apply_wallpaper call"
      pattern: "hyprpaper::apply_wallpaper"
    - from: "vulcan-wallpaper-manager/src/app.rs"
      to: "components::wallpaper_picker"
      via: "WallpaperPickerOutput::Selected handler"
      pattern: "WallpaperPickerOutput::Selected"
---

<objective>
Integrate monitor layout and wallpaper picker components with hyprpaper IPC for real-time wallpaper application.

Purpose: Connect the UI components so users can select a monitor and assign a wallpaper that applies immediately.
Output: Complete workflow: select monitor -> pick wallpaper -> wallpaper appears on that monitor.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-vulcanos-wallpaper-manager/05-RESEARCH.md
@.planning/phases/05-vulcanos-wallpaper-manager/05-02-SUMMARY.md
@.planning/phases/05-vulcanos-wallpaper-manager/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hyprpaper service wrapper</name>
  <files>
    vulcan-wallpaper-manager/src/services/hyprpaper.rs
    vulcan-wallpaper-manager/src/services/mod.rs
  </files>
  <action>
Create dedicated hyprpaper service for wallpaper operations:

services/hyprpaper.rs:
```rust
use std::path::Path;
use std::process::Command;
use std::collections::HashSet;
use std::sync::Mutex;
use anyhow::{Result, Context};

lazy_static::lazy_static! {
    /// Track preloaded wallpapers to avoid redundant preloads
    static ref PRELOADED: Mutex<HashSet<String>> = Mutex::new(HashSet::new());
}

/// Preload a wallpaper image into hyprpaper memory
pub fn preload(path: &Path) -> Result<()> {
    let path_str = path.to_string_lossy().to_string();

    // Check if already preloaded
    {
        let preloaded = PRELOADED.lock().unwrap();
        if preloaded.contains(&path_str) {
            return Ok(());
        }
    }

    let output = Command::new("hyprctl")
        .args(["hyprpaper", "preload", &path_str])
        .output()
        .context("Failed to execute hyprctl")?;

    if !output.status.success() {
        let stderr = String::from_utf8_lossy(&output.stderr);
        // Don't fail if already preloaded
        if !stderr.contains("already") {
            anyhow::bail!("hyprpaper preload failed: {}", stderr);
        }
    }

    // Mark as preloaded
    {
        let mut preloaded = PRELOADED.lock().unwrap();
        preloaded.insert(path_str);
    }

    Ok(())
}

/// Set wallpaper for a specific monitor
pub fn set_wallpaper(monitor: &str, path: &Path) -> Result<()> {
    let path_str = path.to_string_lossy().to_string();
    let arg = format!("{},{}", monitor, path_str);

    let output = Command::new("hyprctl")
        .args(["hyprpaper", "wallpaper", &arg])
        .output()
        .context("Failed to execute hyprctl")?;

    if !output.status.success() {
        let stderr = String::from_utf8_lossy(&output.stderr);
        anyhow::bail!("hyprpaper set wallpaper failed: {}", stderr);
    }

    Ok(())
}

/// Apply wallpaper to a monitor (preload + set in one call)
pub fn apply_wallpaper(monitor: &str, path: &Path) -> Result<()> {
    preload(path)?;
    set_wallpaper(monitor, path)?;
    Ok(())
}

/// Unload a wallpaper from hyprpaper to free memory
pub fn unload(path: &Path) -> Result<()> {
    let path_str = path.to_string_lossy().to_string();

    let output = Command::new("hyprctl")
        .args(["hyprpaper", "unload", &path_str])
        .output()
        .context("Failed to execute hyprctl")?;

    if output.status.success() {
        // Remove from preloaded set
        let mut preloaded = PRELOADED.lock().unwrap();
        preloaded.remove(&path_str);
    }

    Ok(())
}

/// List currently loaded wallpapers
pub fn list_loaded() -> Result<Vec<String>> {
    let output = Command::new("hyprctl")
        .args(["hyprpaper", "listloaded"])
        .output()
        .context("Failed to execute hyprctl")?;

    let stdout = String::from_utf8_lossy(&output.stdout);
    let loaded: Vec<String> = stdout
        .lines()
        .filter(|l| !l.is_empty())
        .map(|l| l.to_string())
        .collect();

    Ok(loaded)
}

/// List active wallpapers (monitor -> path mapping)
pub fn list_active() -> Result<Vec<(String, String)>> {
    let output = Command::new("hyprctl")
        .args(["hyprpaper", "listactive"])
        .output()
        .context("Failed to execute hyprctl")?;

    let stdout = String::from_utf8_lossy(&output.stdout);
    let active: Vec<(String, String)> = stdout
        .lines()
        .filter_map(|line| {
            let parts: Vec<&str> = line.split(" = ").collect();
            if parts.len() == 2 {
                Some((parts[0].to_string(), parts[1].to_string()))
            } else {
                None
            }
        })
        .collect();

    Ok(active)
}
```

Add lazy_static to Cargo.toml dependencies:
```toml
lazy_static = "1.4"
```

Update services/mod.rs:
```rust
pub mod hyprctl;
pub mod hyprpaper;
pub mod thumbnail;
```
  </action>
  <verify>
cd vulcan-wallpaper-manager && cargo check
  </verify>
  <done>Hyprpaper service compiles with preload tracking</done>
</task>

<task type="auto">
  <name>Task 2: Integrate components in main app</name>
  <files>
    vulcan-wallpaper-manager/src/app.rs
  </files>
  <action>
Update app.rs to integrate wallpaper picker and wire up wallpaper application:

```rust
use gtk::prelude::*;
use relm4::prelude::*;
use adw::prelude::*;
use std::path::PathBuf;
use std::collections::HashMap;

use crate::models::{Monitor, Wallpaper};
use crate::services::{hyprctl, hyprpaper, thumbnail};
use crate::components::monitor_layout::{MonitorLayoutModel, MonitorLayoutInput, MonitorLayoutOutput};
use crate::components::wallpaper_picker::{WallpaperPickerModel, WallpaperPickerInput, WallpaperPickerOutput};

#[derive(Debug)]
pub enum AppMsg {
    MonitorSelected(String),
    WallpaperSelected(PathBuf),
    ApplyWallpaper,
    RefreshMonitors,
    OpenDirectory,
}

pub struct App {
    monitors: Vec<Monitor>,
    selected_monitor: Option<String>,
    selected_wallpaper: Option<PathBuf>,
    monitor_wallpapers: HashMap<String, PathBuf>,
    monitor_layout: Controller<MonitorLayoutModel>,
    wallpaper_picker: Controller<WallpaperPickerModel>,
}

#[relm4::component(pub)]
impl SimpleComponent for App {
    type Init = ();
    type Input = AppMsg;
    type Output = ();

    view! {
        adw::ApplicationWindow {
            set_title: Some("VulcanOS Wallpaper Manager"),
            set_default_size: (1000, 700),

            adw::ToolbarView {
                add_top_bar = &adw::HeaderBar {
                    #[wrap(Some)]
                    set_title_widget = &adw::WindowTitle {
                        set_title: "Wallpaper Manager",
                        #[watch]
                        set_subtitle: &format!(
                            "{}",
                            model.selected_monitor.as_deref().unwrap_or("Select a monitor")
                        ),
                    },

                    pack_start = &gtk::Button {
                        set_icon_name: "folder-open-symbolic",
                        set_tooltip_text: Some("Open wallpaper folder"),
                        connect_clicked => AppMsg::OpenDirectory,
                    },

                    pack_end = &gtk::Button {
                        set_icon_name: "view-refresh-symbolic",
                        set_tooltip_text: Some("Refresh"),
                        connect_clicked => AppMsg::RefreshMonitors,
                    },
                },

                #[wrap(Some)]
                set_content = &gtk::Paned {
                    set_orientation: gtk::Orientation::Vertical,
                    set_shrink_start_child: false,
                    set_shrink_end_child: false,
                    set_position: 350,

                    // Top: Monitor layout
                    #[wrap(Some)]
                    set_start_child = &gtk::Frame {
                        set_margin_all: 12,

                        gtk::Box {
                            set_orientation: gtk::Orientation::Vertical,
                            set_spacing: 8,

                            gtk::Label {
                                set_markup: "<b>Monitor Layout</b>",
                                set_halign: gtk::Align::Start,
                            },

                            model.monitor_layout.widget() {},
                        },
                    },

                    // Bottom: Wallpaper picker
                    #[wrap(Some)]
                    set_end_child = &gtk::Frame {
                        set_margin_all: 12,

                        gtk::Box {
                            set_orientation: gtk::Orientation::Vertical,
                            set_spacing: 8,

                            gtk::Box {
                                set_orientation: gtk::Orientation::Horizontal,
                                set_spacing: 12,

                                gtk::Label {
                                    set_markup: "<b>Wallpapers</b>",
                                    set_halign: gtk::Align::Start,
                                    set_hexpand: true,
                                },

                                gtk::Button {
                                    set_label: "Apply",
                                    #[watch]
                                    set_sensitive: model.selected_monitor.is_some() && model.selected_wallpaper.is_some(),
                                    add_css_class: "suggested-action",
                                    connect_clicked => AppMsg::ApplyWallpaper,
                                },
                            },

                            model.wallpaper_picker.widget() {},
                        },
                    },
                },
            },
        }
    }

    fn init(
        _init: Self::Init,
        root: Self::Root,
        sender: ComponentSender<Self>,
    ) -> ComponentParts<Self> {
        // Load monitors on startup
        let monitors = hyprctl::get_monitors().unwrap_or_default();

        // Load current wallpaper assignments
        let mut monitor_wallpapers = HashMap::new();
        if let Ok(active) = hyprpaper::list_active() {
            for (mon, path) in active {
                monitor_wallpapers.insert(mon, PathBuf::from(path));
            }
        }

        // Create monitor layout component
        let monitor_layout = MonitorLayoutModel::builder()
            .launch(monitors.clone())
            .forward(sender.input_sender(), |msg| {
                match msg {
                    MonitorLayoutOutput::Selected(name) => AppMsg::MonitorSelected(name),
                }
            });

        // Create wallpaper picker component
        let wallpaper_dir = thumbnail::default_wallpaper_dir();
        let wallpaper_picker = WallpaperPickerModel::builder()
            .launch(wallpaper_dir)
            .forward(sender.input_sender(), |msg| {
                match msg {
                    WallpaperPickerOutput::Selected(path) => AppMsg::WallpaperSelected(path),
                }
            });

        let model = App {
            monitors,
            selected_monitor: None,
            selected_wallpaper: None,
            monitor_wallpapers,
            monitor_layout,
            wallpaper_picker,
        };

        let widgets = view_output!();

        ComponentParts { model, widgets }
    }

    fn update(&mut self, msg: Self::Input, _sender: ComponentSender<Self>) {
        match msg {
            AppMsg::MonitorSelected(name) => {
                self.selected_monitor = Some(name.clone());
                println!("Selected monitor: {}", name);
            }

            AppMsg::WallpaperSelected(path) => {
                self.selected_wallpaper = Some(path.clone());
                println!("Selected wallpaper: {}", path.display());
            }

            AppMsg::ApplyWallpaper => {
                if let (Some(monitor), Some(path)) = (&self.selected_monitor, &self.selected_wallpaper) {
                    match hyprpaper::apply_wallpaper(monitor, path) {
                        Ok(()) => {
                            println!("Applied {} to {}", path.display(), monitor);
                            self.monitor_wallpapers.insert(monitor.clone(), path.clone());
                        }
                        Err(e) => {
                            eprintln!("Failed to apply wallpaper: {}", e);
                        }
                    }
                }
            }

            AppMsg::RefreshMonitors => {
                if let Ok(monitors) = hyprctl::get_monitors() {
                    self.monitors = monitors.clone();
                    self.monitor_layout.emit(MonitorLayoutInput::UpdateMonitors(monitors));
                }
                self.wallpaper_picker.emit(WallpaperPickerInput::Refresh);
            }

            AppMsg::OpenDirectory => {
                let dir = thumbnail::default_wallpaper_dir();
                if let Err(e) = std::process::Command::new("xdg-open")
                    .arg(&dir)
                    .spawn()
                {
                    eprintln!("Failed to open directory: {}", e);
                }
            }
        }
    }
}
```
  </action>
  <verify>
cd vulcan-wallpaper-manager && cargo build
  </verify>
  <done>App integrates both components with Apply button wired to hyprpaper</done>
</task>

<task type="auto">
  <name>Task 3: Test end-to-end wallpaper application</name>
  <files>
    vulcan-wallpaper-manager/src/main.rs
  </files>
  <action>
Test the complete wallpaper application flow:

1. Ensure hyprpaper is running:
```bash
# Check if hyprpaper is running
pgrep hyprpaper || echo "hyprpaper not running - start it first"
```

2. Ensure test wallpapers exist:
```bash
mkdir -p ~/Pictures/Wallpapers
ls ~/Pictures/Wallpapers/*.{png,jpg} 2>/dev/null || echo "Add some wallpapers to test"
```

3. Run the application:
```bash
cd vulcan-wallpaper-manager && cargo run
```

4. Verify functionality:
- Window opens with monitor layout on top, wallpaper picker on bottom
- Clicking a monitor in the layout highlights it and shows name in subtitle
- Thumbnails appear in the picker grid
- Clicking a wallpaper selects it
- Apply button becomes active when both monitor and wallpaper selected
- Clicking Apply changes the actual wallpaper on that monitor
  </action>
  <verify>
# Test hyprpaper is responding
hyprctl hyprpaper listactive && echo "hyprpaper IPC working"
  </verify>
  <done>Full workflow works: select monitor, select wallpaper, click Apply, wallpaper changes on screen</done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. Application opens with split pane (monitors top, wallpapers bottom)
3. Monitor selection updates header bar subtitle
4. Wallpaper thumbnails display in scrollable grid
5. Apply button only enabled when both monitor and wallpaper selected
6. `hyprctl hyprpaper listactive` shows the applied wallpaper after clicking Apply
</verification>

<success_criteria>
- Monitor layout and wallpaper picker integrated in single window
- Selecting monitor highlights it and enables wallpaper selection
- Applying wallpaper calls hyprpaper IPC and wallpaper appears on screen
- Refresh button reloads monitors and wallpaper list
- Folder button opens ~/Pictures/Wallpapers in file manager
- Error handling shows messages for IPC failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-vulcanos-wallpaper-manager/05-04-SUMMARY.md`
</output>
