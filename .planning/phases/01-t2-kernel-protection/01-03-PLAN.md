---
phase: 01-t2-kernel-protection
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
  - archiso/airootfs/etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
  - archiso/airootfs/etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
  - archiso/airootfs/usr/local/bin/vulcan-kernel-protect
  - archiso/airootfs/usr/local/bin/vulcan-kernel-warn
  - archiso/airootfs/usr/local/bin/vulcan-kernel-verify
  - archiso/airootfs/usr/local/bin/vulcan-kernel-fallback
autonomous: false

must_haves:
  truths:
    - "Fresh VulcanOS installations have kernel protection enabled by default"
    - "All protection scripts are included in ISO build"
    - "Protection chain works end-to-end on live system"
  artifacts:
    - path: "archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook"
      provides: "ISO skeleton protection hook"
      contains: "AbortOnFail"
    - path: "archiso/airootfs/usr/local/bin/vulcan-kernel-protect"
      provides: "ISO skeleton protection script"
      min_lines: 50
    - path: "archiso/airootfs/usr/local/bin/vulcan-kernel-fallback"
      provides: "ISO skeleton fallback generator"
      min_lines: 40
  key_links:
    - from: "archiso hooks"
      to: "archiso scripts"
      via: "Exec path matches"
      pattern: "Exec = /usr/local/bin/vulcan-kernel"
---

<objective>
Sync kernel protection infrastructure to archiso skeleton and verify end-to-end protection chain.

Purpose: Ensure fresh VulcanOS installations have T2 kernel protection enabled by default, and validate the complete protection chain works correctly.

Output: All hooks and scripts synced to archiso/airootfs/ with verified end-to-end functionality.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-t2-kernel-protection/01-CONTEXT.md
@.planning/phases/01-t2-kernel-protection/01-01-SUMMARY.md
@.planning/phases/01-t2-kernel-protection/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync Protection Infrastructure to Archiso</name>
  <files>
    archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
    archiso/airootfs/etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
    archiso/airootfs/etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
    archiso/airootfs/usr/local/bin/vulcan-kernel-protect
    archiso/airootfs/usr/local/bin/vulcan-kernel-warn
    archiso/airootfs/usr/local/bin/vulcan-kernel-verify
    archiso/airootfs/usr/local/bin/vulcan-kernel-fallback
  </files>
  <action>
Create the hooks directory if needed:
```bash
mkdir -p /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks
mkdir -p /home/evan/VulcanOS/archiso/airootfs/usr/local/bin
```

Copy all hooks from live system to archiso skeleton:
```bash
cp /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/

cp /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/

cp /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/
```

Copy all scripts from live system to archiso skeleton:
```bash
cp /usr/local/bin/vulcan-kernel-protect \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-warn \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-verify \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-fallback \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/
```

Verify permissions are correct (scripts need +x):
```bash
chmod +x /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/vulcan-kernel-*
```

Verify file contents match between live system and archiso skeleton.
  </action>
  <verify>
1. Hooks directory exists: `ls -la /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/`
2. All hooks present: `ls /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/*.hook | wc -l` equals 3
3. All scripts present: `ls /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/vulcan-kernel-* | wc -l` equals 4
4. Scripts executable: All vulcan-kernel-* scripts have +x permission
5. Content matches: `diff /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook` shows no differences
  </verify>
  <done>
All kernel protection hooks and scripts synced to archiso skeleton with correct permissions. Files match live system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Automated Smoke Tests</name>
  <files>
    (no files created - testing existing scripts)
  </files>
  <action>
Run automated smoke tests to validate all scripts work before human verification.

**Test 1: Script existence and permissions**
```bash
# All 4 scripts exist and are executable
for script in vulcan-kernel-protect vulcan-kernel-warn vulcan-kernel-verify vulcan-kernel-fallback; do
  test -x "/usr/local/bin/$script" || { echo "FAIL: $script missing or not executable"; exit 1; }
done
echo "PASS: All scripts exist and are executable"
```

**Test 2: Protection script blocks mainline kernels**
```bash
# Test each mainline kernel name - all should exit 1
for kernel in linux linux-lts linux-zen linux-hardened; do
  echo "$kernel" | sudo /usr/local/bin/vulcan-kernel-protect 2>/dev/null
  if [ $? -eq 0 ]; then
    echo "FAIL: $kernel was not blocked"
    exit 1
  fi
done
echo "PASS: All mainline kernels blocked"
```

**Test 3: Protection script allows linux-t2**
```bash
# linux-t2 should exit 0 (assuming /boot mounted)
if mountpoint -q /boot 2>/dev/null || [ -d /boot/grub ]; then
  echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-protect 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "FAIL: linux-t2 was blocked incorrectly"
    exit 1
  fi
  echo "PASS: linux-t2 allowed"
else
  echo "SKIP: /boot not mounted, cannot test linux-t2 allowance"
fi
```

**Test 4: Warning script exits 0**
```bash
# Warning script should never block (always exit 0)
echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-warn 2>/dev/null
if [ $? -ne 0 ]; then
  echo "FAIL: warning script exited non-zero"
  exit 1
fi
echo "PASS: Warning script exits 0"
```

**Test 5: Verification script produces output**
```bash
# Verification script should run and produce output
output=$(sudo /usr/local/bin/vulcan-kernel-verify 2>&1)
if [ -z "$output" ]; then
  echo "FAIL: verification script produced no output"
  exit 1
fi
echo "PASS: Verification script produces output"
echo "$output" | head -10
```

**Test 6: Fallback script syntax check**
```bash
# Check fallback script can at least parse (bash -n)
bash -n /usr/local/bin/vulcan-kernel-fallback
if [ $? -ne 0 ]; then
  echo "FAIL: fallback script has syntax errors"
  exit 1
fi
echo "PASS: Fallback script syntax valid"
```

Print summary of all automated tests.
  </action>
  <verify>
All 6 automated smoke tests pass:
1. Script existence: All 4 scripts exist with +x
2. Mainline blocking: linux, linux-lts, linux-zen, linux-hardened all blocked (exit 1)
3. linux-t2 allowed: Exits 0 when /boot is mounted
4. Warning non-blocking: vulcan-kernel-warn always exits 0
5. Verification output: vulcan-kernel-verify produces formatted output
6. Fallback syntax: bash -n passes on vulcan-kernel-fallback
  </verify>
  <done>
All automated smoke tests pass. Scripts are functional and ready for human verification of actual pacman blocking and GRUB menu appearance.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify End-to-End Protection Chain</name>
  <what-built>
Complete T2 kernel protection system:
- PreTransaction protection hook (blocks mainline kernels, checks /boot mount)
- PreTransaction warning hook (notifies user of kernel updates)
- PostTransaction verification hook (validates boot chain)
- Fallback generator (backs up kernels, creates GRUB entries)

Automated smoke tests have confirmed:
- All scripts exist and are executable
- Mainline kernels (linux, linux-lts, linux-zen, linux-hardened) are blocked
- linux-t2 is allowed when /boot is mounted
- Warning script is non-blocking
- Verification script produces output
- Fallback script has valid syntax
  </what-built>
  <how-to-verify>
**Test 1: Live Pacman Blocking (the real test)**
```bash
# This should be blocked with clear error
sudo pacman -S linux --noconfirm
# Expected: Transaction aborted with T2 protection message
```

**Test 2: Notification Delivery**
```bash
# Trigger warning script and verify notification appears on desktop
echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-warn
# Expected: Desktop notification appears with kernel info
```

**Test 3: Fallback Generation (if not already done)**
```bash
sudo /usr/local/bin/vulcan-kernel-fallback
cat /boot/grub/custom.cfg
# Expected: Valid GRUB menuentry with correct UUID (not placeholder)
```

**Test 4: GRUB Menu Verification (requires reboot)**
Reboot and check GRUB menu for fallback entry appearance.
- Fallback entry visible in main GRUB menu
- Entry boots successfully if selected
  </how-to-verify>
  <resume-signal>Type "approved" if protection chain works end-to-end, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. Archiso structure complete:
   - All hooks in archiso/airootfs/etc/pacman.d/hooks/
   - All scripts in archiso/airootfs/usr/local/bin/

2. Automated smoke tests passed:
   - Script existence verified
   - Mainline blocking confirmed
   - linux-t2 allowance confirmed
   - Warning non-blocking confirmed
   - Verification output confirmed
   - Fallback syntax valid

3. Human verification confirmed:
   - Live pacman blocking works
   - Notifications delivered
   - GRUB fallback entry visible

4. Ready for ISO build:
   - Files will be included in next ISO build
   - Permissions correct for execution
</verification>

<success_criteria>
- All 3 hooks synced to archiso/airootfs/etc/pacman.d/hooks/
- All 4 scripts synced to archiso/airootfs/usr/local/bin/ with +x permission
- Automated smoke tests all pass (6 tests)
- End-to-end testing confirms:
  - Mainline kernels blocked by live pacman
  - linux-t2 updates allowed with warning
  - Boot chain verification accurate
  - Fallback kernel backup functional
  - GRUB fallback entry created
- User has confirmed protection chain works via checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-t2-kernel-protection/01-03-SUMMARY.md`
</output>
