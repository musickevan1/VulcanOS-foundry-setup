---
phase: 01-t2-kernel-protection
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
  - archiso/airootfs/etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
  - archiso/airootfs/etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
  - archiso/airootfs/usr/local/bin/vulcan-kernel-protect
  - archiso/airootfs/usr/local/bin/vulcan-kernel-warn
  - archiso/airootfs/usr/local/bin/vulcan-kernel-verify
  - archiso/airootfs/usr/local/bin/vulcan-kernel-fallback
autonomous: false

must_haves:
  truths:
    - "Fresh VulcanOS installations have kernel protection enabled by default"
    - "All protection scripts are included in ISO build"
    - "Protection chain works end-to-end on live system"
  artifacts:
    - path: "archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook"
      provides: "ISO skeleton protection hook"
      contains: "AbortOnFail"
    - path: "archiso/airootfs/usr/local/bin/vulcan-kernel-protect"
      provides: "ISO skeleton protection script"
      min_lines: 50
    - path: "archiso/airootfs/usr/local/bin/vulcan-kernel-fallback"
      provides: "ISO skeleton fallback generator"
      min_lines: 40
  key_links:
    - from: "archiso hooks"
      to: "archiso scripts"
      via: "Exec path matches"
      pattern: "Exec = /usr/local/bin/vulcan-kernel"
---

<objective>
Sync kernel protection infrastructure to archiso skeleton and verify end-to-end protection chain.

Purpose: Ensure fresh VulcanOS installations have T2 kernel protection enabled by default, and validate the complete protection chain works correctly.

Output: All hooks and scripts synced to archiso/airootfs/ with verified end-to-end functionality.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-t2-kernel-protection/01-CONTEXT.md
@.planning/phases/01-t2-kernel-protection/01-01-SUMMARY.md
@.planning/phases/01-t2-kernel-protection/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync Protection Infrastructure to Archiso</name>
  <files>
    archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
    archiso/airootfs/etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
    archiso/airootfs/etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
    archiso/airootfs/usr/local/bin/vulcan-kernel-protect
    archiso/airootfs/usr/local/bin/vulcan-kernel-warn
    archiso/airootfs/usr/local/bin/vulcan-kernel-verify
    archiso/airootfs/usr/local/bin/vulcan-kernel-fallback
  </files>
  <action>
Create the hooks directory if needed:
```bash
mkdir -p /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks
mkdir -p /home/evan/VulcanOS/archiso/airootfs/usr/local/bin
```

Copy all hooks from live system to archiso skeleton:
```bash
cp /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/

cp /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/

cp /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook \
   /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/
```

Copy all scripts from live system to archiso skeleton:
```bash
cp /usr/local/bin/vulcan-kernel-protect \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-warn \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-verify \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/

cp /usr/local/bin/vulcan-kernel-fallback \
   /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/
```

Verify permissions are correct (scripts need +x):
```bash
chmod +x /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/vulcan-kernel-*
```

Verify file contents match between live system and archiso skeleton.
  </action>
  <verify>
1. Hooks directory exists: `ls -la /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/`
2. All hooks present: `ls /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/*.hook | wc -l` equals 3
3. All scripts present: `ls /home/evan/VulcanOS/archiso/airootfs/usr/local/bin/vulcan-kernel-* | wc -l` equals 4
4. Scripts executable: All vulcan-kernel-* scripts have +x permission
5. Content matches: `diff /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook /home/evan/VulcanOS/archiso/airootfs/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook` shows no differences
  </verify>
  <done>
All kernel protection hooks and scripts synced to archiso skeleton with correct permissions. Files match live system.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify End-to-End Protection Chain</name>
  <what-built>
Complete T2 kernel protection system:
- PreTransaction protection hook (blocks mainline kernels, checks /boot mount)
- PreTransaction warning hook (notifies user of kernel updates)
- PostTransaction verification hook (validates boot chain)
- Fallback generator (backs up kernels, creates GRUB entries)
  </what-built>
  <how-to-verify>
**Test 1: Mainline Kernel Blocking**
```bash
# This should be blocked with clear error
sudo pacman -S linux --noconfirm
# Expected: Transaction aborted with T2 protection message
```

**Test 2: /boot Mount Check**
```bash
# Unmount /boot temporarily (if separate partition)
# Or simulate with: echo "linux-t2" | sudo VULCAN_UNSAFE=1 /usr/local/bin/vulcan-kernel-protect
# Expected: Either unmount fails (nested) or script detects unmounted /boot
```

**Test 3: Warning Notification**
```bash
# Trigger warning script manually
echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-warn
# Expected: Desktop notification appears with kernel info
```

**Test 4: Verification Output**
```bash
sudo /usr/local/bin/vulcan-kernel-verify
# Expected: Formatted output showing kernel, initramfs, T2 modules, GRUB status
```

**Test 5: Fallback Generation**
```bash
sudo /usr/local/bin/vulcan-kernel-fallback
# Expected: Backup files created, custom.cfg generated
cat /boot/grub/custom.cfg
# Expected: Valid GRUB menuentry with correct UUID
```

**Test 6: GRUB Menu Verification (requires reboot)**
Reboot and check GRUB menu for fallback entry appearance.
- Fallback entry visible in main GRUB menu
- Entry boots successfully if selected
  </how-to-verify>
  <resume-signal>Type "approved" if protection chain works end-to-end, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After completing both tasks:

1. Archiso structure complete:
   - All hooks in archiso/airootfs/etc/pacman.d/hooks/
   - All scripts in archiso/airootfs/usr/local/bin/

2. Protection chain validated:
   - Mainline kernel installation blocked
   - Warning notifications sent
   - Verification produces accurate output
   - Fallback kernel backup created
   - GRUB entry generated correctly

3. Ready for ISO build:
   - Files will be included in next ISO build
   - Permissions correct for execution
</verification>

<success_criteria>
- All 3 hooks synced to archiso/airootfs/etc/pacman.d/hooks/
- All 4 scripts synced to archiso/airootfs/usr/local/bin/ with +x permission
- End-to-end testing confirms:
  - Mainline kernels blocked
  - linux-t2 updates allowed with warning
  - Boot chain verification accurate
  - Fallback kernel backup functional
  - GRUB fallback entry created
- User has confirmed protection chain works via checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-t2-kernel-protection/01-03-SUMMARY.md`
</output>
