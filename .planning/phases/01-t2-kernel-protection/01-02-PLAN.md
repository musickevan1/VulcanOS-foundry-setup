---
phase: 01-t2-kernel-protection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
  - /usr/local/bin/vulcan-kernel-verify
  - /usr/local/bin/vulcan-kernel-fallback
  - /boot/grub/custom.cfg
autonomous: true

must_haves:
  truths:
    - "User can verify initramfs was generated successfully after kernel operations"
    - "User can run vulcan-kernel-verify manually to check boot chain"
    - "GRUB menu shows previous kernel version as fallback boot option"
    - "Fallback kernel files are preserved during kernel updates"
  artifacts:
    - path: "/etc/pacman.d/hooks/90-vulcan-kernel-verify.hook"
      provides: "PostTransaction hook triggering verification"
      contains: "PostTransaction"
    - path: "/usr/local/bin/vulcan-kernel-verify"
      provides: "Boot chain verification - initramfs, T2 modules, GRUB config"
      min_lines: 60
    - path: "/usr/local/bin/vulcan-kernel-fallback"
      provides: "Fallback kernel backup and GRUB entry generator"
      min_lines: 40
    - path: "/boot/grub/custom.cfg"
      provides: "GRUB fallback boot entries that survive grub-mkconfig"
      contains: "menuentry"
  key_links:
    - from: "90-vulcan-kernel-verify.hook"
      to: "vulcan-kernel-verify"
      via: "Exec directive"
      pattern: "Exec = /usr/local/bin/vulcan-kernel-verify"
    - from: "vulcan-kernel-verify"
      to: "lsinitcpio"
      via: "initramfs inspection"
      pattern: "lsinitcpio"
    - from: "vulcan-kernel-fallback"
      to: "/boot/grub/custom.cfg"
      via: "writes GRUB entries"
      pattern: "cat > .*/custom.cfg"
---

<objective>
Create verification and fallback infrastructure for T2 kernel protection.

Purpose: Ensure boot chain integrity after kernel updates and provide fallback boot options in case new kernel fails.

Output: PostTransaction verification hook, manual verification command, and GRUB fallback entry generator with kernel backup functionality.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-t2-kernel-protection/01-CONTEXT.md
@.planning/phases/01-t2-kernel-protection/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostTransaction Verification Hook and Script</name>
  <files>
    /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
    /usr/local/bin/vulcan-kernel-verify
  </files>
  <action>
Create the verification hook at /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook:

```ini
[Trigger]
Type = Path
Operation = Install
Operation = Upgrade
Target = usr/lib/modules/*/vmlinuz
Target = boot/vmlinuz-*
Target = boot/initramfs-*.img

[Action]
Description = Verifying T2 kernel boot chain integrity...
When = PostTransaction
Exec = /usr/local/bin/vulcan-kernel-verify
```

Note: Uses Path trigger (not Package) to detect kernel file changes. No AbortOnFail since we're verifying AFTER the transaction - damage would already be done, we're just reporting status.

Create the verification script at /usr/local/bin/vulcan-kernel-verify:

The script must perform full boot chain verification:

1. **Kernel Image Check:**
   - Verify /boot/vmlinuz-linux-t2 exists
   - Report file size (human readable)
   - Get kernel version from `pacman -Q linux-t2`

2. **Initramfs Check:**
   - Verify /boot/initramfs-linux-t2.img exists
   - Report file size
   - Check /boot/initramfs-linux-t2-fallback.img exists

3. **T2 Module Verification (critical):**
   - Use `lsinitcpio /boot/initramfs-linux-t2.img` to list contents
   - Check for required T2 modules: apple_bce, applespi, intel_lpss_pci, spi_pxa2xx_platform
   - Report which modules are present vs missing
   - If ANY required module missing: report ERROR, exit 1

4. **GRUB Config Check:**
   - Verify /boot/grub/grub.cfg exists
   - Run `grub-script-check /boot/grub/grub.cfg` for syntax validation
   - Report valid or invalid

5. **Fallback Kernel Check:**
   - Check if /boot/vmlinuz-linux-t2.backup exists
   - Check if /boot/initramfs-linux-t2.backup.img exists
   - Report fallback status

6. **Summary Output:**
   - Print formatted summary with checkmarks or X marks
   - Send desktop notification with result (success or failure)
   - Exit 0 if all critical checks pass, exit 1 if any critical check fails

Format output clearly for both terminal (colored output) and log file:
```
=== VulcanOS Kernel Verification ===
[OK] Kernel image: /boot/vmlinuz-linux-t2 (12 MB)
[OK] Initramfs: /boot/initramfs-linux-t2.img (45 MB)
[OK] T2 modules present in initramfs:
     - apple_bce
     - applespi
     - intel_lpss_pci
     - spi_pxa2xx_platform
[OK] GRUB configuration valid
[WARN] No fallback kernel found

=== Verification Complete ===
Kernel version: 6.6.68-1-t2
Boot chain ready. Reboot to load new kernel.
```

Log to /var/log/vulcan-kernel-verify.log with timestamps.
  </action>
  <verify>
1. Hook file exists: `ls -la /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook`
2. Script is executable: `ls -la /usr/local/bin/vulcan-kernel-verify`
3. Manual run works: `sudo /usr/local/bin/vulcan-kernel-verify` produces verification output
4. Script checks T2 modules: `grep -q "apple_bce" /usr/local/bin/vulcan-kernel-verify`
5. Script uses lsinitcpio: `grep -q "lsinitcpio" /usr/local/bin/vulcan-kernel-verify`
  </verify>
  <done>
Verification hook and script exist, check kernel image, initramfs, T2 modules, GRUB config, and fallback status. Manual run produces clear status report.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GRUB Fallback Generator Script</name>
  <files>
    /usr/local/bin/vulcan-kernel-fallback
    /boot/grub/custom.cfg
  </files>
  <action>
Create the fallback generator script at /usr/local/bin/vulcan-kernel-fallback:

The script must:

1. **Backup Current Kernel:**
   - Copy /boot/vmlinuz-linux-t2 to /boot/vmlinuz-linux-t2.backup
   - Copy /boot/initramfs-linux-t2.img to /boot/initramfs-linux-t2.backup.img
   - Store kernel version in /boot/vulcan-fallback-version.txt

2. **Maintain Two Fallback Kernels (per CONTEXT.md):**
   - If vmlinuz-linux-t2.backup exists, move to vmlinuz-linux-t2.backup2
   - Same for initramfs files
   - When limit (2) reached, remove oldest (.backup2)

3. **Get System Configuration:**
   - Get root UUID: `findmnt -n -o UUID /`
   - Get current kernel version: `pacman -Q linux-t2 | awk '{print $2}'`
   - Get T2-required kernel parameters from existing grub.cfg or use defaults: `intel_iommu=on iommu=pt pcie_ports=compat`

4. **Generate /boot/grub/custom.cfg:**
   ```
   # VulcanOS T2 Kernel Fallback Entries
   # Generated: [timestamp]
   # DO NOT EDIT MANUALLY - regenerated by vulcan-kernel-fallback

   menuentry 'Arch Linux (T2 Fallback: [VERSION])' --class arch --class gnu-linux {
       load_video
       set gfxpayload=keep
       insmod gzio
       insmod part_gpt
       insmod ext2
       search --no-floppy --fs-uuid --set=root [ROOT_UUID]
       echo 'Loading fallback kernel linux-t2 [VERSION]...'
       linux /boot/vmlinuz-linux-t2.backup root=UUID=[ROOT_UUID] rw intel_iommu=on iommu=pt pcie_ports=compat
       initrd /boot/initramfs-linux-t2.backup.img
   }

   # Second fallback if available
   menuentry 'Arch Linux (T2 Fallback 2: [VERSION2])' ... {
       ...
   }
   ```

5. **Output:**
   - Report which files were backed up
   - Report GRUB entries created
   - Confirm custom.cfg written (no grub-mkconfig needed)
   - Log to /var/log/vulcan-kernel-fallback.log

Per CONTEXT.md: Fallback entries visible directly in GRUB main menu (custom.cfg is sourced by /etc/grub.d/41_custom automatically).

Make script callable both manually (`vulcan-kernel-fallback`) and from protection hooks.
  </action>
  <verify>
1. Script is executable: `ls -la /usr/local/bin/vulcan-kernel-fallback`
2. Manual run works: `sudo /usr/local/bin/vulcan-kernel-fallback` creates backup files
3. Backup files created: `ls -la /boot/vmlinuz-linux-t2.backup /boot/initramfs-linux-t2.backup.img`
4. custom.cfg generated: `cat /boot/grub/custom.cfg` shows menuentry
5. GRUB entry syntax valid: `grep -q "menuentry" /boot/grub/custom.cfg`
6. Root UUID populated: custom.cfg contains actual UUID, not placeholder
  </verify>
  <done>
Fallback generator script creates kernel backups, maintains two fallback versions with rotation, generates GRUB custom.cfg with proper boot entries using correct UUID and T2 kernel parameters.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Verification runs cleanly:
   - `sudo /usr/local/bin/vulcan-kernel-verify` produces formatted output
   - All critical checks pass (or report clear errors)

2. Fallback infrastructure works:
   - `sudo /usr/local/bin/vulcan-kernel-fallback` creates backup files
   - /boot/grub/custom.cfg exists with valid GRUB entries
   - Running fallback twice rotates backup -> backup2

3. GRUB recognizes fallback entries:
   - `sudo grub-mkconfig -o /dev/null 2>&1 | grep -i vulcan` or check GRUB menu manually

4. Hook ordering:
   - 90-vulcan-kernel-verify.hook runs after kernel operations complete
</verification>

<success_criteria>
- PostTransaction verification hook installed at /etc/pacman.d/hooks/90-vulcan-kernel-verify.hook
- vulcan-kernel-verify script checks: kernel, initramfs, T2 modules (apple_bce, applespi, etc.), GRUB config, fallback status
- vulcan-kernel-verify usable both automatically (via hook) and manually
- vulcan-kernel-fallback script backs up current kernel before updates
- Two fallback kernel versions maintained with automatic rotation
- /boot/grub/custom.cfg generated with proper GRUB entries
- Fallback entries use correct root UUID and T2 kernel parameters
- All scripts log to /var/log/vulcan-*.log
</success_criteria>

<output>
After completion, create `.planning/phases/01-t2-kernel-protection/01-02-SUMMARY.md`
</output>
