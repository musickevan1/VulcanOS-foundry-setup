---
phase: 01-t2-kernel-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
  - /usr/local/bin/vulcan-kernel-protect
  - /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
  - /usr/local/bin/vulcan-kernel-warn
autonomous: true

must_haves:
  truths:
    - "Pacman refuses to install mainline linux kernel (linux, linux-lts, linux-zen, linux-hardened)"
    - "Pacman aborts if /boot is not mounted before kernel operations"
    - "User sees desktop notification warning before kernel update proceeds"
    - "Terminal output shows clear error messages when protection blocks operation"
  artifacts:
    - path: "/etc/pacman.d/hooks/10-vulcan-kernel-protect.hook"
      provides: "PreTransaction hook triggering protection script"
      contains: "AbortOnFail"
    - path: "/usr/local/bin/vulcan-kernel-protect"
      provides: "Protection logic - mount check, kernel blocking, fallback check"
      min_lines: 50
    - path: "/etc/pacman.d/hooks/20-vulcan-kernel-warn.hook"
      provides: "PreTransaction hook triggering warning script"
      contains: "PreTransaction"
    - path: "/usr/local/bin/vulcan-kernel-warn"
      provides: "Warning notification with kernel version info"
      min_lines: 20
  key_links:
    - from: "10-vulcan-kernel-protect.hook"
      to: "vulcan-kernel-protect"
      via: "Exec directive"
      pattern: "Exec = /usr/local/bin/vulcan-kernel-protect"
    - from: "vulcan-kernel-protect"
      to: "notify-send"
      via: "desktop notification"
      pattern: "notify-send.*--urgency=critical"
---

<objective>
Create pacman hooks and scripts that block dangerous kernel operations and warn users before kernel updates.

Purpose: Prevent catastrophic boot failures on T2 MacBook Pro by blocking mainline kernel installation and ensuring /boot is mounted before kernel operations.

Output: Two pacman hooks (protection + warning) with corresponding scripts that validate system state before allowing kernel changes.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-t2-kernel-protection/01-CONTEXT.md
@.planning/phases/01-t2-kernel-protection/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreTransaction Protection Hook and Script</name>
  <files>
    /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook
    /usr/local/bin/vulcan-kernel-protect
  </files>
  <action>
Create the pacman hook file at /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook:

```ini
[Trigger]
Type = Package
Operation = Install
Operation = Upgrade
Operation = Remove
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = linux-t2

[Action]
Description = Verifying kernel operation safety (T2 MacBook Pro)...
When = PreTransaction
Exec = /usr/local/bin/vulcan-kernel-protect
AbortOnFail
NeedsTargets
```

Create the protection script at /usr/local/bin/vulcan-kernel-protect:

The script must:
1. Check for VULCAN_UNSAFE=1 environment variable as bypass (log warning but proceed)
2. Verify /boot is mounted using `mountpoint -q /boot` - abort with clear error if not
3. Read package names from stdin (NeedsTargets provides them)
4. Block mainline kernels (linux, linux-lts, linux-zen, linux-hardened) with clear T2-specific error
5. Allow linux-t2 operations
6. Check if fallback kernel exists (/boot/vmlinuz-linux-t2.backup) - warn if missing but don't block
7. Send desktop notifications for critical errors (detect DBUS_SESSION_BUS_ADDRESS from active session)
8. Log all actions to /var/log/vulcan-kernel-protect.log
9. Exit 0 for success, exit 1 to abort transaction

For notification from root context, detect active graphical session:
```bash
# Get active session user and their DBUS address
ACTIVE_USER=$(loginctl list-sessions --no-legend | awk '{print $3}' | head -1)
if [[ -n "$ACTIVE_USER" ]]; then
    USER_ID=$(id -u "$ACTIVE_USER")
    export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$USER_ID/bus"
    sudo -u "$ACTIVE_USER" notify-send ...
fi
```

Use `set -euo pipefail` for safety. Include clear error messages explaining WHY T2 requires linux-t2 kernel.
  </action>
  <verify>
1. Hook file exists: `ls -la /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook`
2. Script is executable: `ls -la /usr/local/bin/vulcan-kernel-protect`
3. Hook syntax valid: `grep -q "AbortOnFail" /etc/pacman.d/hooks/10-vulcan-kernel-protect.hook`
4. Test mainline block: `echo "linux" | sudo /usr/local/bin/vulcan-kernel-protect` should exit 1
5. Test linux-t2 allowed: `echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-protect` should exit 0 (assuming /boot mounted)
  </verify>
  <done>
Protection hook and script exist, block mainline kernels, verify /boot mount, and send notifications. Dry-run tests confirm blocking behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PreTransaction Warning Hook and Script</name>
  <files>
    /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook
    /usr/local/bin/vulcan-kernel-warn
  </files>
  <action>
Create the warning hook at /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook:

```ini
[Trigger]
Type = Package
Operation = Upgrade
Target = linux-t2

[Action]
Description = Kernel update detected - notifying user...
When = PreTransaction
Exec = /usr/local/bin/vulcan-kernel-warn
NeedsTargets
```

Note: This hook does NOT have AbortOnFail - it's informational only. Only triggers on Upgrade (not Install or Remove) since those are handled by protection hook.

Create the warning script at /usr/local/bin/vulcan-kernel-warn:

The script must:
1. Get current installed kernel version: `pacman -Q linux-t2 | awk '{print $2}'`
2. Send desktop notification with:
   - --urgency=normal (not critical - this is informational)
   - --expire-time=0 (persist until dismissed per CONTEXT.md)
   - --icon=system-software-update
   - Title: "T2 Kernel Update"
   - Body explaining: current version, that system will need reboot, that fallback will be preserved
3. Print same information to terminal (for users running pacman in terminal)
4. Always exit 0 (never block the transaction)
5. Log to /var/log/vulcan-kernel-warn.log

Handle notification to active session same as protection script.
  </action>
  <verify>
1. Hook file exists: `ls -la /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook`
2. Script is executable: `ls -la /usr/local/bin/vulcan-kernel-warn`
3. Hook does NOT abort: `grep -v "AbortOnFail" /etc/pacman.d/hooks/20-vulcan-kernel-warn.hook`
4. Test warning output: `echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-warn` shows warning and exits 0
  </verify>
  <done>
Warning hook and script exist, display kernel update information to user via notification and terminal, and never block transactions.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Hook ordering correct:
   - `ls /etc/pacman.d/hooks/` shows 10-vulcan-kernel-protect.hook before 20-vulcan-kernel-warn.hook

2. Protection blocks mainline:
   - `echo "linux" | sudo /usr/local/bin/vulcan-kernel-protect` exits 1
   - `echo "linux-lts" | sudo /usr/local/bin/vulcan-kernel-protect` exits 1

3. Protection allows linux-t2:
   - `echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-protect` exits 0

4. Warning is informational:
   - `echo "linux-t2" | sudo /usr/local/bin/vulcan-kernel-warn` exits 0

5. Scripts are documented:
   - Each script has header comments explaining purpose
</verification>

<success_criteria>
- Two pacman hooks installed in /etc/pacman.d/hooks/
- Two scripts installed in /usr/local/bin/ with execute permission
- Protection hook blocks linux/linux-lts/linux-zen/linux-hardened with AbortOnFail
- Protection hook verifies /boot is mounted before kernel operations
- Warning hook notifies user about linux-t2 updates without blocking
- Both scripts send desktop notifications to active session
- Both scripts log to /var/log/
- Bypass via VULCAN_UNSAFE=1 documented and functional
</success_criteria>

<output>
After completion, create `.planning/phases/01-t2-kernel-protection/01-01-SUMMARY.md`
</output>
