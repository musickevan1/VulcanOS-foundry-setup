---
phase: 07-component-integration
plan: 05
type: execute
wave: 3
depends_on: ["07-03", "07-04"]
files_modified:
  - vulcan-appearance-manager/src/app.rs
  - vulcan-appearance-manager/Cargo.toml
  - archiso/airootfs/usr/share/applications/vulcan-appearance-manager.desktop
  - archiso/airootfs/etc/skel/.config/hypr/bindings.conf
autonomous: false

must_haves:
  truths:
    - "User can switch between Themes and Wallpapers tabs with keyboard shortcut (Ctrl+1, Ctrl+2)"
    - "Memory usage remains stable when switching between tabs repeatedly"
    - "Application shows toast messages for user feedback"
    - ".desktop file launches unified appearance manager"
    - "vulcan-appearance-manager command is available from CLI"
  artifacts:
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "Final integrated app with both views"
      contains: "ThemeViewModel"
    - path: "archiso/airootfs/usr/share/applications/vulcan-appearance-manager.desktop"
      provides: "Desktop entry for application launcher"
      contains: "Exec=vulcan-appearance-manager"
  key_links:
    - from: "app.rs"
      to: "ToastOverlay"
      via: "Toast message display"
      pattern: "adw::ToastOverlay"
---

<objective>
Final integration, polish, and desktop entry creation.

Purpose: Ensure both views work together correctly, add toast notification display, verify memory stability, and create desktop integration for the unified appearance manager.

Output: Complete, polished vulcan-appearance-manager application ready for daily use.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-component-integration/07-CONTEXT.md
@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finalize app.rs integration and toast handling</name>
  <files>vulcan-appearance-manager/src/app.rs</files>
  <action>
Complete the app.rs integration:

1. Ensure ToastOverlay is properly used for toast messages:
   ```rust
   pub struct App {
       view_stack: adw::ViewStack,
       theme_view: Controller<ThemeViewModel>,
       wallpaper_view: Controller<WallpaperViewModel>,
       profile_manager: Controller<ProfileManagerModel>,
       toast_overlay: adw::ToastOverlay,
   }
   ```

2. In update(), implement ShowToast to display via adw::Toast:
   ```rust
   AppMsg::ShowToast(message) => {
       let toast = adw::Toast::new(&message);
       toast.set_timeout(3);
       self.toast_overlay.add_toast(toast);
   }
   ```

3. Store toast_overlay reference properly in init() and view!

4. Add keyboard shortcuts for tab switching in init():
   ```rust
   // Add keyboard shortcuts for tab navigation
   let shortcut_controller = gtk::ShortcutController::new();
   shortcut_controller.set_scope(gtk::ShortcutScope::Managed);

   // Ctrl+1 for Themes
   let themes_shortcut = gtk::Shortcut::new(
       gtk::ShortcutTrigger::parse_string("<Control>1"),
       Some(gtk::CallbackAction::new(|widget, _| {
           if let Some(stack) = widget.first_child().and_then(|c| c.downcast::<adw::ViewStack>().ok()) {
               stack.set_visible_child_name("themes");
           }
           glib::Propagation::Stop
       })),
   );

   // Ctrl+2 for Wallpapers
   let wallpapers_shortcut = gtk::Shortcut::new(
       gtk::ShortcutTrigger::parse_string("<Control>2"),
       Some(gtk::CallbackAction::new(|widget, _| {
           if let Some(stack) = widget.first_child().and_then(|c| c.downcast::<adw::ViewStack>().ok()) {
               stack.set_visible_child_name("wallpapers");
           }
           glib::Propagation::Stop
       })),
   );

   shortcut_controller.add_shortcut(themes_shortcut);
   shortcut_controller.add_shortcut(wallpapers_shortcut);
   root.add_controller(shortcut_controller);
   ```

5. Verify Refresh message forwards correctly to active view:
   ```rust
   AppMsg::Refresh => {
       // Determine active view and refresh appropriately
       if self.view_stack.visible_child_name().as_deref() == Some("themes") {
           self.theme_view.emit(ThemeViewMsg::Refresh);
       } else {
           self.wallpaper_view.emit(WallpaperViewMsg::RefreshMonitors);
       }
   }
   ```

6. Ensure all child view outputs are properly forwarded and handled.
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo run` - test toast messages appear, keyboard shortcuts work
  </verify>
  <done>App shows toast notifications, Ctrl+1/Ctrl+2 switch tabs, refresh works for active view</done>
</task>

<task type="auto">
  <name>Task 2: Create desktop entry and update bindings</name>
  <files>
archiso/airootfs/usr/share/applications/vulcan-appearance-manager.desktop
archiso/airootfs/etc/skel/.config/hypr/bindings.conf
  </files>
  <action>
**Create .desktop file:**
```ini
[Desktop Entry]
Type=Application
Name=Appearance Manager
GenericName=Theme and Wallpaper Manager
Comment=Manage VulcanOS themes and wallpapers
Exec=vulcan-appearance-manager
Icon=preferences-desktop-theme
Terminal=false
Categories=Settings;DesktopSettings;GTK;
Keywords=theme;wallpaper;appearance;color;desktop;
StartupNotify=true
```

**Update bindings.conf:**
If there's a keybinding for the old wallpaper-manager or theme-manager, update it to launch the unified app:

Check for existing bindings like:
- `vulcan-wallpaper-manager` -> change to `vulcan-appearance-manager`
- `vulcan-theme-manager` -> change to `vulcan-appearance-manager`

If no existing keybinding, optionally add one (check with user preference):
```
# Appearance Manager (SUPER + A for Appearance)
bind = $mainMod, A, exec, vulcan-appearance-manager
```

NOTE: Only modify bindings if they exist - don't add new keybindings without user request.
  </action>
  <verify>
Check that .desktop file is valid: `desktop-file-validate archiso/airootfs/usr/share/applications/vulcan-appearance-manager.desktop`
  </verify>
  <done>.desktop file created in archiso skeleton, bindings updated if applicable</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete unified Appearance Manager with:
- ViewStack tabbed interface (Themes + Wallpapers)
- Theme browser with color preview cards
- Theme preview panel with mock desktop rendering
- Theme editor modal dialog
- Wallpaper picker with monitor layout
- Panoramic image splitting
- Profile management in header bar
- Toast notifications
- Keyboard shortcuts (Ctrl+1/Ctrl+2)
- Desktop entry for application launcher
  </what-built>
  <how-to-verify>
1. Launch the application: `vulcan-appearance-manager`
2. Verify header bar shows ViewSwitcher with "Themes" and "Wallpapers" buttons
3. Click "Themes" tab:
   - Theme browser shows grid of theme cards with color previews
   - Click a theme to see preview in right panel
   - Click "Apply" to apply theme (desktop should change colors)
   - Click "Edit" on a non-builtin theme to open editor
   - Verify editor has grouped color fields in expander rows
4. Click "Wallpapers" tab:
   - Monitor layout shows current monitors
   - Click a monitor to select it
   - Wallpaper picker shows available wallpapers
   - Click wallpaper + "Apply" to set it
   - Click split panoramic button to test dialog
5. Test profile manager dropdown (save/load profiles)
6. Test keyboard shortcuts: Ctrl+1 and Ctrl+2 switch tabs
7. Verify toast messages appear for actions (apply, save, etc.)
8. Switch between tabs 10+ times and verify no visible memory growth in htop
9. Verify .desktop file exists in archiso skeleton
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cargo build --release` succeeds
2. Application launches and displays unified interface
3. Both tabs are functional with all features working
4. Toast notifications display correctly
5. Keyboard shortcuts work (Ctrl+1, Ctrl+2)
6. Memory usage is stable during repeated operations
7. Desktop entry is valid and exists in archiso skeleton
</verification>

<success_criteria>
- Complete unified Appearance Manager application
- Both theme and wallpaper functionality fully operational
- User can manage themes and wallpapers from single window
- Desktop integration ready for archiso builds
- No memory leaks during normal operation
- Human verification confirms all features work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-component-integration/07-05-SUMMARY.md`
</output>
