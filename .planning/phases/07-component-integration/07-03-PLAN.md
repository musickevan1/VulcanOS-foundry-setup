---
phase: 07-component-integration
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - vulcan-appearance-manager/src/components/theme_view.rs
  - vulcan-appearance-manager/src/components/mod.rs
  - vulcan-appearance-manager/src/app.rs
autonomous: true

must_haves:
  truths:
    - "Themes tab shows horizontal paned layout with browser on left, preview on right"
    - "Clicking a theme card in the browser shows preview in the right panel"
    - "Edit button opens theme editor modal dialog for non-builtin themes"
    - "Apply button applies selected theme via theme_applier service"
    - "Preview button temporarily applies theme for preview"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/theme_view.rs"
      provides: "Container component for Themes tab with paned layout"
      contains: "gtk::Paned"
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "App with ThemeView integrated into ViewStack"
      contains: "ThemeViewModel"
  key_links:
    - from: "theme_view.rs"
      to: "theme_browser.rs"
      via: "Controller composition"
      pattern: "Controller<ThemeBrowserModel>"
    - from: "theme_view.rs"
      to: "preview_panel.rs"
      via: "Controller composition"
      pattern: "Controller<PreviewPanelModel>"
    - from: "app.rs"
      to: "theme_view.rs"
      via: "ViewStack page"
      pattern: "add_titled_with_icon.*themes"
---

<objective>
Create the ThemeView container component and integrate it into the ViewStack.

Purpose: The ThemeView wraps the theme browser, preview panel, and editor dialog into a coherent tab experience. It owns the horizontal paned layout and coordinates communication between child components.

Output: Functional Themes tab with theme browsing, preview, edit, and apply capabilities.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-component-integration/07-CONTEXT.md
@.planning/phases/07-component-integration/07-RESEARCH.md
@vulcan-theme-manager/src/app.rs
@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/src/components/theme_browser.rs
@vulcan-appearance-manager/src/components/preview_panel.rs
@vulcan-appearance-manager/src/components/theme_editor.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme_view.rs container component</name>
  <files>vulcan-appearance-manager/src/components/theme_view.rs</files>
  <action>
Create theme_view.rs as the container for the Themes tab:

1. Define the ThemeView model struct:
   ```rust
   use gtk::prelude::*;
   use relm4::prelude::*;
   use adw::prelude::*;

   use crate::models::Theme;
   use crate::services::{theme_applier, theme_storage};
   use super::theme_browser::{ThemeBrowserModel, ThemeBrowserInput, ThemeBrowserOutput};
   use super::preview_panel::{PreviewPanelModel, PreviewPanelInput};
   use super::theme_editor::{ThemeEditorModel, ThemeEditorOutput};

   #[derive(Debug)]
   pub enum ThemeViewMsg {
       // Theme selection
       ThemeSelected(Theme),
       // Actions
       PreviewTheme,
       ApplyTheme,
       CancelPreview,
       NewTheme,
       EditTheme,
       // Editor callbacks
       ThemeSaved(Theme),
       EditorCancelled,
       // General
       Refresh,
       Import,
   }

   #[derive(Debug)]
   pub enum ThemeViewOutput {
       ShowToast(String),
       ThemeApplied(String), // theme_id
   }

   pub struct ThemeViewModel {
       theme_browser: Controller<ThemeBrowserModel>,
       preview_panel: Controller<PreviewPanelModel>,
       editor_dialog: Option<Controller<ThemeEditorModel>>,
       editor_window: Option<gtk::Window>,
       selected_theme: Option<Theme>,
       original_theme_id: String,
   }
   ```

2. Implement SimpleComponent with horizontal paned layout:
   ```rust
   view! {
       gtk::Paned {
           set_orientation: gtk::Orientation::Horizontal,
           set_shrink_start_child: false,
           set_shrink_end_child: false,
           set_position: 550,

           // Left: Theme browser
           #[wrap(Some)]
           set_start_child = &gtk::Frame {
               set_margin_all: 12,

               gtk::Box {
                   set_orientation: gtk::Orientation::Vertical,
                   set_spacing: 8,

                   gtk::Box {
                       set_orientation: gtk::Orientation::Horizontal,
                       set_spacing: 8,

                       gtk::Label {
                           set_markup: "<b>Available Themes</b>",
                           set_halign: gtk::Align::Start,
                           set_hexpand: true,
                       },

                       gtk::Button {
                           set_icon_name: "list-add-symbolic",
                           set_tooltip_text: Some("Create new theme"),
                           connect_clicked => ThemeViewMsg::NewTheme,
                       },

                       gtk::Button {
                           set_icon_name: "document-open-symbolic",
                           set_tooltip_text: Some("Import theme file"),
                           connect_clicked => ThemeViewMsg::Import,
                       },
                   },

                   model.theme_browser.widget() {},
               },
           },

           // Right: Preview + actions
           #[wrap(Some)]
           set_end_child = &gtk::Box {
               set_orientation: gtk::Orientation::Vertical,
               set_spacing: 12,
               set_margin_all: 12,

               model.preview_panel.widget() {},

               // Action buttons
               gtk::Box {
                   set_orientation: gtk::Orientation::Horizontal,
                   set_spacing: 8,
                   set_halign: gtk::Align::End,

                   gtk::Button {
                       set_label: "Edit",
                       #[watch]
                       set_sensitive: model.selected_theme.as_ref().map(|t| !t.is_builtin).unwrap_or(false),
                       connect_clicked => ThemeViewMsg::EditTheme,
                   },

                   gtk::Button {
                       set_label: "Preview",
                       #[watch]
                       set_sensitive: model.selected_theme.is_some(),
                       connect_clicked => ThemeViewMsg::PreviewTheme,
                   },

                   gtk::Button {
                       set_label: "Cancel",
                       connect_clicked => ThemeViewMsg::CancelPreview,
                   },

                   gtk::Button {
                       set_label: "Apply",
                       add_css_class: "suggested-action",
                       #[watch]
                       set_sensitive: model.selected_theme.is_some(),
                       connect_clicked => ThemeViewMsg::ApplyTheme,
                   },
               },
           },
       }
   }
   ```

3. Implement init() to create child controllers:
   - ThemeBrowserModel with output forwarding to ThemeViewMsg::ThemeSelected
   - PreviewPanelModel detached (no output needed)
   - Get original_theme_id from theme_applier::get_current_theme()

4. Implement update() with full message handling (migrate logic from vulcan-theme-manager/src/app.rs):
   - ThemeSelected: Update preview panel, store selected theme
   - PreviewTheme: Call theme_applier::preview_theme()
   - ApplyTheme: Call theme_applier::apply_theme(), update current theme in browser
   - CancelPreview: Call theme_applier::revert_theme()
   - NewTheme/EditTheme: Open editor modal (open_editor helper method)
   - ThemeSaved: Save to storage, refresh browser, close editor
   - EditorCancelled: Close editor window
   - Refresh: Emit ThemeBrowserInput::Refresh
   - Import: Open file dialog, import theme file

5. Add helper methods:
   - open_editor() for modal dialog creation (from vulcan-theme-manager/src/app.rs)
   - import_theme_dialog() for file picker (from vulcan-theme-manager/src/app.rs)
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - should compile
  </verify>
  <done>theme_view.rs provides container with horizontal paned layout, coordinates browser/preview/editor components, handles all theme operations</done>
</task>

<task type="auto">
  <name>Task 2: Update mod.rs and integrate ThemeView into app.rs</name>
  <files>
vulcan-appearance-manager/src/components/mod.rs
vulcan-appearance-manager/src/app.rs
  </files>
  <action>
**Update components/mod.rs:**
Add the theme_view module export:
```rust
pub mod theme_view;
```

**Update app.rs:**

1. Add import for ThemeView:
   ```rust
   use crate::components::theme_view::{ThemeViewModel, ThemeViewMsg, ThemeViewOutput};
   ```

2. Update App struct to include theme_view controller:
   ```rust
   pub struct App {
       view_stack: adw::ViewStack,
       theme_view: Controller<ThemeViewModel>,
       profile_manager: Controller<ProfileManagerModel>,
       // toast_overlay for showing messages
   }
   ```

3. Update AppMsg to handle ThemeView output:
   ```rust
   pub enum AppMsg {
       Refresh,
       ShowToast(String),
       ThemeApplied(String),
       // Profile messages (existing)
       ProfileApply(HashMap<String, PathBuf>),
       ProfileSaved(String),
       ProfileError(String),
   }
   ```

4. In init(), create ThemeViewModel with output forwarding:
   ```rust
   let theme_view = ThemeViewModel::builder()
       .launch(())
       .forward(sender.input_sender(), |msg| {
           match msg {
               ThemeViewOutput::ShowToast(text) => AppMsg::ShowToast(text),
               ThemeViewOutput::ThemeApplied(id) => AppMsg::ThemeApplied(id),
           }
       });
   ```

5. Replace the themes placeholder in ViewStack:
   ```rust
   // In init(), after creating view_stack and theme_view:
   view_stack.add_titled_with_icon(
       theme_view.widget(),
       Some("themes"),
       "Themes",
       "preferences-color-symbolic"
   );
   ```

6. Update Refresh message handling to forward to theme_view if themes tab is active.
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo run` - app should launch, Themes tab should show horizontal paned layout with theme browser and preview panel
  </verify>
  <done>ThemeView is integrated into ViewStack, Themes tab is fully functional with browsing, preview, edit, and apply</done>
</task>

</tasks>

<verification>
1. `cargo check` passes
2. `cargo run` launches app with functional Themes tab
3. Theme browser shows grid of available themes with color previews
4. Clicking a theme shows preview in right panel
5. Apply button applies selected theme (visible change in desktop)
6. Edit button opens modal editor for non-builtin themes
7. Import button opens file picker dialog
8. New button opens editor for creating new theme
</verification>

<success_criteria>
- ThemeView container component wraps all theme functionality
- Horizontal paned layout with browser left, preview right
- All theme operations work: select, preview, apply, cancel, edit, new, import
- Component is properly integrated into ViewStack Themes page
- Theme changes propagate correctly between components
</success_criteria>

<output>
After completion, create `.planning/phases/07-component-integration/07-03-SUMMARY.md`
</output>
