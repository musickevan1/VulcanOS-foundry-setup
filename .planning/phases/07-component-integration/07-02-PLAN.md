---
phase: 07-component-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vulcan-appearance-manager/src/components/theme_card.rs
  - vulcan-appearance-manager/src/components/theme_browser.rs
  - vulcan-appearance-manager/src/components/preview_panel.rs
  - vulcan-appearance-manager/src/components/theme_editor.rs
  - vulcan-appearance-manager/src/components/mod.rs
autonomous: true

must_haves:
  truths:
    - "Theme browser component renders FlowBox grid of theme cards with 8-color palette previews"
    - "Theme cards show Current and Built-in badges appropriately"
    - "Preview panel renders mock desktop with theme colors using Cairo"
    - "Theme editor opens as modal dialog with color groups in ExpanderRows"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/theme_browser.rs"
      provides: "Theme grid with FactoryVecDeque pattern"
      contains: "FactoryVecDeque<ThemeItem>"
    - path: "vulcan-appearance-manager/src/components/theme_card.rs"
      provides: "Individual theme card factory component"
      contains: "FactoryComponent for ThemeItem"
    - path: "vulcan-appearance-manager/src/components/preview_panel.rs"
      provides: "Cairo-based theme preview rendering"
      contains: "set_draw_func"
    - path: "vulcan-appearance-manager/src/components/theme_editor.rs"
      provides: "Color group editor with ExpanderRows"
      contains: "adw::ExpanderRow"
  key_links:
    - from: "theme_browser.rs"
      to: "theme_card.rs"
      via: "FactoryVecDeque factory"
      pattern: "FactoryVecDeque<ThemeItem>"
    - from: "theme_card.rs"
      to: "Theme model"
      via: "theme field in ThemeItem"
      pattern: "theme: Theme"
---

<objective>
Migrate theme-related UI components from vulcan-theme-manager to vulcan-appearance-manager.

Purpose: Copy and adapt the proven theme browser, card, preview panel, and editor components to the unified crate. These components use Relm4's FactoryVecDeque pattern for efficient grid rendering and already work correctly.

Output: Four theme UI components ready to be composed into a ThemeView container.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-component-integration/07-RESEARCH.md
@vulcan-theme-manager/src/components/theme_browser.rs
@vulcan-theme-manager/src/components/theme_card.rs
@vulcan-theme-manager/src/components/preview_panel.rs
@vulcan-theme-manager/src/components/theme_editor.rs
@vulcan-appearance-manager/src/components/mod.rs
@vulcan-appearance-manager/src/models/theme.rs
@vulcan-appearance-manager/src/models/color_group.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme_card.rs factory component</name>
  <files>vulcan-appearance-manager/src/components/theme_card.rs</files>
  <action>
Create a new file theme_card.rs that provides the ThemeItem factory component:

1. Copy the ThemeItem struct and FactoryComponent implementation from vulcan-theme-manager/src/components/theme_browser.rs (the ThemeItem is defined within that file, not separately)

2. Extract ThemeItem into its own file for better organization:
   ```rust
   use gtk::prelude::*;
   use relm4::prelude::*;
   use relm4::factory::{FactoryComponent, DynamicIndex, FactorySender};

   use crate::models::Theme;

   /// Output messages from ThemeCard
   #[derive(Debug)]
   pub enum ThemeCardOutput {
       Selected(Theme),
   }

   /// Factory item for theme display in FlowBox
   #[derive(Debug)]
   pub struct ThemeItem {
       pub theme: Theme,
       pub is_current: bool,
   }
   ```

3. Implement FactoryComponent for ThemeItem exactly as in the source file:
   - ParentWidget = gtk::FlowBox
   - 8-color palette preview using DrawingArea widgets
   - Theme name label with ellipsize
   - Current/Built-in badges
   - GestureClick for selection

4. Include the parse_hex_color helper function for Cairo drawing.

5. Update Output type to use ThemeCardOutput::Selected(Theme) instead of ThemeBrowserOutput.

Reference: vulcan-theme-manager/src/components/theme_browser.rs lines 21-190
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - should compile (may have warnings about unused code)
  </verify>
  <done>theme_card.rs exists with ThemeItem FactoryComponent that renders 8-color palette preview, badges, and handles click selection</done>
</task>

<task type="auto">
  <name>Task 2: Create theme_browser.rs component</name>
  <files>vulcan-appearance-manager/src/components/theme_browser.rs</files>
  <action>
Create theme_browser.rs with the grid container:

1. Create the file with ThemeBrowserModel struct:
   ```rust
   use gtk::prelude::*;
   use relm4::prelude::*;
   use relm4::factory::FactoryVecDeque;

   use crate::models::Theme;
   use crate::services::theme_storage;
   use super::theme_card::{ThemeItem, ThemeCardOutput};

   /// Input messages for ThemeBrowser
   #[derive(Debug)]
   pub enum ThemeBrowserInput {
       Refresh,
       SetCurrentTheme(String),
   }

   /// Output messages from ThemeBrowser
   #[derive(Debug)]
   pub enum ThemeBrowserOutput {
       ThemeSelected(Theme),
   }

   /// Theme browser component with FlowBox grid of themes
   pub struct ThemeBrowserModel {
       themes: FactoryVecDeque<ThemeItem>,
       current_theme_id: String,
   }
   ```

2. Implement SimpleComponent for ThemeBrowserModel:
   - view! creates ScrolledWindow containing FlowBox
   - FlowBox settings: max_children_per_line: 6, min_children_per_line: 2, row_spacing: 12, column_spacing: 12
   - init() creates FactoryVecDeque and loads themes from theme_storage
   - update() handles Refresh and SetCurrentTheme messages

3. Forward ThemeCardOutput::Selected to ThemeBrowserOutput::ThemeSelected in the factory builder:
   ```rust
   let themes = FactoryVecDeque::builder()
       .launch(gtk::FlowBox::default())
       .forward(sender.output_sender(), |msg| {
           match msg {
               ThemeCardOutput::Selected(theme) => ThemeBrowserOutput::ThemeSelected(theme),
           }
       });
   ```

Reference: vulcan-theme-manager/src/components/theme_browser.rs lines 192-288
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - should compile
  </verify>
  <done>theme_browser.rs exists with FactoryVecDeque-backed FlowBox grid, theme loading from storage, and current theme tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create preview_panel.rs and theme_editor.rs</name>
  <files>
vulcan-appearance-manager/src/components/preview_panel.rs
vulcan-appearance-manager/src/components/theme_editor.rs
  </files>
  <action>
Create both remaining theme components:

**preview_panel.rs:**
1. Copy from vulcan-theme-manager/src/components/preview_panel.rs
2. Update imports to use crate::models::Theme
3. Keep the Cairo-based mock desktop rendering (set_theme_preview function)
4. Keep the empty state rendering (set_empty_preview function)
5. Ensure PreviewPanelInput::SetTheme(Option<Theme>) updates the drawing area

**theme_editor.rs:**
1. Copy from vulcan-theme-manager/src/components/theme_editor.rs
2. Update imports to use crate::models::{Theme, ColorGroup, ColorField}
3. Keep the ExpanderRow-based color group organization
4. Keep the color/text field input handling
5. Note: Uses gtk::ColorButton which is deprecated but works - future plans may update to ColorDialogButton or Entry+hex validation

Both files should work identically to their vulcan-theme-manager counterparts.
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - should compile
  </verify>
  <done>preview_panel.rs provides Cairo mock desktop preview, theme_editor.rs provides ExpanderRow-based color editing modal</done>
</task>

<task type="auto">
  <name>Task 4: Update components/mod.rs to export new modules</name>
  <files>vulcan-appearance-manager/src/components/mod.rs</files>
  <action>
Update the module declarations to include the new theme components:

```rust
pub mod monitor_layout;
pub mod profile_manager;
pub mod split_dialog;
pub mod wallpaper_picker;

// Theme components (migrated from vulcan-theme-manager)
pub mod theme_card;
pub mod theme_browser;
pub mod preview_panel;
pub mod theme_editor;
```

All modules should be public exports for use by app.rs and future view containers.
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - all theme components should compile without errors
  </verify>
  <done>components/mod.rs exports all four theme components alongside existing wallpaper components</done>
</task>

</tasks>

<verification>
1. `cargo check` passes for vulcan-appearance-manager crate
2. theme_card.rs contains ThemeItem with FactoryComponent implementation
3. theme_browser.rs contains ThemeBrowserModel with FactoryVecDeque
4. preview_panel.rs contains Cairo drawing functions for theme preview
5. theme_editor.rs contains ExpanderRow-based color editing
6. All components use imports from crate::models and crate::services (not vulcan-theme-manager)
</verification>

<success_criteria>
- All four theme UI components exist in vulcan-appearance-manager/src/components/
- Components compile successfully
- Components use the unified crate's models and services
- FactoryVecDeque pattern is correctly implemented for theme grid
- Components are ready to be composed into ThemeView container
</success_criteria>

<output>
After completion, create `.planning/phases/07-component-integration/07-02-SUMMARY.md`
</output>
