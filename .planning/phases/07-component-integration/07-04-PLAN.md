---
phase: 07-component-integration
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - vulcan-appearance-manager/src/components/wallpaper_view.rs
  - vulcan-appearance-manager/src/components/mod.rs
  - vulcan-appearance-manager/src/app.rs
autonomous: true

must_haves:
  truths:
    - "Wallpapers tab shows vertical paned layout with monitor layout on top, picker on bottom"
    - "Monitor layout displays current monitor configuration with wallpaper previews"
    - "Clicking a monitor selects it, clicking a wallpaper assigns it to selected monitor"
    - "Apply button sets wallpaper on selected monitor via wallpaper backend"
    - "Split panoramic dialog opens from header button"
  artifacts:
    - path: "vulcan-appearance-manager/src/components/wallpaper_view.rs"
      provides: "Container component for Wallpapers tab with vertical paned layout"
      contains: "gtk::Paned"
    - path: "vulcan-appearance-manager/src/app.rs"
      provides: "App with WallpaperView integrated into ViewStack"
      contains: "WallpaperViewModel"
  key_links:
    - from: "wallpaper_view.rs"
      to: "monitor_layout.rs"
      via: "Controller composition"
      pattern: "Controller<MonitorLayoutModel>"
    - from: "wallpaper_view.rs"
      to: "wallpaper_picker.rs"
      via: "Controller composition"
      pattern: "Controller<WallpaperPickerModel>"
    - from: "app.rs"
      to: "wallpaper_view.rs"
      via: "ViewStack page"
      pattern: "add_titled_with_icon.*wallpapers"
---

<objective>
Create the WallpaperView container component and integrate it into the ViewStack.

Purpose: The WallpaperView wraps the existing wallpaper components (monitor_layout, wallpaper_picker, split_dialog) into a coherent tab experience. Most of this code already exists in the current app.rs - we're extracting it into a dedicated view component.

Output: Functional Wallpapers tab with monitor layout, wallpaper assignment, and panoramic splitting.
</objective>

<execution_context>
@/home/evan/.claude/get-shit-done/workflows/execute-plan.md
@/home/evan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-component-integration/07-CONTEXT.md
@vulcan-appearance-manager/src/app.rs
@vulcan-appearance-manager/src/components/monitor_layout.rs
@vulcan-appearance-manager/src/components/wallpaper_picker.rs
@vulcan-appearance-manager/src/components/split_dialog.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wallpaper_view.rs container component</name>
  <files>vulcan-appearance-manager/src/components/wallpaper_view.rs</files>
  <action>
Create wallpaper_view.rs by extracting wallpaper logic from the current app.rs:

1. Define the WallpaperView model struct (most fields come from current App struct):
   ```rust
   use gtk::prelude::*;
   use relm4::prelude::*;
   use adw::prelude::*;
   use std::path::PathBuf;
   use std::collections::HashMap;

   use crate::models::Monitor;
   use crate::services::{hyprctl, thumbnail};
   use crate::services::wallpaper_backend::{WallpaperBackend, get_backend};
   use super::monitor_layout::{MonitorLayoutModel, MonitorLayoutInput, MonitorLayoutOutput};
   use super::wallpaper_picker::{WallpaperPickerModel, WallpaperPickerInput, WallpaperPickerOutput};
   use super::split_dialog::{SplitDialogModel, SplitDialogOutput};

   #[derive(Debug)]
   pub enum WallpaperViewMsg {
       MonitorSelected(String),
       WallpaperSelected(PathBuf),
       ApplyWallpaper,
       RefreshMonitors,
       OpenDirectory,
       ShowSplitDialog,
       SplitGenerated(HashMap<String, PathBuf>),
       SplitCancelled,
       SplitError(String),
   }

   #[derive(Debug)]
   pub enum WallpaperViewOutput {
       ShowToast(String),
       WallpapersChanged(HashMap<String, PathBuf>),
   }

   pub struct WallpaperViewModel {
       monitors: Vec<Monitor>,
       selected_monitor: Option<String>,
       selected_wallpaper: Option<PathBuf>,
       monitor_wallpapers: HashMap<String, PathBuf>,
       monitor_layout: Controller<MonitorLayoutModel>,
       wallpaper_picker: Controller<WallpaperPickerModel>,
       split_dialog: Option<Controller<SplitDialogModel>>,
       split_dialog_window: Option<gtk::Window>,
       backend: Box<dyn WallpaperBackend>,
   }
   ```

2. Implement SimpleComponent with vertical paned layout (from current app.rs):
   ```rust
   view! {
       gtk::Box {
           set_orientation: gtk::Orientation::Vertical,
           set_spacing: 0,

           // Header bar items (these will be accessed by parent for header placement)
           // The actual buttons are defined in app.rs header bar

           gtk::Paned {
               set_orientation: gtk::Orientation::Vertical,
               set_shrink_start_child: false,
               set_shrink_end_child: false,
               set_position: 350,
               set_vexpand: true,

               // Top: Monitor layout
               #[wrap(Some)]
               set_start_child = &gtk::Frame {
                   set_margin_all: 12,

                   gtk::Box {
                       set_orientation: gtk::Orientation::Vertical,
                       set_spacing: 8,

                       gtk::Label {
                           set_markup: "<b>Monitor Layout</b>",
                           set_halign: gtk::Align::Start,
                       },

                       model.monitor_layout.widget() {},
                   },
               },

               // Bottom: Wallpaper picker
               #[wrap(Some)]
               set_end_child = &gtk::Frame {
                   set_margin_all: 12,

                   gtk::Box {
                       set_orientation: gtk::Orientation::Vertical,
                       set_spacing: 8,

                       gtk::Box {
                           set_orientation: gtk::Orientation::Horizontal,
                           set_spacing: 12,

                           gtk::Label {
                               set_markup: "<b>Wallpapers</b>",
                               set_halign: gtk::Align::Start,
                               set_hexpand: true,
                           },

                           gtk::Button {
                               set_icon_name: "folder-open-symbolic",
                               set_tooltip_text: Some("Open wallpaper folder"),
                               connect_clicked => WallpaperViewMsg::OpenDirectory,
                           },

                           gtk::Button {
                               set_icon_name: "insert-image-symbolic",
                               set_tooltip_text: Some("Import panoramic image"),
                               connect_clicked => WallpaperViewMsg::ShowSplitDialog,
                           },

                           gtk::Button {
                               set_label: "Apply",
                               #[watch]
                               set_sensitive: model.selected_monitor.is_some() && model.selected_wallpaper.is_some(),
                               add_css_class: "suggested-action",
                               connect_clicked => WallpaperViewMsg::ApplyWallpaper,
                           },
                       },

                       model.wallpaper_picker.widget() {},
                   },
               },
           },
       }
   }
   ```

3. Implement init() - migrate from current app.rs init():
   - Load monitors via hyprctl::get_monitors()
   - Load current wallpapers via backend.list_active()
   - Create MonitorLayoutModel controller
   - Create WallpaperPickerModel controller
   - Initialize wallpaper backend via get_backend()

4. Implement update() - migrate ALL wallpaper message handling from current app.rs:
   - MonitorSelected: Store selection
   - WallpaperSelected: Store selection
   - ApplyWallpaper: Use backend.apply_wallpaper(), update monitor_layout, emit WallpapersChanged
   - RefreshMonitors: Reload monitors and wallpapers
   - OpenDirectory: xdg-open wallpaper directory
   - ShowSplitDialog: Create modal with SplitDialogModel
   - SplitGenerated: Apply all wallpapers, close dialog
   - SplitCancelled/SplitError: Handle dialog closure
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo check` - should compile
  </verify>
  <done>wallpaper_view.rs provides container with vertical paned layout, coordinates monitor/picker/split components, handles all wallpaper operations</done>
</task>

<task type="auto">
  <name>Task 2: Update mod.rs and integrate WallpaperView into app.rs</name>
  <files>
vulcan-appearance-manager/src/components/mod.rs
vulcan-appearance-manager/src/app.rs
  </files>
  <action>
**Update components/mod.rs:**
Add the wallpaper_view module export:
```rust
pub mod wallpaper_view;
```

**Update app.rs:**

1. Add import for WallpaperView:
   ```rust
   use crate::components::wallpaper_view::{WallpaperViewModel, WallpaperViewMsg, WallpaperViewOutput};
   ```

2. Update App struct to include wallpaper_view controller:
   ```rust
   pub struct App {
       view_stack: adw::ViewStack,
       theme_view: Controller<ThemeViewModel>,
       wallpaper_view: Controller<WallpaperViewModel>,
       profile_manager: Controller<ProfileManagerModel>,
   }
   ```

3. Update AppMsg to handle WallpaperView output:
   ```rust
   pub enum AppMsg {
       Refresh,
       ShowToast(String),
       ThemeApplied(String),
       WallpapersChanged(HashMap<String, PathBuf>),
       // Profile messages
       ProfileApply(HashMap<String, PathBuf>),
       ProfileSaved(String),
       ProfileError(String),
   }
   ```

4. In init(), create WallpaperViewModel with output forwarding:
   ```rust
   let wallpaper_view = WallpaperViewModel::builder()
       .launch(())
       .forward(sender.input_sender(), |msg| {
           match msg {
               WallpaperViewOutput::ShowToast(text) => AppMsg::ShowToast(text),
               WallpaperViewOutput::WallpapersChanged(wps) => AppMsg::WallpapersChanged(wps),
           }
       });
   ```

5. Replace the wallpapers placeholder in ViewStack:
   ```rust
   view_stack.add_titled_with_icon(
       wallpaper_view.widget(),
       Some("wallpapers"),
       "Wallpapers",
       "preferences-desktop-wallpaper-symbolic"
   );
   ```

6. Handle WallpapersChanged in update() to notify profile_manager:
   ```rust
   AppMsg::WallpapersChanged(wallpapers) => {
       self.profile_manager.emit(ProfileManagerInput::UpdateWallpapers(wallpapers));
   }
   ```

7. Handle ProfileApply to forward to wallpaper_view (need to add message to WallpaperViewMsg):
   - Add WallpaperViewMsg::ApplyProfile(HashMap<String, PathBuf>) to wallpaper_view.rs
   - Forward AppMsg::ProfileApply to wallpaper_view

8. Remove all wallpaper-specific code from app.rs that was moved to wallpaper_view.rs.
  </action>
  <verify>
Run `cd vulcan-appearance-manager && cargo run` - app should launch, Wallpapers tab should show vertical paned layout with monitor visualization and wallpaper picker
  </verify>
  <done>WallpaperView is integrated into ViewStack, Wallpapers tab is fully functional with monitor selection, wallpaper assignment, and split dialog</done>
</task>

</tasks>

<verification>
1. `cargo check` passes
2. `cargo run` launches app with functional Wallpapers tab
3. Monitor layout shows current monitor configuration
4. Clicking a monitor selects it (subtitle updates)
5. Wallpaper picker shows available wallpapers with thumbnails
6. Clicking a wallpaper + Apply sets it on selected monitor
7. Split panoramic button opens dialog
8. Profile manager dropdown works (save/load profiles)
</verification>

<success_criteria>
- WallpaperView container component wraps all wallpaper functionality
- Vertical paned layout with monitor layout top, picker bottom
- All wallpaper operations work: select monitor, select wallpaper, apply, refresh, split
- Component is properly integrated into ViewStack Wallpapers page
- Profile manager communicates correctly with wallpaper view
</success_criteria>

<output>
After completion, create `.planning/phases/07-component-integration/07-04-SUMMARY.md`
</output>
