#!/bin/bash
# VulcanOS T2 Kernel Fallback Generator
# Backs up current kernel and generates GRUB fallback menu entries

set -euo pipefail

# Color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Log file
LOG_FILE="/var/log/vulcan-kernel-fallback.log"

# Maximum number of fallback kernels to keep
MAX_FALLBACKS=2

# Boot directory
BOOT_DIR="/boot"

# GRUB custom config
GRUB_CUSTOM_CFG="${BOOT_DIR}/grub/custom.cfg"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Check mark functions
ok() {
    echo -e "${GREEN}[OK]${NC} $*"
    log "[OK] $*"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $*"
    log "[INFO] $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*"
    log "[ERROR] $*"
}

echo "=== VulcanOS Kernel Fallback Generator ==="
log "=== Starting kernel fallback generation ==="

# 1. Check if kernel exists
if [[ ! -f "${BOOT_DIR}/vmlinuz-linux-t2" ]]; then
    error "Current kernel not found: ${BOOT_DIR}/vmlinuz-linux-t2"
    exit 1
fi

if [[ ! -f "${BOOT_DIR}/initramfs-linux-t2.img" ]]; then
    error "Current initramfs not found: ${BOOT_DIR}/initramfs-linux-t2.img"
    exit 1
fi

# 2. Get kernel version
if KERNEL_VERSION=$(pacman -Q linux-t2 2>/dev/null | awk '{print $2}'); then
    info "Current kernel version: $KERNEL_VERSION"
else
    KERNEL_VERSION="unknown"
    info "Could not determine kernel version, using: $KERNEL_VERSION"
fi

# 3. Rotate existing backups
info "Managing fallback kernels (max: $MAX_FALLBACKS)..."

# If backup exists, rotate to backup2
if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup" ]]; then
    info "Rotating existing backup to backup2..."

    # Remove old backup2 if it exists
    if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup2" ]]; then
        rm -f "${BOOT_DIR}/vmlinuz-linux-t2.backup2"
        rm -f "${BOOT_DIR}/initramfs-linux-t2.backup2.img"
        info "Removed oldest fallback (backup2)"
    fi

    # Move backup to backup2
    mv "${BOOT_DIR}/vmlinuz-linux-t2.backup" "${BOOT_DIR}/vmlinuz-linux-t2.backup2"
    mv "${BOOT_DIR}/initramfs-linux-t2.backup.img" "${BOOT_DIR}/initramfs-linux-t2.backup2.img"

    # Copy version file if it exists
    if [[ -f "${BOOT_DIR}/vulcan-fallback-version.txt" ]]; then
        mv "${BOOT_DIR}/vulcan-fallback-version.txt" "${BOOT_DIR}/vulcan-fallback-version2.txt"
    fi

    ok "Rotated backup to backup2"
fi

# 4. Create new backup
info "Creating new fallback backup..."
cp "${BOOT_DIR}/vmlinuz-linux-t2" "${BOOT_DIR}/vmlinuz-linux-t2.backup"
cp "${BOOT_DIR}/initramfs-linux-t2.img" "${BOOT_DIR}/initramfs-linux-t2.backup.img"
echo "$KERNEL_VERSION" > "${BOOT_DIR}/vulcan-fallback-version.txt"

ok "Created fallback backup:"
echo "  - ${BOOT_DIR}/vmlinuz-linux-t2.backup"
echo "  - ${BOOT_DIR}/initramfs-linux-t2.backup.img"
echo "  - Version: $KERNEL_VERSION"

# 5. Get system configuration
info "Detecting system configuration..."

# Get root UUID
if ROOT_UUID=$(findmnt -n -o UUID /); then
    ok "Root UUID: $ROOT_UUID"
else
    error "Could not determine root filesystem UUID"
    exit 1
fi

# Get T2 kernel parameters from existing GRUB config or use defaults
KERNEL_PARAMS="intel_iommu=on iommu=pt pcie_ports=compat"
if [[ -f "${BOOT_DIR}/grub/grub.cfg" ]]; then
    # Try to extract kernel parameters from existing config
    EXISTING_PARAMS=$(grep -m1 "linux.*vmlinuz-linux-t2" "${BOOT_DIR}/grub/grub.cfg" | sed 's/.*vmlinuz-linux-t2//' | sed 's/root=UUID=[^ ]*//' | xargs || echo "")
    if [[ -n "$EXISTING_PARAMS" ]]; then
        # Merge with required T2 params, avoid duplicates
        KERNEL_PARAMS="intel_iommu=on iommu=pt pcie_ports=compat $EXISTING_PARAMS"
        KERNEL_PARAMS=$(echo "$KERNEL_PARAMS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
    fi
fi
info "Kernel parameters: $KERNEL_PARAMS"

# 6. Generate GRUB custom.cfg
info "Generating GRUB fallback menu entries..."

# Ensure grub directory exists
mkdir -p "$(dirname "$GRUB_CUSTOM_CFG")"

cat > "$GRUB_CUSTOM_CFG" << EOF
# VulcanOS T2 Kernel Fallback Entries
# Generated: $(date '+%Y-%m-%d %H:%M:%S')
# DO NOT EDIT MANUALLY - regenerated by vulcan-kernel-fallback

EOF

# Primary fallback entry
if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup" ]]; then
    FALLBACK1_VERSION=$(cat "${BOOT_DIR}/vulcan-fallback-version.txt" 2>/dev/null || echo "unknown")

    cat >> "$GRUB_CUSTOM_CFG" << EOF
menuentry 'Arch Linux (T2 Fallback: $FALLBACK1_VERSION)' --class arch --class gnu-linux {
    load_video
    set gfxpayload=keep
    insmod gzio
    insmod part_gpt
    insmod ext2
    search --no-floppy --fs-uuid --set=root $ROOT_UUID
    echo 'Loading fallback kernel linux-t2 $FALLBACK1_VERSION...'
    linux /boot/vmlinuz-linux-t2.backup root=UUID=$ROOT_UUID rw $KERNEL_PARAMS
    initrd /boot/initramfs-linux-t2.backup.img
}

EOF
    ok "Created primary fallback entry: $FALLBACK1_VERSION"
fi

# Secondary fallback entry
if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup2" ]]; then
    FALLBACK2_VERSION=$(cat "${BOOT_DIR}/vulcan-fallback-version2.txt" 2>/dev/null || echo "unknown")

    cat >> "$GRUB_CUSTOM_CFG" << EOF
menuentry 'Arch Linux (T2 Fallback 2: $FALLBACK2_VERSION)' --class arch --class gnu-linux {
    load_video
    set gfxpayload=keep
    insmod gzio
    insmod part_gpt
    insmod ext2
    search --no-floppy --fs-uuid --set=root $ROOT_UUID
    echo 'Loading fallback kernel linux-t2 $FALLBACK2_VERSION...'
    linux /boot/vmlinuz-linux-t2.backup2 root=UUID=$ROOT_UUID rw $KERNEL_PARAMS
    initrd /boot/initramfs-linux-t2.backup2.img
}

EOF
    ok "Created secondary fallback entry: $FALLBACK2_VERSION"
fi

# 7. Summary
echo ""
echo "=== Fallback Generation Complete ==="
log "=== Fallback generation complete ==="

echo ""
echo "Backed up files:"
if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup" ]]; then
    echo "  - ${BOOT_DIR}/vmlinuz-linux-t2.backup ($FALLBACK1_VERSION)"
    echo "  - ${BOOT_DIR}/initramfs-linux-t2.backup.img"
fi
if [[ -f "${BOOT_DIR}/vmlinuz-linux-t2.backup2" ]]; then
    echo "  - ${BOOT_DIR}/vmlinuz-linux-t2.backup2 ($FALLBACK2_VERSION)"
    echo "  - ${BOOT_DIR}/initramfs-linux-t2.backup2.img"
fi

echo ""
echo "GRUB configuration:"
echo "  - Written to: $GRUB_CUSTOM_CFG"
echo "  - No grub-mkconfig needed (custom.cfg sourced automatically)"

ENTRY_COUNT=$(grep -c "^menuentry" "$GRUB_CUSTOM_CFG" || echo 0)
echo "  - Fallback entries created: $ENTRY_COUNT"

echo ""
ok "Fallback entries will appear in GRUB boot menu on next boot"

log "SUCCESS: Fallback generation complete with $ENTRY_COUNT entries"
exit 0
