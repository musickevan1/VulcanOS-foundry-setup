#!/bin/bash
# VulcanOS Wallpaper Manager
# Usage: vulcan-wallpaper [command]
# Commands: rotate, random, set <path>, list

set -e

WALLPAPER_DIR="${HOME}/Pictures/Wallpapers"
CONFIG_DIR="${HOME}/.config"
HYPRPAPER_CONF="${CONFIG_DIR}/hypr/hyprpaper.conf"
STATE_FILE="${CONFIG_DIR}/vulcan/wallpaper-index"

# Ensure directories exist
mkdir -p "${CONFIG_DIR}/vulcan"
mkdir -p "$WALLPAPER_DIR"

notify() {
    if command -v notify-send &> /dev/null; then
        notify-send "Wallpaper" "$1" -i preferences-desktop-wallpaper -t 2000
    fi
}

get_wallpapers() {
    find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.svg" \) 2>/dev/null | sort
}

get_current_index() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo "0"
    fi
}

set_wallpaper() {
    local wallpaper="$1"

    if [[ ! -f "$wallpaper" ]]; then
        echo "Error: Wallpaper not found: $wallpaper"
        exit 1
    fi

    # Update hyprpaper config
    cat > "$HYPRPAPER_CONF" << EOF
preload = ${wallpaper}
wallpaper = ,${wallpaper}
splash = false
EOF

    # Reload hyprpaper
    pkill hyprpaper 2>/dev/null || true
    sleep 0.2
    hyprctl dispatch exec hyprpaper &> /dev/null || true

    notify "$(basename "$wallpaper")"
}

rotate_wallpaper() {
    local wallpapers
    mapfile -t wallpapers < <(get_wallpapers)

    if [[ ${#wallpapers[@]} -eq 0 ]]; then
        notify "No wallpapers found in $WALLPAPER_DIR"
        exit 1
    fi

    local current_index
    current_index=$(get_current_index)

    # Move to next wallpaper
    local next_index=$(( (current_index + 1) % ${#wallpapers[@]} ))
    echo "$next_index" > "$STATE_FILE"

    set_wallpaper "${wallpapers[$next_index]}"
}

random_wallpaper() {
    local wallpapers
    mapfile -t wallpapers < <(get_wallpapers)

    if [[ ${#wallpapers[@]} -eq 0 ]]; then
        notify "No wallpapers found in $WALLPAPER_DIR"
        exit 1
    fi

    local random_index=$((RANDOM % ${#wallpapers[@]}))
    echo "$random_index" > "$STATE_FILE"

    set_wallpaper "${wallpapers[$random_index]}"
}

list_wallpapers() {
    echo "Wallpapers in $WALLPAPER_DIR:"
    echo "────────────────────────────────"
    get_wallpapers | while read -r wp; do
        echo "  $(basename "$wp")"
    done
}

show_help() {
    echo "VulcanOS Wallpaper Manager"
    echo ""
    echo "Usage: vulcan-wallpaper [command]"
    echo ""
    echo "Commands:"
    echo "  rotate    Rotate to next wallpaper"
    echo "  random    Set a random wallpaper"
    echo "  set PATH  Set specific wallpaper"
    echo "  list      List available wallpapers"
    echo "  help      Show this help"
    echo ""
    echo "Wallpapers should be placed in: $WALLPAPER_DIR"
}

main() {
    local command="${1:-rotate}"

    case "$command" in
        rotate)
            rotate_wallpaper
            ;;
        random)
            random_wallpaper
            ;;
        set)
            if [[ -z "$2" ]]; then
                echo "Error: Please specify wallpaper path"
                exit 1
            fi
            set_wallpaper "$2"
            ;;
        list)
            list_wallpapers
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
