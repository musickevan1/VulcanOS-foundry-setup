#!/bin/bash
# VulcanOS Theme Switcher
# Usage: vulcan-theme [command] [theme]
# Commands: list, current, set, menu, preview

set -e

# Configuration
THEMES_DIR="${HOME}/.config/themes"
COLORS_DIR="${THEMES_DIR}/colors"
TEMPLATES_DIR="${THEMES_DIR}/templates"
CONFIG_DIR="${HOME}/.config"
VULCAN_CONFIG="${CONFIG_DIR}/vulcan"
CURRENT_THEME_FILE="${VULCAN_CONFIG}/current-theme"

# Ensure vulcan config directory exists
mkdir -p "${VULCAN_CONFIG}"

# Available themes
THEMES=(
    "tokyonight:Tokyo Night:Soft dark theme with vibrant colors"
    "catppuccin-mocha:Catppuccin Mocha:Soothing pastel theme"
    "dracula:Dracula:Dark theme with purple accents"
    "gruvbox-dark:Gruvbox Dark:Retro groove colors"
    "nord:Nord:Arctic, bluish color palette"
    "onedark:One Dark:Atom's iconic dark theme"
    "rosepine:Rose Pine:All natural pine, faux fur and a bit of soho vibes"
)

# Color output helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Get current theme
get_current_theme() {
    if [[ -f "${CURRENT_THEME_FILE}" ]]; then
        cat "${CURRENT_THEME_FILE}"
    else
        echo "tokyonight"
    fi
}

# List available themes
list_themes() {
    echo ""
    echo -e "${PURPLE}Available Themes${NC}"
    echo "─────────────────────────────────────────────"

    current=$(get_current_theme)

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${current}" ]]; then
            echo -e "  ${GREEN}●${NC} ${name} (${id}) ${GREEN}[current]${NC}"
        else
            echo -e "  ○ ${name} (${id})"
        fi
        echo -e "    ${CYAN}${desc}${NC}"
    done
    echo ""
}

# Validate theme exists
validate_theme() {
    local theme_id="$1"

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${theme_id}" ]]; then
            return 0
        fi
    done
    return 1
}

# Get theme name from ID
get_theme_name() {
    local theme_id="$1"

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${theme_id}" ]]; then
            echo "${name}"
            return 0
        fi
    done
    echo "${theme_id}"
}

# Process a single template
process_template() {
    local template="$1"
    local output="$2"

    # Use envsubst to replace all environment variables
    envsubst < "${template}" > "${output}"
}

# Apply theme to all components
apply_theme() {
    local theme_id="$1"
    local save="${2:-true}"

    # Validate theme
    if ! validate_theme "${theme_id}"; then
        print_error "Unknown theme: ${theme_id}"
        echo "Run 'vulcan-theme list' to see available themes"
        exit 1
    fi

    local theme_name
    theme_name=$(get_theme_name "${theme_id}")

    print_info "Applying theme: ${theme_name}"

    # Source the theme colors
    local color_file="${COLORS_DIR}/${theme_id}.sh"
    if [[ ! -f "${color_file}" ]]; then
        print_error "Theme color file not found: ${color_file}"
        exit 1
    fi

    # shellcheck source=/dev/null
    source "${color_file}"

    # Export all variables for envsubst
    export THEME_NAME THEME_ID
    export BG_PRIMARY BG_SECONDARY BG_TERTIARY BG_SURFACE
    export FG_PRIMARY FG_SECONDARY FG_MUTED
    export ACCENT ACCENT_ALT
    export RED GREEN YELLOW BLUE PURPLE CYAN ORANGE PINK
    export BRIGHT_RED BRIGHT_GREEN BRIGHT_YELLOW BRIGHT_BLUE BRIGHT_PURPLE BRIGHT_CYAN
    export BORDER_ACTIVE BORDER_INACTIVE SELECTION CURSOR
    export GRADIENT_START GRADIENT_END
    export GTK_THEME ICON_THEME CURSOR_THEME KVANTUM_THEME
    export NVIM_COLORSCHEME

    # Process Hyprland looknfeel
    if [[ -f "${TEMPLATES_DIR}/hyprland-looknfeel.conf.tpl" ]]; then
        print_info "  Updating Hyprland appearance..."
        process_template "${TEMPLATES_DIR}/hyprland-looknfeel.conf.tpl" "${CONFIG_DIR}/hypr/looknfeel.conf"
    fi

    # Process Waybar style
    if [[ -f "${TEMPLATES_DIR}/waybar-style.css.tpl" ]]; then
        print_info "  Updating Waybar style..."
        process_template "${TEMPLATES_DIR}/waybar-style.css.tpl" "${CONFIG_DIR}/waybar/style.css"
    fi

    # Process Alacritty
    if [[ -f "${TEMPLATES_DIR}/alacritty.toml.tpl" ]]; then
        print_info "  Updating Alacritty colors..."
        mkdir -p "${CONFIG_DIR}/alacritty"
        process_template "${TEMPLATES_DIR}/alacritty.toml.tpl" "${CONFIG_DIR}/alacritty/alacritty.toml"
    fi

    # Process Kitty
    if [[ -f "${TEMPLATES_DIR}/kitty.conf.tpl" ]]; then
        print_info "  Updating Kitty colors..."
        mkdir -p "${CONFIG_DIR}/kitty"
        process_template "${TEMPLATES_DIR}/kitty.conf.tpl" "${CONFIG_DIR}/kitty/kitty.conf"
    fi

    # Process Wofi
    if [[ -f "${TEMPLATES_DIR}/wofi-style.css.tpl" ]]; then
        print_info "  Updating Wofi style..."
        mkdir -p "${CONFIG_DIR}/wofi"
        process_template "${TEMPLATES_DIR}/wofi-style.css.tpl" "${CONFIG_DIR}/wofi/style.css"
    fi

    # Process Hyprlock
    if [[ -f "${TEMPLATES_DIR}/hyprlock.conf.tpl" ]]; then
        print_info "  Updating Hyprlock appearance..."
        process_template "${TEMPLATES_DIR}/hyprlock.conf.tpl" "${CONFIG_DIR}/hypr/hyprlock.conf"
    fi

    # Process Starship
    if [[ -f "${TEMPLATES_DIR}/starship.toml.tpl" ]]; then
        print_info "  Updating Starship prompt..."
        process_template "${TEMPLATES_DIR}/starship.toml.tpl" "${CONFIG_DIR}/starship.toml"
    fi

    # Process SwayNC
    if [[ -f "${TEMPLATES_DIR}/swaync-style.css.tpl" ]]; then
        print_info "  Updating SwayNC style..."
        mkdir -p "${CONFIG_DIR}/swaync"
        process_template "${TEMPLATES_DIR}/swaync-style.css.tpl" "${CONFIG_DIR}/swaync/style.css"
    fi

    # Apply GTK theme
    print_info "  Applying GTK theme..."
    if command -v gsettings &> /dev/null; then
        gsettings set org.gnome.desktop.interface gtk-theme "${GTK_THEME}" 2>/dev/null || true
        gsettings set org.gnome.desktop.interface icon-theme "${ICON_THEME}" 2>/dev/null || true
        gsettings set org.gnome.desktop.interface cursor-theme "${CURSOR_THEME}" 2>/dev/null || true
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark' 2>/dev/null || true
    fi

    # Apply Kvantum theme
    print_info "  Applying Kvantum theme..."
    if command -v kvantummanager &> /dev/null; then
        kvantummanager --set "${KVANTUM_THEME}" 2>/dev/null || true
    fi

    # Update Neovim colorscheme
    print_info "  Updating Neovim colorscheme..."
    local nvim_colors_file="${CONFIG_DIR}/nvim/lua/current-colorscheme.lua"
    mkdir -p "${CONFIG_DIR}/nvim/lua"
    echo "-- Auto-generated by vulcan-theme" > "${nvim_colors_file}"
    echo "return \"${NVIM_COLORSCHEME}\"" >> "${nvim_colors_file}"

    # Reload services
    print_info "Reloading services..."

    # Reload Hyprland
    if command -v hyprctl &> /dev/null && pgrep -x Hyprland &> /dev/null; then
        hyprctl reload &> /dev/null || true
    fi

    # Restart Waybar
    if pgrep -x waybar &> /dev/null; then
        pkill waybar 2>/dev/null || true
        sleep 0.5
        waybar &> /dev/null &
        disown
    fi

    # Reload SwayNC
    if command -v swaync-client &> /dev/null && pgrep -x swaync &> /dev/null; then
        swaync-client -R &> /dev/null || true
        swaync-client -rs &> /dev/null || true
    fi

    # Save current theme
    if [[ "${save}" == "true" ]]; then
        echo "${theme_id}" > "${CURRENT_THEME_FILE}"
    fi

    print_success "Theme '${theme_name}' applied successfully!"
    echo ""
    echo -e "${YELLOW}Note:${NC} Some applications may need to be restarted to see changes:"
    echo "  - Terminal emulators (Alacritty, Kitty)"
    echo "  - Neovim (run :source \$MYVIMRC or restart)"
    echo ""
}

# Preview theme without saving
preview_theme() {
    local theme_id="$1"

    print_warning "Previewing theme: ${theme_id}"
    echo "Note: This change is temporary. Use 'vulcan-theme set ${theme_id}' to make it permanent."
    echo ""

    apply_theme "${theme_id}" "false"
}

# Launch Wofi menu
launch_menu() {
    # Build menu entries
    local menu_entries=""
    local current
    current=$(get_current_theme)

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${current}" ]]; then
            menu_entries+="${name} ✓\n"
        else
            menu_entries+="${name}\n"
        fi
    done

    # Show Wofi menu
    local selection
    selection=$(echo -e "${menu_entries}" | wofi --dmenu --prompt "Select Theme" --cache-file /dev/null 2>/dev/null)

    # Handle selection
    if [[ -n "${selection}" ]]; then
        # Remove the checkmark if present
        selection="${selection% ✓}"

        # Find the theme ID
        for theme_entry in "${THEMES[@]}"; do
            IFS=':' read -r id name desc <<< "${theme_entry}"
            if [[ "${name}" == "${selection}" ]]; then
                apply_theme "${id}"
                # Send notification
                if command -v notify-send &> /dev/null; then
                    notify-send "Theme Changed" "Applied ${name} theme" -i preferences-desktop-theme
                fi
                exit 0
            fi
        done

        print_error "Theme not found: ${selection}"
        exit 1
    fi
}

# Show help
show_help() {
    echo ""
    echo -e "${PURPLE}VulcanOS Theme Switcher${NC}"
    echo ""
    echo "Usage: vulcan-theme [command] [theme]"
    echo ""
    echo "Commands:"
    echo "  list              List all available themes"
    echo "  current           Show the current theme"
    echo "  set <theme>       Apply a theme permanently"
    echo "  preview <theme>   Preview a theme without saving"
    echo "  menu              Launch the Wofi theme selector"
    echo "  help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  vulcan-theme list"
    echo "  vulcan-theme set catppuccin-mocha"
    echo "  vulcan-theme menu"
    echo ""
}

# Main entry point
main() {
    local command="${1:-help}"
    local theme="${2:-}"

    case "${command}" in
        list)
            list_themes
            ;;
        current)
            current=$(get_current_theme)
            name=$(get_theme_name "${current}")
            echo "Current theme: ${name} (${current})"
            ;;
        set)
            if [[ -z "${theme}" ]]; then
                print_error "Please specify a theme"
                echo "Run 'vulcan-theme list' to see available themes"
                exit 1
            fi
            apply_theme "${theme}"
            ;;
        preview)
            if [[ -z "${theme}" ]]; then
                print_error "Please specify a theme"
                echo "Run 'vulcan-theme list' to see available themes"
                exit 1
            fi
            preview_theme "${theme}"
            ;;
        menu)
            launch_menu
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: ${command}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
