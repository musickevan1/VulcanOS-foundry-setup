#!/bin/bash
# VulcanOS Theme Switcher
# Usage: vulcan-theme [command] [theme]
# Commands: list, current, set, menu, preview

set -e

# Configuration
THEMES_DIR="${HOME}/.config/themes"
COLORS_DIR="${THEMES_DIR}/colors"
TEMPLATES_DIR="${THEMES_DIR}/templates"
CONFIG_DIR="${HOME}/.config"
VULCAN_CONFIG="${CONFIG_DIR}/vulcan"
CURRENT_THEME_FILE="${VULCAN_CONFIG}/current-theme"

# Ensure vulcan config directory exists
mkdir -p "${VULCAN_CONFIG}"

# Dynamic theme discovery - scans colors directory for .sh files
# Each theme file must export THEME_NAME and THEME_ID
# Optionally exports THEME_DESCRIPTION for menu display
discover_themes() {
    THEMES=()

    # Scan main colors directory
    if [[ -d "${COLORS_DIR}" ]]; then
        for theme_file in "${COLORS_DIR}"/*.sh; do
            [[ -f "${theme_file}" ]] || continue

            # Source in subshell to extract metadata without polluting environment
            local metadata
            metadata=$(
                unset THEME_NAME THEME_ID THEME_DESCRIPTION
                # shellcheck source=/dev/null
                source "${theme_file}" 2>/dev/null
                echo "${THEME_ID:-}:${THEME_NAME:-}:${THEME_DESCRIPTION:-No description}"
            )

            local id name desc
            IFS=':' read -r id name desc <<< "${metadata}"

            # Only add if we have valid id and name
            if [[ -n "${id}" && -n "${name}" ]]; then
                THEMES+=("${id}:${name}:${desc}")
            fi
        done
    fi

    # Scan custom themes directory
    if [[ -d "${COLORS_DIR}/custom" ]]; then
        for theme_file in "${COLORS_DIR}/custom"/*.sh; do
            [[ -f "${theme_file}" ]] || continue

            local metadata
            metadata=$(
                unset THEME_NAME THEME_ID THEME_DESCRIPTION
                # shellcheck source=/dev/null
                source "${theme_file}" 2>/dev/null
                echo "${THEME_ID:-}:${THEME_NAME:-}:${THEME_DESCRIPTION:-Custom theme}"
            )

            local id name desc
            IFS=':' read -r id name desc <<< "${metadata}"

            if [[ -n "${id}" && -n "${name}" ]]; then
                # Mark custom themes with [custom] prefix in description
                THEMES+=("${id}:${name}:[custom] ${desc}")
            fi
        done
    fi

    # Sort themes alphabetically by name
    IFS=$'\n' THEMES=($(sort -t: -k2 <<<"${THEMES[*]}")); unset IFS
}

# Initialize themes array
discover_themes

# Color output helpers (using _CLR prefix to avoid conflicts with theme variables)
_CLR_RED='\033[0;31m'
_CLR_GREEN='\033[0;32m'
_CLR_YELLOW='\033[0;33m'
_CLR_BLUE='\033[0;34m'
_CLR_PURPLE='\033[0;35m'
_CLR_CYAN='\033[0;36m'
_CLR_NC='\033[0m' # No Color

# Convert hex color to RGB components (comma-separated for CSS rgba())
hex_to_rgb() {
    local hex="${1#\#}"
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo "${r}, ${g}, ${b}"
}

# Convert hex color to RGB components (semicolon-separated for ANSI escape)
hex_to_rgb_ansi() {
    local hex="${1#\#}"
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo "${r};${g};${b}"
}

print_info() {
    echo -e "${_CLR_BLUE}[INFO]${_CLR_NC} $1"
}

print_success() {
    echo -e "${_CLR_GREEN}[SUCCESS]${_CLR_NC} $1"
}

print_error() {
    echo -e "${_CLR_RED}[ERROR]${_CLR_NC} $1"
}

print_warning() {
    echo -e "${_CLR_YELLOW}[WARNING]${_CLR_NC} $1"
}

# Get current theme
get_current_theme() {
    if [[ -f "${CURRENT_THEME_FILE}" ]]; then
        cat "${CURRENT_THEME_FILE}"
    else
        echo "vulcan-forge"
    fi
}

# Generate GTK CSS file with current theme colors
# This creates CSS files for both GTK3 and GTK4 applications
generate_gtk_css() {
    local css_file="${VULCAN_CONFIG}/current-theme.css"
    local gtk4_css="${CONFIG_DIR}/gtk-4.0/gtk.css"
    local gtk3_css="${CONFIG_DIR}/gtk-3.0/gtk.css"

    print_info "  Generating GTK CSS..."

    # Ensure directories exist
    mkdir -p "${CONFIG_DIR}/gtk-4.0"
    mkdir -p "${CONFIG_DIR}/gtk-3.0"

    # CSS content for both GTK3 and GTK4
    local css_content
    css_content=$(cat <<EOF
/* Theme: ${THEME_NAME} (${THEME_ID}) */
/* Generated by vulcan-theme - do not edit manually */

/* Theme color definitions */
@define-color theme_accent ${ACCENT};
@define-color theme_bg_primary ${BG_PRIMARY};
@define-color theme_bg_secondary ${BG_SECONDARY};
@define-color theme_bg_tertiary ${BG_TERTIARY};
@define-color theme_fg_primary ${FG_PRIMARY};
@define-color theme_fg_secondary ${FG_SECONDARY};
@define-color theme_fg_muted ${FG_MUTED};
@define-color theme_red ${RED};
@define-color theme_green ${GREEN};
@define-color theme_yellow ${YELLOW};
@define-color theme_blue ${BLUE};
@define-color theme_purple ${PURPLE};
@define-color theme_cyan ${CYAN};
@define-color theme_border_active ${BORDER_ACTIVE};
@define-color theme_border_inactive ${BORDER_INACTIVE};

/* Override Adwaita/Libadwaita accent colors with theme accent */
@define-color accent_bg_color ${ACCENT};
@define-color accent_color ${ACCENT};

/* Additional Libadwaita color overrides for consistency */
@define-color window_bg_color ${BG_PRIMARY};
@define-color window_fg_color ${FG_PRIMARY};
@define-color view_bg_color ${BG_SECONDARY};
@define-color view_fg_color ${FG_PRIMARY};
@define-color headerbar_bg_color ${BG_SECONDARY};
@define-color headerbar_fg_color ${FG_PRIMARY};
@define-color card_bg_color ${BG_TERTIARY};
@define-color card_fg_color ${FG_PRIMARY};
@define-color popover_bg_color ${BG_SECONDARY};
@define-color popover_fg_color ${FG_PRIMARY};
EOF
)

    # Write to all locations
    echo "${css_content}" > "${css_file}"
    echo "${css_content}" > "${gtk4_css}"
    echo "${css_content}" > "${gtk3_css}"
}

# Generate terminal greeting colors file
# This allows .bashrc to source theme colors without being templated itself
generate_greeting_colors() {
    local greeting_file="${VULCAN_CONFIG}/greeting-colors.sh"
    print_info "  Generating greeting colors..."

    local accent_rgb=$(hex_to_rgb_ansi "${ACCENT}")
    local accent_alt_rgb=$(hex_to_rgb_ansi "${ACCENT_ALT}")

    cat > "${greeting_file}" << EOF
# VulcanOS Greeting Colors - Theme: ${THEME_NAME}
# Generated by vulcan-theme - do not edit manually
VULCAN_GREETING_COLOR1='\033[38;2;${accent_rgb}m'
VULCAN_GREETING_COLOR2='\033[38;2;${accent_alt_rgb}m'
VULCAN_GREETING_RESET='\033[0m'
EOF
}

# List available themes
list_themes() {
    echo ""
    echo -e "${_CLR_PURPLE}Available Themes${_CLR_NC}"
    echo "─────────────────────────────────────────────"

    current=$(get_current_theme)

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${current}" ]]; then
            echo -e "  ${_CLR_GREEN}●${_CLR_NC} ${name} (${id}) ${_CLR_GREEN}[current]${_CLR_NC}"
        else
            echo -e "  ○ ${name} (${id})"
        fi
        echo -e "    ${_CLR_CYAN}${desc}${_CLR_NC}"
    done
    echo ""
}

# Validate theme exists
validate_theme() {
    local theme_id="$1"

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${theme_id}" ]]; then
            return 0
        fi
    done
    return 1
}

# Get theme name from ID
get_theme_name() {
    local theme_id="$1"

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${theme_id}" ]]; then
            echo "${name}"
            return 0
        fi
    done
    echo "${theme_id}"
}

# Process a single template
process_template() {
    local template="$1"
    local output="$2"

    # Ensure output directory exists
    mkdir -p "$(dirname "${output}")"

    # Only substitute theme-specific variables (not starship's $user, $path, etc.)
    local vars='$THEME_NAME $THEME_ID $BG_PRIMARY $BG_SECONDARY $BG_TERTIARY $BG_SURFACE'
    vars+=' $FG_PRIMARY $FG_SECONDARY $FG_MUTED $ACCENT $ACCENT_ALT'
    vars+=' $RED $GREEN $YELLOW $BLUE $PURPLE $CYAN $ORANGE $PINK'
    vars+=' $BRIGHT_RED $BRIGHT_GREEN $BRIGHT_YELLOW $BRIGHT_BLUE $BRIGHT_PURPLE $BRIGHT_CYAN'
    vars+=' $BORDER_ACTIVE $BORDER_INACTIVE $SELECTION $CURSOR'
    vars+=' $GRADIENT_START $GRADIENT_END'
    vars+=' $GTK_THEME $ICON_THEME $CURSOR_THEME $KVANTUM_THEME'
    vars+=' $NVIM_COLORSCHEME $THEME_WALLPAPER'
    # _RAW variants (hex without # for Hyprland rgba())
    vars+=' $GRADIENT_START_RAW $GRADIENT_END_RAW $BORDER_INACTIVE_RAW $BG_SURFACE_RAW'
    vars+=' $ACCENT_RAW $RED_RAW $FG_PRIMARY_RAW $BG_PRIMARY_RAW $BG_SECONDARY_RAW $GREEN_RAW'
    # _RGB variants (comma-separated for CSS rgba())
    vars+=' $BG_PRIMARY_RGB $BG_TERTIARY_RGB'

    envsubst "${vars}" < "${template}" > "${output}"
}

# Apply theme to all components
apply_theme() {
    local theme_id="$1"
    local save="${2:-true}"

    # Validate theme
    if ! validate_theme "${theme_id}"; then
        print_error "Unknown theme: ${theme_id}"
        echo "Run 'vulcan-theme list' to see available themes"
        exit 1
    fi

    local theme_name
    theme_name=$(get_theme_name "${theme_id}")

    print_info "Applying theme: ${theme_name}"

    # Source the theme colors
    local color_file="${COLORS_DIR}/${theme_id}.sh"
    if [[ ! -f "${color_file}" ]]; then
        print_error "Theme color file not found: ${color_file}"
        exit 1
    fi

    # shellcheck source=/dev/null
    source "${color_file}"

    # Create RAW versions (without #) for Hyprland rgba() format
    export GRADIENT_START_RAW="${GRADIENT_START//#/}"
    export GRADIENT_END_RAW="${GRADIENT_END//#/}"
    export BORDER_INACTIVE_RAW="${BORDER_INACTIVE//#/}"
    export BG_SURFACE_RAW="${BG_SURFACE//#/}"
    export ACCENT_RAW="${ACCENT//#/}"
    export RED_RAW="${RED//#/}"
    export FG_PRIMARY_RAW="${FG_PRIMARY//#/}"
    export BG_PRIMARY_RAW="${BG_PRIMARY//#/}"
    export BG_SECONDARY_RAW="${BG_SECONDARY//#/}"
    export GREEN_RAW="${GREEN//#/}"

    # Create RGB versions (comma-separated for CSS rgba())
    export BG_PRIMARY_RGB=$(hex_to_rgb "${BG_PRIMARY}")
    export BG_TERTIARY_RGB=$(hex_to_rgb "${BG_TERTIARY}")

    # Export all variables for envsubst
    export THEME_NAME THEME_ID
    export BG_PRIMARY BG_SECONDARY BG_TERTIARY BG_SURFACE
    export FG_PRIMARY FG_SECONDARY FG_MUTED
    export ACCENT ACCENT_ALT
    export RED GREEN YELLOW BLUE PURPLE CYAN ORANGE PINK
    export BRIGHT_RED BRIGHT_GREEN BRIGHT_YELLOW BRIGHT_BLUE BRIGHT_PURPLE BRIGHT_CYAN
    export BORDER_ACTIVE BORDER_INACTIVE SELECTION CURSOR
    export GRADIENT_START GRADIENT_END
    export GTK_THEME ICON_THEME CURSOR_THEME KVANTUM_THEME
    export NVIM_COLORSCHEME

    # Process Hyprland looknfeel
    if [[ -f "${TEMPLATES_DIR}/hyprland-looknfeel.conf.tpl" ]]; then
        print_info "  Updating Hyprland appearance..."
        process_template "${TEMPLATES_DIR}/hyprland-looknfeel.conf.tpl" "${CONFIG_DIR}/hypr/looknfeel.conf"
    fi

    # Process Waybar style
    if [[ -f "${TEMPLATES_DIR}/waybar-style.css.tpl" ]]; then
        print_info "  Updating Waybar style..."
        process_template "${TEMPLATES_DIR}/waybar-style.css.tpl" "${CONFIG_DIR}/waybar/style.css"
    fi

    # Process Alacritty
    if [[ -f "${TEMPLATES_DIR}/alacritty.toml.tpl" ]]; then
        print_info "  Updating Alacritty colors..."
        mkdir -p "${CONFIG_DIR}/alacritty"
        process_template "${TEMPLATES_DIR}/alacritty.toml.tpl" "${CONFIG_DIR}/alacritty/alacritty.toml"
    fi

    # Process Kitty
    if [[ -f "${TEMPLATES_DIR}/kitty.conf.tpl" ]]; then
        print_info "  Updating Kitty colors..."
        mkdir -p "${CONFIG_DIR}/kitty"
        process_template "${TEMPLATES_DIR}/kitty.conf.tpl" "${CONFIG_DIR}/kitty/kitty.conf"
    fi

    # Process Wofi
    if [[ -f "${TEMPLATES_DIR}/wofi-style.css.tpl" ]]; then
        print_info "  Updating Wofi style..."
        mkdir -p "${CONFIG_DIR}/wofi"
        process_template "${TEMPLATES_DIR}/wofi-style.css.tpl" "${CONFIG_DIR}/wofi/style.css"
    fi

    # Process Hyprlock
    if [[ -f "${TEMPLATES_DIR}/hyprlock.conf.tpl" ]]; then
        print_info "  Updating Hyprlock appearance..."
        process_template "${TEMPLATES_DIR}/hyprlock.conf.tpl" "${CONFIG_DIR}/hypr/hyprlock.conf"
    fi

    # Process Starship
    if [[ -f "${TEMPLATES_DIR}/starship.toml.tpl" ]]; then
        print_info "  Updating Starship prompt..."
        process_template "${TEMPLATES_DIR}/starship.toml.tpl" "${CONFIG_DIR}/starship.toml"
    fi

    # Process SwayNC
    if [[ -f "${TEMPLATES_DIR}/swaync-style.css.tpl" ]]; then
        print_info "  Updating SwayNC style..."
        mkdir -p "${CONFIG_DIR}/swaync"
        process_template "${TEMPLATES_DIR}/swaync-style.css.tpl" "${CONFIG_DIR}/swaync/style.css"
    fi

    # Process Yazi
    if [[ -f "${TEMPLATES_DIR}/yazi-theme.toml.tpl" ]]; then
        print_info "  Updating Yazi theme..."
        mkdir -p "${CONFIG_DIR}/yazi"
        process_template "${TEMPLATES_DIR}/yazi-theme.toml.tpl" "${CONFIG_DIR}/yazi/theme.toml"
    fi

    # Process nwg-dock-hyprland
    if [[ -f "${TEMPLATES_DIR}/nwg-dock-style.css.tpl" ]]; then
        print_info "  Updating nwg-dock-hyprland style..."
        mkdir -p "${CONFIG_DIR}/nwg-dock-hyprland"
        process_template "${TEMPLATES_DIR}/nwg-dock-style.css.tpl" "${CONFIG_DIR}/nwg-dock-hyprland/style.css"
    fi

    # Process launcher icon SVG
    if [[ -f "${TEMPLATES_DIR}/launcher-icon.svg.tpl" ]]; then
        print_info "  Updating launcher icon..."
        mkdir -p "${CONFIG_DIR}/nwg-dock-hyprland"
        process_template "${TEMPLATES_DIR}/launcher-icon.svg.tpl" "${CONFIG_DIR}/nwg-dock-hyprland/launcher.svg"
    fi

    # Apply GTK theme
    print_info "  Applying GTK theme..."
    if command -v gsettings &> /dev/null; then
        timeout 2 gsettings set org.gnome.desktop.interface gtk-theme "${GTK_THEME}" 2>/dev/null || true
        timeout 2 gsettings set org.gnome.desktop.interface icon-theme "${ICON_THEME}" 2>/dev/null || true
        timeout 2 gsettings set org.gnome.desktop.interface cursor-theme "${CURSOR_THEME}" 2>/dev/null || true
        timeout 2 gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark' 2>/dev/null || true
    fi

    # Apply Kvantum theme
    print_info "  Applying Kvantum theme..."
    if command -v kvantummanager &> /dev/null; then
        timeout 2 kvantummanager --set "${KVANTUM_THEME}" 2>/dev/null || true
    fi

    # Update Neovim colorscheme
    print_info "  Updating Neovim colorscheme..."
    local nvim_colors_file="${CONFIG_DIR}/nvim/lua/current-colorscheme.lua"
    mkdir -p "${CONFIG_DIR}/nvim/lua"
    echo "-- Auto-generated by vulcan-theme" > "${nvim_colors_file}"
    echo "return \"${NVIM_COLORSCHEME}\"" >> "${nvim_colors_file}"

    # Set wallpaper if theme has one
    if [[ -n "${THEME_WALLPAPER:-}" ]]; then
        local wallpaper_path="${HOME}/Pictures/Wallpapers/${THEME_WALLPAPER}"
        if [[ -f "${wallpaper_path}" ]]; then
            print_info "  Setting wallpaper..."
            # Update hyprpaper config
            local hyprpaper_conf="${CONFIG_DIR}/hypr/hyprpaper.conf"
            if [[ -f "${hyprpaper_conf}" ]]; then
                cat > "${hyprpaper_conf}" << EOF
preload = ${wallpaper_path}
wallpaper = ,${wallpaper_path}
splash = false
EOF
            fi
            # Reload hyprpaper
            pkill hyprpaper 2>/dev/null || true
            sleep 0.2
            hyprctl dispatch exec hyprpaper &> /dev/null || true
        fi
    fi

    # Generate GTK CSS file for applications that load it at runtime
    generate_gtk_css

    # Generate terminal greeting colors
    generate_greeting_colors

    # Reload services
    print_info "Reloading services..."

    # Reload Hyprland
    if command -v hyprctl &> /dev/null && pgrep -x Hyprland &> /dev/null; then
        timeout 2 hyprctl reload &> /dev/null || true
    fi

    # Restart Waybar (use hyprctl to launch in user session context)
    pkill -9 waybar 2>/dev/null || true
    sleep 0.5
    hyprctl dispatch exec waybar &> /dev/null
    sleep 0.3

    # Reload SwayNC
    if command -v swaync-client &> /dev/null && pgrep -x swaync &> /dev/null; then
        timeout 2 swaync-client -R &> /dev/null || true
        timeout 2 swaync-client -rs &> /dev/null || true
    fi

    # Restart nwg-dock-hyprland if running (to reload CSS and icon)
    if pgrep -f "nwg-dock-hyprland" &> /dev/null; then
        print_info "  Restarting nwg-dock-hyprland..."
        pkill -f "nwg-dock-hyprland" 2>/dev/null || true
        sleep 0.3
        # Re-launch dock with themed launcher icon
        local launcher_icon="${CONFIG_DIR}/nwg-dock-hyprland/launcher.svg"
        if [[ -f "${launcher_icon}" ]]; then
            hyprctl dispatch exec "nwg-dock-hyprland -r -i 48 -mb 10 -l top -ico '${launcher_icon}' -c 'wofi --show drun --allow-images --prompt Launch'" &> /dev/null || true
        else
            hyprctl dispatch exec "nwg-dock-hyprland -r -i 48 -mb 10 -l top -c 'wofi --show drun --allow-images --prompt Launch'" &> /dev/null || true
        fi
    fi

    # Save current theme
    if [[ "${save}" == "true" ]]; then
        echo "${theme_id}" > "${CURRENT_THEME_FILE}"
    fi

    print_success "Theme '${theme_name}' applied successfully!"
    echo ""
    echo -e "${_CLR_YELLOW}Note:${_CLR_NC} Some applications may need to be restarted to see changes:"
    echo "  - Terminal emulators (Alacritty, Kitty)"
    echo "  - Neovim (run :source \$MYVIMRC or restart)"
    echo ""
}

# Preview theme without saving
preview_theme() {
    local theme_id="$1"

    print_warning "Previewing theme: ${theme_id}"
    echo "Note: This change is temporary. Use 'vulcan-theme set ${theme_id}' to make it permanent."
    echo ""

    apply_theme "${theme_id}" "false"
}

# Launch Wofi menu
launch_menu() {
    # Build menu entries
    local menu_entries=""
    local current
    current=$(get_current_theme)

    for theme_entry in "${THEMES[@]}"; do
        IFS=':' read -r id name desc <<< "${theme_entry}"
        if [[ "${id}" == "${current}" ]]; then
            menu_entries+="${name} ✓\n"
        else
            menu_entries+="${name}\n"
        fi
    done

    # Show Wofi menu
    local selection
    selection=$(echo -e "${menu_entries}" | wofi --dmenu --prompt "Select Theme" --cache-file /dev/null 2>/dev/null)

    # Handle selection
    if [[ -n "${selection}" ]]; then
        # Remove the checkmark if present
        selection="${selection% ✓}"

        # Find the theme ID
        for theme_entry in "${THEMES[@]}"; do
            IFS=':' read -r id name desc <<< "${theme_entry}"
            if [[ "${name}" == "${selection}" ]]; then
                apply_theme "${id}"
                # Send notification
                if command -v notify-send &> /dev/null; then
                    notify-send "Theme Changed" "Applied ${name} theme" -i preferences-desktop-theme
                fi
                exit 0
            fi
        done

        print_error "Theme not found: ${selection}"
        exit 1
    fi
}

# Show help
show_help() {
    echo ""
    echo -e "${PURPLE}VulcanOS Theme Switcher${NC}"
    echo ""
    echo "Usage: vulcan-theme [command] [theme]"
    echo ""
    echo "Commands:"
    echo "  list              List all available themes"
    echo "  current           Show the current theme"
    echo "  set <theme>       Apply a theme permanently"
    echo "  preview <theme>   Preview a theme without saving"
    echo "  menu              Launch the Wofi theme selector"
    echo "  help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  vulcan-theme list"
    echo "  vulcan-theme set catppuccin-mocha"
    echo "  vulcan-theme menu"
    echo ""
}

# Main entry point
main() {
    local command="${1:-help}"
    local theme="${2:-}"

    case "${command}" in
        list)
            list_themes
            ;;
        list-ids)
            # Output theme IDs and names in parseable format (for vulcan-menu integration)
            for theme_entry in "${THEMES[@]}"; do
                IFS=':' read -r id name desc <<< "${theme_entry}"
                echo "${id}:${name}"
            done
            ;;
        current)
            current=$(get_current_theme)
            name=$(get_theme_name "${current}")
            echo "Current theme: ${name} (${current})"
            ;;
        set)
            if [[ -z "${theme}" ]]; then
                print_error "Please specify a theme"
                echo "Run 'vulcan-theme list' to see available themes"
                exit 1
            fi
            apply_theme "${theme}"
            ;;
        preview)
            if [[ -z "${theme}" ]]; then
                print_error "Please specify a theme"
                echo "Run 'vulcan-theme list' to see available themes"
                exit 1
            fi
            preview_theme "${theme}"
            ;;
        menu)
            launch_menu
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: ${command}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
