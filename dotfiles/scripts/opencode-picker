#!/bin/bash
# OpenCode Directory Picker v2.0
# Shows a wofi popup to select a project directory before launching opencode
# Improved: Uses opencode's actual project history, better sorting, and faster scans

set -euo pipefail

# Configuration
OPENCODE_PROJECTS_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/opencode/storage/project"
HISTORY_FILE="${XDG_DATA_HOME:-$HOME/.local/share}/opencode-picker-history"
MAX_RECENT=10
MAX_ZOXIDE=10
MAX_GIT_PROJECTS=30

# Project roots to scan for git repos
PROJECT_ROOTS=(
    "$HOME/Projects"
    "$HOME/code"
    "$HOME/work"
    "$HOME/VulcanOS"
    "$HOME/dev"
)

# Directories to exclude from zoxide suggestions
EXCLUDE_PATTERNS=(
    "^/$"
    "^/home$"
    "^/home/[^/]+$"
    "/Downloads$"
    "/Documents$"
    "/Pictures$"
    "/Videos$"
    "/Music$"
    "/Desktop$"
    "/\.cache"
    "/\.local/share$"
    "/node_modules"
    "/\.git$"
    "/dist$"
    "/build$"
    "/target$"
    "/\.venv"
    "/venv$"
    "/MSU/"
)

# Build exclusion regex
build_exclude_regex() {
    local regex=""
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        if [[ -n "$regex" ]]; then
            regex="$regex|$pattern"
        else
            regex="$pattern"
        fi
    done
    echo "$regex"
}

# Get opencode's actual project history (sorted by most recently used)
get_opencode_projects() {
    if [[ ! -d "$OPENCODE_PROJECTS_DIR" ]]; then
        return
    fi
    
    # Read all project JSON files, extract worktree and updated time, sort by time
    for f in "$OPENCODE_PROJECTS_DIR"/*.json; do
        [[ -f "$f" ]] || continue
        # Skip global.json
        [[ "$(basename "$f")" == "global.json" ]] && continue
        
        local worktree updated
        worktree=$(jq -r '.worktree // empty' "$f" 2>/dev/null)
        updated=$(jq -r '.time.updated // 0' "$f" 2>/dev/null)
        
        if [[ -n "$worktree" && -d "$worktree" ]]; then
            echo "$updated $worktree"
        fi
    done | sort -rn | head -n "$MAX_RECENT" | cut -d' ' -f2-
}

# Get picker-specific history (for directories opened via picker but not in opencode history)
get_picker_history() {
    if [[ -f "$HISTORY_FILE" ]]; then
        # Return only directories that still exist
        while IFS= read -r dir; do
            [[ -d "$dir" ]] && echo "$dir"
        done < "$HISTORY_FILE" | head -n 5
    fi
}

# Save to picker history
save_to_history() {
    local dir="$1"
    
    # Create temp file with new entry at top, removing duplicates
    {
        echo "$dir"
        if [[ -f "$HISTORY_FILE" ]]; then
            grep -v "^${dir}$" "$HISTORY_FILE" 2>/dev/null || true
        fi
    } | head -n 20 > "${HISTORY_FILE}.tmp"
    
    mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
}

# Get zoxide suggestions (filtered)
get_zoxide_recent() {
    if ! command -v zoxide &> /dev/null; then
        return
    fi
    
    local exclude_regex
    exclude_regex=$(build_exclude_regex)
    
    zoxide query -l 2>/dev/null | \
        grep -Ev "$exclude_regex" | \
        while read -r dir; do
            # Only include directories that look like projects (have .git, package.json, etc.)
            if [[ -d "$dir/.git" ]] || \
               [[ -f "$dir/package.json" ]] || \
               [[ -f "$dir/Cargo.toml" ]] || \
               [[ -f "$dir/pyproject.toml" ]] || \
               [[ -f "$dir/go.mod" ]] || \
               [[ -f "$dir/Makefile" ]] || \
               [[ -f "$dir/CMakeLists.txt" ]]; then
                echo "$dir"
            fi
        done | head -n "$MAX_ZOXIDE"
}

# Fast git project discovery using fd if available, fallback to find
get_git_projects() {
    local dirs=()
    
    for base in "${PROJECT_ROOTS[@]}"; do
        [[ -d "$base" ]] && dirs+=("$base")
    done
    
    [[ ${#dirs[@]} -eq 0 ]] && return
    
    if command -v fd &> /dev/null; then
        # fd is much faster than find
        fd -H -t d '^\.git$' "${dirs[@]}" --max-depth 5 2>/dev/null | \
            sed 's/\/\.git$//' | \
            sort -u | \
            head -n "$MAX_GIT_PROJECTS"
    else
        # Fallback to find
        find "${dirs[@]}" -maxdepth 5 -type d -name ".git" 2>/dev/null | \
            sed 's/\/\.git$//' | \
            sort -u | \
            head -n "$MAX_GIT_PROJECTS"
    fi
}

# Format directory for display
format_entry() {
    local icon="$1"
    local path="$2"
    local name parent
    
    name=$(basename "$path")
    parent=$(basename "$(dirname "$path")")
    
    # Show parent/name for context, with full path after arrow
    if [[ "$parent" == "$(whoami)" ]] || [[ "$parent" == "home" ]]; then
        echo "$icon $name â†’ $path"
    else
        echo "$icon $parent/$name â†’ $path"
    fi
}

# Build the complete list
build_list() {
    local seen=()
    
    # Quick actions at top
    echo "ğŸ“‚ Browse with file picker..."
    echo "ğŸ“ Current directory: $(pwd)"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # OpenCode recent projects (highest priority)
    local opencode_projects
    opencode_projects=$(get_opencode_projects)
    
    if [[ -n "$opencode_projects" ]]; then
        echo "â˜… Recent OpenCode Projects"
        while IFS= read -r dir; do
            [[ -z "$dir" ]] && continue
            seen+=("$dir")
            format_entry "ğŸ”¥" "$dir"
        done <<< "$opencode_projects"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    fi
    
    # Zoxide suggestions (filtered to project-like directories)
    local zoxide_dirs
    zoxide_dirs=$(get_zoxide_recent)
    
    if [[ -n "$zoxide_dirs" ]]; then
        local has_zoxide_header=false
        while IFS= read -r dir; do
            [[ -z "$dir" ]] && continue
            # Skip if already shown
            local skip=false
            for s in "${seen[@]:-}"; do
                [[ "$s" == "$dir" ]] && skip=true && break
            done
            $skip && continue
            
            if ! $has_zoxide_header; then
                echo "â±ï¸  Frequently Used"
                has_zoxide_header=true
            fi
            
            seen+=("$dir")
            format_entry "ğŸ“" "$dir"
        done <<< "$zoxide_dirs"
        
        $has_zoxide_header && echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    fi
    
    # Git projects from project roots
    local git_projects
    git_projects=$(get_git_projects)
    
    if [[ -n "$git_projects" ]]; then
        echo "ğŸ“¦ Git Projects"
        while IFS= read -r dir; do
            [[ -z "$dir" ]] && continue
            # Skip if already shown
            local skip=false
            for s in "${seen[@]:-}"; do
                [[ "$s" == "$dir" ]] && skip=true && break
            done
            $skip && continue
            
            format_entry "ğŸ“¦" "$dir"
        done <<< "$git_projects"
    fi
}

# Main picker
main() {
    # Build list and show wofi
    local selected
    selected=$(build_list | wofi --dmenu \
        --prompt "ğŸš€ OpenCode" \
        --width 750 \
        --height 550 \
        --cache-file /dev/null \
        --insensitive \
        --matching fuzzy \
        2>/dev/null) || exit 0
    
    [[ -z "$selected" ]] && exit 0
    
    local dir=""
    
    # Handle selection
    case "$selected" in
        "ğŸ“‚ Browse with file picker..."*)
            # Use zenity or kdialog for GUI folder picker
            if command -v zenity &> /dev/null; then
                dir=$(zenity --file-selection --directory --title="Select Project Directory" 2>/dev/null) || exit 0
            elif command -v kdialog &> /dev/null; then
                dir=$(kdialog --getexistingdirectory "$HOME" 2>/dev/null) || exit 0
            elif command -v yad &> /dev/null; then
                dir=$(yad --file --directory --title="Select Project Directory" 2>/dev/null) || exit 0
            else
                notify-send "OpenCode Picker" "No file picker available (install zenity, kdialog, or yad)" --urgency=normal
                exit 1
            fi
            ;;
        "ğŸ“ Current directory:"*)
            dir="$(pwd)"
            ;;
        "â”€â”€â”€"*|"â˜… "*|"â±ï¸ "*|"ğŸ“¦ Git"*)
            # Header or separator, ignore
            exit 0
            ;;
        *" â†’ "*)
            # Extract path after arrow
            dir="${selected##* â†’ }"
            ;;
        *)
            # Try to use as-is (in case user types a path)
            if [[ -d "$selected" ]]; then
                dir="$selected"
            else
                notify-send "OpenCode Picker" "Invalid selection" --urgency=normal
                exit 1
            fi
            ;;
    esac
    
    # Validate and launch
    if [[ -n "$dir" && -d "$dir" ]]; then
        # Save to picker history
        save_to_history "$dir"
        
        # Update zoxide if available
        command -v zoxide &> /dev/null && zoxide add "$dir" 2>/dev/null || true
        
        # Launch opencode in kitty
        cd "$dir"
        exec kitty --title "OpenCode: $(basename "$dir")" -e opencode
    else
        notify-send "OpenCode Picker" "Invalid directory: $dir" --urgency=critical
        exit 1
    fi
}

main "$@"
