#!/bin/bash
# VulcanOS Systems Menu
# Central control hub for system management
# Usage: vulcan-menu [category] [action]

set -e

# Configuration
WOFI_WIDTH=400
WOFI_HEIGHT=450
TERMINAL="${TERMINAL:-kitty}"
EDITOR="${EDITOR:-nvim}"
CONFIG_DIR="${HOME}/.config"

# Icons (Nerd Font)
ICON_SYSTEM="󰒋"
ICON_STYLE="󰏘"
ICON_QUICK="󱁤"
ICON_INSTALL="󰏗"
ICON_REMOVE="󰩺"
ICON_SETUP="󰒓"
ICON_UPDATE="󰚰"
ICON_POWER="󰐥"
ICON_BACK="󰁍"
ICON_T2="󰌢"

# Helpers
notify() {
    if command -v notify-send &> /dev/null; then
        notify-send "Vulcan Menu" "$1" -i preferences-system -t 3000
    fi
}

run_in_terminal() {
    $TERMINAL -e "$@"
}

run_in_terminal_hold() {
    $TERMINAL --hold -e "$@"
}

# Wofi menu helper
wofi_menu() {
    local prompt="$1"
    local options="$2"
    local width="${3:-$WOFI_WIDTH}"
    local height="${4:-$WOFI_HEIGHT}"

    echo -e "$options" | wofi --dmenu \
        --prompt "$prompt" \
        --cache-file /dev/null \
        --width "$width" \
        --height "$height" \
        --location center \
        --hide-scroll \
        --no-actions 2>/dev/null
}

# =============================================================================
# MAIN MENU
# =============================================================================

show_main_menu() {
    local options="$ICON_SYSTEM  System
$ICON_STYLE  Style
$ICON_QUICK  Quick Settings
$ICON_INSTALL  Install
$ICON_REMOVE  Remove
$ICON_SETUP  Setup
$ICON_UPDATE  Update
$ICON_T2  T2 MacBook
$ICON_POWER  Power"

    local choice
    choice=$(wofi_menu "Vulcan Menu" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//' | tr '[:upper:]' '[:lower:]')

    case "$action" in
        "system")         show_system_menu ;;
        "style")          show_style_menu ;;
        "quick settings") show_quick_settings_menu ;;
        "install")        show_install_menu ;;
        "remove")         show_remove_menu ;;
        "setup")          show_setup_menu ;;
        "update")         show_update_menu ;;
        "t2 macbook")     show_t2_menu ;;
        "power")          exec vulcan-power ;;
        *)                exit 0 ;;
    esac
}

# =============================================================================
# DISPLAY SETTINGS SUBMENU
# =============================================================================

show_display_settings_menu() {
    local options="󰍹  HyprMon (TUI)
󰍺  nwg-displays (GUI)
󰸉  Wallpaper Profiles
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Display Settings" "$options" 320 240)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "HyprMon (TUI)")
            if command -v hyprmon &> /dev/null; then
                $TERMINAL --title "hyprmon" -- hyprmon
            else
                notify "HyprMon not found. Install with: yay -S hyprmon-bin"
            fi
            ;;
        "nwg-displays (GUI)")
            if command -v nwg-displays &> /dev/null; then
                nwg-displays &
            else
                notify "nwg-displays not found. Install with: pacman -S nwg-displays"
            fi
            ;;
        "Wallpaper Profiles")
            if command -v vulcan-wallpapers &> /dev/null; then
                run_in_terminal vulcan-wallpapers list
            else
                notify "vulcan-wallpapers not found. Ensure scripts are in PATH."
            fi
            ;;
        "Back")
            show_system_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

# =============================================================================
# QUICK SETTINGS SUBMENU
# =============================================================================

get_wifi_status() {
    # Check if iwd is running
    if ! systemctl is-active --quiet iwd; then
        echo "N/A"
        return
    fi
    
    # Check if any adapter is powered on
    # iwd doesn't have a global radio state, check device state instead
    local device
    device=$(iwctl device list 2>/dev/null | grep -E "wlan[0-9]|wlp" | awk '{print $4}' | head -1)
    
    if [[ "$device" == "on" ]] || iwctl station list 2>/dev/null | grep -q "connected\|disconnected"; then
        echo "On"
    else
        echo "Off"
    fi
}

get_bluetooth_status() {
    if command -v bluetoothctl &> /dev/null; then
        if bluetoothctl show 2>/dev/null | grep -q "Powered: yes"; then
            echo "On"
        else
            echo "Off"
        fi
    else
        echo "N/A"
    fi
}

get_dnd_status() {
    if command -v swaync-client &> /dev/null; then
        if swaync-client -D 2>/dev/null | grep -q "true"; then
            echo "On"
        else
            echo "Off"
        fi
    else
        echo "N/A"
    fi
}

get_autolock_status() {
    if pgrep -x hypridle &> /dev/null; then
        echo "Enabled"
    else
        echo "Disabled"
    fi
}

get_volume() {
    if command -v wpctl &> /dev/null; then
        wpctl get-volume @DEFAULT_AUDIO_SINK@ | awk '{print int($2 * 100)}'
    else
        echo "N/A"
    fi
}

get_brightness() {
    if command -v brightnessctl &> /dev/null; then
        brightnessctl -m | cut -d',' -f4 | tr -d '%'
    else
        echo "N/A"
    fi
}

show_quick_settings_menu() {
    local wifi_status
    local bt_status
    local dnd_status
    local autolock_status
    local volume
    local brightness

    wifi_status=$(get_wifi_status)
    bt_status=$(get_bluetooth_status)
    dnd_status=$(get_dnd_status)
    autolock_status=$(get_autolock_status)
    volume=$(get_volume)
    brightness=$(get_brightness)

    local options="󰖩  WiFi: $wifi_status
󰂯  Bluetooth: $bt_status
󰂚  Do Not Disturb: $dnd_status
󰌵  Auto-Lock: $autolock_status
󰍹  Brightness: ${brightness}%
󰕾  Volume: ${volume}%
󰀝  Keyboard Backlight
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Quick Settings" "$options" 350 420)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//' | cut -d':' -f1)

    case "$action" in
        "WiFi")
            if [[ "$wifi_status" == "N/A" ]]; then
                notify "iwd service not running"
                show_quick_settings_menu
                return
            fi
            
            # Get WiFi device name
            local wifi_device
            wifi_device=$(iwctl device list 2>/dev/null | grep -E "station" | awk '{print $2}' | head -1)
            
            if [[ -z "$wifi_device" ]]; then
                notify "No WiFi device found"
                show_quick_settings_menu
                return
            fi
            
            if [[ "$wifi_status" == "On" ]]; then
                # Disconnect and power off
                iwctl station "$wifi_device" disconnect 2>/dev/null
                iwctl adapter phy0 set-property Powered off 2>/dev/null
                notify "WiFi disabled"
            else
                # Power on
                iwctl adapter phy0 set-property Powered on 2>/dev/null
                notify "WiFi enabled (use iwctl to connect)"
            fi
            show_quick_settings_menu
            ;;
        "Bluetooth")
            if [[ "$bt_status" == "On" ]]; then
                bluetoothctl power off
                notify "Bluetooth disabled"
            else
                bluetoothctl power on
                notify "Bluetooth enabled"
            fi
            show_quick_settings_menu
            ;;
        "Do Not Disturb")
            if [[ "$dnd_status" == "On" ]]; then
                swaync-client -df
                notify "Do Not Disturb disabled"
            else
                swaync-client -dn
                notify "Do Not Disturb enabled"
            fi
            show_quick_settings_menu
            ;;
        "Auto-Lock")
            if [[ "$autolock_status" == "Enabled" ]]; then
                pkill hypridle
                notify "Auto-lock disabled"
            else
                hypridle &
                notify "Auto-lock enabled"
            fi
            show_quick_settings_menu
            ;;
        "Brightness")
            show_brightness_menu
            ;;
        "Volume")
            show_volume_menu
            ;;
        "Keyboard Backlight")
            show_kbd_backlight_quick_menu
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_brightness_menu() {
    local current
    current=$(get_brightness)

    local options="󰃞  25%
󰃟  50%
󰃝  75%
󰃠  100%
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Screen Brightness (Current: ${current}%)" "$options" 280 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "25%")
            brightnessctl set 25%
            notify "Brightness: 25%"
            show_quick_settings_menu
            ;;
        "50%")
            brightnessctl set 50%
            notify "Brightness: 50%"
            show_quick_settings_menu
            ;;
        "75%")
            brightnessctl set 75%
            notify "Brightness: 75%"
            show_quick_settings_menu
            ;;
        "100%")
            brightnessctl set 100%
            notify "Brightness: 100%"
            show_quick_settings_menu
            ;;
        "Back")
            show_quick_settings_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_volume_menu() {
    local current
    current=$(get_volume)

    local options="󰕿  25%
󰖀  50%
󰕾  75%
󰕾  100%
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Volume (Current: ${current}%)" "$options" 280 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "25%")
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 25%
            notify "Volume: 25%"
            show_quick_settings_menu
            ;;
        "50%")
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 50%
            notify "Volume: 50%"
            show_quick_settings_menu
            ;;
        "75%")
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 75%
            notify "Volume: 75%"
            show_quick_settings_menu
            ;;
        "100%")
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 100%
            notify "Volume: 100%"
            show_quick_settings_menu
            ;;
        "Back")
            show_quick_settings_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_kbd_backlight_quick_menu() {
    local current_brightness
    current_brightness=$(cat /sys/class/leds/*kbd_backlight/brightness 2>/dev/null || echo "N/A")
    local max_brightness
    max_brightness=$(cat /sys/class/leds/*kbd_backlight/max_brightness 2>/dev/null || echo "N/A")

    local options="󰃞  0% (Off)
󰃝  25%
󰃟  50%
󰃠  100%
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Keyboard Backlight (${current_brightness}/${max_brightness})" "$options" 320 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "0% (Off)")
            brightnessctl -d '*::kbd_backlight' set 0% 2>/dev/null
            notify "Keyboard backlight off"
            show_quick_settings_menu
            ;;
        "25%")
            brightnessctl -d '*::kbd_backlight' set 25% 2>/dev/null
            notify "Keyboard backlight: 25%"
            show_quick_settings_menu
            ;;
        "50%")
            brightnessctl -d '*::kbd_backlight' set 50% 2>/dev/null
            notify "Keyboard backlight: 50%"
            show_quick_settings_menu
            ;;
        "100%")
            brightnessctl -d '*::kbd_backlight' set 100% 2>/dev/null
            notify "Keyboard backlight: 100%"
            show_quick_settings_menu
            ;;
        "Back")
            show_quick_settings_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

# =============================================================================
# SYSTEM SUBMENU
# =============================================================================

show_system_menu() {
    local options="󰄪  System Monitor (btop)
󰋊  Disk Usage
󰍛  Process Manager (htop)
󰙪  System Logs
󰌢  Hardware Info
󰖩  Network Status
󰂯  Bluetooth Manager
󰕾  Audio Settings
󰍹  Display Settings
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "System" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "System Monitor (btop)")  run_in_terminal btop ;;
        "Disk Usage")             run_in_terminal ncdu --color dark / ;;
        "Process Manager (htop)") run_in_terminal htop ;;
        "System Logs")            run_in_terminal journalctl -f ;;
        "Hardware Info")          run_in_terminal_hold fastfetch ;;
        "Network Status")
            # VulcanOS uses iwd, not NetworkManager
            if command -v iwctl &> /dev/null; then
                run_in_terminal iwctl
            else
                notify "iwctl not found. Install iwd package."
            fi
            ;;
        "Bluetooth Manager")      blueman-manager & ;;
        "Audio Settings")         pavucontrol & ;;
        "Display Settings")
            show_display_settings_menu
            ;;
        "Back")                   show_main_menu ;;
        *)                        exit 0 ;;
    esac
}

# =============================================================================
# STYLE SUBMENU
# =============================================================================

show_style_menu() {
    # Get current theme for display
    local current_theme
    if command -v vulcan-theme &> /dev/null; then
        current_theme=$(vulcan-theme current 2>/dev/null | cut -d'(' -f1 | sed 's/Current theme: //' | sed 's/ *$//')
    else
        current_theme="Unknown"
    fi

    local options="󰏘  Theme: ${current_theme}
󰸉  Wallpaper
󰛖  GTK Settings
󰆍  Font Manager
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Style" "$options" 350 320)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//' | cut -d':' -f1)

    case "$action" in
        "Theme")
            show_theme_selector_menu
            ;;
        "Wallpaper")
            show_wallpaper_menu
            ;;
        "GTK Settings")
            if command -v nwg-look &> /dev/null; then
                nwg-look &
            else
                notify "nwg-look not installed"
            fi
            ;;
        "Font Manager")
            if command -v font-manager &> /dev/null; then
                font-manager &
            else
                notify "font-manager not installed"
            fi
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_theme_selector_menu() {
    if ! command -v vulcan-theme &> /dev/null; then
        notify "vulcan-theme not found"
        show_style_menu
        return
    fi

    # Get current theme
    local current_theme_id
    current_theme_id=$(vulcan-theme current 2>/dev/null | grep -oP '\(\K[^)]+' || echo "")

    # Build theme list
    local theme_list
    theme_list=$(vulcan-theme list-ids 2>/dev/null)

    if [[ -z "$theme_list" ]]; then
        notify "No themes available"
        show_style_menu
        return
    fi

    # Build menu with current theme marked
    local menu_options=""
    while IFS=':' read -r theme_id theme_name; do
        if [[ "$theme_id" == "$current_theme_id" ]]; then
            menu_options+="󰄬 ${theme_name} (Current)\n"
        else
            menu_options+="  ${theme_name}\n"
        fi
    done <<< "$theme_list"

    menu_options+="$ICON_BACK  Back\n"

    # Show menu
    local choice
    choice=$(echo -e "$menu_options" | wofi --dmenu \
        --prompt "Select Theme" \
        --cache-file /dev/null \
        --width 350 \
        --height 450 \
        --location center \
        --hide-scroll \
        --no-actions 2>/dev/null)

    # Handle selection
    if [[ -z "$choice" ]] || [[ "$choice" == *"Back"* ]]; then
        show_style_menu
        return
    fi

    # Extract theme name (remove icon and "(Current)" suffix)
    local selected_theme_name
    selected_theme_name=$(echo "$choice" | sed 's/^[󰄬 ]*//' | sed 's/ (Current)$//')

    # Find theme ID from name
    local selected_theme_id=""
    while IFS=':' read -r theme_id theme_name; do
        if [[ "$theme_name" == "$selected_theme_name" ]]; then
            selected_theme_id="$theme_id"
            break
        fi
    done <<< "$theme_list"

    if [[ -n "$selected_theme_id" ]]; then
        # Apply theme
        notify "Applying theme: $selected_theme_name"
        vulcan-theme set "$selected_theme_id" &
        
        # Return to style menu after a moment
        sleep 0.5
        show_style_menu
    else
        show_style_menu
    fi
}

show_wallpaper_menu() {
    local choice
    choice=$(printf '%s\n' \
        "󰸉  Wallpaper Manager" \
        "󰸉  Wallpaper Profiles" \
        "󰥶  Browse Wallpapers" \
        "󰷊  Random Wallpaper" \
        "󰑘  Rotate Next" \
        "󰁍  Back" | wofi --dmenu \
            --prompt "Wallpaper" \
            --cache-file /dev/null \
            --width 350 \
            --height 420 \
            --location center \
            --hide-scroll \
            --no-actions 2>/dev/null)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Wallpaper Manager")
            if command -v vulcan-wallpaper-manager &> /dev/null; then
                vulcan-wallpaper-manager &
            else
                notify "vulcan-wallpaper-manager not found. Build with: cargo build --release"
            fi
            ;;
        "Wallpaper Profiles")
            show_wallpaper_profiles_menu
            ;;
        "Browse Wallpapers")
            if command -v vulcan-wallpaper-picker &> /dev/null; then
                vulcan-wallpaper-picker &
            else
                notify "vulcan-wallpaper-picker not found"
            fi
            ;;
        "Random Wallpaper")
            if command -v vulcan-wallpaper &> /dev/null; then
                vulcan-wallpaper random
            else
                notify "vulcan-wallpaper not found"
            fi
            ;;
        "Rotate Next")
            if command -v vulcan-wallpaper &> /dev/null; then
                vulcan-wallpaper rotate
            else
                notify "vulcan-wallpaper not found"
            fi
            ;;
        "Back")
            show_style_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_wallpaper_profiles_menu() {
    local profiles_dir="$HOME/Pictures/Wallpapers/profiles"
    local profiles=("desktop" "console" "campus" "laptop" "presentation")

    # Build menu
    local options=""
    for profile in "${profiles[@]}"; do
        local count=0
        if [[ -d "$profiles_dir/$profile" ]]; then
            count=$(find "$profiles_dir/$profile" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)
        fi
        options+="󰸉  ${profile^} ($count wallpapers)\n"
    done
    options+="󰏗  Import Panoramic Image\n"
    options+="$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Wallpaper Profiles" "$options" 380 420)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//' | cut -d'(' -f1 | sed 's/ *$//' | tr '[:upper:]' '[:lower:]')

    case "$action" in
        "desktop"|"console"|"campus"|"laptop"|"presentation")
            show_profile_wallpapers "$action"
            ;;
        "import panoramic image")
            import_panoramic_wallpaper
            ;;
        "back")
            show_wallpaper_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_profile_wallpapers() {
    local profile="$1"
    local profile_dir="$HOME/Pictures/Wallpapers/profiles/$profile"

    # Get wallpapers in this profile
    local wallpapers=""
    if [[ -d "$profile_dir" ]]; then
        wallpapers=$(find "$profile_dir" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort)
    fi

    if [[ -z "$wallpapers" ]]; then
        notify "No wallpapers in $profile profile"
        show_wallpaper_profiles_menu
        return
    fi

    # Get current wallpaper for this profile
    local current=""
    [[ -f "$profile_dir/.current" ]] && current=$(cat "$profile_dir/.current")

    # Build menu
    local options=""
    while IFS= read -r wp; do
        if [[ "$wp" == "$current" ]]; then
            options+="󰄬  $wp (current)\n"
        else
            options+="󰸉  $wp\n"
        fi
    done <<< "$wallpapers"
    options+="$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "${profile^} Wallpapers" "$options" 350 400)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//' | sed 's/ (current)$//')

    if [[ "$action" == "Back" ]]; then
        show_wallpaper_profiles_menu
        return
    fi

    # Apply the selected wallpaper
    if [[ -n "$action" ]] && [[ -d "$profile_dir/$action" ]]; then
        apply_profile_wallpaper "$profile" "$action"
    fi
}

apply_profile_wallpaper() {
    local profile="$1"
    local wallpaper="$2"
    local wallpaper_dir="$HOME/Pictures/Wallpapers/profiles/$profile/$wallpaper"

    notify "Applying: $wallpaper"

    # Check if swww-daemon is running
    if ! pgrep -x swww-daemon > /dev/null; then
        swww-daemon &
        sleep 0.5
    fi

    # Get monitors based on profile
    local monitors
    case $profile in
        desktop)     monitors=("DP-10" "DP-12" "DP-14" "DP-5" "eDP-1") ;;
        console)     monitors=("DP-10" "DP-14" "DP-5" "eDP-1") ;;
        campus)      monitors=("DP-5" "eDP-1") ;;
        laptop)      monitors=("eDP-1") ;;
        presentation) monitors=("eDP-1" "HDMI-A-1") ;;
    esac

    # Apply wallpapers
    for monitor in "${monitors[@]}"; do
        local wallpaper_file="$wallpaper_dir/${wallpaper}-${monitor}.png"

        # Fallback to any image if monitor-specific doesn't exist
        if [[ ! -f "$wallpaper_file" ]]; then
            wallpaper_file=$(find "$wallpaper_dir" -maxdepth 1 \( -name "*.png" -o -name "*.jpg" \) | head -1)
        fi

        if [[ -f "$wallpaper_file" ]]; then
            swww img -o "$monitor" "$wallpaper_file" \
                --transition-type wipe \
                --transition-duration 1 &
        fi
    done
    wait

    # Save as current
    echo "$wallpaper" > "$HOME/Pictures/Wallpapers/profiles/$profile/.current"

    notify "Wallpaper applied: $wallpaper"
    show_profile_wallpapers "$profile"
}

import_panoramic_wallpaper() {
    # Select profile first
    local profiles=("desktop" "console" "campus" "laptop" "presentation")
    local profile_options=""
    for p in "${profiles[@]}"; do
        profile_options+="$p\n"
    done

    local profile
    profile=$(echo -e "$profile_options" | wofi --dmenu --prompt "Select Profile" --cache-file /dev/null 2>/dev/null)

    [[ -z "$profile" ]] && { show_wallpaper_profiles_menu; return; }

    # Get image path via file picker or manual entry
    notify "Select a panoramic image file"

    local image_path
    if command -v zenity &> /dev/null; then
        image_path=$(zenity --file-selection --title="Select Panoramic Image" --file-filter="Images | *.png *.jpg *.jpeg" 2>/dev/null)
    else
        image_path=$(echo "" | wofi --dmenu --prompt "Image path" 2>/dev/null)
    fi

    [[ -z "$image_path" ]] || [[ ! -f "$image_path" ]] && { notify "No image selected"; show_wallpaper_profiles_menu; return; }

    # Get wallpaper name
    local wp_name
    wp_name=$(echo "" | wofi --dmenu --prompt "Wallpaper name" 2>/dev/null)

    [[ -z "$wp_name" ]] && { show_wallpaper_profiles_menu; return; }

    # Create directory and split
    local wp_dir="$HOME/Pictures/Wallpapers/profiles/$profile/$wp_name"
    mkdir -p "$wp_dir"

    notify "Splitting image for $profile profile..."

    if [[ -x "$HOME/VulcanOS/scripts/split-wallpaper.sh" ]]; then
        echo "y" | "$HOME/VulcanOS/scripts/split-wallpaper.sh" "$image_path" "$wp_name"
        mv "$HOME/Pictures/Wallpapers/spanning/${wp_name}-"*.png "$wp_dir/" 2>/dev/null || true

        notify "Imported: $wp_name"

        # Apply it
        apply_profile_wallpaper "$profile" "$wp_name"
    else
        notify "split-wallpaper.sh not found"
        show_wallpaper_profiles_menu
    fi
}



# =============================================================================
# INSTALL SUBMENU
# =============================================================================

show_install_menu() {
    local options="󰏗  Search Packages (pacman)
󰣇  Search AUR (yay)
󰨞  Editor
󰖟  Browser
󱃲  Development Tools
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Install" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Search Packages (pacman)")
            local pkg
            pkg=$(pacman -Ssq 2>/dev/null | wofi --dmenu --prompt "Install Package" --cache-file /dev/null 2>/dev/null)
            if [[ -n "$pkg" ]]; then
                run_in_terminal_hold sudo pacman -S "$pkg"
            fi
            ;;
        "Search AUR (yay)")
            local pkg
            pkg=$(yay -Ssq 2>/dev/null | wofi --dmenu --prompt "Install AUR Package" --cache-file /dev/null 2>/dev/null)
            if [[ -n "$pkg" ]]; then
                run_in_terminal_hold yay -S "$pkg"
            fi
            ;;
        "Editor")
            show_editor_install_menu
            ;;
        "Browser")
            show_browser_install_menu
            ;;
        "Development Tools")
            show_devtools_install_menu
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_editor_install_menu() {
    local options="󰨞  VS Code
󰘦  Cursor
󰘦  Zed
󰘦  Sublime Text
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Install Editor" "$options" 300 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "VS Code")       run_in_terminal_hold yay -S visual-studio-code-bin ;;
        "Cursor")        run_in_terminal_hold yay -S cursor-bin ;;
        "Zed")           run_in_terminal_hold yay -S zed ;;
        "Sublime Text")  run_in_terminal_hold yay -S sublime-text-4 ;;
        "Back")          show_install_menu ;;
        *)               exit 0 ;;
    esac
}

show_browser_install_menu() {
    local options="󰈹  Firefox
󰊯  Chromium
󰊯  Brave
󰈹  Zen Browser
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Install Browser" "$options" 300 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Firefox")     run_in_terminal_hold sudo pacman -S firefox ;;
        "Chromium")    run_in_terminal_hold sudo pacman -S chromium ;;
        "Brave")       run_in_terminal_hold yay -S brave-bin ;;
        "Zen Browser") run_in_terminal_hold yay -S zen-browser-bin ;;
        "Back")        show_install_menu ;;
        *)             exit 0 ;;
    esac
}

show_devtools_install_menu() {
    local options="󰡨  Docker
󰢩  Postman
󰊢  GitKraken
󰆧  DBeaver
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Install Dev Tools" "$options" 300 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Docker")    run_in_terminal_hold sudo pacman -S docker docker-compose && sudo systemctl enable --now docker ;;
        "Postman")   run_in_terminal_hold yay -S postman-bin ;;
        "GitKraken") run_in_terminal_hold yay -S gitkraken ;;
        "DBeaver")   run_in_terminal_hold sudo pacman -S dbeaver ;;
        "Back")      show_install_menu ;;
        *)           exit 0 ;;
    esac
}

# =============================================================================
# REMOVE SUBMENU
# =============================================================================

show_remove_menu() {
    local options="󰩺  Uninstall Package
󰃢  Remove Orphans
󰃨  Clean Package Cache
󰃨  Clean Journal Logs
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Remove" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Uninstall Package")
            local pkg
            pkg=$(pacman -Qq 2>/dev/null | wofi --dmenu --prompt "Uninstall Package" --cache-file /dev/null 2>/dev/null)
            if [[ -n "$pkg" ]]; then
                run_in_terminal_hold sudo pacman -Rns "$pkg"
            fi
            ;;
        "Remove Orphans")
            local orphans
            orphans=$(pacman -Qdtq 2>/dev/null)
            if [[ -n "$orphans" ]]; then
                run_in_terminal_hold sudo pacman -Rns $orphans
            else
                notify "No orphaned packages found"
            fi
            ;;
        "Clean Package Cache")
            run_in_terminal_hold sudo paccache -rk 2
            ;;
        "Clean Journal Logs")
            run_in_terminal_hold sudo journalctl --vacuum-time=7d
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

# =============================================================================
# SETUP SUBMENU
# =============================================================================

show_setup_menu() {
    local options="󰒓  Default Applications
󰌌  Input Settings
󰍹  Display Settings
󰒒  Autostart Apps
󰖟  Network
󰌆  Security
󰏗  Edit Configs
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Setup" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Default Applications")
            show_defaults_menu
            ;;
        "Input Settings")
            notify "Edit ~/.config/hypr/input.conf to customize input"
            run_in_terminal $EDITOR "${CONFIG_DIR}/hypr/input.conf"
            ;;
        "Display Settings")
            if command -v nwg-displays &> /dev/null; then
                nwg-displays &
            elif command -v wdisplays &> /dev/null; then
                wdisplays &
            else
                notify "No display manager found"
            fi
            ;;
        "Autostart Apps")
            run_in_terminal $EDITOR "${CONFIG_DIR}/hypr/autostart.conf"
            ;;
        "Network")
            # VulcanOS uses iwd
            if command -v iwctl &> /dev/null; then
                run_in_terminal iwctl
            else
                notify "iwctl not found. Install iwd package."
            fi
            ;;
        "Security")
            show_security_menu
            ;;
        "Edit Configs")
            show_configs_menu
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_defaults_menu() {
    local options="󰆍  Default Terminal
󰖟  Default Browser
󰨞  Default Editor
󰉋  Default File Manager
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Default Applications" "$options" 350 280)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Default Terminal")
            set_default_terminal
            ;;
        "Default Browser")
            set_default_browser
            ;;
        "Default Editor")
            set_default_editor
            ;;
        "Default File Manager")
            set_default_file_manager
            ;;
        "Back")
            show_setup_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

set_default_terminal() {
    local terminals="kitty
alacritty
foot
wezterm
gnome-terminal"

    local choice
    choice=$(echo -e "$terminals" | wofi --dmenu --prompt "Select Default Terminal" --cache-file /dev/null 2>/dev/null)

    if [[ -n "$choice" ]]; then
        # Update environment variable
        export TERMINAL="$choice"
        # Save to shell config
        if [[ -f "$HOME/.bashrc" ]]; then
            if grep -q "^export TERMINAL=" "$HOME/.bashrc"; then
                sed -i "s|^export TERMINAL=.*|export TERMINAL=\"$choice\"|" "$HOME/.bashrc"
            else
                echo "export TERMINAL=\"$choice\"" >> "$HOME/.bashrc"
            fi
        fi
        notify "Default terminal set to: $choice"
    fi
    show_defaults_menu
}

set_default_browser() {
    local browsers=""
    
    # Detect installed browsers
    command -v firefox &>/dev/null && browsers+="firefox\n"
    command -v chromium &>/dev/null && browsers+="chromium\n"
    command -v brave &>/dev/null && browsers+="brave\n"
    command -v google-chrome &>/dev/null && browsers+="google-chrome\n"
    command -v zen-browser &>/dev/null && browsers+="zen-browser\n"

    if [[ -z "$browsers" ]]; then
        notify "No browsers found"
        show_defaults_menu
        return
    fi

    local choice
    choice=$(echo -e "$browsers" | wofi --dmenu --prompt "Select Default Browser" --cache-file /dev/null 2>/dev/null)

    if [[ -n "$choice" ]]; then
        xdg-settings set default-web-browser "${choice}.desktop" 2>/dev/null || notify "Failed to set default browser"
        notify "Default browser set to: $choice"
    fi
    show_defaults_menu
}

set_default_editor() {
    local editors="nvim
vim
nano
code
gedit"

    local choice
    choice=$(echo -e "$editors" | wofi --dmenu --prompt "Select Default Editor" --cache-file /dev/null 2>/dev/null)

    if [[ -n "$choice" ]]; then
        # Update environment variable
        export EDITOR="$choice"
        # Save to shell config
        if [[ -f "$HOME/.bashrc" ]]; then
            if grep -q "^export EDITOR=" "$HOME/.bashrc"; then
                sed -i "s|^export EDITOR=.*|export EDITOR=\"$choice\"|" "$HOME/.bashrc"
            else
                echo "export EDITOR=\"$choice\"" >> "$HOME/.bashrc"
            fi
        fi
        notify "Default editor set to: $choice"
    fi
    show_defaults_menu
}

set_default_file_manager() {
    local file_managers=""
    
    # Detect installed file managers
    command -v thunar &>/dev/null && file_managers+="thunar\n"
    command -v dolphin &>/dev/null && file_managers+="dolphin\n"
    command -v nautilus &>/dev/null && file_managers+="nautilus\n"
    command -v nemo &>/dev/null && file_managers+="nemo\n"
    command -v pcmanfm &>/dev/null && file_managers+="pcmanfm\n"

    if [[ -z "$file_managers" ]]; then
        notify "No file managers found"
        show_defaults_menu
        return
    fi

    local choice
    choice=$(echo -e "$file_managers" | wofi --dmenu --prompt "Select Default File Manager" --cache-file /dev/null 2>/dev/null)

    if [[ -n "$choice" ]]; then
        xdg-mime default "${choice}.desktop" inode/directory 2>/dev/null || notify "Failed to set default file manager"
        notify "Default file manager set to: $choice"
    fi
    show_defaults_menu
}

show_security_menu() {
    local options="󰒃  Firewall Status
󰌆  SSH Keys
󰯄  GPG Keys
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Security" "$options" 300 240)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Firewall Status")
            run_in_terminal_hold sudo ufw status verbose
            ;;
        "SSH Keys")
            run_in_terminal_hold bash -c "ls -la ~/.ssh/ && echo '' && cat ~/.ssh/*.pub 2>/dev/null || echo 'No public keys found'"
            ;;
        "GPG Keys")
            run_in_terminal_hold gpg --list-keys
            ;;
        "Back")
            show_setup_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_configs_menu() {
    local options="󰖬  Hyprland Config
󰀻  Waybar Config
󰆍  Terminal Config
󰏘  Theme Colors
󰑓  Reload All Configs
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Edit Configs" "$options" 320 320)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Hyprland Config")
            run_in_terminal $EDITOR "${CONFIG_DIR}/hypr/hyprland.conf"
            ;;
        "Waybar Config")
            run_in_terminal $EDITOR "${CONFIG_DIR}/waybar/config.jsonc"
            ;;
        "Terminal Config")
            if [[ -f "${CONFIG_DIR}/kitty/kitty.conf" ]]; then
                run_in_terminal $EDITOR "${CONFIG_DIR}/kitty/kitty.conf"
            elif [[ -f "${CONFIG_DIR}/alacritty/alacritty.toml" ]]; then
                run_in_terminal $EDITOR "${CONFIG_DIR}/alacritty/alacritty.toml"
            fi
            ;;
        "Theme Colors")
            run_in_terminal $EDITOR "${CONFIG_DIR}/themes/colors/"
            ;;
        "Reload All Configs")
            hyprctl reload
            pkill -SIGUSR2 waybar 2>/dev/null || true
            notify "Configs reloaded"
            ;;
        "Back")
            show_setup_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

# =============================================================================
# UPDATE SUBMENU
# =============================================================================

show_update_menu() {
    local options="󰚰  Quick Update (pacman)
󰚰  Full Update (yay)
󰑐  Refresh Mirrors
󰑓  Restore Defaults
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Update" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Quick Update (pacman)")
            run_in_terminal_hold sudo pacman -Syu
            ;;
        "Full Update (yay)")
            run_in_terminal_hold yay -Syu
            ;;
        "Refresh Mirrors")
            if command -v reflector &> /dev/null; then
                notify "Refreshing mirrors... This may take a moment."
                run_in_terminal_hold sudo reflector --latest 20 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
            else
                notify "reflector not installed. Install with: sudo pacman -S reflector"
            fi
            ;;
        "Restore Defaults")
            show_restore_menu
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_restore_menu() {
    local options="󰖬  Restore Hyprland Config
󰀻  Restore Waybar Config
󰗼  Restore All Configs
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Restore Defaults" "$options" 350 240)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Restore Hyprland Config")
            if confirm_restore "Hyprland"; then
                restore_hyprland_config
            fi
            show_restore_menu
            ;;
        "Restore Waybar Config")
            if confirm_restore "Waybar"; then
                restore_waybar_config
            fi
            show_restore_menu
            ;;
        "Restore All Configs")
            if confirm_restore "All Configs"; then
                restore_all_configs
            fi
            show_restore_menu
            ;;
        "Back")
            show_update_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

confirm_restore() {
    local item="$1"
    local choice
    choice=$(echo -e "Yes, restore\nNo, cancel" | wofi --dmenu \
        --prompt "Restore $item to defaults?" \
        --cache-file /dev/null \
        --width 300 \
        --height 100 \
        --location center 2>/dev/null)
    
    [[ "$choice" == "Yes, restore" ]]
}

restore_hyprland_config() {
    # Backup current config
    local backup_dir="$HOME/.config/hypr-backup-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$backup_dir"
    cp -r "$HOME/.config/hypr" "$backup_dir/" 2>/dev/null || true
    
    # Check for default configs in VulcanOS repo
    local vulcan_repo="$HOME/VulcanOS"
    if [[ -d "$vulcan_repo/dotfiles/hypr/.config/hypr" ]]; then
        cp -r "$vulcan_repo/dotfiles/hypr/.config/hypr/"* "$HOME/.config/hypr/" 2>/dev/null
        notify "Hyprland config restored. Backup saved to: $(basename "$backup_dir")"
        hyprctl reload 2>/dev/null || true
    else
        notify "Default config not found in VulcanOS repo"
    fi
}

restore_waybar_config() {
    # Backup current config
    local backup_dir="$HOME/.config/waybar-backup-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$backup_dir"
    cp -r "$HOME/.config/waybar" "$backup_dir/" 2>/dev/null || true
    
    # Check for default configs in VulcanOS repo
    local vulcan_repo="$HOME/VulcanOS"
    if [[ -d "$vulcan_repo/dotfiles/waybar/.config/waybar" ]]; then
        cp -r "$vulcan_repo/dotfiles/waybar/.config/waybar/"* "$HOME/.config/waybar/" 2>/dev/null
        notify "Waybar config restored. Backup saved to: $(basename "$backup_dir")"
        pkill -9 waybar 2>/dev/null || true
        sleep 0.3
        hyprctl dispatch exec waybar &>/dev/null || true
    else
        notify "Default config not found in VulcanOS repo"
    fi
}

restore_all_configs() {
    restore_hyprland_config
    restore_waybar_config
    
    # Add more config restorations as needed
    notify "All configs restored to defaults"
}

# =============================================================================
# T2 MACBOOK SUBMENU
# =============================================================================

show_t2_menu() {
    local options="󰌢  Touch Bar Settings
󰈐  Fan Control
󰃟  Keyboard Backlight
󰖩  WiFi Status
󰋐  Audio Status
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "T2 MacBook" "$options")

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Touch Bar Settings")
            show_touchbar_menu
            ;;
        "Fan Control")
            if systemctl is-active --quiet t2fanrd; then
                run_in_terminal_hold bash -c "echo 'T2 Fan Daemon Status:' && systemctl status t2fanrd"
            else
                notify "t2fanrd not running. Enable with: sudo systemctl enable --now t2fanrd"
            fi
            ;;
        "Keyboard Backlight")
            show_kbd_backlight_menu
            ;;
        "WiFi Status")
            run_in_terminal_hold bash -c "echo 'WiFi Status:' && iwctl station list && echo '' && iwctl station wlan0 show"
            ;;
        "Audio Status")
            run_in_terminal_hold bash -c "echo 'Audio Devices:' && aplay -l && echo '' && echo 'PipeWire Status:' && wpctl status"
            ;;
        "Back")
            show_main_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_touchbar_menu() {
    local options="󰔛  Function Keys Mode
󰝚  Media Keys Mode
󰒓  Configure tiny-dfr
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Touch Bar" "$options" 320 240)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Function Keys Mode")
            echo 2 | sudo tee /sys/class/input/*/device/fnmode &>/dev/null || true
            notify "Touch Bar set to Function Keys mode"
            ;;
        "Media Keys Mode")
            echo 1 | sudo tee /sys/class/input/*/device/fnmode &>/dev/null || true
            notify "Touch Bar set to Media Keys mode"
            ;;
        "Configure tiny-dfr")
            if [[ -f /etc/tiny-dfr/config.toml ]]; then
                run_in_terminal sudo $EDITOR /etc/tiny-dfr/config.toml
            else
                notify "tiny-dfr config not found"
            fi
            ;;
        "Back")
            show_t2_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

show_kbd_backlight_menu() {
    local current_brightness
    current_brightness=$(cat /sys/class/leds/*kbd_backlight/brightness 2>/dev/null || echo "N/A")
    local max_brightness
    max_brightness=$(cat /sys/class/leds/*kbd_backlight/max_brightness 2>/dev/null || echo "N/A")

    local options="󰃠  Brightness: $current_brightness / $max_brightness
󰃞  Set to 0% (Off)
󰃝  Set to 25%
󰃟  Set to 50%
󰃠  Set to 100%
$ICON_BACK  Back"

    local choice
    choice=$(wofi_menu "Keyboard Backlight" "$options" 320 320)

    local action
    action=$(echo "$choice" | sed 's/^[^ ]* *//')

    case "$action" in
        "Set to 0% (Off)")
            brightnessctl -d '*::kbd_backlight' set 0% 2>/dev/null
            notify "Keyboard backlight off"
            ;;
        "Set to 25%")
            brightnessctl -d '*::kbd_backlight' set 25% 2>/dev/null
            notify "Keyboard backlight at 25%"
            ;;
        "Set to 50%")
            brightnessctl -d '*::kbd_backlight' set 50% 2>/dev/null
            notify "Keyboard backlight at 50%"
            ;;
        "Set to 100%")
            brightnessctl -d '*::kbd_backlight' set 100% 2>/dev/null
            notify "Keyboard backlight at 100%"
            ;;
        "Back")
            show_t2_menu
            ;;
        *)
            exit 0
            ;;
    esac
}

# =============================================================================
# ENTRY POINT
# =============================================================================

show_help() {
    echo "VulcanOS Systems Menu"
    echo ""
    echo "Usage: vulcan-menu [category]"
    echo ""
    echo "Categories:"
    echo "  (none)    Show main menu"
    echo "  system    System tools and monitoring"
    echo "  style     Themes and appearance"
    echo "  quick     Quick settings toggles"
    echo "  install   Package installation"
    echo "  remove    Package removal and cleanup"
    echo "  setup     System configuration"
    echo "  update    System updates"
    echo "  t2        T2 MacBook specific options"
    echo "  power     Power/session menu"
    echo ""
}

main() {
    local category="${1:-}"

    case "$category" in
        "")         show_main_menu ;;
        system)     show_system_menu ;;
        style)      show_style_menu ;;
        quick)      show_quick_settings_menu ;;
        install)    show_install_menu ;;
        remove)     show_remove_menu ;;
        setup)      show_setup_menu ;;
        update)     show_update_menu ;;
        t2)         show_t2_menu ;;
        power)      exec vulcan-power ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown category: $category"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
