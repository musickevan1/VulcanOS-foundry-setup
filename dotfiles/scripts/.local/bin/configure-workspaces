#!/bin/bash
# configure-workspaces - Wrapper for vulcan-workspace-init
# Called by hyprmon-desc after applying a monitor profile
#
# This script delegates to vulcan-workspace-init which uses profile-based
# monitor ordering (main monitor first, then left-to-right) rather than
# X-position sorting.

# Detect which profile is likely active based on the applied monitors config
detect_profile() {
    local monitors_conf="$HOME/.config/hypr/monitors.conf"

    if [[ ! -f "$monitors_conf" ]]; then
        echo "desktop"
        return
    fi

    # Detect by structural markers (not DP port numbers, which change on reboot)
    local has_rotated=false
    local has_disabled=false
    local active_count=0

    grep -q "transform" "$monitors_conf" 2>/dev/null && has_rotated=true
    grep -q "disable" "$monitors_conf" 2>/dev/null && has_disabled=true
    active_count=$(grep -cE "^monitor\s*=\s*\S+,\s*[0-9]" "$monitors_conf" 2>/dev/null || echo 0)

    if $has_rotated && ! $has_disabled; then
        echo "desktop"       # rotated left monitor + all enabled = desktop
    elif $has_rotated && $has_disabled; then
        echo "console"       # rotated left monitor + one disabled = console
    elif ! $has_rotated && [[ $active_count -le 2 ]]; then
        if grep -q "eDP-1" "$monitors_conf" 2>/dev/null && ! grep -q "DP-" "$monitors_conf" 2>/dev/null; then
            echo "laptop"    # only eDP-1, no DP monitors = laptop
        else
            echo "campus"    # 2 active monitors, no rotation = campus
        fi
    else
        echo "desktop"
    fi
}

PROFILE=$(detect_profile)
echo "Detected profile: $PROFILE"

# Call vulcan-workspace-init with detected profile
if command -v vulcan-workspace-init &>/dev/null; then
    vulcan-workspace-init "$PROFILE"
else
    # Fallback: call directly from dotfiles
    "$HOME/VulcanOS/dotfiles/scripts/.local/bin/vulcan-workspace-init" "$PROFILE"
fi
