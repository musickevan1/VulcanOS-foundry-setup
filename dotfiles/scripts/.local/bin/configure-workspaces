#!/bin/bash
# configure-workspaces - Dynamically configure workspace bindings based on connected monitors
# Called by hyprmon-desc after applying a monitor profile
#
# This script:
# 1. Detects connected monitors and their output names
# 2. Creates Hyprland workspace rules to bind workspace ranges to monitors
# 3. Updates waybar config with correct persistent-workspaces per output

WAYBAR_CONFIG="$HOME/.config/waybar/config.jsonc"
HYPR_WORKSPACES="$HOME/.config/hypr/workspaces.conf"

# Get connected monitors (sorted by x position for consistent left-to-right ordering)
get_monitors() {
    hyprctl monitors -j | jq -r 'sort_by(.x) | .[] | "\(.name)|\(.description)"'
}

# Generate Hyprland workspace rules
generate_hypr_workspaces() {
    local monitors=("$@")
    local monitor_count=${#monitors[@]}

    echo "# Auto-generated workspace bindings"
    echo "# Generated by configure-workspaces on $(date)"
    echo "# DO NOT EDIT - regenerated on profile switch"
    echo ""

    local workspace_start=1
    local workspaces_per_monitor=5

    for i in "${!monitors[@]}"; do
        local monitor_name="${monitors[$i]%%|*}"
        local monitor_desc="${monitors[$i]#*|}"
        local ws_end=$((workspace_start + workspaces_per_monitor - 1))

        echo "# Monitor $((i+1)): $monitor_desc"
        for ws in $(seq $workspace_start $ws_end); do
            echo "workspace = $ws, monitor:$monitor_name, default:$( [ $ws -eq $workspace_start ] && echo 'true' || echo 'false' )"
        done
        echo ""

        workspace_start=$((ws_end + 1))
    done
}

# Generate waybar persistent-workspaces JSON
generate_waybar_workspaces() {
    local monitors=("$@")
    local monitor_count=${#monitors[@]}

    local workspace_start=1
    local workspaces_per_monitor=5
    local result="{"
    local first=true

    for i in "${!monitors[@]}"; do
        local monitor_name="${monitors[$i]%%|*}"
        local ws_end=$((workspace_start + workspaces_per_monitor - 1))

        if [ "$first" = true ]; then
            first=false
        else
            result+=", "
        fi

        # Build array of workspace numbers
        local ws_array="["
        for ws in $(seq $workspace_start $ws_end); do
            [ $ws -ne $workspace_start ] && ws_array+=", "
            ws_array+="$ws"
        done
        ws_array+="]"

        result+="\"$monitor_name\": $ws_array"
        workspace_start=$((ws_end + 1))
    done

    result+="}"
    echo "$result"
}

# Update waybar config with new persistent-workspaces
update_waybar_config() {
    local new_persistent="$1"

    if [ ! -f "$WAYBAR_CONFIG" ]; then
        echo "Error: Waybar config not found at $WAYBAR_CONFIG" >&2
        return 1
    fi

    # Use jq to update the persistent-workspaces field
    local tmp_file=$(mktemp)

    # Parse JSONC (strip comments) and update
    sed 's|//.*||g' "$WAYBAR_CONFIG" | \
    jq --argjson pw "$new_persistent" \
       '.["hyprland/workspaces"]["persistent-workspaces"] = $pw' \
       > "$tmp_file" 2>/dev/null

    if [ $? -eq 0 ] && [ -s "$tmp_file" ]; then
        # Preserve comments by doing targeted replacement instead
        # Find and replace the persistent-workspaces line
        python3 << PYEOF
import re
import json

config_path = "$WAYBAR_CONFIG"
new_persistent = $new_persistent

with open(config_path, 'r') as f:
    content = f.read()

# Pattern to match the persistent-workspaces block
pattern = r'("persistent-workspaces"\s*:\s*)\{[^}]*\}'
replacement = r'\g<1>' + json.dumps(new_persistent, separators=(', ', ': '))

new_content = re.sub(pattern, replacement, content)

with open(config_path, 'w') as f:
    f.write(new_content)

print("Updated persistent-workspaces to:", json.dumps(new_persistent))
PYEOF
    else
        echo "Error: Failed to generate new config" >&2
        rm -f "$tmp_file"
        return 1
    fi

    rm -f "$tmp_file"
}

# Move existing workspaces to their correct monitors
move_existing_workspaces() {
    local monitors=("$@")
    local workspace_start=1
    local workspaces_per_monitor=5

    echo "Moving existing workspaces to correct monitors..."
    for i in "${!monitors[@]}"; do
        local monitor_name="${monitors[$i]%%|*}"
        local ws_end=$((workspace_start + workspaces_per_monitor - 1))

        for ws in $(seq $workspace_start $ws_end); do
            hyprctl dispatch moveworkspacetomonitor "$ws $monitor_name" 2>/dev/null
        done

        workspace_start=$((ws_end + 1))
    done
}

# Main
main() {
    # Read monitors into array
    local monitors=()
    while IFS= read -r line; do
        [ -n "$line" ] && monitors+=("$line")
    done < <(get_monitors)

    local monitor_count=${#monitors[@]}

    if [ $monitor_count -eq 0 ]; then
        echo "Error: No monitors detected" >&2
        exit 1
    fi

    echo "Configuring workspaces for $monitor_count monitor(s):"
    for m in "${monitors[@]}"; do
        echo "  - ${m#*|} (${m%%|*})"
    done

    # Generate and apply Hyprland workspace rules
    echo ""
    echo "Generating Hyprland workspace rules..."
    generate_hypr_workspaces "${monitors[@]}" > "$HYPR_WORKSPACES"
    echo "  → Written to $HYPR_WORKSPACES"

    # Move existing workspaces to correct monitors
    echo ""
    move_existing_workspaces "${monitors[@]}"

    # Generate and apply waybar config
    echo ""
    echo "Updating waybar persistent-workspaces..."
    local waybar_ws=$(generate_waybar_workspaces "${monitors[@]}")
    update_waybar_config "$waybar_ws"

    echo ""
    echo "✓ Workspace configuration complete"
    echo "  Workspaces 1-5 → ${monitors[0]%%|*}"
    [ $monitor_count -ge 2 ] && echo "  Workspaces 6-10 → ${monitors[1]%%|*}"
    [ $monitor_count -ge 3 ] && echo "  Workspaces 11-15 → ${monitors[2]%%|*}"
}

main "$@"
