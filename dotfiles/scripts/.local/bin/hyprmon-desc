#!/bin/bash
# hyprmon-desc - Wrapper for desc-based monitor profile management
# Applies reboot-stable monitor configurations using EDID descriptions
#
# Usage:
#   hyprmon-desc --profile <profile-name>  # Apply profile (desktop/campus/laptop)
#   hyprmon-desc profiles                  # Show profile selection menu
#   hyprmon-desc                           # Launch hyprmon TUI

PROFILE_DIR="$HOME/.config/hyprmon-desc/profiles"
MONITORS_CONF="$HOME/.config/hypr/monitors.conf"

# Function to apply a profile
apply_profile() {
    local profile_name="$1"
    local profile_file="$PROFILE_DIR/${profile_name}.conf"
    
    if [ ! -f "$profile_file" ]; then
        notify-send -u critical "Monitor Profile Error" "Profile not found: $profile_name\n\nAvailable: desktop, campus, laptop"
        echo "Error: Profile '$profile_name' not found at $profile_file" >&2
        echo "Available profiles:" >&2
        ls "$PROFILE_DIR"/*.conf 2>/dev/null | xargs -n1 basename | sed 's/.conf$//' >&2
        exit 1
    fi
    
    # Backup current config
    cp "$MONITORS_CONF" "${MONITORS_CONF}.backup-$(date +%Y%m%d-%H%M%S)" 2>/dev/null
    
    # Apply profile
    cp "$profile_file" "$MONITORS_CONF"
    hyprctl reload >/dev/null 2>&1
    
    # Success notification
    local monitor_count=$(grep -c '^monitor = desc:' "$profile_file")
    notify-send -u normal "Monitor Profile Applied" "Profile: $profile_name\nMonitors: $monitor_count active"
    
    echo "âœ“ Applied profile: $profile_name"
}

# Function to show profile menu
show_profiles() {
    # Use wofi for profile selection
    local profiles=$(ls "$PROFILE_DIR"/*.conf 2>/dev/null | xargs -n1 basename | sed 's/.conf$//')
    
    if [ -z "$profiles" ]; then
        notify-send -u critical "Monitor Profiles" "No profiles found in $PROFILE_DIR"
        exit 1
    fi
    
    # Create menu with descriptions
    local menu_items=""
    while IFS= read -r profile; do
        case "$profile" in
            desktop)
                menu_items+="desktop - Home setup (3 monitors)\n"
                ;;
            campus)
                menu_items+="campus - On-the-go (Float2 Pro + Laptop)\n"
                ;;
            presentation)
                menu_items+="presentation - Mirrored display (Float2 Pro mirrors Laptop)\n"
                ;;
            laptop)
                menu_items+="laptop - Portable (Laptop only)\n"
                ;;
            *)
                menu_items+="$profile - Custom profile\n"
                ;;
        esac
    done <<< "$profiles"
    
    # Show menu and get selection
    local selection=$(echo -e "$menu_items" | wofi --show dmenu --prompt "Select Monitor Profile" --width 500 --height 300)
    
    if [ -n "$selection" ]; then
        # Extract profile name (first word before ' -')
        local profile_name=$(echo "$selection" | awk '{print $1}')
        apply_profile "$profile_name"
    fi
}

# Main command handling
case "$1" in
    --profile)
        if [ -z "$2" ]; then
            echo "Error: --profile requires a profile name" >&2
            echo "Usage: hyprmon-desc --profile <desktop|campus|laptop>" >&2
            exit 1
        fi
        apply_profile "$2"
        ;;
    profiles)
        show_profiles
        ;;
    --help|-h)
        echo "hyprmon-desc - Desc-based monitor profile manager"
        echo ""
        echo "Usage:"
        echo "  hyprmon-desc --profile <name>   Apply monitor profile"
        echo "  hyprmon-desc profiles           Show profile selection menu"
        echo "  hyprmon-desc                    Launch hyprmon TUI"
        echo ""
        echo "Available profiles:"
        ls "$PROFILE_DIR"/*.conf 2>/dev/null | xargs -n1 basename | sed 's/.conf$//' | sed 's/^/  - /'
        echo ""
        echo "Keybindings:"
        echo "  Super + Alt + 1    Apply 'desktop' profile (3 monitors)"
        echo "  Super + Alt + 2    Apply 'campus' profile (2 monitors)"
        echo "  Super + Alt + 3    Apply 'presentation' profile (mirrored)"
        echo "  Super + Alt + 4    Apply 'laptop' profile (1 monitor)"
        echo "  Super + Shift + M    Emergency restore (desktop)"
        echo ""
        echo "Legacy keybindings (F1-F3) still supported for compatibility"
        ;;
    *)
        # No arguments or unrecognized - launch hyprmon TUI
        exec hyprmon "$@"
        ;;
esac
