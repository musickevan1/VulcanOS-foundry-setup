#!/usr/bin/env bash
# VulcanOS Speech-to-Text Control
# Main CLI for managing the S2T system
#
# Commands:
#   start            - Start S2T server and client
#   stop             - Stop S2T server and client
#   restart          - Restart S2T system
#   status           - Show current S2T status
#   settings         - Open Wofi settings menu
#   set-model        - Change Whisper model
#   set-hotkey       - Change activation hotkey
#   set-language     - Change recognition language
#   set-audio-device - Change audio input device
#   set-output-mode  - Change output mode (type/clipboard)
#   set-debug        - Toggle debug mode
#   audio-devices    - List available audio devices
#   toggle           - Toggle S2T on/off
#   help             - Show this help message

set -euo pipefail

# VulcanOS color scheme
BLUE=$'\e[0;34m'
GREEN=$'\e[0;32m'
YELLOW=$'\e[1;33m'
RED=$'\e[0;31m'
NC=$'\e[0m'

# Config paths
CONFIG_DIR="$HOME/.config/vulcan-s2t"
SETTINGS_FILE="$CONFIG_DIR/settings.conf"
SERVER_FILE="$CONFIG_DIR/server.conf"
DATA_DIR="$HOME/.local/share/vulcan-s2t"
SERVER_PID="$DATA_DIR/server.pid"
CLIENT_PID="$DATA_DIR/client.pid"

# Ensure config directory exists
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -d "$DATA_DIR" ]]; then
        mkdir -p "$DATA_DIR"
    fi

        # Create settings.conf from default if missing
        if [[ ! -f "$SETTINGS_FILE" ]]; then
            local script_dir
            script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            local default_settings="$script_dir/../vulcan-s2t/.config/vulcan-s2t/settings.conf.default"

            if [[ -f "$default_settings" ]]; then
                cp "$default_settings" "$SETTINGS_FILE"
                printf "${GREEN}Created settings.conf from default${NC}\n"
            else
                printf "${RED}Error: Could not find default settings${NC}\n" >&2
                exit 1
            fi
        fi

        # Create server.conf from default if missing
        if [[ ! -f "$SERVER_FILE" ]]; then
            local script_dir
            script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            local default_server="$script_dir/../vulcan-s2t/.config/vulcan-s2t/server.conf.default"

            if [[ -f "$default_server" ]]; then
                cp "$default_server" "$SERVER_FILE"
                printf "${GREEN}Created server.conf from default${NC}\n"
            fi
        fi
}

# Load user settings
load_settings() {
    if [[ -f "$SETTINGS_FILE" ]]; then
        source "$SETTINGS_FILE"
    fi
}

# Check if server is running
is_server_running() {
    [[ -f "$SERVER_PID" ]] && kill -0 "$(cat "$SERVER_PID")" 2>/dev/null
}

# Check if client is running
is_client_running() {
    [[ -f "$CLIENT_PID" ]] && kill -0 "$(cat "$CLIENT_PID")" 2>/dev/null
}

# Show status
show_status() {
    load_settings
    
    printf "${BLUE}=== VulcanOS Speech-to-Text Status ===${NC}\n"

    # Server status
    if is_server_running; then
        local server_pid
        server_pid=$(cat "$SERVER_PID")
        printf "${GREEN}Server: Running (PID: $server_pid)${NC}\n"

        # Show server uptime if possible
        if command -v ps &>/dev/null; then
            local uptime
            uptime=$(ps -o etime= -p "$server_pid" 2>/dev/null | xargs || echo "")
            if [[ -n "$uptime" ]]; then
                printf "  ${BLUE}Uptime:${NC} $uptime\n"
            fi
        fi

        # Check if listening on port
        if command -v nc &>/dev/null; then
            if nc -z localhost "${S2T_PORT:-7007}" 2>/dev/null; then
                printf "  ${BLUE}Listening:${NC} localhost:${S2T_PORT:-7007}\n"
            else
                printf "  ${YELLOW}Waiting for port...${NC}\n"
            fi
        fi
    else
        printf "${RED}Server: Not running${NC}\n"
    fi

    # Client status (check for whisper-overlay process)
    local client_pids
    client_pids=$(pgrep -f "whisper-overlay overlay" || true)

    if [[ -n "$client_pids" ]]; then
        local count
        count=$(echo "$client_pids" | wc -l)
        printf "${GREEN}Client: Running ($count instance(s))${NC}\n"
        echo "$client_pids" | while read -r pid; do
            printf "  ${BLUE}PID:${NC} $pid\n"
        done
    else
        printf "${RED}Client: Not running${NC}\n"
    fi

    # Show current settings if available
    if [[ -f "$SETTINGS_FILE" ]]; then
        printf "\n${BLUE}Current Settings:${NC}\n"
        printf "  ${BLUE}Model:${NC} ${S2T_MODEL:-small}\n"
        
        # Display hotkey in user-friendly format
        local hotkey_display="${S2T_HOTKEY:-KEY_GRAVE}"
        case "$hotkey_display" in
            KEY_GRAVE) printf "  ${BLUE}Hotkey:${NC} Super + \` (grave)\n" ;;
            KEY_F12)   printf "  ${BLUE}Hotkey:${NC} Super + F12\n" ;;
            KEY_F11)   printf "  ${BLUE}Hotkey:${NC} Super + F11\n" ;;
            KEY_F10)   printf "  ${BLUE}Hotkey:${NC} Super + F10\n" ;;
            *)         printf "  ${BLUE}Hotkey:${NC} $hotkey_display\n" ;;
        esac
        
        printf "  ${BLUE}Port:${NC} ${S2T_PORT:-7007}\n"
        printf "  ${BLUE}Language:${NC} ${S2T_LANGUAGE:-auto}\n"
        printf "  ${BLUE}Audio device:${NC} ${S2T_AUDIO_DEVICE:-default}\n"
        printf "  ${BLUE}Output mode:${NC} ${S2T_OUTPUT_MODE:-type}\n"
        printf "  ${BLUE}Debug:${NC} ${S2T_DEBUG:-false}\n"
    fi

    if ! is_server_running && [[ -z "$client_pids" ]]; then
        printf "\n${YELLOW}S2T not running${NC}\n"
        printf "Use ${BLUE}vulcan-s2t start${NC} to begin\n"
    fi
}

# Start S2T
start_s2t() {
    init_config
    load_settings

    printf "${BLUE}Starting VulcanOS Speech-to-Text...${NC}\n"

    # Start server first
    if "$script_dir/vulcan-s2t-server" start; then
        printf "\n"
        printf "${GREEN}Server started successfully${NC}\n"

        # Start client (this will block until exit)
        printf "${BLUE}Starting dictation overlay...${NC}\n"
        "$script_dir/vulcan-dictation"
    else
        printf "${RED}Failed to start server${NC}\n" >&2
        return 1
    fi
}

# Stop S2T
stop_s2t() {
    printf "${BLUE}Stopping VulcanOS Speech-to-Text...${NC}\n"

    # Kill whisper-overlay client
    local client_pids
    client_pids=$(pgrep -f "whisper-overlay overlay" || true)

    if [[ -n "$client_pids" ]]; then
        printf "Stopping client...\n"
        echo "$client_pids" | xargs kill 2>/dev/null || true
        sleep 1

        # Force kill if still running
        client_pids=$(pgrep -f "whisper-overlay overlay" || true)
        if [[ -n "$client_pids" ]]; then
            echo "$client_pids" | xargs kill -9 2>/dev/null || true
        fi
        printf "${GREEN}Client stopped${NC}\n"
    else
        printf "${YELLOW}Client not running${NC}\n"
    fi

    # Stop server
    if "$script_dir/vulcan-s2t-server" stop; then
        printf "${GREEN}S2T stopped${NC}\n"
    fi

    # Clean up PID files
    rm -f "$CLIENT_PID"
}

# Restart S2T
restart_s2t() {
    printf "${BLUE}Restarting VulcanOS Speech-to-Text...${NC}\n"
    stop_s2t
    sleep 2
    start_s2t
}

# Open settings menu
open_settings() {
    init_config
    
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    if [[ -x "$script_dir/vulcan-s2t-settings" ]]; then
        "$script_dir/vulcan-s2t-settings"
    else
        printf "${RED}Error: vulcan-s2t-settings not found${NC}\n" >&2
        exit 1
    fi
}

# Set model
set_model() {
    init_config
    load_settings
    
    local models="tiny base small medium large-v3"
    
    printf "${BLUE}Current model: ${S2T_MODEL:-small}${NC}\n"
    printf "${BLUE}Available models:${NC}\n"
    printf "  tiny     - Fastest, lowest accuracy\n"
    printf "  base     - Fast, low accuracy\n"
    printf "  small    - Balanced (default)\n"
    printf "  medium   - Slower, good accuracy\n"
    printf "  large-v3 - Slowest, best accuracy\n\n"
    
    if [[ -n "${1:-}" ]]; then
        S2T_MODEL="$1"
    else
        printf "${YELLOW}Usage: vulcan-s2t set-model <model>${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    # Validate model
    if [[ ! " $models " =~ " $S2T_MODEL " ]]; then
        printf "${RED}Error: Invalid model '$S2T_MODEL'${NC}\n" >&2
        exit 1
    fi
    
    # Update settings.conf
    sed -i "s/^S2T_MODEL=.*/S2T_MODEL=\"$S2T_MODEL\"/" "$SETTINGS_FILE"
    
    # Update server.conf
    if [[ -f "$SERVER_FILE" ]]; then
        sed -i "s/^S2T_MODEL_SIZE=.*/S2T_MODEL_SIZE=\"$S2T_MODEL\"/" "$SERVER_FILE"
    fi
    
    printf "${GREEN}Model set to: $S2T_MODEL${NC}\n"
    
    # Restart server if running
    if is_server_running; then
        printf "${YELLOW}Restarting server for new model...${NC}\n"
        local script_dir
        script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        "$script_dir/vulcan-s2t-server" restart
        printf "${GREEN}Server restarted${NC}\n"
    fi
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Model changed to $S2T_MODEL" -t 2000
    fi
}

# Set hotkey
set_hotkey() {
    init_config
    load_settings
    
    local hotkeys="KEY_GRAVE KEY_F12 KEY_F11 KEY_F10"
    local key_names="Super+\` Super+F12 Super+F11 Super+F10"
    
    printf "${BLUE}Current hotkey: ${S2T_HOTKEY:-KEY_GRAVE}${NC}\n"
    printf "${BLUE}Available hotkeys:${NC}\n"
    echo "$key_names" | paste <(echo "$hotkeys") - - | column -t
    printf "\n"
    
    if [[ -n "${1:-}" ]]; then
        S2T_HOTKEY="$1"
    else
        printf "${YELLOW}Usage: vulcan-s2t set-hotkey <key>${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    # Validate hotkey
    if [[ ! " $hotkeys " =~ " $S2T_HOTKEY " ]]; then
        printf "${RED}Error: Invalid hotkey '$S2T_HOTKEY'${NC}\n" >&2
        exit 1
    fi
    
    # Update settings.conf
    sed -i "s/^S2T_HOTKEY=.*/S2T_HOTKEY=\"$S2T_HOTKEY\"/" "$SETTINGS_FILE"
    
    printf "${GREEN}Hotkey set to: $S2T_HOTKEY${NC}\n"
    
    # Show mapping
    case "$S2T_HOTKEY" in
        KEY_GRAVE) printf "${BLUE}Press: Super + \` (grave)${NC}\n" ;;
        KEY_F12)   printf "${BLUE}Press: Super + F12${NC}\n" ;;
        KEY_F11)   printf "${BLUE}Press: Super + F11${NC}\n" ;;
        KEY_F10)   printf "${BLUE}Press: Super + F10${NC}\n" ;;
    esac
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Hotkey changed" -t 2000
    fi
}

# Set language
set_language() {
    init_config
    load_settings
    
    printf "${BLUE}Current language: ${S2T_LANGUAGE:-auto}${NC}\n"
    printf "${BLUE}Common languages:${NC} en, es, fr, de, it, pt, ru, zh, ja, ko\n"
    printf "${BLUE}Empty for auto-detect${NC}\n\n"
    
    if [[ $# -gt 0 ]]; then
        S2T_LANGUAGE="$*"
    else
        printf "${YELLOW}Usage: vulcan-s2t set-language <lang-code>${NC}\n"
        printf "Example: ${BLUE}vulcan-s2t set-language es${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    # Update settings.conf
    sed -i "s/^S2T_LANGUAGE=.*/S2T_LANGUAGE=\"$S2T_LANGUAGE\"/" "$SETTINGS_FILE"
    
    if [[ -z "$S2T_LANGUAGE" ]]; then
        printf "${GREEN}Language set to: auto-detect${NC}\n"
    else
        printf "${GREEN}Language set to: $S2T_LANGUAGE${NC}\n"
    fi
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Language changed" -t 2000
    fi
}

# Set audio device
set_audio_device() {
    init_config
    load_settings
    
    if [[ -z "$1" ]]; then
        printf "${YELLOW}Usage: vulcan-s2t set-audio-device <device>${NC}\n"
        printf "List devices with: ${BLUE}vulcan-s2t audio-devices${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    S2T_AUDIO_DEVICE="$1"
    
    # Update settings.conf
    sed -i "s/^S2T_AUDIO_DEVICE=.*/S2T_AUDIO_DEVICE=\"$S2T_AUDIO_DEVICE\"/" "$SETTINGS_FILE"
    
    printf "${GREEN}Audio device set to: $S2T_AUDIO_DEVICE${NC}\n"
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Audio device changed" -t 2000
    fi
}

# Set output mode
set_output_mode() {
    init_config
    load_settings
    
    printf "${BLUE}Current output mode: ${S2T_OUTPUT_MODE:-type}${NC}\n"
    printf "${BLUE}Available modes:${NC}\n"
    printf "  type       - Type text directly\n"
    printf "  clipboard  - Copy to clipboard\n\n"
    
    if [[ -n "${1:-}" ]]; then
        S2T_OUTPUT_MODE="$1"
    else
        printf "${YELLOW}Usage: vulcan-s2t set-output-mode <mode>${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    # Validate output mode
    if [[ "$S2T_OUTPUT_MODE" != "type" && "$S2T_OUTPUT_MODE" != "clipboard" ]]; then
        printf "${RED}Error: Invalid output mode '$S2T_OUTPUT_MODE'${NC}\n" >&2
        printf "Must be: type or clipboard\n" >&2
        exit 1
    fi
    
    # Update settings.conf
    sed -i "s/^S2T_OUTPUT_MODE=.*/S2T_OUTPUT_MODE=\"$S2T_OUTPUT_MODE\"/" "$SETTINGS_FILE"
    
    printf "${GREEN}Output mode set to: $S2T_OUTPUT_MODE${NC}\n"
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Output mode changed" -t 2000
    fi
}

# Set debug mode
set_debug() {
    init_config
    load_settings
    
    printf "${BLUE}Current debug mode: ${S2T_DEBUG:-false}${NC}\n\n"
    
    if [[ -n "${1:-}" ]]; then
        S2T_DEBUG="$1"
    else
        printf "${YELLOW}Usage: vulcan-s2t set-debug <true|false>${NC}\n"
        printf "Or use: ${BLUE}vulcan-s2t settings${NC} for interactive menu\n"
        exit 1
    fi
    
    # Validate debug value
    if [[ "$S2T_DEBUG" != "true" && "$S2T_DEBUG" != "false" ]]; then
        printf "${RED}Error: Invalid debug value '$S2T_DEBUG'${NC}\n" >&2
        printf "Must be: true or false\n" >&2
        exit 1
    fi
    
    # Update settings.conf
    sed -i "s/^S2T_DEBUG=.*/S2T_DEBUG=\"$S2T_DEBUG\"/" "$SETTINGS_FILE"
    
    printf "${GREEN}Debug mode set to: $S2T_DEBUG${NC}\n"
    
    # Notify
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "Debug mode: $S2T_DEBUG" -t 2000
    fi
}

# List audio devices
list_audio_devices() {
    printf "${BLUE}Available Audio Devices:${NC}\n"
    printf "───────────────────────────────\n"
    
    if ! command -v pactl &>/dev/null; then
        printf "${RED}Error: pactl not found${NC}\n" >&2
        printf "Install PipeWire with: ${BLUE}sudo pacman -S pipewire wireplumber${NC}\n" >&2
        exit 1
    fi
    
    local devices
    devices=$(pactl list sources short 2>/dev/null)
    
    if [[ -z "$devices" ]]; then
        printf "${YELLOW}No audio devices found${NC}\n"
        printf "Check PipeWire status: ${BLUE}pactl info${NC}\n"
        exit 1
    fi
    
    # Format output
    echo "$devices" | while read -r idx name desc rest; do
        # Format description (remove underscores and capitalize)
        local pretty_desc
        pretty_desc=$(echo "$desc" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
        
        printf "  ${GREEN}$name${NC}\n"
        printf "    ID: $idx\n"
        printf "    Desc: $pretty_desc\n\n"
    done
    
    printf "───────────────────────────────\n"
    printf "${BLUE}Use:${NC}\n"
    printf "  ${BLUE}vulcan-s2t set-audio-device <name>${NC}\n"
    printf "  ${BLUE}vulcan-s2t settings${NC} (interactive menu)\n"
}

# Toggle S2T (stub)
toggle_s2t() {
    printf "${BLUE}Toggling S2T...${NC}\n"
    printf "${YELLOW}Note: Toggle not implemented yet${NC}\n"
}

# Show help
show_help() {
    cat << EOF
${BLUE}VulcanOS Speech-to-Text${NC}

${GREEN}Usage:${NC}
    vulcan-s2t <command>

${GREEN}Commands:${NC}
    Control:
      start              Start S2T server and client
      stop               Stop S2T server and client
      restart            Restart S2T system
      status             Show current S2T status
      toggle             Toggle S2T on/off

    Settings:
      settings           Open Wofi settings menu
      set-model          Change Whisper model (tiny/base/small/medium/large-v3)
      set-hotkey         Change activation hotkey (KEY_GRAVE/KEY_F12/...)
      set-language       Change recognition language (e.g., en, es, or empty for auto)
      set-audio-device   Change audio input device
      set-output-mode    Change output mode (type/clipboard)
      set-debug          Toggle debug mode (true/false)
      audio-devices      List available audio devices

    Other:
      help               Show this help message

${GREEN}Quick Start:${NC}
    1. Check dependencies: vulcan-s2t-deps
    2. Start S2T system: vulcan-s2t start
    3. Hold Super + \` to dictate

${GREEN}Examples:${NC}
    vulcan-s2t set-model medium           # Use medium model
    vulcan-s2t set-language es            # Set Spanish
    vulcan-s2t set-hotkey KEY_F12        # Change hotkey to Super+F12
    vulcan-s2t set-output-mode clipboard  # Copy to clipboard instead
    vulcan-s2t audio-devices              # List audio devices

${GREEN}Advanced:${NC}
    vulcan-s2t-server status     Check server only
    vulcan-dictation            Launch client directly

${YELLOW}Phase 3: Settings UI${NC}
- Wofi-based settings menu implemented
- set-* commands implemented
- Audio device discovery implemented
- Server restart on model change

For more information, see docs/S2T.md
EOF
}

# Main
main() {
    local command="${1:-help}"

    case "$command" in
        start)
            # Determine script directory
            local script_dir
            script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            start_s2t
            ;;
        stop)
            # Determine script directory
            local script_dir
            script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            stop_s2t
            ;;
        restart)
            restart_s2t
            ;;
        status)
            show_status
            ;;
        settings)
            open_settings
            ;;
        set-model)
            shift
            set_model "$@"
            ;;
        set-hotkey)
            shift
            set_hotkey "$@"
            ;;
        set-language)
            shift
            set_language "$@"
            ;;
        set-audio-device)
            shift
            set_audio_device "$@"
            ;;
        set-output-mode)
            shift
            set_output_mode "$@"
            ;;
        set-debug)
            shift
            set_debug "$@"
            ;;
        audio-devices)
            list_audio_devices
            ;;
        toggle)
            toggle_s2t
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            printf "${RED}Error: Unknown command '$command'${NC}\n" >&2
            printf "Use ${BLUE}vulcan-s2t help${NC} to see available commands\n"
            exit 1
            ;;
    esac
}

main "$@"
