#!/usr/bin/env bash
# VulcanOS Speech-to-Text Settings Menu
# Wofi-based settings interface
#
# This script opens a menu for configuring S2T settings

set -euo pipefail

# VulcanOS color scheme
BLUE=$'\e[0;34m'
GREEN=$'\e[0;32m'
YELLOW=$'\e[1;33m'
RED=$'\e[0;31m'
NC=$'\e[0m'

CONFIG_DIR="$HOME/.config/vulcan-s2t"
SETTINGS_FILE="$CONFIG_DIR/settings.conf"
SERVER_FILE="$CONFIG_DIR/server.conf"
DATA_DIR="$HOME/.local/share/vulcan-s2t"
SERVER_PID="$DATA_DIR/server.pid"

# Wofi config path
WOFI_CONFIG="$HOME/.config/wofi/config"

# Available options
MODELS="tiny|base|small|medium|large-v3"
OUTPUT_MODES="type|clipboard"
DEBUG_OPTIONS="true|false"
HOTKEYS="KEY_GRAVE|KEY_F12|KEY_F11|KEY_F10"

# Notify user
notify() {
    if command -v notify-send &>/dev/null; then
        notify-send "S2T Settings" "$1" -t 2000
    fi
}

# Load settings
load_settings() {
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        printf "${RED}Error: Settings file not found${NC}\n" >&2
        printf "Run ${BLUE}vulcan-s2t start${NC} to create config\n" >&2
        exit 1
    fi
    source "$SETTINGS_FILE"
}

# Save settings
save_settings() {
    cat > "$SETTINGS_FILE" << EOF
# VulcanOS Speech-to-Text User Settings
# This file controls client behavior and user preferences

S2T_MODEL="${S2T_MODEL:-small}"
S2T_HOTKEY="${S2T_HOTKEY:-KEY_GRAVE}"
S2T_LANGUAGE="${S2T_LANGUAGE:-}"
S2T_HOST="${S2T_HOST:-localhost}"
S2T_PORT="${S2T_PORT:-7007}"
S2T_AUDIO_DEVICE="${S2T_AUDIO_DEVICE:-default}"
S2T_OUTPUT_MODE="${S2T_OUTPUT_MODE:-type}"
S2T_DEBUG="${S2T_DEBUG:-false}"
EOF
}

# Update server.conf if model changed
update_server_config() {
    local model="$1"
    
    if [[ ! -f "$SERVER_FILE" ]]; then
        printf "${YELLOW}Warning: server.conf not found${NC}\n"
        return
    fi
    
    # Update S2T_MODEL_SIZE in server.conf
    sed -i "s/^S2T_MODEL_SIZE=.*/S2T_MODEL_SIZE=\"$model\"/" "$SERVER_FILE"
}

# Restart server if running
restart_server_if_needed() {
    if [[ -f "$SERVER_PID" ]] && kill -0 "$(cat "$SERVER_PID")" 2>/dev/null; then
        printf "${YELLOW}Restarting server for model change...${NC}\n"
        local script_dir
        script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        "$script_dir/vulcan-s2t-server" restart
        notify "Server restarted for new model"
    fi
}

# Model submenu
show_model_menu() {
    local selection
    selection=$(echo "$MODELS" | tr '|' '\n' | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Select Model" \
        --width 400 \
        --height 250)
    
    if [[ -n "$selection" ]]; then
        S2T_MODEL="$selection"
        update_server_config "$selection"
        save_settings
        printf "${GREEN}Model set to: $selection${NC}\n"
        notify "Model changed to $selection"
        restart_server_if_needed
    fi
}

# Hotkey submenu
show_hotkey_menu() {
    local selection
    selection=$(echo "$HOTKEYS" | tr '|' '\n' | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Select Hotkey" \
        --width 400 \
        --height 250)
    
    if [[ -n "$selection" ]]; then
        S2T_HOTKEY="$selection"
        save_settings
        printf "${GREEN}Hotkey set to: $selection${NC}\n"
        notify "Hotkey changed"
        
        # Show mapping
        case "$selection" in
            KEY_GRAVE) printf "${BLUE}Press: Super + \` (grave)${NC}\n" ;;
            KEY_F12)   printf "${BLUE}Press: Super + F12${NC}\n" ;;
            KEY_F11)   printf "${BLUE}Press: Super + F11${NC}\n" ;;
            KEY_F10)   printf "${BLUE}Press: Super + F10${NC}\n" ;;
        esac
    fi
}

# Language submenu
show_language_menu() {
    local selection
    selection=$(echo -e "auto\nen\nes\nfr\nde\nit\npt\nru\nzh\nja\nko\nother..." | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Select Language" \
        --width 400 \
        --height 350)
    
    if [[ -n "$selection" ]]; then
        if [[ "$selection" == "auto" ]]; then
            S2T_LANGUAGE=""
            printf "${GREEN}Language set to: auto-detect${NC}\n"
            notify "Language: auto-detect"
        elif [[ "$selection" == "other..." ]]; then
            # Custom input using wofi's dmenu mode
            S2T_LANGUAGE=$(echo "" | wofi \
                --dmenu \
                --conf "$WOFI_CONFIG" \
                --prompt "Enter language code (e.g., en, es)" \
                --width 400)
            
            if [[ -n "$S2T_LANGUAGE" ]]; then
                printf "${GREEN}Language set to: $S2T_LANGUAGE${NC}\n"
                notify "Language changed"
            fi
        else
            S2T_LANGUAGE="$selection"
            printf "${GREEN}Language set to: $selection${NC}\n"
            notify "Language changed"
        fi
        
        save_settings
    fi
}

# Audio device submenu
show_audio_menu() {
    # Get available audio devices
    local devices
    devices=$(pactl list sources short 2>/dev/null | awk '{print $2}' | sort -u || echo "default")
    
    # Add "default" option first
    local device_list
    device_list="default"$'\n'"$devices"
    device_list=$(echo "$device_list" | sort -u)
    
    local selection
    selection=$(echo "$device_list" | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Select Audio Device" \
        --width 500 \
        --height 400)
    
    if [[ -n "$selection" ]]; then
        S2T_AUDIO_DEVICE="$selection"
        save_settings
        printf "${GREEN}Audio device set to: $selection${NC}\n"
        notify "Audio device changed"
    fi
}

# Output mode submenu
show_output_menu() {
    local selection
    selection=$(echo "$OUTPUT_MODES" | tr '|' '\n' | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Select Output Mode" \
        --width 400 \
        --height 200)
    
    if [[ -n "$selection" ]]; then
        S2T_OUTPUT_MODE="$selection"
        save_settings
        printf "${GREEN}Output mode set to: $selection${NC}\n"
        notify "Output mode changed"
    fi
}

# Debug submenu
show_debug_menu() {
    local selection
    selection=$(echo "$DEBUG_OPTIONS" | tr '|' '\n' | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "Debug Mode" \
        --width 400 \
        --height 200)
    
    if [[ -n "$selection" ]]; then
        S2T_DEBUG="$selection"
        save_settings
        printf "${GREEN}Debug mode set to: $selection${NC}\n"
        notify "Debug mode: $selection"
    fi
}

# Main menu
show_main_menu() {
    # Display format with current values
    local hotkey_display
    case "${S2T_HOTKEY:-KEY_GRAVE}" in
        KEY_GRAVE) hotkey_display="Super + \`" ;;
        KEY_F12)   hotkey_display="Super + F12" ;;
        KEY_F11)   hotkey_display="Super + F11" ;;
        KEY_F10)   hotkey_display="Super + F10" ;;
        *)         hotkey_display="$S2T_HOTKEY" ;;
    esac
    
    local lang_display="${S2T_LANGUAGE:-auto}"
    
    local selection
    selection=$(cat <<EOF | wofi \
        --dmenu \
        --conf "$WOFI_CONFIG" \
        --prompt "S2T Settings" \
        --width 500 \
        --height 450
Model: ${S2T_MODEL:-small}
Hotkey: $hotkey_display
Language: $lang_display
Audio Device: ${S2T_AUDIO_DEVICE:-default}
Output Mode: ${S2T_OUTPUT_MODE:-type}
Debug: ${S2T_DEBUG:-false}
EOF
)
    
    if [[ -z "$selection" ]]; then
        return
    fi
    
    case "$selection" in
        Model*)           show_model_menu ;;
        Hotkey*)          show_hotkey_menu ;;
        Language*)        show_language_menu ;;
        Audio\ Device*)   show_audio_menu ;;
        Output\ Mode*)    show_output_menu ;;
        Debug*)           show_debug_menu ;;
    esac
}

# Main
main() {
    # Check for wofi
    if ! command -v wofi &>/dev/null; then
        printf "${RED}Error: wofi not found${NC}\n" >&2
        printf "Install with: ${BLUE}sudo pacman -S wofi${NC}\n" >&2
        exit 1
    fi
    
    load_settings
    show_main_menu
}

main "$@"
