#!/usr/bin/env bash
# VulcanOS Speech-to-Text Client Wrapper
# Launches whisper-overlay with S2T configuration
#
# Usage: vulcan-dictation

set -euo pipefail

# VulcanOS color scheme
BLUE=$'\e[0;34m'
GREEN=$'\e[0;32m'
YELLOW=$'\e[1;33m'
RED=$'\e[0;31m'
NC=$'\e[0m'

# Paths
CONFIG_DIR="$HOME/.config/vulcan-s2t"
SETTINGS_FILE="$CONFIG_DIR/settings.conf"
DATA_DIR="$HOME/.local/share/vulcan-s2t"
CLIENT_PID="$DATA_DIR/client.pid"

# Ensure config directory exists
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -d "$DATA_DIR" ]]; then
        mkdir -p "$DATA_DIR"
    fi
}

# Load settings
load_settings() {
    if [[ -f "$SETTINGS_FILE" ]]; then
        source "$SETTINGS_FILE"
    else
        # Defaults
        S2T_MODEL="small"
        S2T_HOTKEY="KEY_GRAVE"
        S2T_LANGUAGE=""
        S2T_HOST="localhost"
        S2T_PORT="7007"
        S2T_AUDIO_DEVICE="default"
        S2T_OUTPUT_MODE="type"
        S2T_DEBUG="false"
    fi
}

# Check if server is running
check_server() {
    local max_wait=5
    local waited=0

    while [[ $waited -lt $max_wait ]]; do
        if command -v nc &>/dev/null; then
            if nc -z "$S2T_HOST" "$S2T_PORT" 2>/dev/null; then
                return 0
            fi
        fi

        # Check PID file as fallback
        local server_pid_file="$DATA_DIR/server.pid"
        if [[ -f "$server_pid_file" ]]; then
            local server_pid
            server_pid=$(cat "$server_pid_file")
            if kill -0 "$server_pid" 2>/dev/null; then
                # Server process exists but not ready yet
                :
            else
                # Server not running
                return 1
            fi
        fi

        sleep 1
        ((waited++))
    done

    return 1
}

# Check dependencies
check_deps() {
    if ! command -v whisper-overlay &>/dev/null; then
        printf "${RED}Error: whisper-overlay not installed${NC}\n" >&2
        printf "${YELLOW}Install: cargo install --git https://github.com/rhasspy/whisper-overlay${NC}\n"
        return 1
    fi

    if [[ "$S2T_OUTPUT_MODE" == "type" ]] && ! command -v wtype &>/dev/null; then
        printf "${RED}Error: wtype not required for output_mode=type${NC}\n" >&2
        printf "${YELLOW}Install: yay -S wtype${NC}\n"
        return 1
    fi

    return 0
}

# Start whisper-overlay client
start_client() {
    init_config
    load_settings

    # Check server is running
    printf "${BLUE}Checking S2T server...${NC}\n"
    if ! check_server; then
        printf "${RED}Error: S2T server is not running${NC}\n" >&2
        printf "${YELLOW}Start server with: vulcan-s2t-server start${NC}\n"
        return 1
    fi

    printf "${GREEN}Server is running${NC}\n"

    # Check dependencies
    if ! check_deps; then
        return 1
    fi

    # Build command
    local cmd="whisper-overlay overlay --host $S2T_HOST --port $S2T_PORT --hotkey $S2T_HOTKEY"

    # Add language if specified
    if [[ -n "$S2T_LANGUAGE" ]]; then
        cmd="$cmd --language $S2T_LANGUAGE"
    fi

    # Add audio device if specified and not default
    if [[ "$S2T_AUDIO_DEVICE" != "default" ]]; then
        cmd="$cmd --audio-device $S2T_AUDIO_DEVICE"
    fi

    # Add debug flag if enabled
    if [[ "$S2T_DEBUG" == "true" ]]; then
        cmd="$cmd --verbose"
    fi

    printf "${BLUE}Starting dictation overlay...${NC}\n"
    printf "${YELLOW}Hotkey: Super + \` (hold to speak)${NC}\n"

    # Launch client
    exec $cmd
}

# Show help
show_help() {
    cat << EOF
${BLUE}VulcanOS Speech-to-Text Dictation${NC}

${GREEN}Usage:${NC}
    vulcan-dictation

${GREEN}Description:${NC}
    Launches the whisper-overlay client for speech-to-text dictation.
    Requires the S2T server to be running on $S2T_HOST:$S2T_PORT.

${GREEN}Controls:${NC}
    Hold Super + \`    Start dictation
    Release           Stop and insert text

${GREEN}Configuration:${NC}
    Settings file: $SETTINGS_FILE

${GREEN}Start server first:${NC}
    vulcan-s2t-server start

${GREEN}Or use the main CLI:${NC}
    vulcan-s2t start
EOF
}

# Main
main() {
    local command="${1:-start}"

    case "$command" in
        start|"")
            start_client
            ;;
        help|--help|-h)
            # Initialize defaults for help display
            S2T_HOST="localhost"
            S2T_PORT="7007"
            show_help
            ;;
        *)
            printf "${RED}Error: Unknown command '$command'${NC}\n" >&2
            printf "Use ${BLUE}vulcan-dictation help${NC} to see available commands\n"
            exit 1
            ;;
    esac
}

main "$@"
