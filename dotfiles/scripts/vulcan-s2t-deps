#!/usr/bin/env bash
# VulcanOS Speech-to-Text Dependencies Check
# Verifies all required dependencies for S2T system
#
# Returns:
#   0 - All dependencies present
#   1 - One or more dependencies missing

set -euo pipefail

# VulcanOS color scheme
BLUE=$'\e[0;34m'
GREEN=$'\e[0;32m'
YELLOW=$'\e[1;33m'
RED=$'\e[0;31m'
NC=$'\e[0m'

# Track missing dependencies
MISSING_DEPS=0

# Check for python-faster-whisper (AUR package)
check_python_faster_whisper() {
    echo -n "Checking python-faster-whisper... "
    if command -v python3 &>/dev/null && python3 -c "import faster_whisper" 2>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install from AUR:${NC} yay -S python-faster-whisper"
        MISSING_DEPS=1
        return 1
    fi
}

# Check for cargo/rust
check_rust() {
    echo -n "Checking Rust/Cargo... "
    if command -v cargo &>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed ($(cargo --version 2>/dev/null | head -1))"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install:${NC} sudo pacman -S rust cargo"
        MISSING_DEPS=1
        return 1
    fi
}

# Check for wtype (Wayland text input tool)
check_wtype() {
    echo -n "Checking wtype... "
    if command -v wtype &>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install from AUR:${NC} yay -S wtype"
        MISSING_DEPS=1
        return 1
    fi
}

# Check for whisper-overlay (Rust binary)
check_whisper_overlay() {
    echo -n "Checking whisper-overlay... "
    if command -v whisper-overlay &>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install:${NC} cargo install --git https://github.com/rhasspy/whisper-overlay"
        MISSING_DEPS=1
        return 1
    fi
}

# Check for Python and basic packages
check_python() {
    echo -n "Checking Python 3... "
    if command -v python3 &>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed ($(python3 --version))"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install:${NC} sudo pacman -S python"
        MISSING_DEPS=1
        return 1
    fi
}

# Check for pip
check_pip() {
    echo -n "Checking pip3... "
    if command -v pip3 &>/dev/null; then
        echo -e "${GREEN}✓${NC} Installed"
        return 0
    else
        echo -e "${RED}✗${NC} Missing"
        echo -e "  ${YELLOW}Install:${NC} sudo pacman -S python-pip"
        MISSING_DEPS=1
        return 1
    fi
}

# Main
main() {
    echo -e "${BLUE}=== VulcanOS Speech-to-Text Dependencies Check ===${NC}\n"

    check_python
    check_pip
    check_python_faster_whisper
    check_rust
    check_wtype
    check_whisper_overlay

    echo ""
    if [[ $MISSING_DEPS -eq 0 ]]; then
        echo -e "${GREEN}All dependencies satisfied!${NC}"
        return 0
    else
        echo -e "${RED}Some dependencies are missing${NC}"
        echo ""
        echo -e "${YELLOW}Quick install all:${NC}"
        echo "  sudo pacman -S python python-pip rust cargo"
        echo "  yay -S python-faster-whisper wtype"
        echo "  cargo install --git https://github.com/rhasspy/whisper-overlay"
        return 1
    fi
}

main "$@"
