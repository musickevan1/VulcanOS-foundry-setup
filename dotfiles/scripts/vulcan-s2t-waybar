#!/usr/bin/env bash
# VulcanOS Speech-to-Text Waybar Status
# Outputs JSON for Waybar status module
#
# States: idle, ready, recording

set -euo pipefail

DATA_DIR="$HOME/.local/share/vulcan-s2t"
SERVER_PID="$DATA_DIR/server.pid"

# Determine status
get_status() {
    local server_running=false
    local client_running=false
    local recording=false

    # Check if server is running
    if [[ -f "$SERVER_PID" ]] && kill -0 "$(cat "$SERVER_PID")" 2>/dev/null; then
        server_running=true
    fi

    # Check if whisper-overlay process is running
    if pgrep -f "whisper-overlay" >/dev/null 2>&1; then
        client_running=true

        # Try to detect if actively recording
        # Check for overlay window properties or D-Bus signals
        if pgrep -f "whisper-overlay.*record" >/dev/null 2>&1; then
            recording=true
        fi
    fi

    if [[ "$recording" == true ]]; then
        echo "recording"
    elif [[ "$client_running" == true ]]; then
        echo "ready"
    elif [[ "$server_running" == true ]]; then
        echo "ready"
    else
        echo "idle"
    fi
}

# Output JSON
output_json() {
    local status
    status="$(get_status)"

    local tooltip="VulcanOS Speech-to-Text\nStatus: $status"

    # Use empty text since icon format handles visual state
    cat << EOF
{
    "text": "",
    "tooltip": "$tooltip",
    "class": "$status",
    "percentage": 0
}
EOF
}

# Main
main() {
    output_json
}

main "$@"
