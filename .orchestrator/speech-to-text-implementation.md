# Prompt: VulcanOS Speech-to-Text Implementation

> Generated by @prompt-builder on 2026-01-01  
> Branch: `feature/speech-to-text`  
> Status: Ready for Orchestration

## Original Idea

"I want to create/install a speech to text app for VulcanOS. I want it to work globally on the system and be activated with a hotkey. There should be a settings menu for config for things like toggle speech or hold key to speak. Hold to speak should be default. I think super+` would be good."

## Refined Understanding

Build a fully integrated speech-to-text system for VulcanOS with:

**Core Requirements:**
- Global system-wide dictation via global hotkey
- Hold-to-speak mode (default) with toggle option
- Hotkey: Super+` (grave accent)
- Wofi-based settings menu for configuration
- Waybar status indicator (left side, after window title)

**Technical Approach:**
- whisper-overlay as core engine (Wayland-native, Hyprland-compatible)
- python-faster-whisper for offline transcription
- wtype for Wayland text input
- Bash-native configuration (no jq/yq dependencies)
- Manual activation via CLI (`vulcan-s2t start`) per user preference
- No systemd, direct process management

**Configuration System:**
- Bash-sourceable config files (settings.conf, server.conf)
- Settings: model size, hotkey, language, audio device, output mode
- Default model: small (balanced for T2 hardware)

**VulcanOS Integration:**
- Follow existing script patterns (vulcan-screensaver, vulcan-wallpaper)
- Wofi for settings menu (consistent with VulcanOS UX)
- Waybar module with status icons (idle/ready/recording)
- Hyprland keybindings and window rules
- Symlinked to ~/.local/bin via stow (scripts directory)

## Target Agent

`@orchestrator` - Multi-phase implementation spanning config files, bash scripts, wofi menus, Waybar modules, Hyprland bindings, documentation, and ISO integration

---

## Prompt

Implement the VulcanOS Speech-to-Text system according to `docs/S2T-PLAN.md`. This is a multi-phase implementation requiring coordination across multiple file types and subsystems.

### Phase 1: Foundation

Create the directory structure and base configuration files:

**Directory Structure:**
```
dotfiles/scripts/
├── vulcan-s2t              # Main CLI (create empty, stub implementation)
├── vulcan-s2t-settings     # Wofi settings menu (stub)
└── vulcan-s2t-waybar       # Waybar status script (stub)

dotfiles/vulcan-s2t/.config/vulcan-s2t/
├── server.conf.default     # Server configuration template
└── settings.conf.default   # User settings template

dotfiles/vulcan-s2t/.local/share/vulcan-s2t/
└── .gitkeep                # Placeholder for runtime data
```

**Configuration Templates:**

Create `server.conf.default` with these defaults:
```bash
S2T_MODEL_SIZE="small"
S2T_DEVICE="auto"
S2T_LANGUAGE=""
S2T_SAMPLE_RATE=16000
S2T_CHANNELS=1
S2T_LOG_LEVEL="info"
```

Create `settings.conf.default` with these defaults:
```bash
S2T_MODEL="small"
S2T_HOTKEY="KEY_GRAVE"
S2T_LANGUAGE=""
S2T_HOST="localhost"
S2T_PORT="7007"
S2T_AUDIO_DEVICE="default"
S2T_OUTPUT_MODE="type"
S2T_DEBUG="false"
```

**Main CLI Stub (`vulcan-s2t`):**
Create a fully functional stub that:
- Handles commands: start, stop, restart, status, settings, toggle, help
- Sources config from `~/.config/vulcan-s2t/settings.conf`
- Creates config from default if missing
- Shows status but doesn't actually start processes yet
- Uses VulcanOS color scheme and script patterns (see `vulcan-screensaver`)

**Exit Criteria for Phase 1:**
- [ ] Directory structure created
- [ ] Config templates in place
- [ ] `vulcan-s2t help` works and shows all commands
- [ ] `vulcan-s2t status` shows "S2T not running"
- [ ] `vulcan-s2t settings` opens wofi menu (stub)

### Phase 2: Server & Client Setup

Implement the server and client scripts:

**Dependencies Verification Script:**
Create `dotfiles/scripts/vulcan-s2t-deps` that:
- Checks for python-faster-whisper (AUR)
- Checks for cargo/rust
- Checks for wtype
- Provides installation instructions if missing

**Server Wrapper (`dotfiles/scripts/vulcan-s2t-server`):**
```bash
#!/usr/bin/env bash
# Downloads realtime-stt-server.py if missing
# Starts server with config from server.conf
# Outputs PID to ~/.local/share/vulcan-s2t/server.pid
# Logs to ~/.local/share/vulcan-s2t/server.log
# Implements start, stop, status, restart commands
```

**Client Wrapper (`dotfiles/scripts/vulcan-dictation`):**
```bash
#!/usr/bin/env bash
# Wraps whisper-overlay overlay command
# Uses S2T_HOTKEY and S2T_PORT from settings
# Checks server is running before starting
```

**Update Main CLI:**
- `vulcan-s2t start`: Start server (wait for ready), then start client
- `vulcan-s2t stop`: Stop client, then stop server
- `vulcan-s2t restart`: Stop then start
- `vulcan-s2t status`: Check both server and client processes

**Exit Criteria for Phase 2:**
- [ ] Dependencies script works and reports missing deps
- [ ] `vulcan-s2t-server start` downloads and runs server
- [ ] `vulcan-dictation` launches whisper-overlay
- [ ] `vulcan-s2t start` launches both
- [ ] `vulcan-s2t stop` cleans up both
- [ ] Server accessible on localhost:7007

### Phase 3: Settings UI

Implement wofi-based settings menu:

**Settings Menu (`vulcan-s2t-settings`):**
- Main menu with current settings displayed
- Sub-menus for each setting (Model, Hotkey, Language, Audio, etc.)
- Uses global wofi config at `~/.config/wofi/config`
- Updates `settings.conf` when changes are made
- Notifies user of changes via notify-send
- Restarts server if needed (for model changes)

**Setting Sub-commands:**
```bash
vulcan-s2t set-model          # Select from: tiny, base, small, medium, large-v3
vulcan-s2t set-hotkey         # Show key list, select new hotkey
vulcan-s2t set-language       # Enter language code or empty for auto
vulcan-s2t set-audio-device   # List devices, select input
vulcan-s2t set-output-mode    # Toggle: type or clipboard
```

**Audio Device Discovery:**
```bash
vulcan-s2t audio-devices      # Lists: pactl list sources short
```

**Update Main CLI:**
- Add `vulcan-s2t set-*` subcommands
- `vulcan-s2t audio-devices` command

**Exit Criteria for Phase 3:**
- [ ] Settings menu opens and shows current values
- [ ] Changing settings updates config file
- [ ] Model change restarts server automatically
- [ ] Audio device selection shows available devices
- [ ] Notifications appear on setting changes

### Phase 4: Hyprland Integration

Add keybindings and window rules:

**Keybindings (`dotfiles/hypr/.config/hypr/bindings.conf`):**
Add in a new "SPEECH-TO-TEXT" section:
```conf
# Speech-to-Text (Super + grave)
bind = $mainMod, grave, exec, vulcan-dictation
bind = $mainMod SHIFT, grave, exec, vulcan-s2t settings
bind = $mainMod CTRL, grave, exec, vulcan-s2t toggle
```

**Window Rules (`dotfiles/hypr/.config/hypr/windowrules.conf`):**
Add for whisper-overlay window:
```conf
# Speech-to-text overlay
windowrule = match:class whisper-overlay, noanim on
windowrule = match:class whisper-overlay, noblur on
windowrule = match:class whisper-overlay, noshadow on
```

**Exit Criteria for Phase 4:**
- [ ] Super+` (hold) triggers dictation
- [ ] Super+Shift+` opens settings
- [ ] Super+Ctrl+` toggles S2T
- [ ] Overlay window appears correctly during recording
- [ ] No conflicts with existing bindings

### Phase 5: Waybar Integration

Add Waybar status module:

**Status Script (`dotfiles/scripts/vulcan-s2t-waybar`):**
```bash
#!/usr/bin/env bash
# Outputs JSON for Waybar module
# Checks: server running? client running? recording?
# States: idle, ready, recording
# Polling interval: 2 seconds
```

**Waybar Module Definition:**
Add to `dotfiles/waybar/.config/waybar/config.jsonc`:
```json
"custom/s2t": {
    "exec": "~/.local/bin/vulcan-s2t-waybar",
    "interval": 2,
    "return-type": "json",
    "format": "{icon}",
    "format-icons": {
        "idle": "<span foreground='#928374'>󰍜</span>",
        "ready": "<span foreground='#a3be8c'>󰍜</span>",
        "recording": "<span foreground='#fb4934'>󰍁</span>"
    },
    "tooltip": true,
    "on-click": "vulcan-s2t settings",
    "on-click-right": "vulcan-s2t toggle"
}
```

**Positioning:**
- Move to modules-left (after hyprland/window, before clock)
- Move clock to modules-center
- Add separator modules as needed

**Styling (`style.css`):**
Add CSS for `#custom-s2t` with states: idle, ready, recording

**Exit Criteria for Phase 5:**
- [ ] S2T icon appears in left bar
- [ ] Icon changes between idle/ready/recording
- [ ] Click opens settings menu
- [ ] Right-click toggles S2T
- [ ] Tooltip shows correct status
- [ ] Clock centered in modules-center

### Phase 6: Documentation & ISO Integration

Create documentation and prepare for distribution:

**Documentation:**

1. **User Guide (`docs/S2T.md`):**
   - Overview and features
   - Quick start guide
   - Command reference
   - Keyboard shortcuts
   - Settings explanation
   - Performance tips for T2 hardware
   - Troubleshooting section

2. **Installation Guide (`docs/S2T-INSTALL.md`):**
   - Prerequisites
   - Step-by-step installation
   - AUR package installation
   - Cargo build instructions
   - Verification steps
   - First-time configuration

**ISO Integration:**

1. **Update `archiso/packages.x86_64`:**
   Add:
   ```
   # Speech-to-Text
   python-faster-whisper
   rust
   cargo
   ```

2. **Add skel files:**
   - `archiso/airootfs/etc/skel/.config/vulcan-s2t/server.conf.default`
   - `archiso/airootfs/etc/skel/.config/vulcan-s2t/settings.conf.default`
   - `archiso/airootfs/usr/local/bin/vulcan-s2t` → symlink to settings script

3. **Update `CLAUDE.md`:**
   - Add S2T to "Customization Guidelines" section
   - Add to "File Quick Reference"

**Exit Criteria for Phase 6:**
- [ ] User guide is comprehensive and readable
- [ ] Installation guide is accurate and complete
- [ ] packages.x86_64 includes all dependencies
- [ ] Skel files will create correct structure on install
- [ ] CLAUDE.md updated

### Phase 7: Testing & Polish

Comprehensive testing and refinements:

**Testing Checklist:**

1. **Unit Tests:**
   - [ ] Config parsing works correctly
   - [ ] Status command shows accurate state
   - [ ] Waybar JSON is valid
   - [ ] Settings save and reload

2. **Integration Tests:**
   - [ ] `vulcan-s2t start` launches server and client
   - [ ] `vulcan-s2t stop` cleans up all processes
   - [ ] Hotkey triggers dictation
   - [ ] Text inserts into kitty, browser, nvim
   - [ ] Settings menu opens and changes work

3. **T2 Hardware Tests:**
   - [ ] Audio input captures speech
   - [ ] Transcription accuracy acceptable
   - [ ] Latency under 3 seconds for hold-to-speak
   - [ ] No system freezes or audio conflicts

**Refinements:**
- [ ] Error messages are clear and helpful
- [ ] All scripts use `set -euo pipefail`
- [ ] Dependencies checked before operations
- [ ] Logs are informative (when S2T_DEBUG=true)
- [ ] Notifications appear for important events

**Exit Criteria for Phase 7:**
- [ ] All tests pass
- [ ] Performance meets expectations on T2
- [ ] No breaking changes to existing system
- [ ] Documentation matches actual behavior
- [ ] Ready for merge to main branch

---

## Implementation Notes

### Script Conventions

Follow existing VulcanOS patterns:
- Use colors for output (BLUE, GREEN, YELLOW, RED, NC)
- Use `set -euo pipefail`
- Check for required commands before use
- Use `notify-send` for user notifications
- Source config files, don't parse with external tools
- Store PIDs and logs in `~/.local/share/vulcan-s2t/`

See `dotfiles/scripts/vulcan-screensaver` and `dotfiles/scripts/vulcan-wallpaper` for reference.

### Wofi Integration

Use global wofi config at `~/.config/wofi/config`:
- Don't create custom CSS per-invocation
- Use `--prompt` for context
- Use `--dmenu` for single selections
- Preserve VulcanOS theme consistency

### Waybar Integration

- Use JSON output with `return-type: json`
- Poll every 2 seconds (interval: 2)
- Position in modules-left after window title
- Click to open settings, right-click to toggle

### Hyprland Integration

- Use `bind = $mainMod, grave` for Super+`
- Use `exec` to launch scripts
- Add window rules for overlay behavior
- Document all bindings

---

## Context Notes

- **VulcanOS**: Custom Arch Linux distribution for T2 MacBook Pro
- **Compositor**: Hyprland (Wayland)
- **Audio**: PipeWire stack
- **Menu System**: Wofi for applications and menus
- **Status Bar**: Waybar with custom modules
- **Dotfiles**: GNU Stow managed, symlinked to ~/
- **Current Branch**: `feature/speech-to-text`
- **Target Branch**: `main` (after completion)

### Existing Patterns to Follow

1. Scripts in `dotfiles/scripts/` → `~/.local/bin/` via stow
2. Config files in `dotfiles/*/.config/*/` → `~/.config/*/` via stow
3. Wofi for all menus (consistent UX)
4. Bash-native configuration (no jq/yq)
5. Colors and notifications for user feedback

### Key Files for Reference

- `dotfiles/scripts/vulcan-screensaver` - Script pattern
- `dotfiles/scripts/vulcan-wallpaper` - Script with wofi integration
- `dotfiles/hypr/.config/hypr/bindings.conf` - Keybinding format
- `dotfiles/waybar/.config/waybar/config.jsonc` - Module format
- `dotfiles/waybar/.config/waybar/style.css` - Styling format
- `archiso/packages.x86_64` - Package format

---

## Phase Execution Order

Run phases sequentially:
1. Phase 1: Foundation
2. Phase 2: Server & Client
3. Phase 3: Settings UI
4. Phase 4: Hyprland Integration
5. Phase 5: Waybar Integration
6. Phase 6: Documentation & ISO
7. Phase 7: Testing & Polish

Each phase should complete its exit criteria before moving to the next.

**Estimated total effort**: 15-20 development hours

---

## Final Deliverable

A fully functional speech-to-text system integrated into VulcanOS with:
- ✅ Global hold-to-speak dictation (Super+`)
- ✅ Wofi-based settings menu
- ✅ Waybar status indicator
- ✅ Hyprland keybindings
- ✅ Comprehensive documentation
- ✅ ISO integration ready
